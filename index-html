<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Diagnostic Tool v3.0.2 "Safety & Clinical Accuracy"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-after: always; }
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
            border-bottom: 3px solid #1d4ed8;
        }
        .tab-disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            width: calc(100% - 20px);
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            flex-shrink: 0;
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-footer {
            flex-shrink: 0;
        }
        .sintesi-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
        .locked-banner {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #dc2626;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #dc2626; }
            50% { border-color: #991b1b; }
        }
        .mega-reset-btn {
            animation: pulse-glow 1.5s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 10px #dc2626, 0 0 20px #dc2626;
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px #dc2626, 0 0 40px #dc2626;
                transform: scale(1.05);
            }
        }
        .epistemic-note {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <!-- Modal Disclaimer Iniziale -->
    <div id="disclaimer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header bg-red-600 text-white p-4 rounded-t-xl">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <span>STRUMENTO DI SUPPORTO DIAGNOSTICO</span>
                </h2>
            </div>
            <div class="modal-body p-4 space-y-3">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3">
                    <p class="font-bold mb-1 text-yellow-900">
                        ATTENZIONE: Questo tool NON sostituisce
                    </p>
                    <ul class="list-disc ml-5 space-y-1 text-yellow-800 text-sm">
                        <li>Il ragionamento istopatologico del medico</li>
                        <li>L'integrazione con dati clinici ed endoscopici</li>
                        <li>L'esperienza diagnostica in IBD</li>
                        <li>Il giudizio professionale individuale</li>
                    </ul>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-3">
                    <p class="font-semibold text-blue-900 mb-1">
                        Lo scoring percentuale √®:
                    </p>
                    <ul class="list-disc ml-5 space-y-1 text-blue-800 text-sm">
                        <li><strong>PURAMENTE ORIENTATIVO</strong> e non diagnostico</li>
                        <li><strong>NON VALIDATO</strong> prospetticamente</li>
                        <li>Basato su criteri di letteratura ma <strong>non standardizzato</strong></li>
                        <li>Da interpretare SEMPRE nel contesto clinico completo</li>
                    </ul>
                </div>

                <div class="bg-green-50 border-l-4 border-green-500 p-3">
                    <p class="font-semibold text-green-900 mb-1">
                        Uso consigliato:
                    </p>
                    <p class="text-green-800 text-sm">
                        Patologi con esperienza in IBD, come supporto alla diagnosi differenziale 
                        in contesto di studio multidisciplinare integrato.
                    </p>
                </div>

                <div class="bg-gray-100 p-3 rounded">
                    <p class="text-xs text-gray-700 italic">
                        v3.0.2 "Safety & Clinical Accuracy": Fix critici topografia, scoring IBDU, granulomi, CMV, displasia.
                    </p>
                </div>
            </div>
            <div class="modal-footer p-4 bg-gray-50 rounded-b-xl">
                <button 
                    onclick="acceptDisclaimer()"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                >
                    Ho capito, procedi ‚Üí
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <!-- Header -->
        <div class="mb-4 border-b pb-4">
            <h1 class="text-3xl font-bold text-blue-900 mb-2">
                IBD Diagnostic Tool <span class="text-lg text-gray-600">v3.0.2 "Safety & Clinical Accuracy"</span>
            </h1>
            <p class="text-sm text-gray-600">
                Supporto diagnosi differenziale Inflammatory Bowel Disease
            </p>
            <p class="text-xs text-gray-500 mt-1">
                v3.0.2: Fix critici - Topografia (displasia), Scoring IBDU indipendente, Granulomi sospetti, CMV linguaggio, Displasia separata
            </p>
        </div>

        <!-- Banner Locked (v3.0.1 - Fase 2) -->
        <div id="locked-banner" class="hidden locked-banner rounded-lg p-4 mb-6 no-print shadow-lg">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 flex-1">
                    <span class="text-4xl">üîí</span>
                    <div>
                        <p class="font-bold text-red-900 text-lg">
                            DIAGNOSI COMPLETATA - CASO BLOCCATO
                        </p>
                        <p class="text-sm text-red-800">
                            Per prevenire contaminazione dati tra casi consecutivi, i campi sono bloccati dopo generazione referto.
                        </p>
                    </div>
                </div>
                <button 
                    onclick="confirmReset()"
                    class="mega-reset-btn bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all"
                >
                    üîì SBLOCCA<br>NUOVO CASO
                </button>
            </div>
        </div>

        <!-- Banner Permanente Warning -->
        <div class="mb-6 bg-gradient-to-r from-yellow-400 to-orange-400 border-2 border-orange-500 rounded-lg p-4 no-print shadow-md">
            <div class="flex items-center gap-3">
                <span class="text-3xl">‚ö†Ô∏è</span>
                <div class="flex-1">
                    <p class="font-bold text-gray-900 text-sm">
                        TOOL DIAGNOSTICO: Uso riservato a patologi esperti in IBD
                    </p>
                    <p class="text-xs text-gray-800">
                        Scoring orientativo, NON sostitutivo del ragionamento clinico-patologico | 
                        Validazione prospettica assente
                    </p>
                </div>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="main-content"></div>
    </div>

    <script>
        // ==================== CONFIGURAZIONE ====================
        const APP_VERSION = '3.0.2';
        const STORAGE_KEY = 'ibdAppDataV302';
        const DISCLAIMER_KEY = 'ibdDisclaimerAccepted';

        // ==================== STATE ====================
        let specimens = [];
        let ihcData = {
            cd68_pattern: 'non_eseguito',
            p53_pattern: 'non_eseguito',
            cmv_status: 'non_eseguito'
        };
        
        let ibdNota = {
            enabled: false,
            diagnosiIniziale: null,
            diagnosiAttuale: null,
            therapyOngoing: false  // v3.0.2: terapia in corso
        };
        
        let altreColiti = {
            banda_collagene: 'assente',
            iel_aumentati: 'assente',
            pattern_superficiale: false,
            architettura_conservata: false,
            atrofia_ischemica: false,
            membrane_ialine: false,
            emorragia_recente: false,
            apoptosi_cripte: 'assente',
            ulcere_diaframma: false
        };
        
        let activeTab = 'campioni';
        let currentSite = 'ileo';
        
        let diagnosiVeloce = {
            selected: null,
            testo: null,
            gradoManuale: null
        };

        let caseLocked = false;
        let reportGenerated = false;

        // ==================== v3.0.2 FIX #1: TOPOGRAFIA CORRETTA ====================
        
        const hasInflammatoryFindings = (specimen) => {
            const f = specimen.findings;
            const siteType = specimen.siteType || 'colon';
            
            // Escludi: displasia (non infiammatoria), fibrosi (marker cronicit√† strutturale)
            if (siteType === 'ileum') {
                return (
                    f.granulomi_epitelioidi === 'presente' ||
                    f.granulomi_epitelioidi === 'sospetti' ||
                    f.neutrofili_lamina_propria !== 'assente' ||
                    f.erosioni_ulcerazioni === 'presente' ||
                    f.iperplasia_linfoide === 'presente' ||
                    f.edema_lamina_propria === 'presente' ||
                    f.plasmacellule_aumentate === 'presente'
                    // NO atrofia_villi (marker cronicit√† aspecifico: celiachia, post-infettiva, FANS)
                    // Atrofia RESTA nello scoring Crohn, ma NON determina "ileo coinvolto" per topografia
                    // NO fibrosi_sottomucosa
                );
            } else {
                return (
                    f.granulomi_epitelioidi === 'presente' ||
                    f.granulomi_epitelioidi === 'sospetti' ||
                    f.neutrofili_epitelio !== 'assente' ||
                    f.ascessi_criptici === 'presente' ||
                    f.plasmacellule_basale === 'presente' ||
                    f.distorsione_architettura === 'presente' ||
                    f.metaplasia_paneth === 'presente' ||
                    f.ulcerazione === 'presente'
                    // NO displasia, NO fibrosi_sottomucosa
                );
            }
        };

        // ==================== v3.0.1 LOCK FUNCTIONS ====================
        
        const lockCase = () => {
            if (specimens.length > 0 && !caseLocked) {
                caseLocked = true;
                reportGenerated = true;
                document.getElementById('locked-banner').classList.remove('hidden');
                saveData();
            }
        };

        const unlockCase = () => {
            caseLocked = false;
            reportGenerated = false;
            document.getElementById('locked-banner').classList.add('hidden');
            
            // Reset completo
            specimens = [];
            ihcData = {
                cd68_pattern: 'non_eseguito',
                p53_pattern: 'non_eseguito',
                cmv_status: 'non_eseguito'
            };
            ibdNota = {
                enabled: false,
                diagnosiIniziale: null,
                diagnosiAttuale: null,
                therapyOngoing: false
            };
            altreColiti = {
                banda_collagene: 'assente',
                iel_aumentati: 'assente',
                pattern_superficiale: false,
                architettura_conservata: false,
                atrofia_ischemica: false,
                membrane_ialine: false,
                emorragia_recente: false,
                apoptosi_cripte: 'assente',
                ulcere_diaframma: false
            };
            diagnosiVeloce = {
                selected: null,
                testo: null,
                gradoManuale: null
            };
            
            activeTab = 'campioni';
            saveData();
            render();
        };

        const confirmReset = () => {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questo canceller√† TUTTI i dati del caso attuale.\n\nSei sicuro di voler procedere con il reset?')) {
                unlockCase();
            }
        };

        // ==================== IBD NOTA HANDLERS ====================
        const toggleIbdNota = (enabled) => {
            if (caseLocked) return;
            ibdNota.enabled = enabled;
            if (!enabled) {
                ibdNota.diagnosiIniziale = null;
                ibdNota.diagnosiAttuale = null;
                ibdNota.therapyOngoing = false;
            }
            saveData();
            render();
        };

        const updateIbdNota = (field, value) => {
            if (caseLocked) return;
            if (field === 'therapyOngoing') {
                ibdNota[field] = value;
            } else {
                ibdNota[field] = value || null;
            }
            saveData();
            render();
        };

        // ==================== NANCY PER CAMPIONE ====================
        const calculateNancyPerSpecimen = (specimen) => {
            if (specimen.siteType === 'ileum') return null;
            
            const f = specimen.findings;
            
            if (f.ulcerazione === 'presente') return 4;
            
            if (f.neutrofili_epitelio === 'marcata' || 
                f.neutrofili_epitelio === 'moderata' || 
                f.ascessi_criptici === 'presente') {
                return 3;
            }
            
            if (f.neutrofili_epitelio === 'lieve') return 2;
            
            if (f.distorsione_architettura === 'presente' || 
                f.plasmacellule_basale === 'presente' ||
                f.metaplasia_paneth === 'presente') {
                return 1;
            }
            
            return 0;
        };

        const isSpecimenActive = (specimen) => {
            const f = specimen.findings;
            
            if (specimen.siteType === 'ileum') {
                return f.neutrofili_lamina_propria !== 'assente' ||
                       f.erosioni_ulcerazioni === 'presente';
            } else {
                return f.neutrofili_epitelio !== 'assente' ||
                       f.ascessi_criptici === 'presente' ||
                       f.ulcerazione === 'presente';
            }
        };

        const generateSintesiEndoscopista = () => {
            if (specimens.length === 0) return null;
            
            const isFollowUp = ibdNota.enabled && ibdNota.diagnosiAttuale;
            const diagnosiAttuale = ibdNota.diagnosiAttuale;
            const diagnosiIniziale = ibdNota.diagnosiIniziale;
            
            const colonSpecs = specimens.filter(s => s.siteType !== 'ileum');
            
            let sediAttive = [];
            let sediQuiescenti = [];
            let nancyMax = 0;
            
            if (diagnosiAttuale === 'RCU') {
                colonSpecs.forEach(spec => {
                    const nancy = calculateNancyPerSpecimen(spec);
                    if (nancy >= 2) {
                        sediAttive.push({ site: spec.site, nancy });
                    } else {
                        sediQuiescenti.push({ site: spec.site, nancy });
                    }
                    if (nancy > nancyMax) nancyMax = nancy;
                });
            } else {
                specimens.forEach(spec => {
                    if (isSpecimenActive(spec)) {
                        sediAttive.push({ site: spec.site });
                    } else {
                        sediQuiescenti.push({ site: spec.site });
                    }
                });
                
                colonSpecs.forEach(spec => {
                    const nancy = calculateNancyPerSpecimen(spec);
                    if (nancy > nancyMax) nancyMax = nancy;
                });
            }
            
            const displasiaFindings = colonSpecs
                .filter(s => s.findings.displasia && s.findings.displasia !== 'assente')
                .map(s => ({ site: s.site, grado: s.findings.displasia }));
            
            const hasDisplasia = displasiaFindings.length > 0;
            const maxDisplasia = hasDisplasia ? 
                (displasiaFindings.some(d => d.grado === 'HGD') ? 'HGD' : 
                 displasiaFindings.some(d => d.grado === 'LGD') ? 'LGD' : 'IND') : null;
            
            return {
                isFollowUp,
                diagnosiAttuale,
                diagnosiIniziale,
                sediAttive: sediAttive.map(s => s.site),
                sediQuiescenti: sediQuiescenti.map(s => s.site),
                nancyMax: diagnosiAttuale === 'RCU' ? nancyMax : null,
                hasDisplasia,
                maxDisplasia,
                displasiaDetails: displasiaFindings,
                p53Aberrante: ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null'
            };
        };

        const updateFormSite = (newSite) => {
            if (caseLocked) return;
            currentSite = newSite;
            render();
        };

        const updateAltreColiti = (field, value) => {
            if (caseLocked) return;
            altreColiti[field] = value;
            saveData();
            render();
        };

        const diagnosiVeloceOptions = [
            { codice: 'NORMALE', emoji: 'üü¢', label: 'Normale', testo: 'Mucosa colica/ileale istologicamente nella norma.', gruppo: 'ibd' },
            { codice: 'PROCTITE_UC', emoji: 'üîµ', label: 'Proctite ulcerosa', testo: 'Proctite cronica attiva, pattern morfologico compatibile con proctite ulcerosa.', gruppo: 'ibd' },
            { codice: 'COLITE_SINISTRA_UC', emoji: 'üîµ', label: 'Colite ulcerosa sinistra', testo: 'Colite cronica attiva con distribuzione sinistra, pattern morfologico compatibile con rettocolite ulcerosa sinistra.', gruppo: 'ibd' },
            { codice: 'PANCOLITE_UC', emoji: 'üîµ', label: 'Pancolite ulcerosa', testo: 'Pancolite cronica attiva con distribuzione continua, pattern morfologico compatibile con rettocolite ulcerosa estesa. Ileo terminale indenne.', gruppo: 'ibd' },
            { codice: 'IBD_REMISSIONE', emoji: 'üü°', label: 'IBD in remissione', testo: 'Colite cronica in fase di remissione istologica. Persistono alterazioni architetturali residue. Assenza di attivit√† infiammatoria acuta.', gruppo: 'ibd' },
            { codice: 'ILEITE_NAS', emoji: 'üü†', label: 'Ileite NAS', testo: 'Ileite cronica attiva. Pattern aspecifico, da correlare con dati clinici ed endoscopici (DD: Crohn, infettiva, ischemica, FANS).', gruppo: 'ibd' },
            { codice: 'CROHN_LIKE', emoji: 'üü£', label: 'Malattia di Crohn probabile', testo: 'Colite cronica attiva con pattern morfologico suggestivo per malattia di Crohn. Correlare con clinica ed endoscopia.', gruppo: 'ibd' },
            { codice: 'COLITE_COLLAGENA', emoji: 'üî¨', label: 'Colite collagenosica', testo: 'Colite microscopica, tipo collagenosica. Banda collagene subepiteliale ispessita (‚â•10Œºm). Architettura ghiandolare conservata.', gruppo: 'altre' },
            { codice: 'COLITE_LINFOCITICA', emoji: 'üî¨', label: 'Colite Linfocitica', testo: 'Colite microscopica, tipo linfocitica. Linfociti intraepiteliali aumentati (‚â•20/100 cellule epiteliali). Architettura ghiandolare conservata.', gruppo: 'altre' },
            { codice: 'COLITE_INFETTIVA', emoji: 'ü¶†', label: 'Colite Infettiva', testo: 'Colite acuta con pattern superficiale e architettura conservata, compatibile con eziologia infettiva. Correlare con coprocoltura e clinica.', gruppo: 'altre' },
            { codice: 'COLITE_ISCHEMICA', emoji: 'üíî', label: 'Colite Ischemica', testo: 'Colite con pattern ischemico (atrofia cripte, membrane ialine, emorragia lamina propria). Correlare con sede e fattori di rischio cardiovascolare.', gruppo: 'altre' },
            { codice: 'COLITE_FANS', emoji: 'üíä', label: 'Colite da FANS', testo: 'Colite/enteropatia da FANS. Apoptosi cripte aumentata e/o ulcere a diaframma. Confermare anamnesi farmacologica.', gruppo: 'altre' },
            { codice: 'SCAD', emoji: 'üîò', label: 'SCAD', testo: 'Colite cronica segmentale associata a diverticolosi (SCAD). Flogosi cronica attiva limitata al segmento con diverticoli, retto indenne. Escludere IBD.', gruppo: 'altre' }
        ];

        const selectDiagnosiVeloce = (codice) => {
            if (caseLocked) return;
            if (diagnosiVeloce.selected === codice) {
                diagnosiVeloce.selected = null;
                diagnosiVeloce.testo = null;
                diagnosiVeloce.gradoManuale = null;
            } else {
                const opt = diagnosiVeloceOptions.find(o => o.codice === codice);
                diagnosiVeloce.selected = codice;
                diagnosiVeloce.testo = opt ? opt.testo : null;
                diagnosiVeloce.gradoManuale = null;
            }
            saveData();
            render();
        };

        const clearDiagnosiVeloce = () => {
            if (caseLocked) return;
            diagnosiVeloce.selected = null;
            diagnosiVeloce.testo = null;
            diagnosiVeloce.gradoManuale = null;
            saveData();
            render();
        };

        const updateGradoManuale = (grado) => {
            if (caseLocked) return;
            diagnosiVeloce.gradoManuale = grado === '' ? null : parseInt(grado);
            saveData();
            render();
        };

        const toggleMucinCheckbox = (granulomaValue) => {
            const container = document.getElementById('mucin-checkbox-container');
            const checkbox = document.getElementById('mucin-granuloma-checkbox');
            if (!container) return;
            
            if (granulomaValue === 'presente' || granulomaValue === 'sospetti') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                if (checkbox) checkbox.checked = false;
            }
        };

        // ==================== DISCLAIMER MODAL ====================
        const checkDisclaimer = () => {
            const accepted = localStorage.getItem(DISCLAIMER_KEY);
            if (!accepted) {
                document.getElementById('disclaimer-modal').classList.remove('hidden');
            }
        };

        const acceptDisclaimer = () => {
            localStorage.setItem(DISCLAIMER_KEY, 'true');
            document.getElementById('disclaimer-modal').classList.add('hidden');
        };

        // ==================== HELPER FUNCTIONS ====================
        const shouldShowNancy = () => {
            const hasIleum = specimens.some(s => s.siteType === 'ileum');
            if (hasIleum) return false;

            const hasGranulomas = specimens.some(s => 
                s.findings.granulomi_epitelioidi === 'presente'
            );
            if (hasGranulomas) return false;

            const scoring = calculateScoring();
            const crohnScore = scoring.scores.crohn;
            return crohnScore <= 70;
        };

        const calculateNancyIndex = () => {
            if (!shouldShowNancy()) {
                return { score: null, interpretation: null, applicable: false };
            }

            let nancyScore = 0;
            let hasUlceration = false;
            let hasCryptAbscesses = false;
            let neutrophilSeverity = 'assente';

            const colonSpecimens = specimens.filter(s => s.siteType !== 'ileum');

            colonSpecimens.forEach(specimen => {
                if (specimen.findings.ulcerazione === 'presente') hasUlceration = true;
                if (specimen.findings.ascessi_criptici === 'presente') hasCryptAbscesses = true;
                
                const neutLevel = specimen.findings.neutrofili_epitelio;
                if (neutLevel === 'marcata' && neutrophilSeverity !== 'marcata') {
                    neutrophilSeverity = 'marcata';
                } else if (neutLevel === 'moderata' && neutrophilSeverity === 'assente') {
                    neutrophilSeverity = 'moderata';
                } else if (neutLevel === 'lieve' && neutrophilSeverity === 'assente') {
                    neutrophilSeverity = 'lieve';
                }
            });

            if (hasUlceration) {
                nancyScore = 4;
            } else if (neutrophilSeverity === 'marcata' || neutrophilSeverity === 'moderata' || hasCryptAbscesses) {
                nancyScore = 3;
            } else if (neutrophilSeverity === 'lieve') {
                nancyScore = 2;
            } else {
                const hasChronicChanges = colonSpecimens.some(s => 
                    s.findings.distorsione_architettura === 'presente' ||
                    s.findings.plasmacellule_basale === 'presente'
                );
                nancyScore = hasChronicChanges ? 1 : 0;
            }

            const getNancyInterpretation = (score) => {
                const interpretations = {
                    0: { label: 'Remissione completa', description: 'Assenza di attivit√† e alterazioni croniche', prognosis: 'Eccellente. Basso rischio recidiva (15-20% a 1 anno)' },
                    1: { label: 'Remissione con alterazioni croniche', description: 'Alterazioni architetturali senza attivit√† acuta', prognosis: 'Buona. Rischio recidiva moderato (25-30% a 1 anno)' },
                    2: { label: 'Attivit√† lieve', description: 'Infiltrato neutrofilo lieve senza ulcerazione', prognosis: 'Rischio recidiva 40-50% a 1 anno. Monitoraggio clinico' },
                    3: { label: 'Attivit√† moderata', description: 'Infiltrato neutrofilo moderato-severo o ascessi criptici', prognosis: 'Rischio recidiva 60-70% a 1 anno. Escalation terapeutica' },
                    4: { label: 'Attivit√† severa con ulcerazione', description: 'Ulcerazione mucosa presente', prognosis: 'Rischio recidiva >80% a 1 anno. Terapia intensiva necessaria' }
                };
                return interpretations[score] || interpretations[0];
            };

            return {
                score: nancyScore,
                interpretation: getNancyInterpretation(nancyScore),
                applicable: true,
                details: { hasUlceration, hasCryptAbscesses, neutrophilSeverity }
            };
        };

        // ==================== PATTERN TOPOGRAFICO (v3.0.2 FIX #1) ====================
        const analyzeTopographicPattern = () => {
            const sites = specimens.map(s => s.site);
            
            // v3.0.2 FIX #1: Usa hasInflammatoryFindings invece di "qualsiasi finding"
            const sitesWithFindings = specimens.filter(hasInflammatoryFindings).map(s => s.site);
            
            let pattern = {
                rectumSampled: sites.includes('retto'),
                rectumInvolved: sitesWithFindings.includes('retto'),
                ileumSampled: sites.includes('ileo'),
                ileumInvolved: sitesWithFindings.includes('ileo'),
                skipLesions: false,
                continuity: 'sconosciuta',
                warning: null
            };
            
            const detectSkipLesions = () => {
                const colonOrder = ['cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];
                const findingsIndices = sitesWithFindings
                    .filter(s => colonOrder.includes(s))
                    .map(s => colonOrder.indexOf(s))
                    .sort((a, b) => a - b);
                
                for (let i = 1; i < findingsIndices.length; i++) {
                    if (findingsIndices[i] - findingsIndices[i-1] > 1) {
                        return true;
                    }
                }
                return false;
            };
            
            pattern.skipLesions = detectSkipLesions();
            pattern.continuity = pattern.skipLesions ? 'discontinua' : 'continua';
            
            if (pattern.rectumSampled && pattern.rectumInvolved && !pattern.skipLesions && !pattern.ileumInvolved) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico RCU-like: Retto coinvolto, distribuzione continua, ileo non coinvolto";
            } else if (pattern.skipLesions || (pattern.ileumInvolved && !pattern.rectumInvolved)) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico Crohn-like: Distribuzione discontinua e/o ileo coinvolto con retto risparmiato";
            } else if (!pattern.rectumSampled) {
                pattern.warning = "‚ÑπÔ∏è Retto non campionato: Valutazione pattern topografico limitata";
            } else if (pattern.rectumSampled && !pattern.rectumInvolved && sitesWithFindings.length > 0) {
                // v3.0.2 FIX #3: Modula warning se terapia in corso
                if (ibdNota.therapyOngoing) {
                    pattern.warning = "‚ÑπÔ∏è Retto risparmiato in paziente in terapia: Non esclude RCU (retto pu√≤ normalizzarsi in terapia)";
                } else {
                    pattern.warning = "‚ö†Ô∏è Retto risparmiato: Atipico per RCU classica";
                }
            }
            
            return pattern;
        };

        // ==================== v3.0.2 FIX #2: SCORING IBDU INDIPENDENTE ====================
        
        const calculateIBDUScore = (rawScores, topoPattern) => {
            let ibduScore = 0;
            
            // Features che aumentano IBDU (overlap / contraddittori)
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');
            const hasUCPattern = specimens.some(s => 
                s.findings.plasmacellule_basale === 'presente' || 
                s.findings.distorsione_architettura === 'presente'
            );
            
            // Boost per pattern contraddittori (da v2.4.5)
            if (hasGranulomas && hasUCPattern) ibduScore += 60;
            if (topoPattern.skipLesions && hasUCPattern) ibduScore += 50;
            if (topoPattern.rectumSpared && topoPattern.rectumSampled && hasUCPattern) ibduScore += 40;
            
            // IBDU per pattern aspecifico (score raw bassi)
            if (rawScores.crohn < 50 && rawScores.uc < 50) ibduScore += 80;
            
            // IBDU per score equiparati
            if (Math.abs(rawScores.crohn - rawScores.uc) < 20 && rawScores.crohn > 30) ibduScore += 70;
            
            return ibduScore;
        };

        // ==================== v3.0.2 FIX #3: SCORING CON GRANULOMI DIFFERENZIATI ====================
        const calculateScoring = () => {
            let scores = { crohn: 0, uc: 0, ibdu: 0 };

            specimens.forEach(specimen => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';

                if (siteType === 'ileum') {
                    // v3.0.2 FIX #3: Granulomi differenziati
                    if (f.granulomi_epitelioidi === 'presente') {
                        if (specimen.mucinGranulomaLikely) {
                            scores.crohn += 20; // peso ridotto
                        } else {
                            scores.crohn += 150; // peso pieno
                        }
                    } else if (f.granulomi_epitelioidi === 'sospetti') {
                        scores.crohn += 25; // peso molto ridotto
                    }
                    
                    if (f.erosioni_ulcerazioni === 'presente') scores.crohn += 50;
                    if (f.iperplasia_linfoide === 'presente') scores.crohn += 40;
                    if (f.atrofia_villi === 'marcata') scores.crohn += 30;
                    else if (f.atrofia_villi === 'moderata') scores.crohn += 15;
                    else if (f.atrofia_villi === 'lieve') scores.crohn += 5;
                    if (f.neutrofili_lamina_propria === 'marcata') { scores.crohn += 20; scores.uc += 10; }
                    else if (f.neutrofili_lamina_propria === 'moderata') { scores.crohn += 10; scores.uc += 5; }
                    else if (f.neutrofili_lamina_propria === 'lieve') scores.crohn += 5;
                    if (f.edema_lamina_propria === 'presente') scores.crohn += 15;
                    if (f.plasmacellule_aumentate === 'presente') scores.crohn += 15;
                    if (f.fibrosi_sottomucosa === 'marcata') scores.crohn += 25;
                    else if (f.fibrosi_sottomucosa === 'moderata') scores.crohn += 15;
                    else if (f.fibrosi_sottomucosa === 'lieve') scores.crohn += 5;
                } else {
                    // v3.0.2 FIX #3: Granulomi colon differenziati
                    if (f.granulomi_epitelioidi === 'presente') {
                        if (specimen.mucinGranulomaLikely) {
                            scores.crohn += 15;
                        } else {
                            scores.crohn += 100;
                        }
                    } else if (f.granulomi_epitelioidi === 'sospetti') {
                        scores.crohn += 25;
                    }
                    
                    if (f.neutrofili_epitelio === 'marcata') { scores.uc += 40; scores.crohn += 20; }
                    else if (f.neutrofili_epitelio === 'moderata') { scores.uc += 25; scores.crohn += 15; }
                    else if (f.neutrofili_epitelio === 'lieve') { scores.uc += 15; scores.crohn += 10; }
                    if (f.ascessi_criptici === 'presente') { scores.uc += 30; scores.crohn += 15; }
                    if (f.plasmacellule_basale === 'presente') { scores.uc += 25; scores.crohn += 10; }
                    if (f.distorsione_architettura === 'presente') { scores.uc += 20; scores.crohn += 15; }
                    if (f.metaplasia_paneth === 'presente') scores.uc += 15;
                    if (f.ulcerazione === 'presente') { scores.crohn += 15; scores.uc += 10; }
                    if (f.fibrosi_sottomucosa === 'marcata') { scores.crohn += 25; scores.uc += 10; }
                    else if (f.fibrosi_sottomucosa === 'moderata') { scores.crohn += 15; scores.uc += 5; }
                }
            });

            // v3.0.2 FIX #4: CD68 rinominato
            if (ihcData.cd68_pattern === 'aggregati_profondi') scores.crohn += 35;
            else if (ihcData.cd68_pattern === 'diffuso_mucosa') { scores.uc += 20; scores.crohn += 10; }

            const dysplasiaRisk = ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null';

            // v3.0.2 FIX #2: IBDU score indipendente
            const topoPattern = analyzeTopographicPattern();
            const rawScores = { crohn: scores.crohn, uc: scores.uc };
            scores.ibdu = calculateIBDUScore(rawScores, topoPattern);

            // Normalizzazione
            const total = scores.crohn + scores.uc + scores.ibdu;
            if (total > 0) {
                scores.crohn = Math.round((scores.crohn / total) * 100);
                scores.uc = Math.round((scores.uc / total) * 100);
                scores.ibdu = Math.round((scores.ibdu / total) * 100);
            }

            return { scores, dysplasiaRisk, rawScores };
        };

        // ==================== v3.0.1: INTERPRETAZIONE GRADUATA ====================
        
        const interpretScoringGraduated = (scores) => {
            const { crohn, uc, ibdu } = scores;
            const max = Math.max(crohn, uc, ibdu);
            
            let result = {
                primary: null,
                level: null,
                headline: null,
                description: null,
                epistemicNote: null
            };
            
            if (max === crohn && crohn >= 40) {
                result.primary = 'Malattia di Crohn';
                
                if (crohn >= 80) {
                    result.level = 'alta';
                    result.headline = 'MALATTIA DI CROHN (pattern istologico fortemente suggestivo)';
                    result.description = 'Pattern morfologico e architetturale fortemente indicativo per malattia di Crohn.';
                } else if (crohn >= 60) {
                    result.level = 'probabile';
                    result.headline = 'QUADRO COMPATIBILE CON MALATTIA DI CROHN';
                    result.description = 'Pattern morfologico compatibile con malattia di Crohn. Correlazione con dati clinici, endoscopici e imaging NECESSARIA per diagnosi definitiva.';
                    result.epistemicNote = 'Score in range intermedio (60-79%). Diagnosi basata su criteri multipli ma non patognomonici. Conferma clinico-radiologica essenziale.';
                } else {
                    result.level = 'suggestivo';
                    result.headline = 'PATTERN SUGGESTIVO MA NON DIAGNOSTICO PER MALATTIA DI CROHN';
                    result.description = 'Pattern istologico con alcune features compatibili con Crohn, ma INSUFFICIENTE per diagnosi definitiva.';
                    result.epistemicNote = 'Score borderline (40-59%). Istologia da sola NON consente diagnosi. Correlazione clinica, distribuzione endoscopica e imaging INDISPENSABILI. Considerare rivalutazione con follow-up istologico.';
                }
            }
            else if (max === uc && uc >= 40) {
                result.primary = 'Rettocolite Ulcerosa';
                
                if (uc >= 80) {
                    result.level = 'alta';
                    result.headline = 'COLITE ULCEROSA (pattern istologico fortemente suggestivo)';
                    result.description = 'Pattern morfologico e distributivo fortemente indicativo per rettocolite ulcerosa.';
                } else if (uc >= 60) {
                    result.level = 'probabile';
                    result.headline = 'QUADRO COMPATIBILE CON COLITE ULCEROSA';
                    result.description = 'Pattern morfologico compatibile con rettocolite ulcerosa. Correlazione con distribuzione endoscopica NECESSARIA per diagnosi definitiva.';
                    result.epistemicNote = 'Score in range intermedio (60-79%). Conferma con pattern topografico endoscopico (continuo, retto coinvolto, ileo indenne) essenziale.';
                } else {
                    result.level = 'suggestivo';
                    result.headline = 'PATTERN SUGGESTIVO MA NON DIAGNOSTICO PER COLITE ULCEROSA';
                    result.description = 'Pattern istologico con alcune features compatibili con RCU, ma INSUFFICIENTE per diagnosi definitiva.';
                    result.epistemicNote = 'Score borderline (40-59%). Istologia da sola NON consente diagnosi. Verifica distribuzione continua, coinvolgimento rettale e risparmio ileale tramite endoscopia.';
                }
            }
            else if (max === ibdu || Math.abs(crohn - uc) < 15) {
                result.primary = 'IBDU';
                result.level = 'indeterminato';
                result.headline = 'IBD NON CLASSIFICABILE (IBDU)';
                
                if (ibdu > 50) {
                    result.description = 'Pattern contraddittorio con features sovrapposte Crohn/UC. Classificazione istologica non possibile.';
                    result.epistemicNote = 'IBDU con overlap features. Scoring mostra pattern contraddittori (es: granulomi + cronicit√† RCU-like, skip lesions + plasmacellule basali). Diagnosi definitiva richiede follow-up clinico-istologico prolungato.';
                } else {
                    result.description = 'Pattern aspecifico di IBD. Dati istologici insufficienti per classificazione Crohn vs RCU.';
                    result.epistemicNote = 'Score equiparati Crohn/UC (<15% differenza). Istologia indeterminata. Rivalutazione con follow-up istologico + correlazione clinico-endoscopica-radiologica INDISPENSABILE.';
                }
            }
            else {
                result.primary = 'Indeterminato';
                result.level = 'insufficiente';
                result.headline = 'PATTERN ISTOLOGICO ASPECIFICO';
                result.description = 'Reperti morfologici insufficienti per orientamento diagnostico IBD.';
                result.epistemicNote = 'Score globalmente basso. Campionamento inadeguato o fase precoce di malattia. Necessaria rivalutazione istologica con campionamento esteso.';
            }
            
            return result;
        };

        // ==================== PATTERN CONTRADITTORI v3.0.1 ====================
        
        const detectContradictoryPatterns = () => {
            const notes = [];
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');
            const hasUCPattern = specimens.some(s => 
                s.findings.plasmacellule_basale === 'presente' || 
                s.findings.distorsione_architettura === 'presente'
            );
            const topoPattern = analyzeTopographicPattern();
            const scoring = calculateScoring();
            
            if (hasGranulomas && hasUCPattern) {
                notes.push({
                    type: 'CONTRADDITTORIO',
                    title: 'Pattern contraddittorio: Granulomi + Cronicit√† RCU-like',
                    features: [
                        'Granulomi epitelioidi presenti (feature Crohn)',
                        'Alterazioni croniche RCU-like (plasmacellule basali, distorsione architetturale)'
                    ],
                    interpretation: 'Scoring calcolato a fini DESCRITTIVI; affidabilit√† LIMITATA per presenza di features contraddittorie.',
                    suggestion: 'Pattern suggerisce IBDU con overlap features. Rivalutazione con follow-up clinico-istologico prolungato NECESSARIA.'
                });
            }
            
            if (!hasGranulomas && scoring.scores.crohn > 60) {
                const hasTransmuralEquivalent = specimens.some(s => 
                    s.findings.fibrosi_sottomucosa === 'marcata'
                );
                
                if (!hasTransmuralEquivalent) {
                    notes.push({
                        type: 'LIMITAZIONE',
                        title: 'Crohn senza features pathognomoniche',
                        features: [
                            'Score Crohn >60% ma ASSENZA granulomi',
                            'ASSENZA pattern transmurale (biopsia mucosa)'
                        ],
                        interpretation: 'Diagnosi basata su criteri ASPECIFICI (pattern infiammatorio, topografia).',
                        suggestion: 'Conferma con imaging (spessore parete, fistole, stenosi) e distribuzione endoscopica ESSENZIALE. Considerare Crohn colico vs IBDU.'
                    });
                }
            }
            
            if (Math.abs(scoring.scores.crohn - scoring.scores.uc) < 15) {
                notes.push({
                    type: 'INCERTEZZA',
                    title: 'Score Crohn/UC sovrapponibili',
                    features: [
                        `Crohn ${scoring.scores.crohn}% vs RCU ${scoring.scores.uc}%`,
                        'Differenza <15% (non significativa)'
                    ],
                    interpretation: 'Istologia INSUFFICIENTE per diagnosi definitiva.',
                    suggestion: 'Pattern indeterminato. Diagnosi richiede integrazione con: distribuzione endoscopica, imaging (entero-RM/TC), risposta terapeutica, evoluzione clinica.'
                });
            }
            
            return notes;
        };

        // ==================== VALIDAZIONE CLINICA ====================
        const validateClinicalLogic = () => {
            const warnings = [];

            specimens.forEach((specimen, index) => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';

                // v3.0.2 FIX #3: Warning granulomi
                if (f.granulomi_epitelioidi === 'presente') {
                    if (specimen.mucinGranulomaLikely) {
                        warnings.push({
                            type: 'GRANULOMA_CAUTION',
                            site: specimen.site,
                            message: `üîç ${specimen.site.toUpperCase()}: Granulomi marcati come "possibile rottura criptale"`,
                            severity: 'medium',
                            suggestion: 'Escludere mucin granuloma prima di diagnosi Crohn definitiva. Se persistono dubbi, considerare colorazioni PAS-D, follow-up istologico.'
                        });
                    } else if (siteType === 'ileum') {
                        if (f.atrofia_villi === 'assente' && f.plasmacellule_aumentate === 'assente') {
                            warnings.push({
                                type: 'DIAGNOSTIC_ALERT',
                                site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()} (ILEO): Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Considerare: tubercolosi, Yersinia, sarcoidosi, Crohn precoce. Se sospetto infettivo, considerare colorazioni Ziehl-Neelsen, PCR Mycobacterium.'
                            });
                        }
                    } else {
                        if (f.distorsione_architettura === 'assente' && f.plasmacellule_basale === 'assente') {
                            warnings.push({
                                type: 'DIAGNOSTIC_ALERT',
                                site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()}: Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Considerare: tubercolosi, sarcoidosi, Crohn precoce, iatrogeni (farmaci). DD infettiva richiede colorazioni specifiche.'
                            });
                        }
                    }
                } else if (f.granulomi_epitelioidi === 'sospetti') {
                    warnings.push({
                        type: 'GRANULOMA_UNCERTAIN',
                        site: specimen.site,
                        message: `üîç ${specimen.site.toUpperCase()}: Granulomi "sospetti" (non definitivi)`,
                        severity: 'medium',
                        suggestion: 'Considerare DD: aggregati linfoidi, mucin granuloma, artefatto. Se persistono sospetti Crohn, necessario follow-up istologico con campionamento esteso.'
                    });
                }
            });

            const topoPattern = analyzeTopographicPattern();
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');
            const hasChronicChanges = specimens.some(s => 
                s.findings.distorsione_architettura === 'presente' || 
                s.findings.plasmacellule_basale === 'presente'
            );
            const rectumSpared = topoPattern.rectumSampled && !topoPattern.rectumInvolved;
            const hasColonFindings = specimens.filter(hasInflammatoryFindings).some(s => s.siteType !== 'ileum');
            
            if (!hasGranulomas && hasChronicChanges && rectumSpared && hasColonFindings && !ibdNota.therapyOngoing) {
                warnings.push({
                    type: 'DIAGNOSTIC_CAUTION',
                    message: 'üîç Pattern cronico SENZA granulomi + retto risparmiato',
                    severity: 'medium',
                    suggestion: 'UC possibile ma non esclusiva. Retto risparmiato atipico per RCU classica. Considerare: Crohn colico, IBDU, RCU trattata/lunga durata. Correlare con distribuzione endoscopica e clinica.'
                });
            }

            return warnings;
        };

        // ==================== v3.0.2 FIX #7: DISPLASIA SEPARATA ====================
        
        const generateDysplasiaReport = () => {
            const colonSpecs = specimens.filter(s => s.siteType !== 'ileum');
            const displasiaFindings = colonSpecs
                .filter(s => s.findings.displasia && s.findings.displasia !== 'assente')
                .map(s => ({
                    site: s.site,
                    grade: s.findings.displasia,
                    p53Support: ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null'
                }));
            
            if (displasiaFindings.length === 0) return null;
            
            const maxGrade = displasiaFindings.some(d => d.grade === 'HGD') ? 'HGD' :
                             displasiaFindings.some(d => d.grade === 'LGD') ? 'LGD' : 'IND';
            
            let recommendation = '';
            if (maxGrade === 'HGD') {
                recommendation = 'HGD: Colectomia da considerare. Discussione multidisciplinare URGENTE.';
            } else if (maxGrade === 'LGD') {
                recommendation = 'LGD: Sorveglianza endoscopica stretta (3-6 mesi). Valutare resezione endoscopica se lesione visibile circoscritta.';
            } else {
                recommendation = 'IND: Rivalutazione con campionamento esteso. Considerare controllo con patologo esperto.';
            }
            
            return {
                present: true,
                maxGrade,
                findings: displasiaFindings,
                recommendation,
                p53Aberrant: displasiaFindings.some(d => d.p53Support)
            };
        };

        // ==================== DETECT ALTRE COLITI ====================
        const detectAltreColitiPattern = () => {
            const results = [];
            
            if (altreColiti.banda_collagene === 'ispessita' || altreColiti.banda_collagene === 'marcata') {
                results.push({
                    tipo: 'COLITE_COLLAGENA', emoji: 'üî¨', diagnosi: 'Colite collagenosica',
                    descrizione: `Banda collagene subepiteliale ${altreColiti.banda_collagene === 'marcata' ? 'marcatamente ispessita (>20Œºm)' : 'ispessita (‚â•10Œºm)'}. Pattern diagnostico per colite collagenosica.`,
                    confidence: altreColiti.banda_collagene === 'marcata' ? 'alta' : 'buona', color: 'purple'
                });
            }
            
            if (altreColiti.iel_aumentati === 'aumentati' || altreColiti.iel_aumentati === 'marcati') {
                results.push({
                    tipo: 'COLITE_LINFOCITICA', emoji: 'üî¨', diagnosi: 'Colite Linfocitica',
                    descrizione: `IEL ${altreColiti.iel_aumentati === 'marcati' ? 'marcatamente aumentati (>30/100)' : 'aumentati (‚â•20/100 cellule epiteliali)'}. Pattern diagnostico per colite linfocitica.`,
                    confidence: altreColiti.iel_aumentati === 'marcati' ? 'alta' : 'buona', color: 'purple'
                });
            }
            
            if (altreColiti.pattern_superficiale && altreColiti.architettura_conservata) {
                results.push({
                    tipo: 'COLITE_INFETTIVA', emoji: 'ü¶†', diagnosi: 'Pattern compatibile con colite infettiva',
                    descrizione: 'Infiammazione superficiale con architettura conservata. Correlare con coprocoltura.',
                    confidence: 'suggestivo', color: 'orange'
                });
            }
            
            const ischemicFeatures = [altreColiti.atrofia_ischemica, altreColiti.membrane_ialine, altreColiti.emorragia_recente].filter(Boolean).length;
            if (ischemicFeatures >= 2) {
                results.push({
                    tipo: 'COLITE_ISCHEMICA', emoji: 'üíî', diagnosi: 'Pattern compatibile con colite ischemica',
                    descrizione: `Presenti ${ischemicFeatures}/3 criteri ischemici.`,
                    confidence: ischemicFeatures === 3 ? 'alta' : 'suggestivo', color: 'red'
                });
            }
            
            if (altreColiti.ulcere_diaframma) {
                results.push({
                    tipo: 'COLITE_FANS', emoji: 'üíä', diagnosi: 'Enteropatia/Colite da FANS',
                    descrizione: 'Ulcere a diaframma presenti (patognomonico). Confermare anamnesi farmacologica.',
                    confidence: 'alta', color: 'blue'
                });
            } else if (altreColiti.apoptosi_cripte !== 'assente') {
                results.push({
                    tipo: 'COLITE_FANS_POSSIBILE', emoji: 'üíä', diagnosi: 'Possibile colite da FANS',
                    descrizione: `Apoptosi cripte ${altreColiti.apoptosi_cripte}. Considerare eziologia farmacologica.`,
                    confidence: 'suggestivo', color: 'blue'
                });
            }
            
            return results;
        };

        // ==================== GENERATE REPORT ====================
        const generateReport = () => {
            const scoring = calculateScoring();
            const interpretation = interpretScoringGraduated(scoring.scores);
            const contradictoryNotes = detectContradictoryPatterns();
            const nancy = calculateNancyIndex();
            const topoPattern = analyzeTopographicPattern();
            const validations = validateClinicalLogic();
            const sintesiEndoscopista = generateSintesiEndoscopista();
            const dysplasiaReport = generateDysplasiaReport(); // v3.0.2 FIX #7

            const suspiciousGranulomas = specimens.filter(s => 
                s.findings.granulomi_epitelioidi === 'sospetti'
            ).map(s => s.site);

            return {
                specimens,
                scoring,
                interpretation,
                contradictoryNotes,
                nancy,
                topoPattern,
                sintesiEndoscopista,
                ibdNota,
                diagnosiVeloce,
                dysplasiaReport, // v3.0.2 FIX #7
                altreColitiPatterns: detectAltreColitiPattern(),
                suspiciousGranulomas,
                validations,
                ihcData,
                altreColiti,
                metadata: {
                    version: APP_VERSION,
                    date: new Date().toISOString(),
                    hasGranulomas: specimens.some(s => s.findings.granulomi_epitelioidi === 'presente'),
                    hasNancy: shouldShowNancy()
                }
            };
        };

        // ==================== COMPONENTS ====================
        const TabNavigation = ({ active, onChange }) => {
            const tabs = [
                { id: 'campioni', label: 'üìã Campioni' },
                { id: 'ihc', label: 'üî¨ IHC' },
                { id: 'referto', label: 'üìÑ Referto' }
            ];

            return `
                <div class="flex gap-2 mb-6 border-b no-print">
                    ${tabs.map(tab => {
                        const isDisabled = caseLocked && (tab.id === 'campioni' || tab.id === 'ihc');
                        return `
                        <button
                            onclick="${isDisabled ? 'return false' : `switchTab('${tab.id}')`}"
                            class="px-6 py-3 font-semibold rounded-t-lg transition-colors ${
                                active === tab.id ? 'tab-active' : 
                                isDisabled ? 'tab-disabled' : 
                                'bg-gray-200 hover:bg-gray-300'
                            }"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${tab.label}
                            ${isDisabled ? ' üîí' : ''}
                        </button>
                    `}).join('')}
                </div>
            `;
        };

        // ==================== DIAGNOSI VELOCE PANEL ====================
        const DiagnosiVelocePanel = () => {
            if (caseLocked) return '';
            
            const ibdOptions = diagnosiVeloceOptions.filter(o => o.gruppo === 'ibd');
            const altreOptions = diagnosiVeloceOptions.filter(o => o.gruppo === 'altre');
            
            return `
                <div class="bg-green-50 rounded-lg p-4 mb-6 border-2 border-green-300">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-green-900 flex items-center gap-2">
                            <span>‚ö°</span> Diagnosi Veloce
                        </h3>
                        ${diagnosiVeloce.selected ? `
                            <button 
                                onclick="clearDiagnosiVeloce()"
                                class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200"
                            >
                                ‚úï Rimuovi
                            </button>
                        ` : ''}
                    </div>
                    <p class="text-xs text-green-800 mb-3">
                        Hai gi√† visto i vetrini? Seleziona direttamente la diagnosi:
                    </p>
                    
                    <div class="mb-3">
                        <p class="text-xs font-semibold text-green-700 mb-2">IBD:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${ibdOptions.map(opt => `
                                <button 
                                    onclick="selectDiagnosiVeloce('${opt.codice}')"
                                    class="p-2 rounded text-sm font-medium transition-all ${
                                        diagnosiVeloce.selected === opt.codice 
                                            ? 'bg-green-600 text-white ring-2 ring-green-800' 
                                            : 'bg-white border border-green-300 hover:bg-green-100'
                                    }"
                                >
                                    <span class="text-lg">${opt.emoji}</span>
                                    <span class="block text-xs mt-1">${opt.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-xs font-semibold text-amber-700 mb-2">Altre Coliti:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${altreOptions.map(opt => `
                                <button 
                                    onclick="selectDiagnosiVeloce('${opt.codice}')"
                                    class="p-2 rounded text-sm font-medium transition-all ${
                                        diagnosiVeloce.selected === opt.codice 
                                            ? 'bg-amber-500 text-white ring-2 ring-amber-700' 
                                            : 'bg-white border border-amber-300 hover:bg-amber-100'
                                    }"
                                >
                                    <span class="text-lg">${opt.emoji}</span>
                                    <span class="block text-xs mt-1">${opt.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${diagnosiVeloce.selected ? `
                        <div class="mt-3 p-3 bg-white rounded border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 mb-1">Diagnosi selezionata:</p>
                            <p class="text-sm font-medium text-green-900">${diagnosiVeloceOptions.find(o => o.codice === diagnosiVeloce.selected)?.testo || ''}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        // ==================== IBD NOTA PANEL (v3.0.2 FIX #3: checkbox terapia) ====================
        const IbdNotaPanel = () => {
            if (caseLocked) return '';
            
            return `
                <div class="bg-indigo-50 rounded-lg p-4 mb-6 border-2 border-indigo-300">
                    <div class="flex items-center gap-3 mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                ${ibdNota.enabled ? 'checked' : ''}
                                onchange="toggleIbdNota(this.checked)"
                                class="w-5 h-5 accent-indigo-600"
                            >
                            <span class="font-bold text-indigo-900">IBD nota (Follow-up)</span>
                        </label>
                    </div>
                    
                    ${ibdNota.enabled ? `
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-indigo-800 mb-1">Diagnosi iniziale:</label>
                                    <select 
                                        onchange="updateIbdNota('diagnosiIniziale', this.value)"
                                        class="w-full p-2 border-2 border-indigo-300 rounded bg-white"
                                    >
                                        <option value="" ${!ibdNota.diagnosiIniziale ? 'selected' : ''}>-- Seleziona --</option>
                                        <option value="RCU" ${ibdNota.diagnosiIniziale === 'RCU' ? 'selected' : ''}>RCU</option>
                                        <option value="Crohn" ${ibdNota.diagnosiIniziale === 'Crohn' ? 'selected' : ''}>Crohn</option>
                                        <option value="IBDU" ${ibdNota.diagnosiIniziale === 'IBDU' ? 'selected' : ''}>IBDU</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-indigo-800 mb-1">Diagnosi attuale:</label>
                                    <select 
                                        onchange="updateIbdNota('diagnosiAttuale', this.value)"
                                        class="w-full p-2 border-2 border-indigo-300 rounded bg-white"
                                    >
                                        <option value="" ${!ibdNota.diagnosiAttuale ? 'selected' : ''}>-- Seleziona --</option>
                                        <option value="RCU" ${ibdNota.diagnosiAttuale === 'RCU' ? 'selected' : ''}>RCU</option>
                                        <option value="Crohn" ${ibdNota.diagnosiAttuale === 'Crohn' ? 'selected' : ''}>Crohn</option>
                                        <option value="IBDU" ${ibdNota.diagnosiAttuale === 'IBDU' ? 'selected' : ''}>IBDU</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- v3.0.2 FIX #3: Checkbox terapia in corso -->
                            <div class="p-3 bg-white rounded border border-indigo-200">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        ${ibdNota.therapyOngoing ? 'checked' : ''}
                                        onchange="updateIbdNota('therapyOngoing', this.checked)"
                                        class="w-4 h-4 accent-indigo-600"
                                    >
                                    <span class="text-sm font-semibold text-indigo-900">
                                        üíä Paziente in terapia immunosoppressiva/biologica
                                    </span>
                                </label>
                                <p class="text-xs text-indigo-700 mt-1 ml-6">
                                    Modula interpretazione pattern topografico (es: retto risparmiato in RCU trattata)
                                </p>
                            </div>
                            
                            ${ibdNota.diagnosiIniziale && ibdNota.diagnosiAttuale && ibdNota.diagnosiIniziale !== ibdNota.diagnosiAttuale ? `
                                <div class="p-2 bg-yellow-100 rounded text-sm text-yellow-800">
                                    ‚ÑπÔ∏è Riclassificazione: ${ibdNota.diagnosiIniziale} ‚Üí ${ibdNota.diagnosiAttuale}
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <p class="text-xs text-indigo-600">
                            Spunta se il paziente ha gi√† diagnosi di IBD (RCU, Crohn, IBDU). Altrimenti lascia vuoto per prima diagnosi.
                        </p>
                    `}
                </div>
            `;
        };

        const SpecimenForm = () => {
            if (caseLocked) return '';
            
            const sites = ['ileo', 'cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto', 'pouch', 'anastomosi'];

            const colonFindings = {
                granulomi_epitelioidi: ['assente', 'sospetti', 'presente'],
                neutrofili_epitelio: ['assente', 'lieve', 'moderata', 'marcata'],
                ascessi_criptici: ['assente', 'presente'],
                plasmacellule_basale: ['assente', 'presente'],
                distorsione_architettura: ['assente', 'presente'],
                metaplasia_paneth: ['assente', 'presente'],
                ulcerazione: ['assente', 'presente'],
                fibrosi_sottomucosa: ['assente', 'lieve', 'moderata', 'marcata'],
                displasia: ['assente', 'indefinita', 'LGD', 'HGD']
            };

            const ileumFindings = {
                granulomi_epitelioidi: ['assente', 'sospetti', 'presente'],
                neutrofili_lamina_propria: ['assente', 'lieve', 'moderata', 'marcata'],
                erosioni_ulcerazioni: ['assente', 'presente'],
                iperplasia_linfoide: ['assente', 'presente'],
                edema_lamina_propria: ['assente', 'presente'],
                atrofia_villi: ['assente', 'lieve', 'moderata', 'marcata'],
                plasmacellule_aumentate: ['assente', 'presente'],
                fibrosi_sottomucosa: ['assente', 'lieve', 'moderata', 'marcata']
            };

            const getLabel = (key) => {
                const labels = {
                    'granulomi_epitelioidi': 'Granulomi Epitelioidi',
                    'neutrofili_epitelio': 'Neutrofili Intraepiteliali',
                    'neutrofili_lamina_propria': 'Neutrofili Lamina Propria',
                    'erosioni_ulcerazioni': 'Erosioni/Ulcerazioni Aftose',
                    'iperplasia_linfoide': 'Iperplasia Linfoide',
                    'edema_lamina_propria': 'Edema Lamina Propria',
                    'atrofia_villi': 'Atrofia Villi',
                    'plasmacellule_aumentate': 'Plasmacellule Aumentate',
                    'ascessi_criptici': 'Ascessi Criptici',
                    'plasmacellule_basale': 'Plasmacellule Basale',
                    'distorsione_architettura': 'Distorsione Architettura',
                    'metaplasia_paneth': 'Metaplasia Paneth',
                    'ulcerazione': 'Ulcerazione',
                    'fibrosi_sottomucosa': 'Fibrosi Sottomucosa',
                    'displasia': '‚ö†Ô∏è Displasia'
                };
                return labels[key] || key.replace(/_/g, ' ');
            };

            const renderFindings = (site) => {
                const isIleum = site === 'ileo';
                const findings = isIleum ? ileumFindings : colonFindings;
                
                return Object.entries(findings).map(([key, values]) => {
                    const label = getLabel(key);
                    const isDisplasia = key === 'displasia';
                    const isGranulomi = key === 'granulomi_epitelioidi';
                    const options = values.map(v => 
                        '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>'
                    ).join('');
                    
                    return `
                        <div class="${isDisplasia ? 'col-span-2 bg-red-50 p-2 rounded border border-red-200' : ''}">
                            <label class="block text-sm font-semibold mb-2 ${isDisplasia ? 'text-red-700' : ''}">${label}:</label>
                            <select id="finding-${key}" class="w-full p-2 border rounded ${isDisplasia ? 'border-red-300' : ''}" ${isGranulomi ? 'onchange="toggleMucinCheckbox(this.value)"' : ''}>
                            ${options}
                            </select>
                        </div>
                        ${isGranulomi ? `
                            <div id="mucin-checkbox-container" class="col-span-2 hidden bg-yellow-50 p-3 border border-yellow-400 rounded">
                                <label class="flex items-center gap-2">
                                    <input 
                                        type="checkbox" 
                                        id="mucin-granuloma-checkbox"
                                        class="w-4 h-4"
                                    >
                                    <span class="text-sm font-semibold text-yellow-900">
                                        ‚ö†Ô∏è Rottura criptale/Mucin granuloma plausibile?
                                    </span>
                                </label>
                                <p class="text-xs text-yellow-800 mt-1">
                                    Spunta se granulomi potrebbero essere secondari a rottura criptale (riduce peso Crohn)
                                </p>
                            </div>
                        ` : ''}
                    `;
                }).join('');
            };

            return `
                <div class="bg-blue-50 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">Aggiungi Campione</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Sede:</label>
                        <select id="site-select" onchange="updateFormSite(this.value)" class="w-full p-2 border rounded">
                            ${sites.map(s => '<option value="' + s + '"' + (s === currentSite ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('')}
                        </select>
                        <p class="text-xs text-gray-600 mt-1">
                            ${currentSite === 'ileo' 
                                ? 'üî¨ Criteri ILEO: erosioni aftose, atrofia villi, iperplasia linfoide (no displasia)' 
                                : 'üî¨ Criteri COLON: cripte, distorsione architettura, displasia'
                            }
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        ${renderFindings(currentSite)}
                    </div>

                    <button 
                        onclick="addSpecimen()"
                        class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
                    >
                        + Aggiungi Campione
                    </button>
                </div>
            `;
        };

        const SpecimenList = () => {
            if (specimens.length === 0) {
                return `<div class="text-center py-8 text-gray-500"><p>Nessun campione inserito</p></div>`;
            }

            const getLabel = (key) => {
                const labels = {
                    'granulomi_epitelioidi': 'Granulomi',
                    'neutrofili_epitelio': 'Neutrofili (epitelio)',
                    'neutrofili_lamina_propria': 'Neutrofili (LP)',
                    'erosioni_ulcerazioni': 'Erosioni',
                    'iperplasia_linfoide': 'Iperplasia linf.',
                    'edema_lamina_propria': 'Edema LP',
                    'atrofia_villi': 'Atrofia villi',
                    'plasmacellule_aumentate': 'Plasmacellule',
                    'ascessi_criptici': 'Ascessi criptici',
                    'plasmacellule_basale': 'Plasmacellule basale',
                    'distorsione_architettura': 'Distorsione arch.',
                    'metaplasia_paneth': 'Metaplasia Paneth',
                    'ulcerazione': 'Ulcerazione',
                    'fibrosi_sottomucosa': 'Fibrosi',
                    'displasia': '‚ö†Ô∏è DISPLASIA'
                };
                return labels[key] || key;
            };

            return `
                <div class="space-y-4">
                    ${specimens.map((spec, idx) => {
                        const nancy = spec.siteType !== 'ileum' ? calculateNancyPerSpecimen(spec) : null;
                        const isActive = isSpecimenActive(spec);
                        
                        return `
                        <div class="bg-white border-2 ${spec.findings.displasia && spec.findings.displasia !== 'assente' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-lg capitalize">${spec.site}</h4>
                                    <div class="flex gap-2 mt-1 flex-wrap">
                                        <span class="text-xs px-2 py-1 rounded ${spec.siteType === 'ileum' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                                            ${spec.siteType === 'ileum' ? 'üî¨ Ileo' : 'üî¨ Colon'}
                                        </span>
                                        ${nancy !== null ? `
                                            <span class="text-xs px-2 py-1 rounded ${nancy >= 2 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                                Nancy: ${nancy}
                                            </span>
                                        ` : ''}
                                        <span class="text-xs px-2 py-1 rounded ${isActive ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                            ${isActive ? 'üî• Attiva' : '‚úì Quiescente'}
                                        </span>
                                        ${spec.mucinGranulomaLikely ? `
                                            <span class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700">
                                                ‚ö†Ô∏è Mucin granuloma?
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                ${!caseLocked ? `
                                    <button 
                                        onclick="removeSpecimen(${idx})"
                                        class="text-red-600 hover:text-red-800 font-bold"
                                    >
                                        ‚úï Rimuovi
                                    </button>
                                ` : ''}
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                ${Object.entries(spec.findings)
                                    .filter(([k, v]) => v !== 'assente')
                                    .map(([k, v]) => `
                                        <div class="bg-gray-50 p-2 rounded ${k === 'displasia' ? 'bg-red-100 col-span-3' : ''}">
                                            <span class="font-semibold ${k === 'displasia' ? 'text-red-700' : ''}">${getLabel(k)}:</span>
                                            <span class="ml-1">${v}</span>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        };

        // ==================== IHC PANEL (v3.0.2 FIX #4 e #5) ====================
        const IHCPanel = () => {
            if (caseLocked) {
                return `
                    <div class="bg-gray-100 rounded-lg p-6 text-center">
                        <p class="text-gray-600">üîí Caso bloccato. IHC non modificabile.</p>
                    </div>
                `;
            }
            
            return `
                <div class="bg-purple-50 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Immunoistochimica</h3>
                    
                    <div class="space-y-4">
                        <!-- v3.0.2 FIX #4: CD68 rinominato -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">CD68 Pattern:</label>
                            <select onchange="updateIHC('cd68_pattern', this.value)" class="w-full p-2 border rounded">
                                <option value="non_eseguito" ${ihcData.cd68_pattern === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                                <option value="aggregati_profondi" ${ihcData.cd68_pattern === 'aggregati_profondi' ? 'selected' : ''}>Aggregati macrofagici profondi/sottomucosa (Crohn-like)</option>
                                <option value="diffuso_mucosa" ${ihcData.cd68_pattern === 'diffuso_mucosa' ? 'selected' : ''}>Diffuso mucosa (RCU-like)</option>
                            </select>
                            <p class="text-xs text-gray-600 mt-1">
                                ‚ÑπÔ∏è "Aggregati profondi": pattern macrofagico con estensione sottomucosa (se presente in biopsia)
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">p53 Pattern:</label>
                            <select onchange="updateIHC('p53_pattern', this.value)" class="w-full p-2 border rounded">
                                <option value="non_eseguito" ${ihcData.p53_pattern === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                                <option value="wild_type" ${ihcData.p53_pattern === 'wild_type' ? 'selected' : ''}>Wild-type (normale)</option>
                                <option value="overexpression" ${ihcData.p53_pattern === 'overexpression' ? 'selected' : ''}>Overexpression (mutazione missense)</option>
                                <option value="null" ${ihcData.p53_pattern === 'null' ? 'selected' : ''}>Null/Complete loss (mutazione nonsense)</option>
                            </select>
                            ${ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null' ? `
                                <p class="text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è Pattern aberrante = ALTO RISCHIO DISPLASIA</p>
                            ` : ''}
                        </div>

                        <!-- v3.0.2 FIX #5: CMV linguaggio qualitativo -->
                        <div class="border-t pt-4">
                            <label class="block text-sm font-semibold mb-2">ü¶† CMV:</label>
                            <select onchange="updateIHC('cmv_status', this.value)" class="w-full p-2 border rounded">
                                <option value="non_eseguito" ${ihcData.cmv_status === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                                <option value="negativo" ${ihcData.cmv_status === 'negativo' ? 'selected' : ''}>Negativo</option>
                                <option value="dubbio" ${ihcData.cmv_status === 'dubbio' ? 'selected' : ''}>Dubbio</option>
                                <option value="positivo" ${ihcData.cmv_status === 'positivo' ? 'selected' : ''}>Positivo</option>
                            </select>
                            ${ihcData.cmv_status === 'positivo' ? `
                                <div class="mt-2 p-3 bg-red-100 border border-red-400 rounded">
                                    <p class="text-sm text-red-800 font-semibold">‚ö†Ô∏è CMV POSITIVO</p>
                                    <p class="text-xs text-red-700 mt-1">
                                        Compatibile con colite da CMV sovrapposta. 
                                        Correlare con carica virale, inclusioni citomegaliche e contesto clinico. 
                                        Considerare valutazione infettivologica.
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        // ==================== SINTESI ENDOSCOPISTA ====================
        const SintesiEndoscopistaBox = ({ sintesi }) => {
            if (!sintesi || !sintesi.isFollowUp || !sintesi.diagnosiAttuale) return '';
            
            const diagnosiLabel = {
                'RCU': 'COLITE ULCEROSA',
                'Crohn': 'MALATTIA DI CROHN',
                'IBDU': 'IBD UNCLASSIFIED'
            };
            
            const formatSedi = (sedi) => sedi.length > 0 ? sedi.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ') : '‚Äî';
            
            const sintesiText = `${diagnosiLabel[sintesi.diagnosiAttuale]} - FOLLOW-UP

Quiescenza: ${formatSedi(sintesi.sediQuiescenti)}
Attivit√†: ${formatSedi(sintesi.sediAttive)}
${sintesi.nancyMax !== null ? `NANCY MAX: ${sintesi.nancyMax}` : ''}
${sintesi.hasDisplasia ? `‚ö†Ô∏è DISPLASIA: ${sintesi.maxDisplasia} (${sintesi.displasiaDetails.map(d => d.site).join(', ')})${sintesi.p53Aberrante ? ' - p53 aberrante' : ''}` : ''}`.trim();
            
            return `
                <div class="sintesi-box rounded-lg p-5 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-lg text-green-900 flex items-center gap-2">
                            <span>üìã</span> SINTESI PER ENDOSCOPISTA
                        </h3>
                        <button 
                            onclick="copySintesi()"
                            class="copy-btn bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-all"
                        >
                            üìã Copia
                        </button>
                    </div>
                    
                    <div class="bg-white rounded p-4 font-mono text-sm space-y-2">
                        <p class="font-bold text-lg">${diagnosiLabel[sintesi.diagnosiAttuale]} - FOLLOW-UP</p>
                        ${sintesi.diagnosiIniziale !== sintesi.diagnosiAttuale ? `
                            <p class="text-xs text-gray-500">(diagnosi iniziale: ${sintesi.diagnosiIniziale})</p>
                        ` : ''}
                        <div class="border-t pt-2 mt-2">
                            <p><span class="text-green-700">Quiescenza:</span> ${formatSedi(sintesi.sediQuiescenti)}</p>
                            <p><span class="text-red-700">Attivit√†:</span> ${formatSedi(sintesi.sediAttive)}</p>
                        </div>
                        ${sintesi.nancyMax !== null ? `
                            <p class="text-xl font-bold mt-2">NANCY MAX: ${sintesi.nancyMax}</p>
                        ` : ''}
                        ${sintesi.hasDisplasia ? `
                            <div class="mt-2 p-2 bg-red-100 rounded border border-red-300">
                                <p class="text-red-800 font-bold">‚ö†Ô∏è DISPLASIA: ${sintesi.maxDisplasia}</p>
                                <p class="text-sm text-red-700">Sede: ${sintesi.displasiaDetails.map(d => `${d.site} (${d.grado})`).join(', ')}</p>
                                ${sintesi.p53Aberrante ? `<p class="text-sm text-red-700">p53: aberrante (supporta)</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <p class="text-xs text-green-700 mt-2">
                        Questa sintesi √® pensata per copia-incolla nel referto endoscopico.
                    </p>
                </div>
                
                <textarea id="sintesi-clipboard" class="hidden">${sintesiText}</textarea>
            `;
        };

        // ==================== REPORT TAB (v3.0.2 FIX #6 e #7) ====================
        const ReportTab = () => {
            if (specimens.length === 0) {
                return `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-xl mb-2">Nessun dato disponibile</p>
                        <p>Aggiungi almeno un campione per generare il referto</p>
                    </div>
                `;
            }

            // v3.0.2 FIX #6: NO lock qui (gestito in switchTab)
            const report = generateReport();

            return `
                <div class="space-y-6">
                    <!-- SINTESI ENDOSCOPISTA -->
                    ${SintesiEndoscopistaBox({ sintesi: report.sintesiEndoscopista })}

                    <!-- v3.0.2 FIX #5: CMV Warning -->
                    ${report.ihcData.cmv_status === 'positivo' ? `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-4">
                            <h4 class="font-bold text-red-900 mb-2">ü¶† CMV POSITIVO</h4>
                            <p class="text-sm text-red-800">
                                Compatibile con colite da CMV sovrapposta. 
                                Correlare con carica virale, inclusioni citomegaliche e contesto clinico. 
                                Considerare valutazione infettivologica.
                            </p>
                        </div>
                    ` : ''}

                    <!-- v3.0.2 FIX #7: Displasia Report Separato -->
                    ${report.dysplasiaReport ? `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-4">
                            <h4 class="font-bold text-red-900 mb-2">‚ö†Ô∏è DISPLASIA RILEVATA</h4>
                            <div class="space-y-2">
                                <p class="text-sm text-red-800 font-semibold">Grado massimo: ${report.dysplasiaReport.maxGrade}</p>
                                ${report.dysplasiaReport.findings.map(d => `
                                    <p class="text-sm text-red-800">‚Ä¢ ${d.site.toUpperCase()}: ${d.grade}</p>
                                `).join('')}
                                ${report.dysplasiaReport.p53Aberrant ? `
                                    <p class="text-sm text-red-800 mt-2 font-semibold">
                                        p53 aberrante (${report.ihcData.p53_pattern}): supporta displasia
                                    </p>
                                ` : ''}
                                <div class="mt-3 p-3 bg-white rounded border-l-4 border-red-600">
                                    <p class="text-sm font-semibold text-red-900">Raccomandazione:</p>
                                    <p class="text-sm text-red-800">${report.dysplasiaReport.recommendation}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- v3.0.1 - NOTE EPISTEMOLOGICHE -->
                    ${report.contradictoryNotes.length > 0 ? `
                        <div class="no-print">
                            <h4 class="font-bold text-amber-900 mb-3">‚ö†Ô∏è Note Metodologiche (Solo per patologo)</h4>
                            ${report.contradictoryNotes.map(note => `
                                <div class="epistemic-note p-4 rounded-lg mb-3">
                                    <p class="font-bold text-amber-900 mb-2">${note.title}</p>
                                    <ul class="list-disc ml-5 space-y-1 text-sm text-amber-800">
                                        ${note.features.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                    <p class="text-sm text-amber-900 mt-2"><strong>Interpretazione:</strong> ${note.interpretation}</p>
                                    <p class="text-sm text-amber-900 mt-1"><strong>Raccomandazione:</strong> ${note.suggestion}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Validazioni Cliniche (v3.0.2 FIX #3: warnings granulomi) -->
                    ${report.validations.length > 0 ? `
                        <div class="bg-orange-50 border-2 border-orange-400 rounded-lg p-4 mb-4">
                            <h4 class="font-bold text-orange-900 mb-2">üîç Note Cliniche</h4>
                            ${report.validations.map(w => `
                                <div class="mb-2 p-2 bg-white rounded">
                                    <p class="font-semibold text-sm">${w.message}</p>
                                    <p class="text-xs text-gray-600">${w.suggestion}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Nancy Index -->
                    ${!report.ibdNota.enabled && report.nancy.applicable ? `
                        <div class="bg-indigo-50 border-2 border-indigo-400 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-2">Nancy Histological Index</h4>
                            <div class="flex items-center gap-4">
                                <span class="text-3xl font-bold text-indigo-700">${report.nancy.score}/4</span>
                                <div>
                                    <p class="font-semibold">${report.nancy.interpretation.label}</p>
                                    <p class="text-xs text-gray-600">${report.nancy.interpretation.description}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- v3.0.1 - INTERPRETAZIONE GRADUATA -->
                    ${!report.ibdNota.enabled ? `
                        <div class="bg-white border-2 border-blue-400 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold mb-3">üìä Interpretazione Diagnostica (Graduata)</h4>
                            <div class="p-4 bg-blue-50 rounded-lg mb-3">
                                <p class="font-bold text-xl text-blue-900 mb-2">${report.interpretation.headline}</p>
                                <p class="text-sm text-blue-800">${report.interpretation.description}</p>
                            </div>
                            
                            ${report.interpretation.epistemicNote ? `
                                <div class="epistemic-note p-3 rounded no-print">
                                    <p class="text-xs font-semibold text-amber-900 mb-1">üìå Nota Epistemologica:</p>
                                    <p class="text-xs text-amber-800">${report.interpretation.epistemicNote}</p>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span>Crohn</span>
                                    <span class="font-bold">${report.scoring.scores.crohn}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${report.scoring.scores.crohn}%"></div>
                                </div>
                                
                                <div class="flex justify-between items-center text-sm">
                                    <span>UC</span>
                                    <span class="font-bold">${report.scoring.scores.uc}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-purple-600 h-2 rounded-full" style="width: ${report.scoring.scores.uc}%"></div>
                                </div>
                                
                                <div class="flex justify-between items-center text-sm">
                                    <span>IBDU</span>
                                    <span class="font-bold">${report.scoring.scores.ibdu}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-amber-600 h-2 rounded-full" style="width: ${report.scoring.scores.ibdu}%"></div>
                                </div>
                            </div>
                            
                            <p class="text-xs text-gray-500 mt-3 italic">
                                ‚ö†Ô∏è Scoring orientativo, NON validato. Diagnosi finale richiede correlazione clinica.
                            </p>
                        </div>
                    ` : ''}

                    <!-- Referto Testuale -->
                    <div class="bg-white border-2 border-gray-400 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">REFERTO ISTOLOGICO</h3>
                        
                        ${report.ibdNota.enabled && report.ibdNota.diagnosiAttuale ? `
                            <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                                <p class="font-semibold text-base">
                                    Quadro istologico di IBD compatibile, alla luce della storia clinica, con 
                                    <strong>${report.ibdNota.diagnosiAttuale === 'RCU' ? 'rettocolite ulcerosa' : 
                                             report.ibdNota.diagnosiAttuale === 'Crohn' ? 'malattia di Crohn' : 'IBD non classificata'}</strong>.
                                </p>
                            </div>
                        ` : `
                            <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                                <p class="font-bold text-lg mb-1">${report.interpretation.headline}</p>
                                <p class="text-sm text-gray-700">${report.interpretation.description}</p>
                            </div>
                        `}

                        <!-- Tabella campioni -->
                        <div class="mb-4">
                            <h4 class="font-semibold mb-2">Dettaglio per sede:</h4>
                            <table class="w-full text-sm border-collapse">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="border p-2 text-left">Sede</th>
                                        <th class="border p-2 text-left">Stato</th>
                                        ${report.ibdNota.diagnosiAttuale === 'RCU' ? '<th class="border p-2 text-left">Nancy</th>' : ''}
                                        <th class="border p-2 text-left">Displasia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${specimens.map(s => {
                                        const nancy = s.siteType !== 'ileum' ? calculateNancyPerSpecimen(s) : null;
                                        const active = isSpecimenActive(s);
                                        return `
                                            <tr>
                                                <td class="border p-2 capitalize font-semibold">${s.site}</td>
                                                <td class="border p-2 ${active ? 'text-red-600' : 'text-green-600'}">${active ? 'Attiva' : 'Quiescente'}</td>
                                                ${report.ibdNota.diagnosiAttuale === 'RCU' ? `<td class="border p-2">${nancy !== null ? nancy : 'N/A'}</td>` : ''}
                                                <td class="border p-2 ${s.findings.displasia && s.findings.displasia !== 'assente' ? 'text-red-600 font-bold' : ''}">${s.findings.displasia || 'N/A'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Azioni -->
                    <div class="flex gap-4 no-print">
                        <button onclick="window.print()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">
                            üñ®Ô∏è Stampa/PDF
                        </button>
                        <button onclick="saveData()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
                            üíæ Salva
                        </button>
                    </div>
                </div>
            `;
        };

        // ==================== EVENT HANDLERS ====================
        
        // v3.0.2 FIX #6: Lock gestito qui, NON in ReportTab
        const switchTab = (tab) => {
            if (caseLocked && (tab === 'campioni' || tab === 'ihc')) return;
            
            activeTab = tab;
            
            // Lock PRIMA di render
            if (tab === 'referto' && specimens.length > 0 && !caseLocked) {
                lockCase();
            }
            
            render(); // singolo render
        };

        const addSpecimen = () => {
            if (caseLocked) return;
            
            const site = document.getElementById('site-select').value;
            const findings = {};
            const isIleum = (site === 'ileo');
            
            const findingKeys = isIleum ? [
                'granulomi_epitelioidi', 'neutrofili_lamina_propria', 
                'erosioni_ulcerazioni', 'iperplasia_linfoide',
                'edema_lamina_propria', 'atrofia_villi', 
                'plasmacellule_aumentate', 'fibrosi_sottomucosa'
            ] : [
                'granulomi_epitelioidi', 'neutrofili_epitelio', 'ascessi_criptici',
                'plasmacellule_basale', 'distorsione_architettura', 'metaplasia_paneth',
                'ulcerazione', 'fibrosi_sottomucosa', 'displasia'
            ];

            findingKeys.forEach(key => {
                const element = document.getElementById(`finding-${key}`);
                if (element) findings[key] = element.value;
            });

            // v3.0.2 FIX #3: Checkbox mucin granuloma
            const mucinCheckbox = document.getElementById('mucin-granuloma-checkbox');
            const mucinGranulomaLikely = mucinCheckbox && mucinCheckbox.checked;

            specimens.push({ 
                site, 
                findings, 
                siteType: isIleum ? 'ileum' : 'colon',
                mucinGranulomaLikely: mucinGranulomaLikely || false
            });
            
            saveData();
            render();
        };

        const removeSpecimen = (index) => {
            if (caseLocked) return;
            specimens.splice(index, 1);
            saveData();
            render();
        };

        const updateIHC = (field, value) => {
            if (caseLocked) return;
            ihcData[field] = value;
            saveData();
            render();
        };

        const copySintesi = () => {
            const textarea = document.getElementById('sintesi-clipboard');
            if (textarea) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert('Sintesi copiata negli appunti!');
                }).catch(() => {
                    textarea.classList.remove('hidden');
                    textarea.select();
                    document.execCommand('copy');
                    textarea.classList.add('hidden');
                    alert('Sintesi copiata!');
                });
            }
        };

        const clearData = () => {
            if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                unlockCase();
            }
        };

        const saveData = () => {
            try {
                const data = {
                    version: APP_VERSION,
                    specimens,
                    ihcData,
                    ibdNota,
                    altreColiti,
                    diagnosiVeloce,
                    caseLocked,
                    reportGenerated,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        };

        const loadData = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    specimens = data.specimens || [];
                    ihcData = data.ihcData || { cd68_pattern: 'non_eseguito', p53_pattern: 'non_eseguito', cmv_status: 'non_eseguito' };
                    if (!ihcData.cmv_status) ihcData.cmv_status = 'non_eseguito';
                    ibdNota = data.ibdNota || { enabled: false, diagnosiIniziale: null, diagnosiAttuale: null, therapyOngoing: false };
                    if (data.altreColiti) altreColiti = { ...altreColiti, ...data.altreColiti };
                    if (data.diagnosiVeloce) diagnosiVeloce = data.diagnosiVeloce;
                    
                    caseLocked = data.caseLocked || false;
                    reportGenerated = data.reportGenerated || false;
                    
                    if (caseLocked) {
                        document.getElementById('locked-banner').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        };

        // ==================== RENDER ====================
        const render = () => {
            const content = document.getElementById('main-content');
            
            let tabContent = '';
            if (activeTab === 'campioni') {
                if (caseLocked) {
                    tabContent = `
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-2xl mb-4">üîí</p>
                            <p class="text-xl mb-2">Caso Bloccato</p>
                            <p>Tab Campioni non accessibile dopo generazione referto.</p>
                            <p class="mt-4">Usa il pulsante "SBLOCCA NUOVO CASO" per iniziare un nuovo caso.</p>
                        </div>
                    `;
                } else {
                    tabContent = IbdNotaPanel() + DiagnosiVelocePanel() + SpecimenForm() + SpecimenList();
                }
            } else if (activeTab === 'ihc') {
                tabContent = IHCPanel();
            } else if (activeTab === 'referto') {
                tabContent = ReportTab();
            }

            content.innerHTML = TabNavigation({ active: activeTab, onChange: switchTab }) + tabContent;
        };

        // ==================== EXPORT GLOBALI ====================
        window.acceptDisclaimer = acceptDisclaimer;
        window.addSpecimen = addSpecimen;
        window.removeSpecimen = removeSpecimen;
        window.clearData = clearData;
        window.saveData = saveData;
        window.switchTab = switchTab;
        window.updateFormSite = updateFormSite;
        window.updateIHC = updateIHC;
        window.toggleIbdNota = toggleIbdNota;
        window.updateIbdNota = updateIbdNota;
        window.copySintesi = copySintesi;
        window.updateAltreColiti = updateAltreColiti;
        window.selectDiagnosiVeloce = selectDiagnosiVeloce;
        window.clearDiagnosiVeloce = clearDiagnosiVeloce;
        window.updateGradoManuale = updateGradoManuale;
        window.confirmReset = confirmReset;
        window.toggleMucinCheckbox = toggleMucinCheckbox;

        // ==================== INIT ====================
        loadData();
        checkDisclaimer();
        render();
    </script>

    <!-- Footer -->
    <div class="max-w-6xl mx-auto mt-8 text-xs text-gray-600 text-center p-4 bg-gray-100 rounded">
        <p class="font-semibold mb-2">IBD Diagnostic Tool v3.0.2 "Safety & Clinical Accuracy"</p>
        <p class="mb-1">
            <strong>v3.0.2:</strong> Fix critici - Topografia (displasia esclusa), Scoring IBDU indipendente, Granulomi differenziati, CMV linguaggio, Displasia separata
        </p>
        <p class="text-gray-500 text-xs mt-2">
            Release: Gennaio 2026 | Fix per giovani colleghi + safety clinica
        </p>
        <p class="text-gray-500 text-xs mt-2">
            Contatto: <a href="/cdn-cgi/l/email-protection#17717e7b7e67677839757e7679747f7e57766464633a7175713a6476747478397e63" class="text-blue-600 hover:underline"><span class="__cf_emai
