<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Diagnostic Tool v2.4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-after: always; }
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
            border-bottom: 3px solid #1d4ed8;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <!-- Modal Disclaimer Iniziale -->
    <div id="disclaimer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="bg-red-600 text-white p-6 rounded-t-xl">
                <h2 class="text-2xl font-bold flex items-center gap-3">
                    <span class="text-4xl">‚ö†Ô∏è</span>
                    <span>STRUMENTO DI SUPPORTO DIAGNOSTICO</span>
                </h2>
            </div>
            <div class="p-8 space-y-4">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                    <p class="font-bold text-lg mb-2 text-yellow-900">
                        ATTENZIONE: Questo tool NON sostituisce
                    </p>
                    <ul class="list-disc ml-6 space-y-1 text-yellow-800">
                        <li>Il ragionamento istopatologico del medico</li>
                        <li>L'integrazione con dati clinici ed endoscopici</li>
                        <li>L'esperienza diagnostica in IBD</li>
                        <li>Il giudizio professionale individuale</li>
                    </ul>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                    <p class="font-semibold text-blue-900 mb-2">
                        Lo scoring percentuale √®:
                    </p>
                    <ul class="list-disc ml-6 space-y-1 text-blue-800 text-sm">
                        <li><strong>PURAMENTE ORIENTATIVO</strong> e non diagnostico</li>
                        <li><strong>NON VALIDATO</strong> prospetticamente</li>
                        <li>Basato su criteri di letteratura ma <strong>non standardizzato</strong></li>
                        <li>Da interpretare SEMPRE nel contesto clinico completo</li>
                    </ul>
                </div>

                <div class="bg-green-50 border-l-4 border-green-500 p-4">
                    <p class="font-semibold text-green-900 mb-2">
                        Uso consigliato:
                    </p>
                    <p class="text-green-800 text-sm">
                        Patologi con esperienza in IBD, come supporto alla diagnosi differenziale 
                        in contesto di studio multidisciplinare integrato (istologia + clinica + 
                        endoscopia + sierologia).
                    </p>
                </div>

                <div class="bg-gray-100 p-4 rounded">
                    <p class="text-xs text-gray-700 italic">
                        Proseguendo, dichiari di aver compreso che questo √® uno strumento di supporto 
                        orientativo e che la diagnosi definitiva richiede valutazione professionale 
                        completa da parte di un medico patologo qualificato.
                    </p>
                </div>
            </div>
            <div class="p-6 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                <button 
                    onclick="acceptDisclaimer()"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                >
                    Ho capito, procedi ‚Üí
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <!-- Header -->
        <div class="mb-4 border-b pb-4">
            <h1 class="text-3xl font-bold text-blue-900 mb-2">
                IBD Diagnostic Tool
            </h1>
            <p class="text-sm text-gray-600">
                Versione 2.4.2 | Supporto diagnosi differenziale Inflammatory Bowel Disease
            </p>
            <p class="text-xs text-gray-500 mt-1">
                v2.4.2: Diagnosi suggerita automatica | v2.4.1: CMV | v2.4: Criteri ILEO dedicati, Nancy solo colon
            </p>
        </div>

        <!-- Banner Permanente Warning -->
        <div class="mb-6 bg-gradient-to-r from-yellow-400 to-orange-400 border-2 border-orange-500 rounded-lg p-4 no-print shadow-md">
            <div class="flex items-center gap-3">
                <span class="text-3xl">‚ö†Ô∏è</span>
                <div class="flex-1">
                    <p class="font-bold text-gray-900 text-sm">
                        TOOL DIAGNOSTICO: Uso riservato a patologi esperti in IBD
                    </p>
                    <p class="text-xs text-gray-800">
                        Scoring orientativo, NON sostitutivo del ragionamento clinico-patologico | 
                        Validazione prospettica assente
                    </p>
                </div>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="main-content"></div>
    </div>

    <script>
        // ==================== CONFIGURAZIONE ====================
        const APP_VERSION = '2.4.2';
        const STORAGE_KEY = 'ibdAppDataV242';
        const DISCLAIMER_KEY = 'ibdDisclaimerAccepted';

        // ==================== STATE ====================
        let specimens = [];
        let ihcData = {
            cd68_pattern: 'non_eseguito',
            p53_pattern: 'non_eseguito',
            cmv_status: 'non_eseguito'  // v2.4.1: CMV
        };
        let activeTab = 'campioni';
        let currentSite = 'ileo';

        // v2.4.0: Update form quando cambia sede
        const updateFormSite = (newSite) => {
            currentSite = newSite;
            render();
        };

        // ==================== DISCLAIMER MODAL ====================
        const checkDisclaimer = () => {
            const accepted = localStorage.getItem(DISCLAIMER_KEY);
            if (!accepted) {
                document.getElementById('disclaimer-modal').classList.remove('hidden');
            }
        };

        const acceptDisclaimer = () => {
            localStorage.setItem(DISCLAIMER_KEY, 'true');
            document.getElementById('disclaimer-modal').classList.add('hidden');
        };

        // ==================== HELPER FUNCTIONS ====================
        const shouldShowNancy = () => {
            const hasIleum = specimens.some(s => s.siteType === 'ileum');
            if (hasIleum) return false;

            const hasGranulomas = specimens.some(s => 
                s.findings.granulomi_epitelioidi === 'presente'
            );
            if (hasGranulomas) return false;

            const scoring = calculateScoring();
            const crohnScore = scoring.scores.crohn;
            return crohnScore <= 70;
        };

        const calculateNancyIndex = () => {
            if (!shouldShowNancy()) {
                return { score: null, interpretation: null, applicable: false };
            }

            let nancyScore = 0;
            let hasUlceration = false;
            let hasCryptAbscesses = false;
            let neutrophilSeverity = 'assente';

            const colonSpecimens = specimens.filter(s => s.siteType !== 'ileum');

            colonSpecimens.forEach(specimen => {
                if (specimen.findings.ulcerazione === 'presente') hasUlceration = true;
                if (specimen.findings.ascessi_criptici === 'presente') hasCryptAbscesses = true;
                
                const neutLevel = specimen.findings.neutrofili_epitelio;
                if (neutLevel === 'marcata' && neutrophilSeverity !== 'marcata') {
                    neutrophilSeverity = 'marcata';
                } else if (neutLevel === 'moderata' && neutrophilSeverity === 'assente') {
                    neutrophilSeverity = 'moderata';
                } else if (neutLevel === 'lieve' && neutrophilSeverity === 'assente') {
                    neutrophilSeverity = 'lieve';
                }
            });

            if (hasUlceration) {
                nancyScore = 4;
            } else if (neutrophilSeverity === 'marcata' || neutrophilSeverity === 'moderata' || hasCryptAbscesses) {
                nancyScore = 3;
            } else if (neutrophilSeverity === 'lieve') {
                nancyScore = 2;
            } else {
                const hasChronicChanges = colonSpecimens.some(s => 
                    s.findings.distorsione_architettura === 'presente' ||
                    s.findings.plasmacellule_basale === 'presente'
                );
                nancyScore = hasChronicChanges ? 1 : 0;
            }

            const getNancyInterpretation = (score) => {
                const interpretations = {
                    0: {
                        label: 'Remissione completa',
                        description: 'Assenza di attivit√† e alterazioni croniche',
                        prognosis: 'Eccellente. Basso rischio recidiva (15-20% a 1 anno)'
                    },
                    1: {
                        label: 'Remissione con alterazioni croniche',
                        description: 'Alterazioni architetturali senza attivit√† acuta',
                        prognosis: 'Buona. Rischio recidiva moderato (25-30% a 1 anno)'
                    },
                    2: {
                        label: 'Attivit√† lieve',
                        description: 'Infiltrato neutrofilo lieve senza ulcerazione',
                        prognosis: 'Rischio recidiva 40-50% a 1 anno. Monitoraggio clinico'
                    },
                    3: {
                        label: 'Attivit√† moderata',
                        description: 'Infiltrato neutrofilo moderato-severo o ascessi criptici',
                        prognosis: 'Rischio recidiva 60-70% a 1 anno. Escalation terapeutica'
                    },
                    4: {
                        label: 'Attivit√† severa con ulcerazione',
                        description: 'Ulcerazione mucosa presente',
                        prognosis: 'Rischio recidiva >80% a 1 anno. Terapia intensiva necessaria'
                    }
                };
                return interpretations[score] || interpretations[0];
            };

            return {
                score: nancyScore,
                interpretation: getNancyInterpretation(nancyScore),
                applicable: true,
                details: {
                    hasUlceration,
                    hasCryptAbscesses,
                    neutrophilSeverity
                }
            };
        };

        // ==================== PATTERN TOPOGRAFICO ====================
        const analyzeTopographicPattern = () => {
            const sites = specimens.map(s => s.site);
            const sitesWithFindings = specimens
                .filter(s => Object.values(s.findings).some(v => v !== 'assente'))
                .map(s => s.site);
            
            let pattern = {
                rectumSampled: sites.includes('retto'),
                rectumInvolved: sitesWithFindings.includes('retto'),
                ileumSampled: sites.includes('ileo'),
                ileumInvolved: sitesWithFindings.includes('ileo'),
                skipLesions: false,
                continuity: 'sconosciuta',
                warning: null
            };
            
            const detectSkipLesions = () => {
                const colonOrder = ['cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];
                const findingsIndices = sitesWithFindings
                    .filter(s => colonOrder.includes(s))
                    .map(s => colonOrder.indexOf(s))
                    .sort((a, b) => a - b);
                
                for (let i = 1; i < findingsIndices.length; i++) {
                    if (findingsIndices[i] - findingsIndices[i-1] > 1) {
                        return true;
                    }
                }
                return false;
            };
            
            pattern.skipLesions = detectSkipLesions();
            pattern.continuity = pattern.skipLesions ? 'discontinua' : 'continua';
            
            if (pattern.rectumSampled && pattern.rectumInvolved && !pattern.skipLesions && !pattern.ileumInvolved) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico UC-like: Retto coinvolto, distribuzione continua, ileo non coinvolto";
            } else if (pattern.skipLesions || (pattern.ileumInvolved && !pattern.rectumInvolved)) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico Crohn-like: Distribuzione discontinua e/o ileo coinvolto con retto risparmiato";
            } else if (!pattern.rectumSampled) {
                pattern.warning = "‚ÑπÔ∏è Retto non campionato: Valutazione pattern topografico limitata";
            } else if (pattern.rectumSampled && !pattern.rectumInvolved && sitesWithFindings.length > 0) {
                pattern.warning = "‚ö†Ô∏è Retto risparmiato: Atipico per UC classica (possibile in UC pediatrica, UC trattata/di lunga data, o post-terapia topica)";
            }
            
            return pattern;
        };

        // ==================== INTERPRETAZIONE QUALITATIVA ====================
        const interpretScoring = (scores) => {
            const { crohn, uc, ibdu } = scores;
            
            let interpretation = {
                primary: null,
                confidence: null
            };
            
            const max = Math.max(crohn, uc, ibdu);
            
            if (max === crohn) {
                interpretation.primary = 'Crohn Disease';
                if (crohn > 80) interpretation.confidence = 'Alta probabilit√†';
                else if (crohn > 60) interpretation.confidence = 'Probabile';
                else interpretation.confidence = 'Pattern suggestivo';
            } else if (max === uc) {
                interpretation.primary = 'Ulcerative Colitis';
                if (uc > 80) interpretation.confidence = 'Alta probabilit√†';
                else if (uc > 60) interpretation.confidence = 'Probabile';
                else interpretation.confidence = 'Pattern suggestivo';
            } else {
                interpretation.primary = 'IBD Unclassified';
                interpretation.confidence = 'Pattern indeterminato';
            }
            
            return interpretation;
        };

        // ==================== SCORING ====================
        const calculateScoring = () => {
            let scores = { crohn: 0, uc: 0, ibdu: 0 };

            specimens.forEach(specimen => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';

                // ==================== SCORING ILEO ====================
                if (siteType === 'ileum') {
                    if (f.granulomi_epitelioidi === 'presente') {
                        scores.crohn += 150;
                    }

                    if (f.erosioni_ulcerazioni === 'presente') {
                        scores.crohn += 50;
                    }

                    if (f.iperplasia_linfoide === 'presente') {
                        scores.crohn += 40;
                    }

                    if (f.atrofia_villi === 'marcata') {
                        scores.crohn += 30;
                    } else if (f.atrofia_villi === 'moderata') {
                        scores.crohn += 15;
                    } else if (f.atrofia_villi === 'lieve') {
                        scores.crohn += 5;
                    }

                    if (f.neutrofili_lamina_propria === 'marcata') {
                        scores.crohn += 20;
                        scores.uc += 10;
                    } else if (f.neutrofili_lamina_propria === 'moderata') {
                        scores.crohn += 10;
                        scores.uc += 5;
                    } else if (f.neutrofili_lamina_propria === 'lieve') {
                        scores.crohn += 5;
                    }

                    if (f.edema_lamina_propria === 'presente') {
                        scores.crohn += 15;
                    }

                    if (f.plasmacellule_aumentate === 'presente') {
                        scores.crohn += 15;
                    }

                    if (f.fibrosi_sottomucosa === 'marcata') {
                        scores.crohn += 25;
                    } else if (f.fibrosi_sottomucosa === 'moderata') {
                        scores.crohn += 15;
                    } else if (f.fibrosi_sottomucosa === 'lieve') {
                        scores.crohn += 5;
                    }

                } else {
                    // ==================== SCORING COLON ====================
                    if (f.granulomi_epitelioidi === 'presente') {
                        scores.crohn += 100;
                    }

                    if (f.neutrofili_epitelio === 'marcata') {
                        scores.uc += 40;
                        scores.crohn += 20;
                    } else if (f.neutrofili_epitelio === 'moderata') {
                        scores.uc += 25;
                        scores.crohn += 15;
                    } else if (f.neutrofili_epitelio === 'lieve') {
                        scores.uc += 15;
                        scores.crohn += 10;
                    }

                    if (f.ascessi_criptici === 'presente') {
                        scores.uc += 30;
                        scores.crohn += 15;
                    }

                    if (f.plasmacellule_basale === 'presente') {
                        scores.uc += 25;
                        scores.crohn += 10;
                    }

                    if (f.distorsione_architettura === 'presente') {
                        scores.uc += 20;
                        scores.crohn += 15;
                    }

                    if (f.metaplasia_paneth === 'presente') {
                        scores.uc += 15;
                    }

                    if (f.ulcerazione === 'presente') {
                        scores.crohn += 15;
                        scores.uc += 10;
                    }

                    if (f.fibrosi_sottomucosa === 'marcata') {
                        scores.crohn += 25;
                        scores.uc += 10;
                    } else if (f.fibrosi_sottomucosa === 'moderata') {
                        scores.crohn += 15;
                        scores.uc += 5;
                    }
                }
            });

            // IHC - CD68
            if (ihcData.cd68_pattern === 'cluster_transmurale') {
                scores.crohn += 35;
            } else if (ihcData.cd68_pattern === 'diffuso_mucosa') {
                scores.uc += 20;
                scores.crohn += 10;
            }

            // p53 SEPARATO da scoring IBD
            const dysplasiaRisk = 
                ihcData.p53_pattern === 'overexpression' || 
                ihcData.p53_pattern === 'null';

            // CMV NON influenza scoring IBD (√® complicazione sovrapposta)

            // IBDU scoring
            if (scores.crohn < 30 && scores.uc < 30) {
                scores.ibdu = 100;
            } else {
                scores.ibdu = Math.max(0, 100 - scores.crohn - scores.uc);
            }

            // Normalizzazione
            const total = scores.crohn + scores.uc + scores.ibdu;
            if (total > 0) {
                scores.crohn = Math.round((scores.crohn / total) * 100);
                scores.uc = Math.round((scores.uc / total) * 100);
                scores.ibdu = Math.round((scores.ibdu / total) * 100);
            }

            return { 
                scores, 
                dysplasiaRisk
            };
        };

        // ==================== VALIDAZIONE CLINICA ====================
        const validateClinicalLogic = () => {
            const warnings = [];

            specimens.forEach((specimen, index) => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';

                if (f.granulomi_epitelioidi === 'presente') {
                    if (siteType === 'ileum') {
                        if (f.atrofia_villi === 'assente' && f.plasmacellule_aumentate === 'assente') {
                            warnings.push({
                                type: 'DIAGNOSTIC_ALERT',
                                site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()} (ILEO): Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Nota clinica: Pattern insolito per Crohn ileale. Considerare diagnosi alternative (tubercolosi, Yersinia enterocolitica, sarcoidosi, Crohn in fase precoce acuta)'
                            });
                        }
                    } else {
                        if (f.distorsione_architettura === 'assente' && f.plasmacellule_basale === 'assente') {
                            warnings.push({
                                type: 'DIAGNOSTIC_ALERT',
                                site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()}: Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Nota clinica: Pattern insolito per IBD. Considerare diagnosi alternative (tubercolosi, sarcoidosi, infezioni granulomatose, Crohn in fase precoce)'
                            });
                        }
                    }
                }
            });

            const dysplasiaRisk = 
                ihcData.p53_pattern === 'overexpression' || 
                ihcData.p53_pattern === 'null';
            
            if (dysplasiaRisk && specimens.length < 2) {
                warnings.push({
                    type: 'SAMPLING_NOTE',
                    message: 'üîç p53 aberrante rilevato su campionamento limitato',
                    severity: 'medium',
                    suggestion: 'Nota metodologica: p53 aberrante in singola biopsia. Considerare biopsie multiple per valutare estensione ed escludere focality della displasia'
                });
            }

            const nancy = calculateNancyIndex();
            if (nancy.applicable && nancy.score >= 3 && !nancy.details.hasUlceration) {
                warnings.push({
                    type: 'NANCY_NOTE',
                    message: 'üîç Nancy Index elevato (‚â•3) senza ulcerazione documentata',
                    severity: 'low',
                    suggestion: 'Nota interpretativa: Score Nancy alto guidato da neutrofili/ascessi. Possibile sottostima endoscopica ulcerazioni o ulcerazioni microscopiche non campionate'
                });
            }

            const topoPattern = analyzeTopographicPattern();
            if (topoPattern.rectumSampled && !topoPattern.rectumInvolved && 
                topoPattern.ileumInvolved) {
                warnings.push({
                    type: 'TOPOGRAPHIC_NOTE',
                    message: 'üîç Pattern topografico: Retto risparmiato con ileo terminale coinvolto',
                    severity: 'low',
                    suggestion: 'Nota diagnostica: Pattern suggestivo per Crohn Disease. Considerare anche: IBDU, UC con backwash ileitis (raro), UC trattata con remissione rettale'
                });
            }

            return warnings;
        };

        // ==================== PATTERN RECOGNITION v2.4.2 ====================
        const detectDiagnosticPattern = () => {
            if (specimens.length === 0) {
                return { pattern: null, diagnosis: null, description: null };
            }

            const colonOrder = ['cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];
            const leftColon = ['discendente', 'sigma', 'retto'];
            const rightColon = ['cieco', 'ascendente', 'trasverso'];

            // Helper: check if specimen has active inflammation
            const hasActiveInflammation = (spec) => {
                if (spec.siteType === 'ileum') {
                    return spec.findings.neutrofili_lamina_propria !== 'assente' ||
                           spec.findings.erosioni_ulcerazioni === 'presente';
                } else {
                    return spec.findings.neutrofili_epitelio !== 'assente' ||
                           spec.findings.ascessi_criptici === 'presente' ||
                           spec.findings.ulcerazione === 'presente';
                }
            };

            // Helper: check if specimen has chronic changes only (no activity)
            const hasChronicChangesOnly = (spec) => {
                if (spec.siteType === 'ileum') {
                    const hasActivity = spec.findings.neutrofili_lamina_propria !== 'assente' ||
                                        spec.findings.erosioni_ulcerazioni === 'presente';
                    const hasChronic = spec.findings.atrofia_villi !== 'assente' ||
                                       spec.findings.plasmacellule_aumentate === 'presente' ||
                                       spec.findings.fibrosi_sottomucosa !== 'assente';
                    return !hasActivity && hasChronic;
                } else {
                    const hasActivity = spec.findings.neutrofili_epitelio !== 'assente' ||
                                        spec.findings.ascessi_criptici === 'presente' ||
                                        spec.findings.ulcerazione === 'presente';
                    const hasChronic = spec.findings.distorsione_architettura === 'presente' ||
                                       spec.findings.plasmacellule_basale === 'presente' ||
                                       spec.findings.metaplasia_paneth === 'presente' ||
                                       spec.findings.fibrosi_sottomucosa !== 'assente';
                    return !hasActivity && hasChronic;
                }
            };

            // Helper: check if specimen is completely normal
            const isNormal = (spec) => {
                return Object.values(spec.findings).every(v => v === 'assente');
            };

            // Helper: has granulomas
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');

            // Separate specimens by type
            const ileumSpecs = specimens.filter(s => s.siteType === 'ileum');
            const colonSpecs = specimens.filter(s => s.siteType !== 'ileum');
            
            const activeColonSpecs = colonSpecs.filter(hasActiveInflammation);
            const activeIleumSpecs = ileumSpecs.filter(hasActiveInflammation);
            
            const activeSites = activeColonSpecs.map(s => s.site);
            const chronicOnlySpecs = specimens.filter(hasChronicChangesOnly);
            const normalSpecs = specimens.filter(isNormal);

            // ========== PATTERN DETECTION ==========

            // 1. NORMALE - tutti i campioni normali
            if (normalSpecs.length === specimens.length) {
                const sites = specimens.map(s => s.site);
                const hasIleum = sites.includes('ileo');
                const hasColon = colonSpecs.length > 0;
                
                let mucosaType = 'colica';
                if (hasIleum && hasColon) mucosaType = 'ileo-colica';
                else if (hasIleum && !hasColon) mucosaType = 'ileale';
                
                return {
                    pattern: 'NORMALE',
                    emoji: 'üü¢',
                    diagnosis: 'Mucosa nella norma istologica',
                    description: `Mucosa ${mucosaType} nella norma istologica. Non evidenza di malattia infiammatoria intestinale in atto.`,
                    color: 'green'
                };
            }

            // 2. IBD IN REMISSIONE - solo alterazioni croniche, no attivit√†
            if (chronicOnlySpecs.length > 0 && 
                activeColonSpecs.length === 0 && 
                activeIleumSpecs.length === 0 &&
                !hasGranulomas) {
                
                const chronicSites = chronicOnlySpecs.map(s => s.site.charAt(0).toUpperCase() + s.site.slice(1)).join(', ');
                
                return {
                    pattern: 'IBD_REMISSIONE',
                    emoji: 'üü°',
                    diagnosis: 'IBD in fase di remissione istologica',
                    description: `Colite cronica in fase di remissione istologica. Persistono alterazioni architetturali residue (${chronicSites}). Assenza di attivit√† infiammatoria acuta.`,
                    color: 'yellow'
                };
            }

            // 3. ILEITE NAS - solo ileo coinvolto, colon normale
            if (activeIleumSpecs.length > 0 && 
                activeColonSpecs.length === 0 &&
                colonSpecs.every(s => isNormal(s) || hasChronicChangesOnly(s))) {
                
                const hasIleumGranulomas = ileumSpecs.some(s => s.findings.granulomi_epitelioidi === 'presente');
                
                if (hasIleumGranulomas) {
                    return {
                        pattern: 'ILEITE_CROHN',
                        emoji: 'üü†',
                        diagnosis: 'Ileite cronica granulomatosa',
                        description: `Ileite cronica attiva granulomatosa, pattern morfologico compatibile con Malattia di Crohn ileale. Mucosa colica esaminata indenne.`,
                        color: 'orange'
                    };
                } else {
                    return {
                        pattern: 'ILEITE_NAS',
                        emoji: 'üü†',
                        diagnosis: 'Ileite cronica attiva NAS',
                        description: `Ileite cronica attiva. Pattern aspecifico, da correlare con dati clinici ed endoscopici (DD: Crohn, infettiva, ischemica, farmacologica, FANS). Mucosa colica esaminata indenne.`,
                        color: 'orange'
                    };
                }
            }

            // Skip if granulomas (Crohn-like, don't suggest UC patterns)
            if (hasGranulomas) {
                const granulomasSites = specimens
                    .filter(s => s.findings.granulomi_epitelioidi === 'presente')
                    .map(s => s.site.charAt(0).toUpperCase() + s.site.slice(1))
                    .join(', ');
                
                return {
                    pattern: 'CROHN_LIKE',
                    emoji: 'üü£',
                    diagnosis: 'Pattern Crohn-like (granulomi)',
                    description: `Colite cronica attiva granulomatosa (${granulomasSites}). Pattern morfologico compatibile con Malattia di Crohn. Escludere: TBC, Yersinia, sarcoidosi.`,
                    color: 'purple'
                };
            }

            // 4. PROCTITE ULCEROSA - solo retto coinvolto
            if (activeSites.length === 1 && activeSites[0] === 'retto') {
                const otherColonNormal = colonSpecs
                    .filter(s => s.site !== 'retto')
                    .every(s => isNormal(s));
                const ileumOk = ileumSpecs.every(s => isNormal(s) || !hasActiveInflammation(s));
                
                if (otherColonNormal && ileumOk) {
                    return {
                        pattern: 'PROCTITE_UC',
                        emoji: 'üîµ',
                        diagnosis: 'Proctite ulcerosa',
                        description: `Proctite cronica attiva, pattern morfologico compatibile con Colite Ulcerosa limitata al retto (E1 Montreal). Restante mucosa colica esaminata indenne.`,
                        color: 'blue'
                    };
                }
            }

            // 5. COLITE SINISTRA UC - coinvolgimento da retto a flessura splenica
            const activeLeftSites = activeSites.filter(s => leftColon.includes(s));
            const activeRightSites = activeSites.filter(s => rightColon.includes(s));
            
            if (activeLeftSites.length > 0 && 
                activeRightSites.length === 0 &&
                activeSites.includes('retto')) {
                
                const ileumOk = ileumSpecs.every(s => isNormal(s) || !hasActiveInflammation(s));
                
                if (ileumOk) {
                    const extent = activeLeftSites.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ');
                    return {
                        pattern: 'COLITE_SINISTRA_UC',
                        emoji: 'üîµ',
                        diagnosis: 'Colite sinistra (UC)',
                        description: `Colite cronica attiva con distribuzione sinistra (${extent}), pattern morfologico compatibile con Colite Ulcerosa sinistra (E2 Montreal). Colon destro e ileo indenni.`,
                        color: 'blue'
                    };
                }
            }

            // 6. PANCOLITE UC - coinvolgimento esteso + retto + continuo + no ileo attivo
            const colonSitesSampled = colonSpecs.map(s => s.site);
            const hasRectum = colonSitesSampled.includes('retto');
            const hasLeftColon = colonSitesSampled.some(s => leftColon.includes(s));
            const hasRightColon = colonSitesSampled.some(s => rightColon.includes(s));
            
            if (activeColonSpecs.length >= 3 && 
                activeSites.includes('retto') &&
                hasLeftColon && hasRightColon) {
                
                // Check continuity
                const activeIndices = activeSites
                    .filter(s => colonOrder.includes(s))
                    .map(s => colonOrder.indexOf(s))
                    .sort((a, b) => a - b);
                
                let isContinuous = true;
                for (let i = 1; i < activeIndices.length; i++) {
                    if (activeIndices[i] - activeIndices[i-1] > 1) {
                        isContinuous = false;
                        break;
                    }
                }
                
                const ileumOk = ileumSpecs.every(s => isNormal(s));
                const ileumMild = ileumSpecs.some(s => hasActiveInflammation(s) && 
                    (s.findings.neutrofili_lamina_propria === 'lieve'));
                
                if (isContinuous && ileumOk) {
                    return {
                        pattern: 'PANCOLITE_UC',
                        emoji: 'üîµ',
                        diagnosis: 'Pancolite (UC)',
                        description: `Pancolite cronica attiva con distribuzione continua, pattern morfologico compatibile con Colite Ulcerosa estesa (E3 Montreal). Ileo terminale indenne.`,
                        color: 'blue'
                    };
                }
                
                // 7. BACKWASH ILEITIS
                if (isContinuous && ileumMild) {
                    return {
                        pattern: 'BACKWASH_ILEITIS',
                        emoji: 'üîµ',
                        diagnosis: 'Pancolite con backwash ileitis',
                        description: `Pancolite cronica attiva con distribuzione continua e lieve ileite associata (backwash ileitis). Pattern morfologico compatibile con Colite Ulcerosa estesa.`,
                        color: 'blue'
                    };
                }
            }

            // 8. DEFAULT - Colite cronica attiva aspecifica
            if (activeColonSpecs.length > 0) {
                const activeSitesStr = activeSites
                    .map(s => s.charAt(0).toUpperCase() + s.slice(1))
                    .join(', ');
                
                return {
                    pattern: 'COLITE_ATTIVA_NAS',
                    emoji: '‚ö™',
                    diagnosis: 'Colite cronica attiva',
                    description: `Colite cronica attiva (${activeSitesStr}). Pattern non dirimente per classificazione UC vs Crohn. Correlare con dati clinici, endoscopici e sierologici.`,
                    color: 'gray'
                };
            }

            return { pattern: null, diagnosis: null, description: null };
        };

        // ==================== GENERATE REPORT ====================
        const generateReport = () => {
            const scoring = calculateScoring();
            const nancy = calculateNancyIndex();
            const topoPattern = analyzeTopographicPattern();
            const validations = validateClinicalLogic();
            const diagnosticPattern = detectDiagnosticPattern();  // v2.4.2

            const suspiciousGranulomas = specimens.filter(s => 
                s.findings.granulomi_epitelioidi === 'sospetti'
            ).map(s => s.site);

            const diagnoses = specimens.map(s => {
                const findings = [];
                if (s.findings.granulomi_epitelioidi === 'presente') findings.push('granulomi epitelioidi');
                if (s.findings.neutrofili_epitelio !== 'assente') findings.push('neutrofili intraepiteliali');
                if (s.findings.ascessi_criptici === 'presente') findings.push('ascessi criptici');
                if (s.findings.distorsione_architettura === 'presente') findings.push('distorsione architettura');
                if (s.findings.ulcerazione === 'presente') findings.push('ulcerazione');

                let diagnosis = 'Colite cronica';
                if (findings.length > 0) diagnosis += ' attiva';

                return {
                    site: s.site,
                    diagnosis,
                    findings
                };
            });

            return {
                specimens,
                diagnoses,
                scoring,
                nancy,
                topoPattern,
                diagnosticPattern,  // v2.4.2
                suspiciousGranulomas,
                validations,
                ihcData,
                metadata: {
                    version: APP_VERSION,
                    date: new Date().toISOString(),
                    hasGranulomas: specimens.some(s => s.findings.granulomi_epitelioidi === 'presente'),
                    hasNancy: shouldShowNancy()
                }
            };
        };

        // ==================== COMPONENTS ====================

        const TabNavigation = ({ active, onChange }) => {
            const tabs = [
                { id: 'campioni', label: 'üìã Campioni' },
                { id: 'ihc', label: 'üî¨ IHC' },
                { id: 'referto', label: 'üìÑ Referto' }
            ];

            return `
                <div class="flex gap-2 mb-6 border-b no-print">
                    ${tabs.map(tab => `
                        <button
                            onclick="switchTab('${tab.id}')"
                            class="px-6 py-3 font-semibold rounded-t-lg transition-colors ${
                                active === tab.id ? 'tab-active' : 'bg-gray-200 hover:bg-gray-300'
                            }"
                        >
                            ${tab.label}
                        </button>
                    `).join('')}
                </div>
            `;
        };

        const SpecimenForm = () => {
            const sites = [
                'ileo', 'cieco', 'ascendente', 'trasverso', 
                'discendente', 'sigma', 'retto', 'pouch', 'anastomosi'
            ];

            const colonFindings = {
                granulomi_epitelioidi: ['assente', 'sospetti', 'presente'],
                neutrofili_epitelio: ['assente', 'lieve', 'moderata', 'marcata'],
                ascessi_criptici: ['assente', 'presente'],
                plasmacellule_basale: ['assente', 'presente'],
                distorsione_architettura: ['assente', 'presente'],
                metaplasia_paneth: ['assente', 'presente'],
                ulcerazione: ['assente', 'presente'],
                fibrosi_sottomucosa: ['assente', 'lieve', 'moderata', 'marcata']
            };

            const ileumFindings = {
                granulomi_epitelioidi: ['assente', 'sospetti', 'presente'],
                neutrofili_lamina_propria: ['assente', 'lieve', 'moderata', 'marcata'],
                erosioni_ulcerazioni: ['assente', 'presente'],
                iperplasia_linfoide: ['assente', 'presente'],
                edema_lamina_propria: ['assente', 'presente'],
                atrofia_villi: ['assente', 'lieve', 'moderata', 'marcata'],
                plasmacellule_aumentate: ['assente', 'presente'],
                fibrosi_sottomucosa: ['assente', 'lieve', 'moderata', 'marcata']
            };

            const getLabel = (key) => {
                const labels = {
                    'granulomi_epitelioidi': 'Granulomi Epitelioidi',
                    'neutrofili_epitelio': 'Neutrofili Intraepiteliali',
                    'neutrofili_lamina_propria': 'Neutrofili Lamina Propria',
                    'erosioni_ulcerazioni': 'Erosioni/Ulcerazioni Aftose',
                    'iperplasia_linfoide': 'Iperplasia Linfoide',
                    'edema_lamina_propria': 'Edema Lamina Propria',
                    'atrofia_villi': 'Atrofia Villi',
                    'plasmacellule_aumentate': 'Plasmacellule Aumentate',
                    'ascessi_criptici': 'Ascessi Criptici',
                    'plasmacellule_basale': 'Plasmacellule Basale',
                    'distorsione_architettura': 'Distorsione Architettura',
                    'metaplasia_paneth': 'Metaplasia Paneth',
                    'ulcerazione': 'Ulcerazione',
                    'fibrosi_sottomucosa': 'Fibrosi Sottomucosa'
                };
                return labels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            };

            const renderFindings = (site) => {
                const isIleum = site === 'ileo';
                const findings = isIleum ? ileumFindings : colonFindings;
                
                return Object.entries(findings).map(([key, values]) => {
                    const label = getLabel(key);
                    const options = values.map(v => 
                        '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>'
                    ).join('');
                    
                    return '<div>' +
                        '<label class="block text-sm font-semibold mb-2">' + label + ':</label>' +
                        '<select id="finding-' + key + '" class="w-full p-2 border rounded">' +
                        options +
                        '</select>' +
                        '</div>';
                }).join('');
            };

            return `
                <div class="bg-blue-50 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">Aggiungi Campione</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Sede:</label>
                        <select id="site-select" onchange="updateFormSite(this.value)" class="w-full p-2 border rounded">
                            ${sites.map(s => '<option value="' + s + '"' + (s === currentSite ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('')}
                        </select>
                        <p class="text-xs text-gray-600 mt-1">
                            ${currentSite === 'ileo' 
                                ? 'üî¨ Criteri ILEO: erosioni aftose, atrofia villi, iperplasia linfoide' 
                                : currentSite === 'pouch' || currentSite === 'anastomosi'
                                ? 'üî¨ Criteri COLON-LIKE: pouch/anastomosi valutati con criteri colon (cripte)'
                                : 'üî¨ Criteri COLON: ascessi criptici, distorsione architettura, plasmacellule basale'
                            }
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        ${renderFindings(currentSite)}
                    </div>

                    <button 
                        onclick="addSpecimen()"
                        class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
                    >
                        + Aggiungi Campione
                    </button>
                </div>
            `;
        };

        const SpecimenList = () => {
            if (specimens.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-500">
                        <p>Nessun campione inserito</p>
                    </div>
                `;
            }

            const getLabel = (key) => {
                const labels = {
                    'granulomi_epitelioidi': 'Granulomi',
                    'neutrofili_epitelio': 'Neutrofili (epitelio)',
                    'neutrofili_lamina_propria': 'Neutrofili (lamina propria)',
                    'erosioni_ulcerazioni': 'Erosioni/Ulcerazioni',
                    'iperplasia_linfoide': 'Iperplasia linfoide',
                    'edema_lamina_propria': 'Edema LP',
                    'atrofia_villi': 'Atrofia villi',
                    'plasmacellule_aumentate': 'Plasmacellule',
                    'ascessi_criptici': 'Ascessi criptici',
                    'plasmacellule_basale': 'Plasmacellule basale',
                    'distorsione_architettura': 'Distorsione arch.',
                    'metaplasia_paneth': 'Metaplasia Paneth',
                    'ulcerazione': 'Ulcerazione',
                    'fibrosi_sottomucosa': 'Fibrosi'
                };
                return labels[key] || key;
            };

            return `
                <div class="space-y-4">
                    ${specimens.map((spec, idx) => `
                        <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-lg capitalize">${spec.site}</h4>
                                    <span class="text-xs text-gray-600">
                                        ${spec.siteType === 'ileum' ? 'üî¨ Criteri ileo' : 'üî¨ Criteri colon'}
                                    </span>
                                </div>
                                <button 
                                    onclick="removeSpecimen(${idx})"
                                    class="text-red-600 hover:text-red-800 font-bold"
                                >
                                    ‚úï Rimuovi
                                </button>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                ${Object.entries(spec.findings)
                                    .filter(([k, v]) => v !== 'assente')
                                    .map(([k, v]) => `
                                        <div class="bg-gray-50 p-2 rounded">
                                            <span class="font-semibold">${getLabel(k)}:</span>
                                            <span class="ml-1">${v}</span>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        };

        // ==================== IHC PANEL con CMV ====================
        const IHCPanel = () => {
            return `
                <div class="bg-purple-50 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Immunoistochimica</h3>
                    
                    <div class="space-y-4">
                        <!-- CD68 -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                CD68 Pattern (distribuzione macrofagi):
                            </label>
                            <select 
                                id="cd68-pattern" 
                                onchange="updateIHC('cd68_pattern', this.value)"
                                class="w-full p-2 border rounded"
                            >
                                <option value="non_eseguito" ${ihcData.cd68_pattern === 'non_eseguito' ? 'selected' : ''}>
                                    Non eseguito
                                </option>
                                <option value="cluster_transmurale" ${ihcData.cd68_pattern === 'cluster_transmurale' ? 'selected' : ''}>
                                    Cluster transmurale (Crohn-like)
                                </option>
                                <option value="diffuso_mucosa" ${ihcData.cd68_pattern === 'diffuso_mucosa' ? 'selected' : ''}>
                                    Diffuso mucosa (UC-like)
                                </option>
                            </select>
                            <p class="text-xs text-gray-600 mt-1">
                                Cluster transmurale: aggregati macrofagici in tonaca propria profonda/sottomucosa (suggestivo Crohn)
                            </p>
                        </div>

                        <!-- p53 -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                p53 Pattern:
                            </label>
                            <select 
                                id="p53-pattern" 
                                onchange="updateIHC('p53_pattern', this.value)"
                                class="w-full p-2 border rounded"
                            >
                                <option value="non_eseguito" ${ihcData.p53_pattern === 'non_eseguito' ? 'selected' : ''}>
                                    Non eseguito
                                </option>
                                <option value="wild_type" ${ihcData.p53_pattern === 'wild_type' ? 'selected' : ''}>
                                    Wild-type (pattern normale)
                                </option>
                                <option value="overexpression" ${ihcData.p53_pattern === 'overexpression' ? 'selected' : ''}>
                                    Overexpression (mutazione missense)
                                </option>
                                <option value="null" ${ihcData.p53_pattern === 'null' ? 'selected' : ''}>
                                    Null/Complete loss (mutazione nonsense)
                                </option>
                            </select>
                            <p class="text-xs text-red-600 mt-1 font-semibold">
                                ‚ö†Ô∏è Pattern aberranti (overexpression/null) = ALTO RISCHIO DISPLASIA
                            </p>
                        </div>

                        <!-- CMV v2.4.1 -->
                        <div class="border-t pt-4 mt-4">
                            <label class="block text-sm font-semibold mb-2">
                                ü¶† CMV (Citomegalovirus):
                            </label>
                            <select 
                                id="cmv-status" 
                                onchange="updateIHC('cmv_status', this.value)"
                                class="w-full p-2 border rounded"
                            >
                                <option value="non_eseguito" ${ihcData.cmv_status === 'non_eseguito' ? 'selected' : ''}>
                                    Non eseguito
                                </option>
                                <option value="negativo" ${ihcData.cmv_status === 'negativo' ? 'selected' : ''}>
                                    Negativo
                                </option>
                                <option value="dubbio" ${ihcData.cmv_status === 'dubbio' ? 'selected' : ''}>
                                    Dubbio (rare cellule positive / focale)
                                </option>
                                <option value="positivo" ${ihcData.cmv_status === 'positivo' ? 'selected' : ''}>
                                    Positivo (inclusions e/o IHC diffusamente +)
                                </option>
                            </select>
                            <p class="text-xs text-gray-600 mt-1">
                                Ricercare in IBD refrattaria, UC severa/steroido-resistente, pazienti immunosoppressi
                            </p>
                            ${ihcData.cmv_status === 'positivo' || ihcData.cmv_status === 'dubbio' ? `
                                <div class="mt-2 p-3 bg-red-100 border border-red-400 rounded">
                                    <p class="text-sm text-red-800 font-semibold">
                                        ‚ö†Ô∏è ${ihcData.cmv_status === 'positivo' ? 'CMV POSITIVO' : 'CMV DUBBIO'}: 
                                        Considerare colite da CMV sovrapposta!
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        // ==================== DIAGNOSI SUGGERITA v2.4.2 ====================
        const DiagnosticPatternDisplay = ({ pattern }) => {
            if (!pattern || !pattern.pattern) return '';
            
            const colorMap = {
                'green': 'bg-green-50 border-green-500 text-green-900',
                'yellow': 'bg-yellow-50 border-yellow-500 text-yellow-900',
                'orange': 'bg-orange-50 border-orange-500 text-orange-900',
                'blue': 'bg-blue-50 border-blue-500 text-blue-900',
                'purple': 'bg-purple-50 border-purple-500 text-purple-900',
                'gray': 'bg-gray-50 border-gray-400 text-gray-900'
            };
            
            const colorClass = colorMap[pattern.color] || colorMap['gray'];
            
            return `
                <div class="${colorClass} border-2 rounded-lg p-5 mb-6">
                    <div class="flex items-start gap-3">
                        <span class="text-3xl">${pattern.emoji}</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-bold text-lg">DIAGNOSI SUGGERITA</h4>
                                <span class="text-xs bg-white bg-opacity-50 px-2 py-1 rounded">v2.4.2 Auto</span>
                            </div>
                            <p class="font-bold text-xl mb-2">${pattern.diagnosis}</p>
                            <p class="text-sm opacity-90">${pattern.description}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-current border-opacity-20">
                        <p class="text-xs opacity-70">
                            <strong>‚ö†Ô∏è Nota:</strong> Diagnosi suggerita automaticamente dal pattern morfologico. 
                            Il grado di attivit√† va valutato separatamente (vedi Nancy Index se applicabile). 
                            Confermare sempre con correlazione clinico-endoscopica.
                        </p>
                    </div>
                </div>
            `;
        };

        // ==================== CMV Warning Component ====================
        const CMVWarningDisplay = ({ cmvStatus }) => {
            if (cmvStatus === 'non_eseguito' || cmvStatus === 'negativo') return '';
            
            const isPositive = cmvStatus === 'positivo';
            
            return `
                <div class="bg-red-50 border-2 ${isPositive ? 'border-red-600' : 'border-orange-500'} rounded-lg p-5 mb-6">
                    <h4 class="font-bold text-lg ${isPositive ? 'text-red-900' : 'text-orange-900'} mb-3 flex items-center gap-2">
                        <span class="text-2xl">ü¶†</span>
                        <span>${isPositive ? 'CMV POSITIVO' : 'CMV DUBBIO'}</span>
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="bg-white bg-opacity-60 rounded p-3">
                            <p class="text-sm ${isPositive ? 'text-red-800' : 'text-orange-800'} font-semibold mb-2">
                                ${isPositive 
                                    ? 'Infezione da CMV confermata: considerare colite da CMV sovrapposta a IBD'
                                    : 'Possibile infezione da CMV: confermare con PCR/viremia e/o livelli pi√π profondi'
                                }
                            </p>
                            <p class="text-sm ${isPositive ? 'text-red-700' : 'text-orange-700'}">
                                ${isPositive 
                                    ? 'Valutare terapia antivirale (ganciclovir/valganciclovir) e riduzione/sospensione immunosoppressione.'
                                    : 'In caso di dubbio con clinica suggestiva, trattare empiricamente o approfondire diagnostica.'
                                }
                            </p>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-400 rounded p-3">
                            <p class="text-xs text-yellow-900 font-semibold mb-1">
                                üìã Nota clinica:
                            </p>
                            <p class="text-xs text-yellow-800">
                                CMV √® frequente in UC refrattaria a steroidi, UC severa/fulminante, e pazienti in terapia 
                                immunosoppressiva (anti-TNF, azatioprina, ciclosporina). L'infezione da CMV pu√≤ mimare 
                                o esacerbare IBD attiva. <strong>Continuare immunosoppressione con CMV attivo pu√≤ essere pericoloso.</strong>
                            </p>
                        </div>

                        <div class="text-xs text-gray-600 space-y-1">
                            <p><strong>Criteri diagnostici CMV:</strong></p>
                            <ul class="ml-4 list-disc space-y-1">
                                <li><strong>Inclusions</strong>: Cellule con inclusioni nucleari "owl's eye" e/o citoplasmatiche</li>
                                <li><strong>IHC</strong>: Positivit√† per anticorpi anti-CMV (pp65, IE1)</li>
                                <li><strong>Localizzazione</strong>: Cellule endoteliali, stromali, epiteliali nelle ulcere</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        };

        const SuspiciousGranulomasWarning = ({ sites }) => {
            if (!sites || sites.length === 0) return '';
            
            return `
                <div class="bg-orange-50 border-2 border-orange-400 rounded-lg p-4 mb-4">
                    <h4 class="font-bold text-lg text-orange-900 mb-3 flex items-center gap-2">
                        <span class="text-xl">‚ö†Ô∏è</span>
                        <span>Granulomi Epitelioidi "Sospetti"</span>
                    </h4>
                    
                    <div class="bg-white bg-opacity-60 rounded p-3 mb-3">
                        <p class="text-sm font-semibold text-orange-900 mb-2">
                            Aggregati epitelioidi sospetti rilevati in: ${sites.map(s => s.toUpperCase()).join(', ')}
                        </p>
                        <p class="text-sm text-orange-800">
                            <strong>Interpretazione cauta raccomandata.</strong> Possibili diagnosi differenziali:
                        </p>
                        <ul class="list-disc ml-6 text-sm text-orange-800 mt-2 space-y-1">
                            <li>Artefatti da manipolazione/schiacciamento biopsia</li>
                            <li>Microaggregati istiocitari reattivi (non granulomi veri)</li>
                            <li>Follicolite linfoide frammentata</li>
                            <li>Detriti cellulari/fibrina organizzata</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-400 rounded p-3">
                        <p class="text-xs text-yellow-900 font-semibold mb-1">
                            üìã Nota metodologica:
                        </p>
                        <p class="text-xs text-yellow-800">
                            I granulomi "sospetti" <strong>NON sono pesati nello scoring</strong> per evitare 
                            sovradiagnosi di Crohn in presenza di reperti ambigui. Conferma su biopsia 
                            profonda/multipla consigliata prima di diagnosi definitiva.
                        </p>
                    </div>
                </div>
            `;
        };

        const TopographicPatternDisplay = ({ pattern }) => {
            if (!pattern) return '';
            
            const getWarningColor = () => {
                if (!pattern.warning) return 'bg-gray-50 border-gray-300';
                if (pattern.warning.includes('UC-like')) return 'bg-blue-50 border-blue-400';
                if (pattern.warning.includes('Crohn-like')) return 'bg-purple-50 border-purple-400';
                return 'bg-yellow-50 border-yellow-400';
            };
            
            return `
                <div class="${getWarningColor()} border-2 rounded-lg p-4 mb-4">
                    <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                        <span class="text-xl">üó∫Ô∏è</span>
                        <span>Pattern Topografico di Distribuzione</span>
                    </h4>
                    
                    ${pattern.warning ? `
                        <div class="mb-3 p-3 bg-white bg-opacity-60 rounded">
                            <p class="text-sm font-semibold">${pattern.warning}</p>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${
                                pattern.rectumInvolved ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-600'
                            }">
                                ${pattern.rectumInvolved ? '‚úì' : '‚úó'}
                            </span>
                            <span>Retto coinvolto</span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${
                                pattern.ileumInvolved ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-600'
                            }">
                                ${pattern.ileumInvolved ? '‚úì' : '‚úó'}
                            </span>
                            <span>Ileo coinvolto</span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <span class="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${
                                pattern.skipLesions ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
                            }">
                                ${pattern.skipLesions ? '‚úì' : '‚úó'}
                            </span>
                            <span>Skip lesions</span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-semibold text-gray-600">Continuit√†:</span>
                            <span class="text-xs font-bold">${pattern.continuity}</span>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-300">
                        <p class="text-xs text-gray-600">
                            <strong>Nota:</strong> Il pattern topografico √® indicativo (sensibilit√† 60-80%). 
                            La diagnosi richiede integrazione con morfologia, IHC e clinica.
                        </p>
                    </div>
                </div>
            `;
        };

        const DysplasiaRiskDisplay = ({ scoring, ihcData }) => {
            if (!scoring.dysplasiaRisk) return '';
            
            return `
                <div class="bg-red-50 border-2 border-red-500 rounded-lg p-5 mb-6 no-print">
                    <h4 class="font-bold text-lg text-red-900 mb-3 flex items-center gap-2">
                        <span class="text-2xl">üö®</span>
                        <span>Warning Displasia (p53 aberrante)</span>
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="bg-white bg-opacity-50 rounded p-3">
                            <p class="text-sm text-red-800 font-semibold mb-2">
                                Pattern p53 aberrante (${ihcData.p53_pattern}): ALTO RISCHIO DISPLASIA
                            </p>
                            <p class="text-sm text-red-700">
                                Valutazione morfologica attenta per displasia low-grade (LGD) o 
                                high-grade (HGD) √® <strong>obbligatoria</strong>.
                            </p>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-400 rounded p-3">
                            <p class="text-xs text-yellow-900 font-semibold mb-1">
                                ‚ö†Ô∏è Importante:
                            </p>
                            <p class="text-xs text-yellow-800">
                                p53 aberrante √® marker di <strong>DISPLASIA</strong>, non di tipo di IBD.
                                Questa informazione <strong>NON</strong> influenza lo scoring Crohn vs UC.
                            </p>
                        </div>
                        
                        <div class="text-xs text-gray-600 space-y-1">
                            <p><strong>Pattern p53 aberranti:</strong></p>
                            <ul class="ml-4 list-disc space-y-1">
                                <li>
                                    <strong>Overexpression</strong>: Mutazione missense, accumulo nucleare 
                                    diffuso e intenso (&gt;60% cellule epiteliali)
                                </li>
                                <li>
                                    <strong>Null/Complete loss</strong>: Mutazione nonsense/frameshift, 
                                    assenza completa di espressione nucleare
                                </li>
                            </ul>
                            <p class="mt-2 italic">
                                Ref: Loughrey MB et al. Histopathology 2020; 77:3-15.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        };

        const NancyIndexDisplay = ({ nancy }) => {
            if (!nancy || !nancy.applicable) return '';

            return `
                <div class="bg-indigo-50 border-2 border-indigo-400 rounded-lg p-4 mb-4">
                    <h4 class="font-bold text-lg mb-3">Nancy Histological Index</h4>
                    
                    <div class="mb-3 bg-white bg-opacity-60 rounded p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold">Score:</span>
                            <span class="text-2xl font-bold text-indigo-700">${nancy.score}/4</span>
                        </div>
                        <p class="text-sm font-semibold text-indigo-900">
                            ${nancy.interpretation.label}
                        </p>
                        <p class="text-xs text-gray-700 mt-1">
                            ${nancy.interpretation.description}
                        </p>
                    </div>

                    <div class="bg-blue-50 border border-blue-300 rounded p-3 text-xs">
                        <p class="font-semibold mb-1">Prognosi (Battat 2019):</p>
                        <p class="text-gray-700">${nancy.interpretation.prognosis}</p>
                    </div>

                    <div class="mt-3 text-xs text-gray-600">
                        <strong>Dettagli:</strong> 
                        Ulcerazione: ${nancy.details.hasUlceration ? 'S√¨' : 'No'} | 
                        Ascessi: ${nancy.details.hasCryptAbscesses ? 'S√¨' : 'No'} | 
                        Neutrofili: ${nancy.details.neutrophilSeverity}
                    </div>
                </div>
            `;
        };

        const ValidationPanel = ({ warnings }) => {
            if (!warnings || warnings.length === 0) return '';
            
            const highSeverity = warnings.filter(w => w.severity === 'high');
            const otherWarnings = warnings.filter(w => w.severity !== 'high');
            
            return `
                ${highSeverity.length > 0 ? `
                    <div class="bg-orange-50 border-2 border-orange-500 rounded-lg p-5 mb-4">
                        <h4 class="font-bold text-lg text-orange-900 mb-3 flex items-center gap-2">
                            <span class="text-2xl">üîç</span>
                            <span>Note Cliniche Importanti (${highSeverity.length})</span>
                        </h4>
                        ${highSeverity.map(w => `
                            <div class="mb-3 p-3 bg-white rounded border-l-4 border-orange-500">
                                <p class="font-semibold text-orange-900 mb-1">${w.message}</p>
                                <p class="text-sm text-orange-800 mt-2">${w.suggestion}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${otherWarnings.length > 0 ? `
                    <div class="bg-blue-50 border-2 border-blue-400 rounded-lg p-4 mb-4">
                        <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                            <span class="text-xl">üí°</span>
                            <span>Note Tecniche e Metodologiche (${otherWarnings.length})</span>
                        </h4>
                        ${otherWarnings.map(w => `
                            <div class="mb-2 p-3 bg-white bg-opacity-60 rounded">
                                <p class="text-sm font-semibold text-blue-900">${w.message}</p>
                                <p class="text-xs text-blue-800 mt-1">${w.suggestion}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        };

        const ConfidenceBar = ({ crohn, uc, ibdu }) => {
            const interpretation = interpretScoring({ crohn, uc, ibdu });
            
            return `
                <div class="space-y-4">
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                        <div class="flex items-start gap-3 mb-3">
                            <span class="text-3xl">‚ö†Ô∏è</span>
                            <div class="flex-1">
                                <p class="font-bold text-lg text-yellow-900 mb-2">
                                    ATTENZIONE: Scoring % NON validato clinicamente
                                </p>
                                <p class="text-sm text-yellow-800">
                                    Le percentuali sottostanti sono <strong>PURAMENTE ORIENTATIVE</strong> e 
                                    non rappresentano misure diagnostiche precise. L'algoritmo √® basato su 
                                    criteri di letteratura ma <strong>NON ha validazione prospettica</strong>. 
                                    Interpretare sempre nel contesto clinico completo.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                        <h4 class="font-bold text-green-900 mb-3 flex items-center gap-2">
                            <span class="text-xl">üìä</span>
                            <span>Interpretazione Orientativa</span>
                        </h4>
                        <div class="text-lg mb-2">
                            <span class="font-bold text-green-900">${interpretation.primary}</span>
                            <span class="text-base text-green-700 ml-3">
                                (${interpretation.confidence})
                            </span>
                        </div>
                        <p class="text-xs text-green-800">
                            Basato su: Pattern morfologico, distribuzione topografica, immunoistochimica
                        </p>
                    </div>
                    
                    <div class="bg-white border border-gray-300 rounded-lg p-4">
                        <h5 class="text-sm font-semibold text-gray-700 mb-3">
                            Scoring % Dettagliato (orientativo)
                        </h5>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-sm text-gray-700">Crohn Disease</span>
                                    <span class="text-sm font-bold text-blue-600">${crohn}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div 
                                        class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" 
                                        style="width: ${crohn}%"
                                    ></div>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-sm text-gray-700">Ulcerative Colitis</span>
                                    <span class="text-sm font-bold text-purple-600">${uc}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div 
                                        class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" 
                                        style="width: ${uc}%"
                                    ></div>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-semibold text-sm text-gray-700">IBD Unclassified</span>
                                    <span class="text-sm font-bold text-amber-600">${ibdu}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div 
                                        class="bg-amber-600 h-2.5 rounded-full transition-all duration-300" 
                                        style="width: ${ibdu}%"
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const ReportTab = () => {
            if (specimens.length === 0) {
                return `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-xl mb-2">Nessun dato disponibile</p>
                        <p>Aggiungi almeno un campione per generare il referto</p>
                    </div>
                `;
            }

            const report = generateReport();

            return `
                <div class="space-y-6">
                    <!-- DIAGNOSI SUGGERITA v2.4.2 -->
                    ${DiagnosticPatternDisplay({ pattern: report.diagnosticPattern })}

                    <!-- CMV Warning v2.4.1 -->
                    ${CMVWarningDisplay({ cmvStatus: report.ihcData.cmv_status })}

                    <!-- Warning Granulomi Sospetti -->
                    ${SuspiciousGranulomasWarning({ sites: report.suspiciousGranulomas })}

                    <!-- Clinical Validation -->
                    ${ValidationPanel({ warnings: report.validations })}

                    <!-- Pattern Topografico -->
                    ${TopographicPatternDisplay({ pattern: report.topoPattern })}

                    <!-- Warning Displasia -->
                    ${DysplasiaRiskDisplay({ scoring: report.scoring, ihcData: report.ihcData })}

                    <!-- Nancy Index -->
                    ${NancyIndexDisplay({ nancy: report.nancy })}

                    <!-- Scoring con Disclaimer -->
                    ${ConfidenceBar({ 
                        crohn: report.scoring.scores.crohn,
                        uc: report.scoring.scores.uc,
                        ibdu: report.scoring.scores.ibdu
                    })}

                    <!-- Referto Testuale -->
                    <div class="bg-white border-2 border-gray-400 rounded-lg p-6 print-friendly">
                        <h3 class="text-xl font-bold mb-4">REFERTO ISTOLOGICO</h3>
                        
                        <!-- DIAGNOSI SUGGERITA v2.4.2 - PRIMA DI TUTTO -->
                        ${report.diagnosticPattern && report.diagnosticPattern.pattern ? `
                            <div class="mb-4 p-4 bg-gray-100 border-l-4 border-blue-500 rounded">
                                <h4 class="font-bold text-lg mb-2">${report.diagnosticPattern.emoji} DIAGNOSI:</h4>
                                <p class="font-semibold text-base mb-2">${report.diagnosticPattern.diagnosis}</p>
                                <p class="text-sm text-gray-700">${report.diagnosticPattern.description}</p>
                            </div>
                        ` : ''}

                        <!-- Tabella Campioni -->
                        <div class="mb-4">
                            <h4 class="font-semibold mb-2">Dettaglio per sede:</h4>
                            <table class="w-full text-sm border-collapse">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="border p-2 text-left">Sede</th>
                                        <th class="border p-2 text-left">Diagnosi</th>
                                        <th class="border p-2 text-left">Reperti Principali</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.diagnoses.map(d => `
                                        <tr>
                                            <td class="border p-2 capitalize font-semibold">${d.site}</td>
                                            <td class="border p-2">${d.diagnosis}</td>
                                            <td class="border p-2 text-xs">${d.findings.join(', ') || 'Nessun reperto significativo'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- CMV Testuale v2.4.1 -->
                        ${report.ihcData.cmv_status === 'positivo' ? `
                            <h4 class="font-semibold mt-4 mb-2 text-red-700">ü¶† CMV POSITIVO:</h4>
                            <p class="text-sm mb-2 text-red-800 font-semibold">
                                Infezione da CMV confermata. Considerare colite da CMV sovrapposta a IBD.
                            </p>
                            <p class="text-sm mb-2 text-red-700">
                                Valutare terapia antivirale (ganciclovir) e riduzione immunosoppressione.
                            </p>
                        ` : report.ihcData.cmv_status === 'dubbio' ? `
                            <h4 class="font-semibold mt-4 mb-2 text-orange-700">ü¶† CMV DUBBIO:</h4>
                            <p class="text-sm mb-2 text-orange-800">
                                Rare cellule positive per CMV. Confermare con PCR/viremia e/o livelli pi√π profondi.
                                In caso di clinica suggestiva, considerare trattamento empirico.
                            </p>
                        ` : ''}

                        <!-- Warning Granulomi Sospetti Testuale -->
                        ${report.suspiciousGranulomas.length > 0 ? `
                            <h4 class="font-semibold mt-4 mb-2 text-orange-700">‚ö†Ô∏è GRANULOMI SOSPETTI:</h4>
                            <p class="text-sm mb-2 text-orange-800">
                                Aggregati epitelioidi sospetti in: ${report.suspiciousGranulomas.map(s => s.toUpperCase()).join(', ')}.
                            </p>
                            <p class="text-sm mb-2 text-orange-700">
                                Interpretazione cauta. <strong>Non pesati nello scoring</strong>. 
                                Conferma su biopsia profonda/multipla consigliata.
                            </p>
                        ` : ''}

                        <!-- Pattern Topografico Testuale -->
                        ${report.topoPattern && report.topoPattern.warning ? `
                            <h4 class="font-semibold mt-4 mb-2">DISTRIBUZIONE TOPOGRAFICA:</h4>
                            <p class="text-sm mb-2">
                                ${report.topoPattern.warning}
                            </p>
                            <p class="text-xs text-gray-600 mb-2">
                                Retto: ${report.topoPattern.rectumInvolved ? 'Coinvolto' : 'Non coinvolto'}${
                                    report.topoPattern.rectumSampled ? '' : ' (non campionato)'
                                } | 
                                Ileo: ${report.topoPattern.ileumInvolved ? 'Coinvolto' : 'Non coinvolto'}${
                                    report.topoPattern.ileumSampled ? '' : ' (non campionato)'
                                } | 
                                Distribuzione: ${report.topoPattern.continuity}
                            </p>
                        ` : ''}

                        <!-- Warning Displasia Testuale -->
                        ${report.scoring.dysplasiaRisk ? `
                            <h4 class="font-semibold mt-4 mb-2 text-red-700">‚ö†Ô∏è WARNING DISPLASIA:</h4>
                            <p class="text-sm mb-2 text-red-800 font-semibold">
                                Pattern p53 aberrante (${report.ihcData.p53_pattern}): ALTO RISCHIO DISPLASIA.
                            </p>
                            <p class="text-sm mb-2 text-red-700">
                                Valutazione morfologica attenta per LGD/HGD obbligatoria.
                            </p>
                        ` : ''}

                        <!-- Scoring Orientativo -->
                        <h4 class="font-semibold mt-4 mb-2">SCORING ORIENTATIVO (non validato):</h4>
                        <p class="text-sm mb-2">
                            Pattern morfologico: <strong>${interpretScoring(report.scoring.scores).primary}</strong> 
                            (${interpretScoring(report.scoring.scores).confidence})
                        </p>
                        ${report.nancy.applicable ? `
                            <p class="text-sm mb-2">
                                Nancy Histological Index: ${report.nancy.score}/4 (${report.nancy.interpretation.label})
                            </p>
                        ` : '<p class="text-sm mb-2">Nancy Index: Non applicabile</p>'}

                        <!-- Disclaimer Finale -->
                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded">
                            <p class="text-xs text-gray-700">
                                <strong>NOTA IMPORTANTE:</strong> Lo scoring % √® supporto decisionale orientativo, 
                                NON diagnosi definitiva. La diagnosi richiede integrazione con contesto clinico, 
                                endoscopia, sierologia e follow-up.
                            </p>
                        </div>
                    </div>

                    <!-- Azioni -->
                    <div class="flex gap-4 no-print">
                        <button 
                            onclick="window.print()"
                            class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700"
                        >
                            üñ®Ô∏è Stampa/PDF
                        </button>
                        <button 
                            onclick="saveData()"
                            class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700"
                        >
                            üíæ Salva Dati
                        </button>
                        <button 
                            onclick="clearData()"
                            class="bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700"
                        >
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
            `;
        };

        // ==================== EVENT HANDLERS ====================
        const switchTab = (tab) => {
            activeTab = tab;
            render();
        };

        const addSpecimen = () => {
            const site = document.getElementById('site-select').value;
            const findings = {};

            const isIleum = (site === 'ileo');
            
            const findingKeys = isIleum ? [
                'granulomi_epitelioidi', 'neutrofili_lamina_propria', 
                'erosioni_ulcerazioni', 'iperplasia_linfoide',
                'edema_lamina_propria', 'atrofia_villi', 
                'plasmacellule_aumentate', 'fibrosi_sottomucosa'
            ] : [
                'granulomi_epitelioidi', 'neutrofili_epitelio', 'ascessi_criptici',
                'plasmacellule_basale', 'distorsione_architettura', 'metaplasia_paneth',
                'ulcerazione', 'fibrosi_sottomucosa'
            ];

            findingKeys.forEach(key => {
                const element = document.getElementById(`finding-${key}`);
                if (element) {
                    findings[key] = element.value;
                }
            });

            specimens.push({ site, findings, siteType: isIleum ? 'ileum' : 'colon' });
            saveData();
            render();
        };

        const removeSpecimen = (index) => {
            specimens.splice(index, 1);
            saveData();
            render();
        };

        const updateIHC = (field, value) => {
            ihcData[field] = value;
            saveData();
            render();
        };

        const clearData = () => {
            if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                specimens = [];
                ihcData = { cd68_pattern: 'non_eseguito', p53_pattern: 'non_eseguito', cmv_status: 'non_eseguito' };
                localStorage.removeItem(STORAGE_KEY);
                render();
            }
        };

        const saveData = () => {
            try {
                const data = {
                    version: APP_VERSION,
                    specimens,
                    ihcData,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        };

        const loadData = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    specimens = data.specimens || [];
                    ihcData = data.ihcData || { cd68_pattern: 'non_eseguito', p53_pattern: 'non_eseguito', cmv_status: 'non_eseguito' };
                    // Ensure cmv_status exists for older data
                    if (!ihcData.cmv_status) ihcData.cmv_status = 'non_eseguito';
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        };

        // ==================== RENDER ====================
        const render = () => {
            const content = document.getElementById('main-content');
            
            let tabContent = '';
            if (activeTab === 'campioni') {
                tabContent = SpecimenForm() + SpecimenList();
            } else if (activeTab === 'ihc') {
                tabContent = IHCPanel();
            } else if (activeTab === 'referto') {
                tabContent = ReportTab();
            }

            content.innerHTML = TabNavigation({ active: activeTab, onChange: switchTab }) + tabContent;
        };

        // ==================== INIT ====================
        loadData();
        checkDisclaimer();
        render();
    </script>

    <!-- Footer -->
    <div class="max-w-6xl mx-auto mt-8 text-xs text-gray-600 text-center p-4 bg-gray-100 rounded">
        <p class="font-semibold mb-2">
            IBD Diagnostic Tool v2.4.2 - STRUMENTO DI SUPPORTO DIAGNOSTICO
        </p>
        <p class="mb-1">
            <strong>DISCLAIMER:</strong> Questo tool fornisce supporto orientativo alla diagnosi 
            differenziale IBD basato su criteri morfologici, topografici e immunoistochimici 
            validati in letteratura. Lo scoring % NON √® validato prospetticamente.
        </p>
        <p class="mb-1">
            La diagnosi definitiva richiede sempre integrazione con: 
            <strong>contesto clinico, endoscopia, sierologia, follow-up</strong>.
        </p>
        <p class="text-gray-500 text-xs mt-2">
            Release: Gennaio 2026 | v2.4.2: +Diagnosi suggerita automatica | v2.4.1: +CMV | 
            Criteri ileo dedicati, Nancy solo colon
        </p>
        <p class="text-gray-500 text-xs mt-2">
            Contatto: <a href="mailto:filippo.bianchi@asst-fbf-sacco.it" class="text-blue-600 hover:underline">filippo.bianchi@asst-fbf-sacco.it</a>
        </p>
    </div>
</body>
</html>
