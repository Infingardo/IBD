<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Diagnostic Tool v2.0 - Scoring Avanzato</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        .confidence-bar {
            height: 30px;
            background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #84cc16 75%, #22c55e 100%);
            border-radius: 4px;
            position: relative;
        }
        .confidence-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #000;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        const Microscope = () => <i data-lucide="microscope"></i>;
        const FileText = () => <i data-lucide="file-text"></i>;
        const User = () => <i data-lucide="user"></i>;
        const MapPin = () => <i data-lucide="map-pin"></i>;
        const Printer = () => <i data-lucide="printer"></i>;
        const AlertCircle = () => <i data-lucide="alert-circle"></i>;
        const CheckCircle = () => <i data-lucide="check-circle"></i>;

        const IBDDiagnosticTool = () => {
            const [activeTab, setActiveTab] = useState('clinical');
            const [patientData, setPatientData] = useState({
                age: '',
                gender: '',
                clinicalHistory: '',
                indication: ''
            });
            
            const [specimens, setSpecimens] = useState([
                { id: 1, label: 'A', site: 'cieco', findings: {} }
            ]);
            
            const [ihcData, setIhcData] = useState({
                cd3: '',
                cd68: '',
                cmv: 'assente',
                p53: '',
                cd20: 'assente',
                cd138: 'assente'
            });

            const [warnings, setWarnings] = useState({});

            const anatomicalSites = [
                { value: 'ileo', label: 'Ileo terminale' },
                { value: 'cieco', label: 'Cieco' },
                { value: 'ascendente', label: 'Colon ascendente' },
                { value: 'trasverso', label: 'Colon trasverso' },
                { value: 'discendente', label: 'Colon discendente' },
                { value: 'sigma', label: 'Sigma' },
                { value: 'retto', label: 'Retto' }
            ];

            // VALIDAZIONE IHC CON RANGE CLINICI
            const validateIHC = (marker, value) => {
                const ranges = {
                    cd3: { min: 0, max: 500, unit: '/100 cellule', warn_low: 5, warn_high: 300 },
                    cd68: { min: 0, max: 100, unit: '%', warn_low: 0, warn_high: 80 },
                    p53: { min: 0, max: 100, unit: '%', warn_low: 50, warn_high: 100 }
                };

                if (!ranges[marker]) return null;

                const range = ranges[marker];
                const num = parseFloat(value);

                if (isNaN(num)) return null;
                
                let warning = null;
                if (num < range.min || num > range.max) {
                    warning = `⚠️ Valore fuori range biologico (0-${range.max} ${range.unit})`;
                } else if (num < range.warn_low) {
                    warning = `⚠️ Valore basso (atteso ≥ ${range.warn_low} ${range.unit})`;
                } else if (num > range.warn_high) {
                    warning = `⚠️ Valore alto (atteso ≤ ${range.warn_high} ${range.unit})`;
                }

                return warning;
            };

            const updateIHC = (marker, value) => {
                setIhcData({...ihcData, [marker]: value});
                
                if (value) {
                    const warning = validateIHC(marker, value);
                    setWarnings({
                        ...warnings,
                        [marker]: warning
                    });
                } else {
                    const newWarnings = {...warnings};
                    delete newWarnings[marker];
                    setWarnings(newWarnings);
                }
            };

            useEffect(() => {
                const savedData = localStorage.getItem('ibdAppDataV2');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.patientData) setPatientData(parsed.patientData);
                        if (parsed.specimens) setSpecimens(parsed.specimens);
                        if (parsed.ihcData) setIhcData(parsed.ihcData);
                    } catch (e) {
                        console.error('Errore caricamento:', e);
                    }
                }
            }, []);

            useEffect(() => {
                const dataToSave = { patientData, specimens, ihcData, lastUpdated: new Date().toISOString() };
                localStorage.setItem('ibdAppDataV2', JSON.stringify(dataToSave));
            }, [patientData, specimens, ihcData]);

            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [activeTab, specimens, ihcData]);

            const findingsDatabase = {
                architectural: {
                    title: "Alterazioni Architetturali (Cronicità)",
                    color: "bg-purple-50 border-purple-300",
                    items: {
                        glandular_distortion: {
                            name: "Distorsione ghiandolare",
                            desc: "Cripte ramificate, accorciate, distribuzione irregolare",
                            crohnScore: 15,
                            ucScore: 20
                        },
                        glandular_atrophy: {
                            name: "Atrofia ghiandolare",
                            desc: "Riduzione numerica delle cripte, spaziatura aumentata",
                            crohnScore: 10,
                            ucScore: 15
                        },
                        paneth_metaplasia: {
                            name: "Metaplasia di Paneth",
                            desc: "Cellule di Paneth ectopiche nel colon sinistro",
                            crohnScore: 5,
                            ucScore: 10
                        },
                        mucin_depletion: {
                            name: "Deplezione mucinica",
                            desc: "Riduzione/assenza goblet cells",
                            crohnScore: 3,
                            ucScore: 8
                        }
                    }
                },
                inflammation: {
                    title: "Pattern Infiammatorio",
                    color: "bg-red-50 border-red-300",
                    items: {
                        chronic_inflammation: {
                            name: "Infiammazione cronica linfoplasmacellulare",
                            desc: "Infiltrato cronico nella lamina propria",
                            crohnScore: 10,
                            ucScore: 10
                        },
                        basal_plasmacytosis: {
                            name: "Plasmacitosi basale",
                            desc: "Accumulo plasmacellule alla base delle cripte",
                            crohnScore: 8,
                            ucScore: 12
                        },
                        acute_inflammation: {
                            name: "Infiltrato flogistico acuto (granulocitario)",
                            desc: "Granulociti neutrofili nella lamina propria",
                            crohnScore: 5,
                            ucScore: 12
                        },
                        cryptitis: {
                            name: "Criptite",
                            desc: "Neutrofili nell'epitelio delle cripte",
                            crohnScore: 5,
                            ucScore: 15
                        },
                        crypt_abscesses: {
                            name: "Ascessi criptici",
                            desc: "Neutrofili nel lume ghiandolare",
                            crohnScore: 3,
                            ucScore: 20
                        },
                        transmural: {
                            name: "Infiammazione transmurale",
                            desc: "Infiltrato in tutti gli strati (solo su resezioni)",
                            crohnScore: 50,
                            ucScore: 0
                        },
                        fissuring_ulcers: {
                            name: "Ulcere fissuriformi",
                            desc: "Ulcere lineari profonde",
                            crohnScore: 35,
                            ucScore: 5
                        }
                    }
                },
                specific: {
                    title: "Reperti Patognomonici",
                    color: "bg-orange-50 border-orange-300",
                    items: {
                        granulomas: {
                            name: "Granulomi epitelioidi non-caseosi",
                            desc: "Aggregati epitelioidi con/senza cellule giganti",
                            pathognomonic: true,
                            crohnScore: 100,
                            ucScore: 0
                        }
                    }
                }
            };

            const addSpecimen = () => {
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const nextLetter = letters[specimens.length];
                setSpecimens([...specimens, { 
                    id: Date.now(), 
                    label: nextLetter, 
                    site: 'cieco', 
                    findings: {} 
                }]);
            };

            const removeSpecimen = (id) => {
                if (specimens.length > 1) {
                    setSpecimens(specimens.filter(s => s.id !== id));
                }
            };

            const updateSpecimen = (id, field, value) => {
                setSpecimens(specimens.map(s => 
                    s.id === id ? { ...s, [field]: value } : s
                ));
            };

            const updateFinding = (specimenId, category, key, severity) => {
                setSpecimens(specimens.map(s => {
                    if (s.id === specimenId) {
                        return {
                            ...s,
                            findings: {
                                ...s.findings,
                                [`${category}_${key}`]: severity
                            }
                        };
                    }
                    return s;
                }));
            };

            const getFindingSeverity = (specimenId, category, key) => {
                const specimen = specimens.find(s => s.id === specimenId);
                return specimen?.findings?.[`${category}_${key}`] || 'assente';
            };

            // SCORING SYSTEM AVANZATO CON CONFIDENZA
            const calculateScoring = () => {
                let scores = {
                    crohn: 0,
                    uc: 0,
                    ibdu: 0
                };

                // Scoring dai reperti
                specimens.forEach(spec => {
                    Object.entries(spec.findings).forEach(([key, severity]) => {
                        if (severity === 'assente') return;

                        const [category, findingKey] = key.split('_').reduce((acc, part, idx, arr) => {
                            if (idx === 0) return [part, ''];
                            if (idx === 1) return [acc[0], part];
                            return [acc[0], acc[1] + '_' + part];
                        }, ['', '']);

                        const finding = findingsDatabase[category]?.items[findingKey];
                        if (finding) {
                            // Moltiplicatore per severità
                            const severityMult = {
                                'lieve': 0.5,
                                'moderata': 1.0,
                                'severa': 1.5
                            }[severity] || 0.3;

                            scores.crohn += (finding.crohnScore || 0) * severityMult;
                            scores.uc += (finding.ucScore || 0) * severityMult;

                            // Se è patognomonico, aumenta aggressivamente
                            if (finding.pathognomonic) {
                                if (finding.crohnScore > 0) {
                                    scores.crohn += 150;
                                    scores.uc -= 50;
                                }
                            }
                        }
                    });
                });

                // Scoring da IHC
                const cd3 = parseFloat(ihcData.cd3);
                if (!isNaN(cd3) && cd3 >= 20) {
                    scores.crohn += 15; // Colite linfocitica suggestiva
                }

                if (ihcData.cmv !== 'assente') {
                    scores.crohn += 5;
                    scores.uc += 5; // Superinfezione CMV in entrambe
                }

                const p53 = parseFloat(ihcData.p53);
                if (!isNaN(p53) && p53 > 50) {
                    scores.crohn += 30; // Displasia
                    scores.uc += 35;
                }

                // Normalizzazione con confidenza percentuale
                const total = Math.max(scores.crohn, scores.uc);
                
                let result = {};
                if (total === 0) {
                    result = { crohn: 0, uc: 0, ibdu: 100 };
                } else {
                    result.crohn = Math.min(100, Math.round((scores.crohn / total) * 100));
                    result.uc = Math.min(100, Math.round((scores.uc / total) * 100));
                    
                    // Se entrambi hanno score basso, aumenta IBDU
                    if (result.crohn < 35 && result.uc < 35) {
                        result.ibdu = 100 - Math.max(result.crohn, result.uc);
                    } else {
                        result.ibdu = 100 - Math.max(result.crohn, result.uc);
                    }
                }

                return result;
            };

            const generateReport = () => {
                const groupedSpecimens = {};
                
                specimens.forEach(spec => {
                    const hasFindings = Object.values(spec.findings).some(v => v !== 'assente');
                    if (!groupedSpecimens[spec.site]) {
                        groupedSpecimens[spec.site] = [];
                    }
                    groupedSpecimens[spec.site].push({
                        ...spec,
                        hasFindings
                    });
                });

                let report = {
                    materialReceived: [],
                    diagnoses: [],
                    comment: '',
                    scoring: calculateScoring()
                };

                Object.entries(groupedSpecimens).forEach(([site, specs]) => {
                    const labels = specs.map(s => s.label).join('-');
                    const siteName = anatomicalSites.find(a => a.value === site)?.label || site;
                    report.materialReceived.push(`${labels}: ${siteName}`);

                    const withFindings = specs.filter(s => s.hasFindings);
                    const withoutFindings = specs.filter(s => !s.hasFindings);

                    if (withFindings.length > 0) {
                        const allFindings = withFindings[0].findings;
                        const findingsList = [];
                        
                        let hasChronicChanges = false;
                        let hasActivity = false;
                        let hasGranulomas = false;
                        let hasTransmural = false;

                        Object.entries(allFindings).forEach(([key, severity]) => {
                            if (severity === 'assente') return;
                            
                            const [category, findingKey] = key.split('_').reduce((acc, part, idx, arr) => {
                                if (idx === 0) return [part, ''];
                                if (idx === 1) return [acc[0], part];
                                return [acc[0], acc[1] + '_' + part];
                            }, ['', '']);
                            
                            const finding = findingsDatabase[category]?.items[findingKey];
                            if (finding) {
                                if (category === 'architectural') hasChronicChanges = true;
                                if (category === 'inflammation' && (findingKey.includes('crypt') || findingKey === 'cryptitis' || findingKey === 'acute_inflammation')) hasActivity = true;
                                if (findingKey === 'granulomas') hasGranulomas = true;
                                if (findingKey === 'transmural') hasTransmural = true;
                            }
                        });

                        let diagnosis = '';
                        if (hasGranulomas) {
                            diagnosis = `Colite cronica attiva con granulomi epitelioidi non-caseosi (CROHN DISEASE - HIGH CONFIDENCE)`;
                        } else if (hasTransmural) {
                            diagnosis = `Colite cronica con infiammazione transmurale (CROHN DISEASE - SUGGESTIVO)`;
                        } else if (hasChronicChanges && hasActivity) {
                            diagnosis = `Colite cronica attiva`;
                            
                            const chronicDetails = [];
                            const activityDetails = [];
                            
                            if (allFindings['inflammation_crypt_abscesses'] !== 'assente' || 
                                allFindings['inflammation_cryptitis'] !== 'assente') {
                                activityDetails.push('ascessi/criptite');
                            }
                            if (allFindings['inflammation_acute_inflammation'] !== 'assente') {
                                activityDetails.push('infiltrato granulocitario');
                            }
                            if (allFindings['architectural_glandular_distortion'] !== 'assente' || 
                                allFindings['architectural_glandular_atrophy'] !== 'assente') {
                                chronicDetails.push('alterazioni architetturali');
                            }
                            
                            if (chronicDetails.length > 0 && activityDetails.length > 0) {
                                diagnosis += ` con ${chronicDetails.join(', ')} e ${activityDetails.join(' / ')}`;
                            }
                            
                        } else if (hasChronicChanges) {
                            diagnosis = `Colite cronica in fase quiescente`;
                        } else if (hasActivity) {
                            diagnosis = `Colite attiva senza franche alterazioni croniche`;
                        } else {
                            diagnosis = `Mucosa colica con lievi alterazioni infiammatorie`;
                        }

                        report.diagnoses.push({
                            site: siteName,
                            labels: labels,
                            diagnosis: diagnosis
                        });
                    }

                    if (withoutFindings.length > 0) {
                        const labels = withoutFindings.map(s => s.label).join('-');
                        report.diagnoses.push({
                            site: siteName,
                            labels: labels,
                            diagnosis: 'Mucosa colica nei limiti della norma'
                        });
                    }
                });

                return report;
            };

            const report = useMemo(() => {
                if (activeTab !== 'diagnosis') return null;
                return generateReport();
            }, [activeTab, specimens, ihcData]);

            const printReport = () => {
                window.print();
            };

            const ConfidenceBar = ({ crohn, uc, ibdu }) => {
                const total = crohn + uc + ibdu;
                if (total === 0) return <div className="text-gray-500">Nessun dato di scoring disponibile</div>;

                return (
                    <div className="space-y-4">
                        {/* Crohn */}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-sm">Crohn Disease</span>
                                <span className="text-sm font-bold text-blue-600">{crohn}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div className="bg-blue-600 h-2 rounded-full" style={{ width: `${crohn}%` }}></div>
                            </div>
                        </div>

                        {/* UC */}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-sm">Ulcerative Colitis</span>
                                <span className="text-sm font-bold text-purple-600">{uc}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div className="bg-purple-600 h-2 rounded-full" style={{ width: `${uc}%` }}></div>
                            </div>
                        </div>

                        {/* IBD-U */}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-sm">IBD Unclassified</span>
                                <span className="text-sm font-bold text-amber-600">{ibdu}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div className="bg-amber-600 h-2 rounded-full" style={{ width: `${ibdu}%` }}></div>
                            </div>
                        </div>

                        {/* Diagnosi Suggerita */}
                        <div className="mt-4 p-3 bg-green-50 border border-green-300 rounded-lg">
                            <p className="text-sm">
                                <strong>Diagnosi più probabile:</strong> {
                                    crohn >= uc && crohn >= ibdu ? 'Crohn Disease' :
                                    uc >= crohn && uc >= ibdu ? 'Ulcerative Colitis' :
                                    'IBD Unclassified'
                                }
                            </p>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6 no-print">
                            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <Microscope />
                                    <div>
                                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">IBD Diagnostic Tool v2.0</h1>
                                        <p className="text-xs md:text-sm text-gray-600">Scoring Avanzato con Validazione IHC</p>
                                    </div>
                                </div>
                                <div className="flex flex-col items-start md:items-end gap-2">
                                    <span className="text-xs text-green-600 flex items-center gap-1">
                                        <span className="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                                        Salvataggio automatico
                                    </span>
                                    <button
                                        onClick={() => {
                                            if (confirm('Cancellare tutti i dati?')) {
                                                setPatientData({ age: '', gender: '', clinicalHistory: '', indication: '' });
                                                setSpecimens([{ id: 1, label: 'A', site: 'cieco', findings: {} }]);
                                                setIhcData({ cd3: '', cd68: '', cmv: 'assente', p53: '', cd20: 'assente', cd138: 'assente' });
                                                localStorage.removeItem('ibdAppDataV2');
                                            }
                                        }}
                                        className="text-xs text-red-600 hover:text-red-800 underline"
                                    >
                                        Reset dati
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg mb-6">
                            <div className="flex flex-col sm:flex-row border-b no-print">
                                {[
                                    { id: 'clinical', label: 'Dati Clinici', icon: <User /> },
                                    { id: 'specimens', label: 'Campioni', icon: <MapPin /> },
                                    { id: 'ihc', label: 'Immunoistochimica', icon: <Microscope /> },
                                    { id: 'diagnosis', label: 'Referto', icon: <FileText /> }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 font-semibold ${
                                            activeTab === tab.id ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'
                                        }`}
                                    >
                                        {tab.icon}
                                        <span className="text-sm sm:text-base">{tab.label}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="p-6">
                                {/* TAB DATI CLINICI */}
                                {activeTab === 'clinical' && (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p className="text-sm text-blue-800">
                                                <strong>Info:</strong> Questi dati compariranno nel referto finale.
                                            </p>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block font-semibold mb-2">Età</label>
                                                <input
                                                    type="number"
                                                    value={patientData.age}
                                                    onChange={(e) => setPatientData({...patientData, age: e.target.value})}
                                                    placeholder="Es. 45"
                                                    className="w-full px-4 py-2 border rounded-lg"
                                                />
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Sesso</label>
                                                <select
                                                    value={patientData.gender}
                                                    onChange={(e) => setPatientData({...patientData, gender: e.target.value})}
                                                    className="w-full px-4 py-2 border rounded-lg"
                                                >
                                                    <option value="">Seleziona...</option>
                                                    <option value="M">Maschio</option>
                                                    <option value="F">Femmina</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block font-semibold mb-2">Quesito Diagnostico / Indicazione Clinica</label>
                                            <textarea
                                                value={patientData.indication}
                                                onChange={(e) => setPatientData({...patientData, indication: e.target.value})}
                                                placeholder="Es. Sospetta IBD. Mapping colonoscopico."
                                                className="w-full px-4 py-3 border rounded-lg h-24"
                                            />
                                        </div>

                                        <div>
                                            <label className="block font-semibold mb-2">Storia Clinica (opzionale)</label>
                                            <textarea
                                                value={patientData.clinicalHistory}
                                                onChange={(e) => setPatientData({...patientData, clinicalHistory: e.target.value})}
                                                placeholder="Es. Pregressa RCU diagnosticata 5 anni fa..."
                                                className="w-full px-4 py-3 border rounded-lg h-32"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* TAB CAMPIONI */}
                                {activeTab === 'specimens' && (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start justify-between">
                                            <p className="text-sm text-blue-800">
                                                <strong>Campioni bioptici:</strong> Aggiungi le sedi anatomiche biopsiate e per ciascuna specifica i reperti istologici.
                                            </p>
                                            <button
                                                onClick={addSpecimen}
                                                className="ml-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold whitespace-nowrap"
                                            >
                                                + Aggiungi sede
                                            </button>
                                        </div>

                                        {specimens.map((specimen, idx) => (
                                            <div key={specimen.id} className="border-2 border-indigo-200 rounded-lg p-6 bg-indigo-50">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">
                                                            {specimen.label}
                                                        </div>
                                                        <select
                                                            value={specimen.site}
                                                            onChange={(e) => updateSpecimen(specimen.id, 'site', e.target.value)}
                                                            className="px-4 py-2 border-2 border-indigo-300 rounded-lg font-semibold"
                                                        >
                                                            {anatomicalSites.map(site => (
                                                                <option key={site.value} value={site.value}>{site.label}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    {specimens.length > 1 && (
                                                        <button
                                                            onClick={() => removeSpecimen(specimen.id)}
                                                            className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                                                        >
                                                            Rimuovi
                                                        </button>
                                                    )}
                                                </div>

                                                {Object.entries(findingsDatabase).map(([category, data]) => (
                                                    <div key={category} className={`border-2 ${data.color} rounded-lg p-4 mb-4`}>
                                                        <h4 className="font-bold mb-3">{data.title}</h4>
                                                        <div className="space-y-3">
                                                            {Object.entries(data.items).map(([key, item]) => {
                                                                const severity = getFindingSeverity(specimen.id, category, key);
                                                                return (
                                                                    <div key={key} className="bg-white rounded-lg border p-3">
                                                                        <div className="flex items-start gap-2 mb-2">
                                                                            <span className="font-semibold text-sm flex-1">{item.name}</span>
                                                                            {item.pathognomonic && (
                                                                                <span className="text-xs bg-red-600 text-white px-2 py-1 rounded font-bold">
                                                                                    PATOGNOMONICO
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                        <p className="text-xs text-gray-600 mb-2">{item.desc}</p>
                                                                        <div className="flex items-center gap-2">
                                                                            <select
                                                                                value={severity}
                                                                                onChange={(e) => updateFinding(specimen.id, category, key, e.target.value)}
                                                                                className="flex-1 px-2 py-1 border rounded text-sm"
                                                                            >
                                                                                <option value="assente">Assente</option>
                                                                                <option value="lieve">Lieve</option>
                                                                                <option value="moderata">Moderata</option>
                                                                                <option value="severa">Severa</option>
                                                                            </select>
                                                                            <div className={`px-3 py-1 text-xs font-bold rounded ${
                                                                                severity === 'assente' ? 'bg-gray-200' :
                                                                                severity === 'lieve' ? 'bg-green-200' :
                                                                                severity === 'moderata' ? 'bg-yellow-200' :
                                                                                'bg-red-200'
                                                                            }`}>
                                                                                {severity.toUpperCase()}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* TAB IMMUNOISTOCHIMICA */}
                                {activeTab === 'ihc' && (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p className="text-sm text-blue-800">
                                                <strong>Immunoistochimica:</strong> Inserisci i valori misurati. Il tool validherà i range biologici e avviserà su valori anomali.
                                            </p>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-6">
                                            {/* CD3 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD3 (/100 cellule)</label>
                                                <input
                                                    type="number"
                                                    value={ihcData.cd3}
                                                    onChange={(e) => updateIHC('cd3', e.target.value)}
                                                    placeholder="Es. 25"
                                                    min="0"
                                                    max="500"
                                                    className="w-full px-3 py-2 border rounded-lg mb-2"
                                                />
                                                <p className="text-xs text-gray-600 mb-2">Range normale: 5-300 /100 cellule</p>
                                                {warnings.cd3 && (
                                                    <div className="flex items-start gap-2 text-xs text-orange-700 bg-orange-50 p-2 rounded">
                                                        <AlertCircle />
                                                        <span>{warnings.cd3}</span>
                                                    </div>
                                                )}
                                                {!warnings.cd3 && ihcData.cd3 && (
                                                    <div className="flex items-start gap-2 text-xs text-green-700 bg-green-50 p-2 rounded">
                                                        <CheckCircle />
                                                        <span>Valore accettabile</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* CD68 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD68 - Macrofagi (%)</label>
                                                <input
                                                    type="number"
                                                    value={ihcData.cd68}
                                                    onChange={(e) => updateIHC('cd68', e.target.value)}
                                                    placeholder="Es. 15"
                                                    min="0"
                                                    max="100"
                                                    className="w-full px-3 py-2 border rounded-lg mb-2"
                                                />
                                                <p className="text-xs text-gray-600 mb-2">Range normale: 0-80%</p>
                                                {warnings.cd68 && (
                                                    <div className="flex items-start gap-2 text-xs text-orange-700 bg-orange-50 p-2 rounded">
                                                        <AlertCircle />
                                                        <span>{warnings.cd68}</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* CMV */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CMV - Citomegalovirus</label>
                                                <select
                                                    value={ihcData.cmv}
                                                    onChange={(e) => setIhcData({...ihcData, cmv: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="assente">Assente</option>
                                                    <option value="presente">Presente (positivo)</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">Superinfezione oppurtunistica</p>
                                            </div>

                                            {/* p53 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">p53 - Displasia (%)</label>
                                                <input
                                                    type="number"
                                                    value={ihcData.p53}
                                                    onChange={(e) => updateIHC('p53', e.target.value)}
                                                    placeholder="Es. 65"
                                                    min="0"
                                                    max="100"
                                                    className="w-full px-3 py-2 border rounded-lg mb-2"
                                                />
                                                <p className="text-xs text-gray-600 mb-2">Soglia displasia: {'>'} 50%</p>
                                                {warnings.p53 && (
                                                    <div className="flex items-start gap-2 text-xs text-orange-700 bg-orange-50 p-2 rounded">
                                                        <AlertCircle />
                                                        <span>{warnings.p53}</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* CD20 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD20 - Linfociti B</label>
                                                <select
                                                    value={ihcData.cd20}
                                                    onChange={(e) => setIhcData({...ihcData, cd20: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="assente">Assente / Scarsi</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="moderato">Moderato</option>
                                                    <option value="cospicuo">Cospicuo</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">Follicoli linfoidi B</p>
                                            </div>

                                            {/* CD138 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD138 - Plasmacellule</label>
                                                <select
                                                    value={ihcData.cd138}
                                                    onChange={(e) => setIhcData({...ihcData, cd138: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="assente">Assente</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="moderata">Moderata</option>
                                                    <option value="severa">Severa</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">Plasmacitosi - segno di cronicità</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* TAB REFERTO CON SCORING */}
                                {activeTab === 'diagnosis' && report && (
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center no-print mb-4">
                                            <h2 className="text-2xl font-bold">Referto Anatomopatologico</h2>
                                            <button
                                                onClick={printReport}
                                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold"
                                            >
                                                <Printer />
                                                Stampa
                                            </button>
                                        </div>

                                        {/* SCORING SECTION */}
                                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-indigo-300 rounded-lg p-6 no-print">
                                            <h3 className="text-lg font-bold mb-4 text-indigo-900">📊 Analisi Scoring Diagnostico</h3>
                                            <ConfidenceBar 
                                                crohn={report.scoring.crohn}
                                                uc={report.scoring.uc}
                                                ibdu={report.scoring.ibdu}
                                            />
                                        </div>

                                        <div className="print-only mb-6">
                                            <div className="border-b-2 pb-4 mb-4">
                                                <h1 className="text-2xl font-bold">U.O. ANATOMIA PATOLOGICA</h1>
                                                <p className="text-sm text-gray-600">Referto Istologico - IBD Diagnostic Tool v2.0</p>
                                            </div>
                                            {patientData.age && (
                                                <p><strong>Età:</strong> {patientData.age} anni</p>
                                            )}
                                            {patientData.gender && (
                                                <p><strong>Sesso:</strong> {patientData.gender === 'M' ? 'Maschio' : 'Femmina'}</p>
                                            )}
                                            {patientData.indication && (
                                                <p><strong>Quesito diagnostico:</strong> {patientData.indication}</p>
                                            )}
                                        </div>

                                        <div className="bg-white border-2 border-gray-300 rounded-lg p-6">
                                            <div className="mb-6">
                                                <h3 className="text-lg font-bold mb-3 text-indigo-800">MATERIALE PERVENUTO:</h3>
                                                <div className="bg-gray-50 p-4 rounded">
                                                    {report.materialReceived.map((item, idx) => (
                                                        <p key={idx} className="mb-1">• {item}</p>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="mb-6">
                                                <h3 className="text-lg font-bold mb-3 text-indigo-800">DIAGNOSI:</h3>
                                                <div className="space-y-3">
                                                    {report.diagnoses.map((diag, idx) => (
                                                        <div key={idx} className="bg-blue-50 p-4 rounded border-l-4 border-indigo-600">
                                                            <p className="font-bold text-indigo-900 mb-1">
                                                                {diag.labels} ({diag.site}):
                                                            </p>
                                                            <p className="text-gray-800">{diag.diagnosis}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="text-lg font-bold mb-3 text-indigo-800">COMMENTO:</h3>
                                                <div className="bg-yellow-50 p-4 rounded border-l-4 border-yellow-600">
                                                    <p className="text-gray-800">Quadro istologico analizzato con sistema di scoring ponderato. Confidenza diagnostica: Crohn {report.scoring.crohn}%, UC {report.scoring.uc}%, IBD-U {report.scoring.ibdu}%.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4 no-print">
                                            <p className="text-sm">
                                                <strong>Disclaimer:</strong> Questo referto è generato automaticamente dal sistema di scoring v2.0. La diagnosi definitiva richiede sempre correlazione clinica, endoscopica e sierologica. Validare sempre i range IHC secondo gli standard locali del laboratorio.
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="text-center text-xs text-gray-600 space-y-1 no-print">
                            <p className="font-semibold">IBD Diagnostic Tool v2.0 - Scoring Avanzato con Validazione IHC</p>
                            <p>Basato su: ECCO Guidelines | WHO Classification 5th Ed | Montreal Classification | Evidence-Based IHC Cutoffs</p>
                            <p className="text-green-600">✓ Salvataggio automatico nel browser | ✓ Compatibile Mac/Windows/Android | ✓ Offline-ready</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<IBDDiagnosticTool />, document.getElementById('root'));
    </script>
</body>
</html>
