<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Diagnostic Tool v3.0.8 "Lean Expert"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font uniforme per tutto il referto */
        body, body *, h1, h2, h3, h4, h5, h6, p, div, span, td, th, li, button, input, select {
            font-family: Arial, sans-serif !important;
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-after: always; }
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
            border-bottom: 3px solid #1d4ed8;
        }
        .tab-disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            width: calc(100% - 20px);
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            flex-shrink: 0;
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .modal-footer {
            flex-shrink: 0;
        }
        .sintesi-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
        }
        .copy-btn:active {
            transform: scale(0.95);
        }
        .locked-banner {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #dc2626;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #dc2626; }
            50% { border-color: #991b1b; }
        }
        .mega-reset-btn {
            animation: pulse-glow 1.5s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 10px #dc2626, 0 0 20px #dc2626;
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 20px #dc2626, 0 0 40px #dc2626;
                transform: scale(1.05);
            }
        }
        .epistemic-note {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <!-- Modal Disclaimer Iniziale -->
    <div id="disclaimer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header bg-red-600 text-white p-4 rounded-t-xl">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <span>STRUMENTO DI SUPPORTO DIAGNOSTICO</span>
                </h2>
            </div>
            <div class="modal-body p-4 space-y-3">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3">
                    <p class="font-bold mb-1 text-yellow-900">
                        ATTENZIONE: Questo tool NON sostituisce
                    </p>
                    <ul class="list-disc ml-5 space-y-1 text-yellow-800 text-sm">
                        <li>Il ragionamento istopatologico del medico</li>
                        <li>L'integrazione con dati clinici ed endoscopici</li>
                        <li>L'esperienza diagnostica in IBD</li>
                        <li>Il giudizio professionale individuale</li>
                    </ul>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-3">
                    <p class="font-semibold text-blue-900 mb-1">
                        Lo scoring percentuale √®:
                    </p>
                    <ul class="list-disc ml-5 space-y-1 text-blue-800 text-sm">
                        <li><strong>PURAMENTE ORIENTATIVO</strong> e non diagnostico</li>
                        <li><strong>NON VALIDATO</strong> prospetticamente</li>
                        <li>Basato su criteri di letteratura ma <strong>non standardizzato</strong></li>
                        <li>Da interpretare SEMPRE nel contesto clinico completo</li>
                    </ul>
                </div>

                <div class="bg-green-50 border-l-4 border-green-500 p-3">
                    <p class="font-semibold text-green-900 mb-1">
                        Uso consigliato:
                    </p>
                    <p class="text-green-800 text-sm">
                        Patologi con esperienza in IBD, come supporto alla diagnosi differenziale 
                        in contesto di studio multidisciplinare integrato.
                    </p>
                </div>

                <div class="bg-gray-100 p-3 rounded">
                    <p class="text-xs text-gray-700 italic">
                        v3.0.8 "Lean Expert": Griglia selezione sedi + bottone "Seleziona Tutti" (7 sedi standard).
                    </p>
                </div>
            </div>
            <div class="modal-footer p-4 bg-gray-50 rounded-b-xl">
                <button 
                    onclick="acceptDisclaimer()"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                >
                    Ho capito, procedi ‚Üí
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <!-- Header -->
        <div class="mb-4 border-b pb-4">
            <h1 class="text-3xl font-bold text-blue-900 mb-2">
                IBD Diagnostic Tool <span class="text-lg text-gray-600">v3.0.8 "Lean Expert"</span>
            </h1>
            <p class="text-sm text-gray-600">
                Supporto diagnosi differenziale Malattie Infiammatorie Croniche Intestinali (IBD)
            </p>
            <p class="text-xs text-gray-500 mt-1">
                v3.0.6: Watermark simulazione didattica + "Seleziona Tutti" (7 sedi standard, escluse pouch/anastomosi)
            </p>
        </div>

        <!-- Banner Locked (v3.0.1 - Fase 2) -->
        <div id="locked-banner" class="hidden locked-banner rounded-lg p-4 mb-6 no-print shadow-lg">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 flex-1">
                    <span class="text-4xl">üîí</span>
                    <div>
                        <p class="font-bold text-red-900 text-lg">
                            DIAGNOSI COMPLETATA - CASO BLOCCATO
                        </p>
                        <p class="text-sm text-red-800">
                            Per prevenire contaminazione dati tra casi consecutivi, i campi sono bloccati dopo generazione referto.
                        </p>
                    </div>
                </div>
                <button 
                    onclick="confirmReset()"
                    class="mega-reset-btn bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all"
                >
                    üîì SBLOCCA<br>NUOVO CASO
                </button>
            </div>
        </div>

        <!-- Banner Permanente Warning -->
        <div class="mb-6 bg-gradient-to-r from-yellow-400 to-orange-400 border-2 border-orange-500 rounded-lg p-4 no-print shadow-md">
            <div class="flex items-center gap-3">
                <span class="text-3xl">‚ö†Ô∏è</span>
                <div class="flex-1">
                    <p class="font-bold text-gray-900 text-sm">
                        TOOL DIAGNOSTICO: Uso riservato a patologi esperti in IBD
                    </p>
                    <p class="text-xs text-gray-800">
                        Scoring orientativo, NON sostitutivo del ragionamento clinico-patologico | 
                        Validazione prospettica assente
                    </p>
                </div>
            </div>
        </div>

        <!-- Main App Container -->
        <div id="main-content"></div>
    </div>

    <script>
        // ==================== CONFIGURAZIONE ====================
        const APP_VERSION = '3.0.8';
        const STORAGE_KEY = 'ibdAppDataV305';
        const DISCLAIMER_KEY = 'ibdDisclaimerAccepted';

        // ==================== STATE ====================
        let specimens = [];
        let ihcData = {
            cd68_pattern: 'non_eseguito',
            p53_pattern: 'non_eseguito',
            cmv_status: 'non_eseguito'
        };
        
        let ibdNota = {
            enabled: false,
            diagnosiIniziale: null,
            diagnosiAttuale: null,
            therapyOngoing: false
        };
        
        let altreColiti = {
            banda_collagene: 'assente',
            banda_collagene_um: null,  // Spessore in Œºm
            iel_aumentati: 'assente',
            iel_count: null,  // Valore numerico IEL/100 cellule epiteliali
            pattern_superficiale: false,
            architettura_conservata: false,
            atrofia_ischemica: false,
            membrane_ialine: false,
            emorragia_recente: false,
            apoptosi_cripte: 'assente',
            ulcere_diaframma: false
        };
        
        let activeTab = 'campioni';
        let currentSite = 'ileo';
        let selectedSites = [];
        let multiSiteMode = false;
        
        let diagnosiVeloce = {
            selected: null,
            testo: null,
            gradoManuale: null,
            autoGenerated: false  // Punto 2 ChatGPT: traccia findings auto-generati
        };

        let caseLocked = false;
        let reportGenerated = false;
        let editingSpecimenIndex = null;  // Per editing singoli campioni
        

        // ==================== v3.0.4 FIX: UNLOCK CASE (FUNZIONA OVUNQUE) ====================
        
        const unlockCase = () => {
            console.log('üîì unlockCase() v3.0.4 - Reset MANUALE (no reload)');
            
            // 1. Clear localStorage
            try {
                localStorage.removeItem(STORAGE_KEY);
                console.log('üóëÔ∏è localStorage CLEARED');
            } catch(e) {
                console.warn('localStorage clear failed:', e);
            }
            
            // 2. Reset TUTTE le variabili di stato
            specimens = [];
            ihcData = {
                cd68_pattern: 'non_eseguito',
                p53_pattern: 'non_eseguito',
                cmv_status: 'non_eseguito'
            };
            ibdNota = {
                enabled: false,
                diagnosiIniziale: null,
                diagnosiAttuale: null,
                therapyOngoing: false
            };
            altreColiti = {
                banda_collagene: 'assente',
                banda_collagene_um: null,
                iel_aumentati: 'assente',
                iel_count: null,
                pattern_superficiale: false,
                architettura_conservata: false,
                atrofia_ischemica: false,
                membrane_ialine: false,
                emorragia_recente: false,
                apoptosi_cripte: 'assente',
                ulcere_diaframma: false
            };
            diagnosiVeloce = {
                selected: null,
                testo: null,
                gradoManuale: null,
                autoGenerated: false  // Fix ChatGPT: reset simmetrico
            };
            selectedSites = [];
            multiSiteMode = false;
            activeTab = 'campioni';
            currentSite = 'ileo';
            
            // 3. CRITICO: Reset lock flags
            caseLocked = false;
            reportGenerated = false;
            editingSpecimenIndex = null;
            
            console.log('‚úÖ Variabili resettate, caseLocked =', caseLocked);
            
            // 4. Salva stato PULITO
            saveData();
            
            // 5. Nascondi banner locked
            const banner = document.getElementById('locked-banner');
            if (banner) {
                banner.classList.add('hidden');
                console.log('‚úÖ Banner nascosto');
            }
            
            // 6. Re-render UI
            render();
            
            console.log('üéâ unlockCase() v3.0.4 COMPLETATO');
        };

        const lockCase = () => {
            if (specimens.length > 0 && !caseLocked) {
                caseLocked = true;
                reportGenerated = true;
                document.getElementById('locked-banner').classList.remove('hidden');
                saveData();
            }
        };

        // Sblocca per modifiche SENZA cancellare dati
        const unlockForEdit = () => {
            caseLocked = false;
            reportGenerated = false;
            activeTab = 'campioni';
            document.getElementById('locked-banner').classList.add('hidden');
            saveData();
            render();
        };

        const confirmReset = () => {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questo canceller√† TUTTI i dati del caso attuale.\n\nSei sicuro di voler procedere con il reset?')) {
                unlockCase();
            }
        };

        const ResetButton = () => {
            if (caseLocked) return '';
            
            return `
                <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-lg p-4 mb-6 shadow-lg">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üîÑ</span>
                            <div>
                                <p class="font-bold text-white text-lg">
                                    Vuoi iniziare un nuovo caso?
                                </p>
                                <p class="text-sm text-white/90">
                                    Click qui per resettare tutti i dati e ricominciare da zero
                                </p>
                            </div>
                        </div>
                        <button 
                            onclick="confirmReset()"
                            class="bg-white text-red-600 px-8 py-4 rounded-lg font-bold hover:bg-red-50 transition-all shadow-md text-lg"
                        >
                            üóëÔ∏è RESET<br>COMPLETO
                        </button>
                    </div>
                </div>
            `;
        };

        // ==================== v3.0.2 FIX #1: TOPOGRAFIA CORRETTA ====================
        
        const hasInflammatoryFindings = (specimen) => {
            const f = specimen.findings;
            const siteType = specimen.siteType || 'colon';
            
            if (siteType === 'ileum') {
                return (
                    f.granulomi_epitelioidi === 'presente' ||
                    f.granulomi_epitelioidi === 'sospetti' ||
                    f.neutrofili_lamina_propria !== 'assente' ||
                    f.erosioni_ulcerazioni === 'presente' ||
                    f.iperplasia_linfoide === 'presente' ||
                    f.edema_lamina_propria === 'presente' ||
                    f.plasmacellule_aumentate === 'presente'
                );
            } else {
                return (
                    f.granulomi_epitelioidi === 'presente' ||
                    f.granulomi_epitelioidi === 'sospetti' ||
                    f.neutrofili_epitelio !== 'assente' ||
                    f.ascessi_criptici === 'presente' ||
                    f.plasmacellule_basale === 'presente' ||
                    f.distorsione_architettura === 'presente' ||
                    f.metaplasia_paneth === 'presente' ||
                    f.ulcerazione === 'presente'
                );
            }
        };

        // ==================== IBD NOTA HANDLERS ====================
        const toggleIbdNota = (enabled) => {
            if (caseLocked) return;
            ibdNota.enabled = enabled;
            if (!enabled) {
                ibdNota.diagnosiIniziale = null;
                ibdNota.diagnosiAttuale = null;
                ibdNota.therapyOngoing = false;
            }
            saveData();
            render();
        };

        const updateIbdNota = (field, value) => {
            if (caseLocked) return;
            if (field === 'therapyOngoing') {
                ibdNota[field] = value;
            } else {
                ibdNota[field] = value || null;
            }
            saveData();
            render();
        };

        // ==================== NANCY PER CAMPIONE ====================
        const calculateNancyPerSpecimen = (specimen) => {
            if (specimen.siteType === 'ileum') return null;
            
            const f = specimen.findings;
            
            if (f.ulcerazione === 'presente') return 4;
            
            if (f.neutrofili_epitelio === 'marcata' || 
                f.neutrofili_epitelio === 'moderata' || 
                f.ascessi_criptici === 'presente') {
                return 3;
            }
            
            if (f.neutrofili_epitelio === 'lieve') return 2;
            
            if (f.distorsione_architettura === 'presente' || 
                f.plasmacellule_basale === 'presente' ||
                f.metaplasia_paneth === 'presente') {
                return 1;
            }
            
            return 0;
        };

        const isSpecimenActive = (specimen) => {
            const f = specimen.findings;
            
            if (specimen.siteType === 'ileum') {
                return f.neutrofili_lamina_propria !== 'assente' ||
                       f.erosioni_ulcerazioni === 'presente';
            } else {
                return f.neutrofili_epitelio !== 'assente' ||
                       f.ascessi_criptici === 'presente' ||
                       f.ulcerazione === 'presente';
            }
        };

        const generateSintesiEndoscopista = () => {
            if (specimens.length === 0) return null;
            
            const isFollowUp = ibdNota.enabled && ibdNota.diagnosiAttuale;
            const diagnosiAttuale = ibdNota.diagnosiAttuale;
            const diagnosiIniziale = ibdNota.diagnosiIniziale;
            
            const colonSpecs = specimens.filter(s => s.siteType !== 'ileum');
            
            let sediAttive = [];
            let sediQuiescenti = [];
            let nancyMax = 0;
            
            if (diagnosiAttuale === 'RCU') {
                colonSpecs.forEach(spec => {
                    const nancy = calculateNancyPerSpecimen(spec);
                    if (nancy >= 2) {
                        sediAttive.push({ site: spec.site, nancy });
                    } else {
                        sediQuiescenti.push({ site: spec.site, nancy });
                    }
                    if (nancy > nancyMax) nancyMax = nancy;
                });
            } else {
                specimens.forEach(spec => {
                    if (isSpecimenActive(spec)) {
                        sediAttive.push({ site: spec.site });
                    } else {
                        sediQuiescenti.push({ site: spec.site });
                    }
                });
                
                colonSpecs.forEach(spec => {
                    const nancy = calculateNancyPerSpecimen(spec);
                    if (nancy > nancyMax) nancyMax = nancy;
                });
            }
            
            const displasiaFindings = colonSpecs
                .filter(s => s.findings.displasia && s.findings.displasia !== 'assente')
                .map(s => ({ site: s.site, grado: s.findings.displasia }));
            
            const hasDisplasia = displasiaFindings.length > 0;
            const maxDisplasia = hasDisplasia ? 
                (displasiaFindings.some(d => d.grado === 'HGD') ? 'HGD' : 
                 displasiaFindings.some(d => d.grado === 'LGD') ? 'LGD' : 'IND') : null;
            
            return {
                isFollowUp,
                diagnosiAttuale,
                diagnosiIniziale,
                sediAttive: sediAttive.map(s => s.site),
                sediQuiescenti: sediQuiescenti.map(s => s.site),
                nancyMax: diagnosiAttuale === 'RCU' ? nancyMax : null,
                hasDisplasia,
                maxDisplasia,
                displasiaDetails: displasiaFindings,
                p53Aberrante: ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null'
            };
        };

        const updateFormSite = (newSite) => {
            if (caseLocked) return;
            currentSite = newSite;
            render();
        };

        const updateAltreColiti = (field, value) => {
            if (caseLocked) return;
            altreColiti[field] = value;
            // Se IEL tornano normali, resetta anche il count
            if (field === 'iel_aumentati' && value === 'assente') {
                altreColiti.iel_count = null;
            }
            // Se banda collagene torna assente, resetta anche lo spessore
            if (field === 'banda_collagene' && value === 'assente') {
                altreColiti.banda_collagene_um = null;
            }
            saveData();
            render();
        };

        const diagnosiVeloceOptions = [
            { codice: 'NORMALE', emoji: 'üü¢', label: 'Normale', testo: 'Mucosa colica/ileale istologicamente nella norma.', gruppo: 'ibd' },
            { codice: 'PROCTITE_UC', emoji: 'üîµ', label: 'Proctite ulcerosa', testo: 'Proctite cronica attiva, pattern morfologico compatibile con proctite ulcerosa.', gruppo: 'ibd' },
            { codice: 'COLITE_SINISTRA_UC', emoji: 'üîµ', label: 'Colite ulcerosa sinistra', testo: 'Colite cronica attiva con distribuzione sinistra, pattern morfologico compatibile con rettocolite ulcerosa sinistra.', gruppo: 'ibd' },
            { codice: 'PANCOLITE_UC', emoji: 'üîµ', label: 'Pancolite ulcerosa', testo: 'Pancolite cronica attiva con distribuzione continua, pattern morfologico compatibile con rettocolite ulcerosa estesa. Ileo terminale indenne.', gruppo: 'ibd' },
            { codice: 'IBD_REMISSIONE', emoji: 'üü°', label: 'IBD in remissione', testo: 'Colite cronica in fase di remissione istologica. Persistono alterazioni architetturali residue. Assenza di attivit√† infiammatoria acuta.', gruppo: 'ibd' },
            { codice: 'ILEITE_NAS', emoji: 'üü†', label: 'Ileite NAS', testo: 'Ileite cronica attiva. Pattern aspecifico, da correlare con dati clinici ed endoscopici (DD: Crohn, infettiva, ischemica, FANS).', gruppo: 'ibd' },
            { codice: 'CROHN_LIKE', emoji: 'üü£', label: 'Malattia di Crohn probabile', testo: 'Colite cronica attiva con pattern morfologico suggestivo per malattia di Crohn. Correlare con clinica ed endoscopia.', gruppo: 'ibd' },
            { codice: 'COLITE_COLLAGENA', emoji: 'üî¨', label: 'Colite collagenosica', testo: 'Colite microscopica, tipo collagenosica. Banda collagene subepiteliale ispessita (‚â•10Œºm). Architettura ghiandolare conservata.', gruppo: 'altre' },
            { codice: 'COLITE_LINFOCITICA', emoji: 'üî¨', label: 'Colite Linfocitica', testo: 'Colite microscopica, tipo linfocitica. Linfociti intraepiteliali aumentati (‚â•20/100 cellule epiteliali). Architettura ghiandolare conservata.', gruppo: 'altre' },
            { codice: 'COLITE_INFETTIVA', emoji: 'ü¶†', label: 'Colite Infettiva', testo: 'Colite acuta con pattern superficiale e architettura conservata, compatibile con eziologia infettiva. Correlare con coprocoltura e clinica.', gruppo: 'altre' },
            { codice: 'COLITE_ISCHEMICA', emoji: 'üíî', label: 'Colite Ischemica', testo: 'Colite con pattern ischemico (atrofia cripte, membrane ialine, emorragia lamina propria). Correlare con sede e fattori di rischio cardiovascolare.', gruppo: 'altre' },
            { codice: 'COLITE_FANS', emoji: 'üíä', label: 'Colite da FANS', testo: 'Colite/enteropatia da FANS. Apoptosi cripte aumentata e/o ulcere a diaframma. Confermare anamnesi farmacologica.', gruppo: 'altre' },
            { codice: 'SCAD', emoji: 'üîò', label: 'SCAD', testo: 'Colite cronica segmentale associata a diverticolosi (SCAD). Flogosi cronica attiva limitata al segmento con diverticoli, retto indenne. Escludere IBD.', gruppo: 'altre' }
        ];

        const selectDiagnosiVeloce = (codice) => {
            if (caseLocked) return;
            if (diagnosiVeloce.selected === codice) {
                diagnosiVeloce.selected = null;
                diagnosiVeloce.testo = null;
                diagnosiVeloce.gradoManuale = null;
            } else {
                const opt = diagnosiVeloceOptions.find(o => o.codice === codice);
                diagnosiVeloce.selected = codice;
                diagnosiVeloce.testo = opt ? opt.testo : null;
                diagnosiVeloce.gradoManuale = null;
            }
            saveData();
            render();
        };

        const clearDiagnosiVeloce = () => {
            if (caseLocked) return;
            diagnosiVeloce.selected = null;
            diagnosiVeloce.testo = null;
            diagnosiVeloce.gradoManuale = null;
            saveData();
            render();
        };

        const updateGradoManuale = (grado) => {
            if (caseLocked) return;
            diagnosiVeloce.gradoManuale = grado === '' ? null : parseInt(grado);
            saveData();
            render();
        };

        const toggleMucinCheckbox = (site, siteIndex, granulomaValue) => {
            const container = document.getElementById(`mucin-checkbox-container-${siteIndex}`);
            const checkbox = document.getElementById(`mucin-granuloma-checkbox-${siteIndex}`);
            if (!container) return;
            
            if (granulomaValue === 'presente' || granulomaValue === 'sospetti') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                if (checkbox) checkbox.checked = false;
            }
        };

        const toggleMucinCheckboxSingle = (granulomaValue) => {
            const container = document.getElementById('mucin-checkbox-container-single');
            const checkbox = document.getElementById('mucin-granuloma-checkbox-single');
            if (!container) return;
            
            if (granulomaValue === 'presente' || granulomaValue === 'sospetti') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                if (checkbox) checkbox.checked = false;
            }
        };

        const switchToMultiSiteMode = () => {
            if (caseLocked) return;
            multiSiteMode = true;
            selectedSites = [];
            saveData();
            render();
        };

        const toggleSiteSelection = (site, checked) => {
            if (caseLocked) return;
            if (checked) {
                if (!selectedSites.includes(site)) {
                    selectedSites.push(site);
                }
            } else {
                selectedSites = selectedSites.filter(s => s !== site);
            }
            
            saveData();
            render(); // Aggiorna UI per mostrare/nascondere pannello diagnosi
        };

        const confirmSiteSelection = () => {
            if (caseLocked || selectedSites.length === 0) return;
            // Passa alla modalit√† compilazione manuale
            multiSiteMode = true;
            saveData();
            render();
        };

        const cancelMultiSiteMode = () => {
            if (caseLocked) return;
            multiSiteMode = false;
            selectedSites = [];
            saveData();
            render();
        };

        const addAllSpecimens = () => {
            if (caseLocked) return;
            
            selectedSites.forEach((site, siteIndex) => {
                const isIleum = (site === 'ileo');
                const findings = {};
                
                const findingKeys = isIleum ? [
                    'granulomi_epitelioidi', 'neutrofili_lamina_propria', 
                    'erosioni_ulcerazioni', 'iperplasia_linfoide',
                    'edema_lamina_propria', 'atrofia_villi', 
                    'plasmacellule_aumentate', 'fibrosi_sottomucosa'
                ] : [
                    'granulomi_epitelioidi', 'neutrofili_epitelio', 'ascessi_criptici',
                    'plasmacellule_basale', 'distorsione_architettura', 'metaplasia_paneth',
                    'ulcerazione', 'fibrosi_sottomucosa', 'displasia'
                ];

                findingKeys.forEach(key => {
                    const element = document.getElementById(`finding-${siteIndex}-${key}`);
                    if (element) findings[key] = element.value;
                });

                const mucinCheckbox = document.getElementById(`mucin-granuloma-checkbox-${siteIndex}`);
                const mucinGranulomaLikely = mucinCheckbox && mucinCheckbox.checked;

                specimens.push({ 
                    site, 
                    findings, 
                    siteType: isIleum ? 'ileum' : 'colon',
                    mucinGranulomaLikely: mucinGranulomaLikely || false
                });
            });
            
            multiSiteMode = false;
            selectedSites = [];
            
            saveData();
            render();
        };


        // ==================== DISCLAIMER MODAL ====================
        const checkDisclaimer = () => {
            const accepted = localStorage.getItem(DISCLAIMER_KEY);
            if (!accepted) {
                document.getElementById('disclaimer-modal').classList.remove('hidden');
            }
        };

        const acceptDisclaimer = () => {
            localStorage.setItem(DISCLAIMER_KEY, 'true');
            document.getElementById('disclaimer-modal').classList.add('hidden');
        };

        // ==================== HELPER FUNCTIONS ====================
        // ChatGPT: shouldShowNancy ora restituisce oggetto con warning opzionale
        const shouldShowNancy = () => {
            // No granulomi veri (esclude Crohn)
            const hasGranulomas = specimens.some(s => 
                s.findings.granulomi_epitelioidi === 'presente' && !s.mucinGranulomaLikely
            );
            if (hasGranulomas) return { show: false, warning: null };
            
            // Verifica se ileo √® coinvolto (non solo presente)
            const ileumSpecimens = specimens.filter(s => s.siteType === 'ileum');
            const ileumInvolved = ileumSpecimens.some(s => 
                s.findings.erosioni_ulcerazioni === 'presente' ||
                s.findings.granulomi_epitelioidi !== 'assente' ||
                s.findings.neutrofili_lamina_propria !== 'assente'
            );
            if (ileumInvolved) return { show: false, warning: null };
            
            // Verifica skip lesions (pattern Crohn)
            const topoPattern = analyzeTopographicPattern();
            if (topoPattern.skipLesions) return { show: false, warning: null };
            
            // Verifica che pattern sia UC-like: RCU > Crohn
            const scoring = calculateScoring();
            
            // ChatGPT: se Crohn > UC ma niente granulomi/ileite, mostra Nancy CON warning
            if (scoring.scores.crohn > scoring.scores.uc) {
                return { 
                    show: true, 
                    warning: 'Nancy calcolato ma pattern complessivo non UC-classico (score Crohn > RCU). Interpretare con cautela.'
                };
            }
            
            // Solo colon con pattern UC-like
            return { show: true, warning: null };
        };

        const calculateNancyIndex = () => {
            const nancyDecision = shouldShowNancy();
            
            // Forza calcolo Nancy se diagnosi veloce UC
            const forceNancy = diagnosiVeloce.selected && 
                ['PROCTITE_UC', 'COLITE_SINISTRA_UC', 'PANCOLITE_UC', 'IBD_REMISSIONE'].includes(diagnosiVeloce.selected);
            
            if (!nancyDecision.show && !forceNancy) {
                return { score: null, interpretation: null, applicable: false, warning: null };
            }

            let nancyScore = 0;
            let hasUlceration = false;
            let hasCryptAbscesses = false;
            let neutrophilSeverity = 'assente';
            
            // Fix ChatGPT: ranking numerico per upgrade corretto
            const neutRank = { assente: 0, lieve: 1, moderata: 2, marcata: 3 };

            const colonSpecimens = specimens.filter(s => s.siteType !== 'ileum');

            colonSpecimens.forEach(specimen => {
                if (specimen.findings.ulcerazione === 'presente') hasUlceration = true;
                if (specimen.findings.ascessi_criptici === 'presente') hasCryptAbscesses = true;
                
                const neutLevel = specimen.findings.neutrofili_epitelio;
                if (neutRank[neutLevel] > neutRank[neutrophilSeverity]) {
                    neutrophilSeverity = neutLevel;
                }
            });

            if (hasUlceration) {
                nancyScore = 4;
            } else if (neutrophilSeverity === 'marcata' || neutrophilSeverity === 'moderata' || hasCryptAbscesses) {
                nancyScore = 3;
            } else if (neutrophilSeverity === 'lieve') {
                nancyScore = 2;
            } else {
                const hasChronicChanges = colonSpecimens.some(s => 
                    s.findings.distorsione_architettura === 'presente' ||
                    s.findings.plasmacellule_basale === 'presente'
                );
                nancyScore = hasChronicChanges ? 1 : 0;
            }

            const getNancyInterpretation = (score) => {
                // Fix ChatGPT: rimosse % pseudo-precise, solo etichette qualitative
                const interpretations = {
                    0: { label: 'Remissione completa', description: 'Assenza di attivit√† e alterazioni croniche', prognosis: 'Eccellente. Basso rischio recidiva.' },
                    1: { label: 'Remissione con alterazioni croniche', description: 'Alterazioni architetturali senza attivit√† acuta', prognosis: 'Buona. Rischio recidiva moderato.' },
                    2: { label: 'Attivit√† lieve', description: 'Infiltrato neutrofilo lieve senza ulcerazione', prognosis: 'Rischio recidiva aumentato. Monitoraggio clinico.' },
                    3: { label: 'Attivit√† moderata', description: 'Infiltrato neutrofilo moderato-severo o ascessi criptici', prognosis: 'Rischio recidiva elevato. Considerare escalation terapeutica.' },
                    4: { label: 'Attivit√† severa con ulcerazione', description: 'Ulcerazione mucosa presente', prognosis: 'Rischio recidiva molto elevato. Terapia intensiva necessaria.' }
                };
                return interpretations[score] || interpretations[0];
            };

            return {
                score: nancyScore,
                interpretation: getNancyInterpretation(nancyScore),
                applicable: true,
                warning: nancyDecision.warning,  // ChatGPT: warning se pattern non UC-classico
                details: { hasUlceration, hasCryptAbscesses, neutrophilSeverity }
            };
        };

        // ==================== PATTERN TOPOGRAFICO ====================
        const analyzeTopographicPattern = () => {
            const sites = specimens.map(s => s.site);
            const sitesWithFindings = specimens.filter(hasInflammatoryFindings).map(s => s.site);
            
            let pattern = {
                rectumSampled: sites.includes('retto'),
                rectumInvolved: sitesWithFindings.includes('retto'),
                ileumSampled: sites.includes('ileo'),
                ileumInvolved: sitesWithFindings.includes('ileo'),
                skipLesions: false,
                skipLesionsIndeterminate: false,  // ChatGPT: flag per campionamento incompleto
                continuity: 'sconosciuta',
                warning: null
            };
            
            const detectSkipLesions = () => {
                const colonOrder = ['cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];
                const findingsIndices = sitesWithFindings
                    .filter(s => colonOrder.includes(s))
                    .map(s => colonOrder.indexOf(s))
                    .sort((a, b) => a - b);
                
                if (findingsIndices.length < 2) return { skip: false, indeterminate: false };
                
                for (let i = 1; i < findingsIndices.length; i++) {
                    const gap = findingsIndices[i] - findingsIndices[i-1];
                    if (gap > 1) {
                        // ChatGPT: controlla se le sedi intermedie sono state campionate
                        let missingSamples = false;
                        for (let j = findingsIndices[i-1] + 1; j < findingsIndices[i]; j++) {
                            if (!sites.includes(colonOrder[j])) {
                                missingSamples = true;
                                break;
                            }
                        }
                        if (missingSamples) {
                            return { skip: false, indeterminate: true };  // Campioni mancanti, non possiamo dire
                        }
                        return { skip: true, indeterminate: false };  // Vera skip lesion
                    }
                }
                return { skip: false, indeterminate: false };
            };
            
            const skipResult = detectSkipLesions();
            pattern.skipLesions = skipResult.skip;
            pattern.skipLesionsIndeterminate = skipResult.indeterminate;
            pattern.continuity = skipResult.skip ? 'discontinua' : (skipResult.indeterminate ? 'indeterminabile' : 'continua');
            
            if (pattern.rectumSampled && pattern.rectumInvolved && !pattern.skipLesions && !pattern.ileumInvolved) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico RCU-like: Retto coinvolto, distribuzione continua, ileo non coinvolto";
            } else if (pattern.skipLesionsIndeterminate) {
                // ChatGPT: campionamento incompleto
                pattern.warning = "‚ö†Ô∏è Campionamento incompleto: Sedi intermedie non campionate. Continuit√†/discontinuit√† NON valutabile. Completare mapping endoscopico.";
            } else if (pattern.skipLesions || (pattern.ileumInvolved && !pattern.rectumInvolved)) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico Crohn-like: Distribuzione discontinua e/o ileo coinvolto con retto risparmiato";
            } else if (!pattern.rectumSampled) {
                pattern.warning = "‚ÑπÔ∏è Retto non campionato: Valutazione pattern topografico limitata";
            } else if (pattern.rectumSampled && !pattern.rectumInvolved && sitesWithFindings.length > 0) {
                if (ibdNota.therapyOngoing) {
                    pattern.warning = "‚ÑπÔ∏è Retto risparmiato in paziente in terapia: Non esclude RCU (retto pu√≤ normalizzarsi in terapia)";
                } else {
                    pattern.warning = "‚ö†Ô∏è Retto risparmiato: Atipico per RCU classica";
                }
            }
            
            return pattern;
        };

        // ==================== SCORING IBDU INDIPENDENTE ====================
        
        const calculateIBDUScore = (rawScores, topoPattern) => {
            let ibduScore = 0;
            
            // Fix ChatGPT: escludi mucin granuloma dal conteggio IBDU
            const hasGranulomas = specimens.some(s => 
                s.findings.granulomi_epitelioidi === 'presente' && !s.mucinGranulomaLikely
            );
            const hasUCPattern = specimens.some(s => 
                s.findings.plasmacellule_basale === 'presente' || 
                s.findings.distorsione_architettura === 'presente'
            );
            
            if (hasGranulomas && hasUCPattern) ibduScore += 60;
            if (topoPattern.skipLesions && hasUCPattern) ibduScore += 50;
            // Fix: rectumSpared non esiste, usare logica esplicita
            if (topoPattern.rectumSampled && !topoPattern.rectumInvolved && hasUCPattern) ibduScore += 40;
            
            // Fix ChatGPT 2.2: Rimosso trigger "low score = IBDU"
            // IBDU deve emergere da CONTRADDIZIONE, non da debolezza
            // if (rawScores.crohn < 50 && rawScores.uc < 50) ibduScore += 80; // RIMOSSO
            
            // Score Crohn/UC molto vicini con evidenza di infiammazione = IBDU
            if (Math.abs(rawScores.crohn - rawScores.uc) < 20 && rawScores.crohn > 30) ibduScore += 70;
            
            return ibduScore;
        };

        // Etichette qualitative per scoring (punto 1 ChatGPT)
        const getScoreLabel = (score) => {
            if (score >= 80) return { text: 'Forte', class: 'bg-red-100 text-red-800' };
            if (score >= 60) return { text: 'Compatibile', class: 'bg-orange-100 text-orange-800' };
            if (score >= 40) return { text: 'Borderline', class: 'bg-yellow-100 text-yellow-800' };
            return { text: 'Basso', class: 'bg-gray-100 text-gray-600' };
        };
        
        // Flag MDT automatico (punto 4 ChatGPT)
        const shouldFlagMDT = (report) => {
            // Fix ChatGPT 2.1: Niente MDT per simulazioni
            if (report.metadata && report.metadata.simulation) {
                return null;
            }
            
            const reasons = [];
            
            // Pattern contraddittorio
            if (report.contradictoryNotes && report.contradictoryNotes.length > 0) {
                reasons.push('Pattern contraddittorio');
            }
            
            // IBDU alto
            if (report.scoring.scores.ibdu >= 40) {
                reasons.push('IBDU score elevato');
            }
            
            // Displasia + p53 aberrante
            if (report.dysplasiaReport && 
                (report.ihcData.p53_pattern === 'overexpression' || report.ihcData.p53_pattern === 'null')) {
                reasons.push('Displasia con p53 aberrante');
            }
            
            // Score Crohn/RCU molto vicini
            if (Math.abs(report.scoring.scores.crohn - report.scoring.scores.uc) < 15 && 
                report.scoring.scores.crohn >= 30 && report.scoring.scores.uc >= 30) {
                reasons.push('Score Crohn/RCU sovrapposti');
            }
            
            return reasons.length > 0 ? reasons : null;
        };

        // ==================== SCORING CON GRANULOMI DIFFERENZIATI ====================
        const calculateScoring = () => {
            let scores = { crohn: 0, uc: 0, ibdu: 0 };
            let granulomaScore = 0; // Tracking peso granulomi

            specimens.forEach(specimen => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';

                if (siteType === 'ileum') {
                    if (f.granulomi_epitelioidi === 'presente') {
                        if (specimen.mucinGranulomaLikely) {
                            scores.crohn += 20;
                            granulomaScore += 20;
                        } else {
                            scores.crohn += 150;
                            granulomaScore += 150;
                        }
                    } else if (f.granulomi_epitelioidi === 'sospetti') {
                        scores.crohn += 25;
                        granulomaScore += 25;
                    }
                    
                    if (f.erosioni_ulcerazioni === 'presente') scores.crohn += 50;
                    if (f.iperplasia_linfoide === 'presente') scores.crohn += 40;
                    if (f.atrofia_villi === 'marcata') scores.crohn += 30;
                    else if (f.atrofia_villi === 'moderata') scores.crohn += 15;
                    else if (f.atrofia_villi === 'lieve') scores.crohn += 5;
                    if (f.neutrofili_lamina_propria === 'marcata') { scores.crohn += 20; scores.uc += 10; }
                    else if (f.neutrofili_lamina_propria === 'moderata') { scores.crohn += 10; scores.uc += 5; }
                    else if (f.neutrofili_lamina_propria === 'lieve') scores.crohn += 5;
                    if (f.edema_lamina_propria === 'presente') scores.crohn += 15;
                    if (f.plasmacellule_aumentate === 'presente') scores.crohn += 15;
                    if (f.fibrosi_sottomucosa === 'marcata') scores.crohn += 25;
                    else if (f.fibrosi_sottomucosa === 'moderata') scores.crohn += 15;
                    else if (f.fibrosi_sottomucosa === 'lieve') scores.crohn += 5;
                } else {
                    if (f.granulomi_epitelioidi === 'presente') {
                        if (specimen.mucinGranulomaLikely) {
                            scores.crohn += 15;
                            granulomaScore += 15;
                        } else {
                            scores.crohn += 100;
                            granulomaScore += 100;
                        }
                    } else if (f.granulomi_epitelioidi === 'sospetti') {
                        scores.crohn += 25;
                    }
                    
                    if (f.neutrofili_epitelio === 'marcata') { scores.uc += 40; scores.crohn += 20; }
                    else if (f.neutrofili_epitelio === 'moderata') { scores.uc += 25; scores.crohn += 15; }
                    else if (f.neutrofili_epitelio === 'lieve') { scores.uc += 15; scores.crohn += 10; }
                    if (f.ascessi_criptici === 'presente') { scores.uc += 30; scores.crohn += 15; }
                    if (f.plasmacellule_basale === 'presente') { scores.uc += 25; scores.crohn += 10; }
                    if (f.distorsione_architettura === 'presente') { scores.uc += 20; scores.crohn += 15; }
                    if (f.metaplasia_paneth === 'presente') scores.uc += 15;
                    if (f.ulcerazione === 'presente') { scores.crohn += 15; scores.uc += 10; }
                    if (f.fibrosi_sottomucosa === 'marcata') { scores.crohn += 25; scores.uc += 10; }
                    else if (f.fibrosi_sottomucosa === 'moderata') { scores.crohn += 15; scores.uc += 5; }
                }
            });

            if (ihcData.cd68_pattern === 'aggregati_profondi') scores.crohn += 35;
            else if (ihcData.cd68_pattern === 'diffuso_mucosa') { scores.uc += 20; scores.crohn += 10; }

            const dysplasiaRisk = ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null';

            const topoPattern = analyzeTopographicPattern();
            const rawScores = { crohn: scores.crohn, uc: scores.uc };
            scores.ibdu = calculateIBDUScore(rawScores, topoPattern);

            const total = scores.crohn + scores.uc + scores.ibdu;
            if (total > 0) {
                scores.crohn = Math.round((scores.crohn / total) * 100);
                scores.uc = Math.round((scores.uc / total) * 100);
                scores.ibdu = Math.round((scores.ibdu / total) * 100);
            }
            
            // Punto 2 ChatGPT: flag se granulomi trainano lo score
            const granulomasDriven = rawScores.crohn > 0 && (granulomaScore / rawScores.crohn) > 0.5;

            return { scores, dysplasiaRisk, rawScores, granulomaScore, granulomasDriven };
        };

        // ==================== INTERPRETAZIONE GRADUATA ====================
        
        const interpretScoringGraduated = (scores) => {
            const { crohn, uc, ibdu } = scores;
            const max = Math.max(crohn, uc, ibdu);
            
            let result = {
                primary: null,
                level: null,
                headline: null,
                description: null,
                epistemicNote: null
            };
            
            // CHECK PRIORITARIO: Mucosa normale (tutti findings assenti E nessuna colite speciale)
            const hasAltreColitiFindings = 
                (altreColiti.banda_collagene !== 'assente' && altreColiti.banda_collagene !== 'normale') ||
                (altreColiti.iel_aumentati !== 'assente' && altreColiti.iel_aumentati !== 'normale') ||
                altreColiti.apoptosi_cripte !== 'assente' ||
                altreColiti.pattern_superficiale === true ||
                altreColiti.atrofia_ischemica === true ||
                altreColiti.membrane_ialine === true ||
                altreColiti.emorragia_recente === true ||
                altreColiti.ulcere_diaframma === true;
            
            const isAllNormal = !hasAltreColitiFindings && specimens.every(s => {
                const f = s.findings;
                if (s.siteType === 'ileum') {
                    return f.granulomi_epitelioidi === 'assente' &&
                           f.neutrofili_lamina_propria === 'assente' &&
                           f.erosioni_ulcerazioni === 'assente' &&
                           f.iperplasia_linfoide === 'assente' &&
                           f.edema_lamina_propria === 'assente' &&
                           f.atrofia_villi === 'assente' &&
                           f.plasmacellule_aumentate === 'assente' &&
                           f.fibrosi_sottomucosa === 'assente';
                } else {
                    return f.granulomi_epitelioidi === 'assente' &&
                           f.neutrofili_epitelio === 'assente' &&
                           f.ascessi_criptici === 'assente' &&
                           f.plasmacellule_basale === 'assente' &&
                           f.distorsione_architettura === 'assente' &&
                           f.metaplasia_paneth === 'assente' &&
                           f.ulcerazione === 'assente' &&
                           f.fibrosi_sottomucosa === 'assente' &&
                           (f.displasia === 'assente' || !f.displasia);
                }
            });
            
            if (isAllNormal) {
                result.primary = 'Normale';
                result.level = 'normale';
                result.headline = 'Mucosa ileo-colica nella norma';
                result.description = 'Non si osservano alterazioni istologiche significative nei campioni esaminati.';
                result.epistemicNote = null;
                return result;
            }
            
            // CHECK COLITI SPECIALI (microscopiche, ischemica, FANS)
            if (hasAltreColitiFindings) {
                // Colite collagenosica
                if (altreColiti.banda_collagene === 'ispessita' || altreColiti.banda_collagene === 'marcata') {
                    result.primary = 'Colite Collagenosica';
                    result.level = altreColiti.banda_collagene === 'marcata' ? 'alta' : 'buona';
                    result.headline = 'Colite microscopica, tipo collagenosica';
                    const bandaText = altreColiti.banda_collagene_um 
                        ? `Banda collagene subepiteliale: ${altreColiti.banda_collagene_um}Œºm (v.n. <10Œºm)`
                        : `Banda collagene subepiteliale ${altreColiti.banda_collagene === 'marcata' ? 'marcatamente ispessita (>20Œºm)' : 'ispessita (‚â•10Œºm)'}`;
                    result.description = `${bandaText}. Architettura ghiandolare conservata.`;
                    return result;
                }
                // Colite linfocitica
                if (altreColiti.iel_aumentati === 'aumentati' || altreColiti.iel_aumentati === 'marcati') {
                    result.primary = 'Colite Linfocitica';
                    result.level = altreColiti.iel_aumentati === 'marcati' ? 'alta' : 'buona';
                    result.headline = 'Colite microscopica, tipo linfocitica';
                    const ielText = altreColiti.iel_count 
                        ? `Linfociti intraepiteliali: ${altreColiti.iel_count}/100 cellule epiteliali (v.n. <20)`
                        : `Linfociti intraepiteliali ${altreColiti.iel_aumentati === 'marcati' ? 'marcatamente aumentati (>30/100)' : 'aumentati (‚â•20/100 cellule epiteliali)'}`;
                    result.description = `${ielText}. Architettura ghiandolare conservata.`;
                    return result;
                }
                // Colite ischemica
                const ischemicFeatures = [altreColiti.atrofia_ischemica, altreColiti.membrane_ialine, altreColiti.emorragia_recente].filter(Boolean).length;
                if (ischemicFeatures >= 2) {
                    result.primary = 'Colite Ischemica';
                    result.level = ischemicFeatures === 3 ? 'alta' : 'suggestivo';
                    result.headline = 'Pattern compatibile con colite ischemica';
                    result.description = `Presenti ${ischemicFeatures}/3 criteri ischemici (atrofia cripte, membrane ialine, emorragia). Correlare con sede e fattori di rischio cardiovascolare.`;
                    return result;
                }
                // Colite da FANS
                if (altreColiti.ulcere_diaframma) {
                    result.primary = 'Enteropatia da FANS';
                    result.level = 'alta';
                    result.headline = 'Enteropatia/Colite da FANS';
                    result.description = 'Ulcere a diaframma presenti (patognomonico). Confermare anamnesi farmacologica.';
                    return result;
                }
                if (altreColiti.apoptosi_cripte !== 'assente') {
                    result.primary = 'Possibile Colite da FANS';
                    result.level = 'suggestivo';
                    result.headline = 'Pattern suggestivo per colite da FANS';
                    result.description = `Apoptosi cripte ${altreColiti.apoptosi_cripte}. Considerare eziologia farmacologica.`;
                    return result;
                }
                // Colite infettiva
                if (altreColiti.pattern_superficiale && altreColiti.architettura_conservata) {
                    result.primary = 'Colite Infettiva';
                    result.level = 'suggestivo';
                    result.headline = 'Pattern compatibile con colite infettiva';
                    result.description = 'Infiammazione superficiale con architettura conservata. Correlare con coprocoltura e dati clinici.';
                    return result;
                }
            }
            
            if (max === crohn && crohn >= 40) {
                result.primary = 'Malattia di Crohn';
                
                if (crohn >= 80) {
                    result.level = 'alta';
                    result.headline = 'Malattia di Crohn (pattern istologico fortemente suggestivo)';
                    result.description = 'Pattern morfologico e architetturale fortemente indicativo per malattia di Crohn.';
                } else if (crohn >= 60) {
                    result.level = 'probabile';
                    result.headline = 'Quadro compatibile con malattia di Crohn';
                    result.description = 'Pattern morfologico compatibile con malattia di Crohn. Correlazione con dati clinici, endoscopici e imaging NECESSARIA per diagnosi definitiva.';
                    result.epistemicNote = 'Score in range intermedio (60-79%). Diagnosi basata su criteri multipli ma non patognomonici. Conferma clinico-radiologica essenziale.';
                } else {
                    result.level = 'suggestivo';
                    result.headline = 'Pattern suggestivo ma non diagnostico per malattia di Crohn';
                    result.description = 'Pattern istologico con alcune features compatibili con Crohn, ma INSUFFICIENTE per diagnosi definitiva.';
                    result.epistemicNote = 'Score borderline (40-59%). Istologia da sola NON consente diagnosi. Correlazione clinica, distribuzione endoscopica e imaging INDISPENSABILI. Considerare rivalutazione con follow-up istologico.';
                }
            }
            else if (max === uc && uc >= 40) {
                // Determina se proctite, colite sinistra o pancolite
                const topoPattern = analyzeTopographicPattern();
                const activeSites = specimens.filter(s => 
                    s.siteType !== 'ileum' && (
                        s.findings.neutrofili_epitelio !== 'assente' ||
                        s.findings.distorsione_architettura === 'presente' ||
                        s.findings.plasmacellule_basale === 'presente'
                    )
                ).map(s => s.site);
                
                // Rileva remissione: diagnosi veloce O assenza di attivit√† acuta (neutrofili)
                const hasAcuteActivity = specimens.some(s => 
                    s.siteType !== 'ileum' && (
                        s.findings.neutrofili_epitelio !== 'assente' ||
                        s.findings.ascessi_criptici === 'presente' ||
                        s.findings.ulcerazione === 'presente'
                    )
                );
                const isRemission = diagnosiVeloce.selected === 'IBD_REMISSIONE' || !hasAcuteActivity;
                
                // Proctite: solo retto coinvolto
                const isProctitis = activeSites.length === 1 && activeSites.includes('retto');
                // Colite sinistra: retto + sigma +/- discendente, no trasverso/ascendente/cieco
                const leftSites = ['retto', 'sigma', 'discendente'];
                const rightSites = ['trasverso', 'ascendente', 'cieco'];
                const isLeftSided = activeSites.every(s => leftSites.includes(s)) && 
                                    activeSites.some(s => s === 'retto') &&
                                    !activeSites.some(s => rightSites.includes(s));
                
                const ucLabel = isProctitis ? 'proctite ulcerosa' : 
                               (isLeftSided && !isProctitis) ? 'rettocolite ulcerosa sinistra' : 
                               'rettocolite ulcerosa';
                const ucLabelCap = isProctitis ? 'Proctite ulcerosa' : 
                                  (isLeftSided && !isProctitis) ? 'Rettocolite ulcerosa sinistra' : 
                                  'Rettocolite ulcerosa';
                
                const remissionSuffix = isRemission ? ' in fase di remissione istologica' : '';
                
                result.primary = ucLabelCap;
                
                if (uc >= 80) {
                    result.level = 'alta';
                    result.headline = `${ucLabelCap}${remissionSuffix} (pattern istologico fortemente suggestivo)`;
                    result.description = `Pattern morfologico e distributivo fortemente indicativo per ${ucLabel}${remissionSuffix}.`;
                } else if (uc >= 60) {
                    result.level = 'probabile';
                    result.headline = `Quadro compatibile con ${ucLabel}${remissionSuffix}`;
                    result.description = `Pattern morfologico compatibile con ${ucLabel}${remissionSuffix}.${isRemission ? ' Persistono alterazioni architetturali croniche residue. Assenza di attivit√† infiammatoria acuta.' : ' Correlazione con distribuzione endoscopica NECESSARIA per diagnosi definitiva.'}`;
                    result.epistemicNote = isRemission ? null : 'Score in range intermedio (60-79%). Conferma con pattern topografico endoscopico (continuo, retto coinvolto, ileo indenne) essenziale.';
                } else {
                    result.level = 'suggestivo';
                    result.headline = `Pattern suggestivo ma non diagnostico per ${ucLabel}${remissionSuffix}`;
                    result.description = `Pattern istologico con alcune features compatibili con ${ucLabel}, ma INSUFFICIENTE per diagnosi definitiva.`;
                    result.epistemicNote = 'Score borderline (40-59%). Istologia da sola NON consente diagnosi. Verifica distribuzione continua, coinvolgimento rettale e risparmio ileale tramite endoscopia.';
                }
            }
            else if (max === ibdu || Math.abs(crohn - uc) < 15) {
                result.primary = 'IBDU';
                result.level = 'indeterminato';
                result.headline = 'IBD non classificabile (IBDU)';
                
                if (ibdu > 50) {
                    result.description = 'Pattern contraddittorio con features sovrapposte Crohn/RCU. Classificazione istologica non possibile.';
                    result.epistemicNote = 'IBDU con overlap features. Scoring mostra pattern contraddittori (es: granulomi + cronicit√† RCU-like, skip lesions + plasmacellule basali). Diagnosi definitiva richiede follow-up clinico-istologico prolungato.';
                } else {
                    result.description = 'Pattern aspecifico di IBD. Dati istologici insufficienti per classificazione Crohn vs RCU.';
                    result.epistemicNote = 'Score equiparati Crohn/RCU (<15% differenza). Istologia indeterminata. Rivalutazione con follow-up istologico + correlazione clinico-endoscopica-radiologica INDISPENSABILE.';
                }
            }
            else {
                result.primary = 'Indeterminato';
                result.level = 'insufficiente';
                result.headline = 'Pattern istologico aspecifico';
                result.description = 'Reperti morfologici insufficienti per orientamento diagnostico IBD.';
                result.epistemicNote = 'Score globalmente basso. Campionamento inadeguato o fase precoce di malattia. Necessaria rivalutazione istologica con campionamento esteso.';
            }
            
            return result;
        };

        // ==================== PATTERN CONTRADITTORI ====================
        
        const detectContradictoryPatterns = () => {
            const notes = [];
            
            // Se mucosa normale, nessuna nota contraddittoria
            const isAllNormal = specimens.every(s => {
                const f = s.findings;
                if (s.siteType === 'ileum') {
                    return f.granulomi_epitelioidi === 'assente' &&
                           f.neutrofili_lamina_propria === 'assente' &&
                           f.erosioni_ulcerazioni === 'assente' &&
                           f.atrofia_villi === 'assente' &&
                           f.plasmacellule_aumentate === 'assente';
                } else {
                    return f.granulomi_epitelioidi === 'assente' &&
                           f.neutrofili_epitelio === 'assente' &&
                           f.ascessi_criptici === 'assente' &&
                           f.plasmacellule_basale === 'assente' &&
                           f.distorsione_architettura === 'assente' &&
                           f.ulcerazione === 'assente';
                }
            });
            
            if (isAllNormal) return notes; // Array vuoto
            
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');
            const hasUCPattern = specimens.some(s => 
                s.findings.plasmacellule_basale === 'presente' || 
                s.findings.distorsione_architettura === 'presente'
            );
            const topoPattern = analyzeTopographicPattern();
            const scoring = calculateScoring();
            
            if (hasGranulomas && hasUCPattern) {
                notes.push({
                    type: 'CONTRADDITTORIO',
                    title: 'Pattern contraddittorio: Granulomi + Cronicit√† RCU-like',
                    features: [
                        'Granulomi epitelioidi presenti (feature Crohn)',
                        'Alterazioni croniche RCU-like (plasmacellule basali, distorsione architetturale)'
                    ],
                    interpretation: 'Scoring calcolato a fini DESCRITTIVI; affidabilit√† LIMITATA per presenza di features contraddittorie.',
                    suggestion: 'Pattern suggerisce IBDU con overlap features. Rivalutazione con follow-up clinico-istologico prolungato NECESSARIA.'
                });
            }
            
            if (!hasGranulomas && scoring.scores.crohn > 60) {
                const hasTransmuralEquivalent = specimens.some(s => 
                    s.findings.fibrosi_sottomucosa === 'marcata'
                );
                
                if (!hasTransmuralEquivalent) {
                    notes.push({
                        type: 'LIMITAZIONE',
                        title: 'Crohn senza features pathognomoniche',
                        features: [
                            'Score Crohn >60% ma ASSENZA granulomi epitelioidi',
                            'ASSENZA evidenza di transmuralit√†',
                            '‚ö†Ô∏è Biopsia mucosa NON √® lo strumento per dimostrare transmuralit√†'
                        ],
                        interpretation: 'Diagnosi basata su criteri ASPECIFICI (pattern infiammatorio, topografia). Granulomi assenti nel 30-50% dei Crohn bioptici.',
                        suggestion: 'IMAGING MANDATORIO: entero-RM o entero-TC per valutare ispessimento parietale, fistole, stenosi, coinvolgimento mesenterico. La biopsia mucosa documenta solo pattern superficiale.'
                    });
                }
            }
            
            if (Math.abs(scoring.scores.crohn - scoring.scores.uc) < 15) {
                notes.push({
                    type: 'INCERTEZZA',
                    title: 'Score Crohn/RCU sovrapponibili',
                    features: [
                        `Crohn ${scoring.scores.crohn}% vs RCU ${scoring.scores.uc}%`,
                        'Differenza <15% (non significativa)'
                    ],
                    interpretation: 'Istologia INSUFFICIENTE per diagnosi definitiva.',
                    suggestion: 'Pattern indeterminato. Diagnosi richiede integrazione con: distribuzione endoscopica, imaging (entero-RM/TC), risposta terapeutica, evoluzione clinica.'
                });
            }
            
            return notes;
        };

        // ==================== VALIDAZIONE CLINICA ====================
        const validateClinicalLogic = () => {
            const warnings = [];

            specimens.forEach((specimen, index) => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';

                if (f.granulomi_epitelioidi === 'presente') {
                    if (specimen.mucinGranulomaLikely) {
                        warnings.push({
                            type: 'GRANULOMA_CAUTION',
                            site: specimen.site,
                            message: `üîç ${specimen.site.toUpperCase()}: Granulomi marcati come "possibile rottura criptale"`,
                            severity: 'medium',
                            suggestion: 'Escludere mucin granuloma prima di diagnosi Crohn definitiva. Se persistono dubbi, considerare colorazioni PAS-D, follow-up istologico.'
                        });
                    } else if (siteType === 'ileum') {
                        if (f.atrofia_villi === 'assente' && f.plasmacellule_aumentate === 'assente') {
                            warnings.push({
                                type: 'DIAGNOSTIC_ALERT',
                                site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()} (ILEO): Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Considerare: TBC, Yersinia, sarcoidosi, Crohn precoce. Se sospetto infettivo, considerare colorazioni Ziehl-Neelsen, PCR Mycobacterium.'
                            });
                        }
                    } else {
                        if (f.distorsione_architettura === 'assente' && f.plasmacellule_basale === 'assente') {
                            warnings.push({
                                type: 'DIAGNOSTIC_ALERT',
                                site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()}: Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Considerare: TBC, sarcoidosi, Crohn precoce, iatrogeni (farmaci). DD infettiva richiede colorazioni specifiche.'
                            });
                        }
                    }
                } else if (f.granulomi_epitelioidi === 'sospetti') {
                    warnings.push({
                        type: 'GRANULOMA_UNCERTAIN',
                        site: specimen.site,
                        message: `üîç ${specimen.site.toUpperCase()}: Granulomi "sospetti" (non definitivi)`,
                        severity: 'medium',
                        suggestion: 'Considerare DD: aggregati linfoidi, mucin granuloma, artefatto. Se persistono sospetti Crohn, necessario follow-up istologico con campionamento esteso.'
                    });
                }
            });

            const topoPattern = analyzeTopographicPattern();
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');
            const hasChronicChanges = specimens.some(s => 
                s.findings.distorsione_architettura === 'presente' || 
                s.findings.plasmacellule_basale === 'presente'
            );
            const rectumSpared = topoPattern.rectumSampled && !topoPattern.rectumInvolved;
            const hasColonFindings = specimens.filter(hasInflammatoryFindings).some(s => s.siteType !== 'ileum');
            
            if (!hasGranulomas && hasChronicChanges && rectumSpared && hasColonFindings && !ibdNota.therapyOngoing) {
                warnings.push({
                    type: 'DIAGNOSTIC_CAUTION',
                    message: 'üîç Pattern cronico SENZA granulomi + retto risparmiato',
                    severity: 'medium',
                    suggestion: 'UC possibile ma non esclusiva. Retto risparmiato atipico per RCU classica. Considerare: Crohn colico, IBDU, RCU trattata/lunga durata. Correlare con distribuzione endoscopica e clinica.'
                });
            }

            return warnings;
        };

        // ==================== DISPLASIA SEPARATA ====================
        
        const generateDysplasiaReport = () => {
            const colonSpecs = specimens.filter(s => s.siteType !== 'ileum');
            const displasiaFindings = colonSpecs
                .filter(s => s.findings.displasia && s.findings.displasia !== 'assente')
                .map(s => ({
                    site: s.site,
                    grade: s.findings.displasia,
                    p53Support: ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null'
                }));
            
            if (displasiaFindings.length === 0) return null;
            
            const maxGrade = displasiaFindings.some(d => d.grade === 'HGD') ? 'HGD' :
                             displasiaFindings.some(d => d.grade === 'LGD') ? 'LGD' : 'IND';
            
            let recommendation = '';
            if (maxGrade === 'HGD') {
                recommendation = 'HGD: Colectomia da considerare. Discussione multidisciplinare URGENTE.';
            } else if (maxGrade === 'LGD') {
                recommendation = 'LGD: Sorveglianza endoscopica stretta (3-6 mesi). Valutare resezione endoscopica se lesione visibile circoscritta.';
            } else {
                recommendation = 'IND: Rivalutazione con campionamento esteso. Considerare controllo con patologo esperto.';
            }
            
            return {
                present: true,
                maxGrade,
                findings: displasiaFindings,
                recommendation,
                p53Aberrant: displasiaFindings.some(d => d.p53Support)
            };
        };

        // ==================== DETECT ALTRE COLITI ====================
        const detectAltreColitiPattern = () => {
            const results = [];
            
            if (altreColiti.banda_collagene === 'ispessita' || altreColiti.banda_collagene === 'marcata') {
                const bandaDesc = altreColiti.banda_collagene_um 
                    ? `Banda collagene: ${altreColiti.banda_collagene_um}Œºm (v.n. <10Œºm)`
                    : `Banda collagene subepiteliale ${altreColiti.banda_collagene === 'marcata' ? 'marcatamente ispessita (>20Œºm)' : 'ispessita (‚â•10Œºm)'}`;
                results.push({
                    tipo: 'COLITE_COLLAGENA', emoji: 'üî¨', diagnosi: 'Colite collagenosica',
                    descrizione: `${bandaDesc}. Pattern diagnostico per colite collagenosica.`,
                    confidence: altreColiti.banda_collagene === 'marcata' ? 'alta' : 'buona', color: 'purple'
                });
            }
            
            if (altreColiti.iel_aumentati === 'aumentati' || altreColiti.iel_aumentati === 'marcati') {
                const ielDesc = altreColiti.iel_count 
                    ? `IEL: ${altreColiti.iel_count}/100 cellule epiteliali (v.n. <20)`
                    : `IEL ${altreColiti.iel_aumentati === 'marcati' ? 'marcatamente aumentati (>30/100)' : 'aumentati (‚â•20/100 cellule epiteliali)'}`;
                results.push({
                    tipo: 'COLITE_LINFOCITICA', emoji: 'üî¨', diagnosi: 'Colite Linfocitica',
                    descrizione: `${ielDesc}. Pattern diagnostico per colite linfocitica.`,
                    confidence: altreColiti.iel_aumentati === 'marcati' ? 'alta' : 'buona', color: 'purple'
                });
            }
            
            if (altreColiti.pattern_superficiale && altreColiti.architettura_conservata) {
                results.push({
                    tipo: 'COLITE_INFETTIVA', emoji: 'ü¶†', diagnosi: 'Pattern compatibile con colite infettiva',
                    descrizione: 'Infiammazione superficiale con architettura conservata. Correlare con coprocoltura.',
                    confidence: 'suggestivo', color: 'orange'
                });
            }
            
            const ischemicFeatures = [altreColiti.atrofia_ischemica, altreColiti.membrane_ialine, altreColiti.emorragia_recente].filter(Boolean).length;
            if (ischemicFeatures >= 2) {
                results.push({
                    tipo: 'COLITE_ISCHEMICA', emoji: 'üíî', diagnosi: 'Pattern compatibile con colite ischemica',
                    descrizione: `Presenti ${ischemicFeatures}/3 criteri ischemici.`,
                    confidence: ischemicFeatures === 3 ? 'alta' : 'suggestivo', color: 'red'
                });
            }
            
            if (altreColiti.ulcere_diaframma) {
                results.push({
                    tipo: 'COLITE_FANS', emoji: 'üíä', diagnosi: 'Enteropatia/Colite da FANS',
                    descrizione: 'Ulcere a diaframma presenti (patognomonico). Confermare anamnesi farmacologica.',
                    confidence: 'alta', color: 'blue'
                });
            } else if (altreColiti.apoptosi_cripte !== 'assente') {
                results.push({
                    tipo: 'COLITE_FANS_POSSIBILE', emoji: 'üíä', diagnosi: 'Possibile colite da FANS',
                    descrizione: `Apoptosi cripte ${altreColiti.apoptosi_cripte}. Considerare eziologia farmacologica.`,
                    confidence: 'suggestivo', color: 'blue'
                });
            }
            
            return results;
        };

        // ==================== GENERATE REPORT ====================
        const generateReport = () => {
            const scoring = calculateScoring();
            const interpretation = interpretScoringGraduated(scoring.scores);
            const contradictoryNotes = detectContradictoryPatterns();
            const nancy = calculateNancyIndex();
            const topoPattern = analyzeTopographicPattern();
            const validations = validateClinicalLogic();
            const sintesiEndoscopista = generateSintesiEndoscopista();
            const dysplasiaReport = generateDysplasiaReport();

            const suspiciousGranulomas = specimens.filter(s => 
                s.findings.granulomi_epitelioidi === 'sospetti'
            ).map(s => s.site);

            return {
                specimens,
                scoring,
                interpretation,
                contradictoryNotes,
                nancy,
                topoPattern,
                sintesiEndoscopista,
                ibdNota,
                diagnosiVeloce,
                dysplasiaReport,
                altreColitiPatterns: detectAltreColitiPattern(),
                suspiciousGranulomas,
                validations,
                ihcData,
                altreColiti,
                metadata: {
                    version: APP_VERSION,
                    date: new Date().toISOString(),
                    hasGranulomas: specimens.some(s => s.findings.granulomi_epitelioidi === 'presente'),
                    hasNancy: shouldShowNancy().show,
                    // Fix ChatGPT 2.1: flag simulazione didattica
                    simulation: diagnosiVeloce.autoGenerated === true,
                    // Fix ChatGPT 3.3: versioning concettuale
                    logicVersion: 'IBD-ECCO2023-adapted',
                    educationalProfile: 'Senior-pathologist-Rosai-school'
                }
            };
        };

        // ==================== COMPONENTS ====================
        const TabNavigation = ({ active, onChange }) => {
            const tabs = [
                { id: 'campioni', label: 'üìã Campioni' },
                { id: 'ihc', label: 'üî¨ IHC' },
                { id: 'referto', label: 'üìÑ Referto' }
            ];

            return `
                <div class="flex gap-2 mb-6 border-b no-print">
                    ${tabs.map(tab => {
                        const isDisabled = caseLocked && (tab.id === 'campioni' || tab.id === 'ihc');
                        return `
                        <button
                            onclick="${isDisabled ? 'return false' : `switchTab('${tab.id}')`}"
                            class="px-6 py-3 font-semibold rounded-t-lg transition-colors ${
                                active === tab.id ? 'tab-active' : 
                                isDisabled ? 'tab-disabled' : 
                                'bg-gray-200 hover:bg-gray-300'
                            }"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${tab.label}
                            ${isDisabled ? ' üîí' : ''}
                        </button>
                    `}).join('')}
                </div>
            `;
        };

        // ==================== DIAGNOSI VELOCE PANEL ====================
        const DiagnosiVelocePanel = () => {
            if (caseLocked) return '';
            
            const ibdOptions = diagnosiVeloceOptions.filter(o => o.gruppo === 'ibd');
            const altreOptions = diagnosiVeloceOptions.filter(o => o.gruppo === 'altre');
            
            return `
                <div class="bg-green-50 rounded-lg p-4 mb-6 border-2 border-green-300">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-green-900 flex items-center gap-2">
                            <span>‚ö°</span> Diagnosi Veloce
                        </h3>
                        ${diagnosiVeloce.selected ? `
                            <button 
                                onclick="clearDiagnosiVeloce()"
                                class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200"
                            >
                                ‚úï Rimuovi
                            </button>
                        ` : ''}
                    </div>
                    <p class="text-xs text-green-800 mb-3">
                        Hai gi√† visto i vetrini? Seleziona direttamente la diagnosi:
                    </p>
                    
                    <div class="mb-3">
                        <p class="text-xs font-semibold text-green-700 mb-2">IBD:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${ibdOptions.map(opt => `
                                <button 
                                    onclick="selectDiagnosiVeloce('${opt.codice}')"
                                    class="p-2 rounded text-sm font-medium transition-all ${
                                        diagnosiVeloce.selected === opt.codice 
                                            ? 'bg-green-600 text-white ring-2 ring-green-800' 
                                            : 'bg-white border border-green-300 hover:bg-green-100'
                                    }"
                                >
                                    <span class="text-lg">${opt.emoji}</span>
                                    <span class="block text-xs mt-1">${opt.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-xs font-semibold text-amber-700 mb-2">Altre Coliti:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${altreOptions.map(opt => `
                                <button 
                                    onclick="selectDiagnosiVeloce('${opt.codice}')"
                                    class="p-2 rounded text-sm font-medium transition-all ${
                                        diagnosiVeloce.selected === opt.codice 
                                            ? 'bg-amber-500 text-white ring-2 ring-amber-700' 
                                            : 'bg-white border border-amber-300 hover:bg-amber-100'
                                    }"
                                >
                                    <span class="text-lg">${opt.emoji}</span>
                                    <span class="block text-xs mt-1">${opt.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${diagnosiVeloce.selected ? `
                        <div class="mt-3 p-3 bg-white rounded border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 mb-1">Diagnosi selezionata:</p>
                            <p class="text-sm font-medium text-green-900">${diagnosiVeloceOptions.find(o => o.codice === diagnosiVeloce.selected)?.testo || ''}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        // ==================== IBD NOTA PANEL ====================
        const IbdNotaPanel = () => {
            if (caseLocked) return '';
            
            return `
                <div class="bg-indigo-50 rounded-lg p-4 mb-6 border-2 border-indigo-300">
                    <div class="flex items-center gap-3 mb-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                ${ibdNota.enabled ? 'checked' : ''}
                                onchange="toggleIbdNota(this.checked)"
                                class="w-5 h-5 accent-indigo-600"
                            >
                            <span class="font-bold text-indigo-900">IBD nota (Follow-up)</span>
                        </label>
                    </div>
                    
                    ${ibdNota.enabled ? `
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-indigo-800 mb-1">Diagnosi iniziale:</label>
                                    <select 
                                        onchange="updateIbdNota('diagnosiIniziale', this.value)"
                                        class="w-full p-2 border-2 border-indigo-300 rounded bg-white"
                                    >
                                        <option value="" ${!ibdNota.diagnosiIniziale ? 'selected' : ''}>-- Seleziona --</option>
                                        <option value="RCU" ${ibdNota.diagnosiIniziale === 'RCU' ? 'selected' : ''}>RCU</option>
                                        <option value="Crohn" ${ibdNota.diagnosiIniziale === 'Crohn' ? 'selected' : ''}>Crohn</option>
                                        <option value="IBDU" ${ibdNota.diagnosiIniziale === 'IBDU' ? 'selected' : ''}>IBDU</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-indigo-800 mb-1">Diagnosi attuale:</label>
                                    <select 
                                        onchange="updateIbdNota('diagnosiAttuale', this.value)"
                                        class="w-full p-2 border-2 border-indigo-300 rounded bg-white"
                                    >
                                        <option value="" ${!ibdNota.diagnosiAttuale ? 'selected' : ''}>-- Seleziona --</option>
                                        <option value="RCU" ${ibdNota.diagnosiAttuale === 'RCU' ? 'selected' : ''}>RCU</option>
                                        <option value="Crohn" ${ibdNota.diagnosiAttuale === 'Crohn' ? 'selected' : ''}>Crohn</option>
                                        <option value="IBDU" ${ibdNota.diagnosiAttuale === 'IBDU' ? 'selected' : ''}>IBDU</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="p-3 bg-white rounded border border-indigo-200">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        ${ibdNota.therapyOngoing ? 'checked' : ''}
                                        onchange="updateIbdNota('therapyOngoing', this.checked)"
                                        class="w-4 h-4 accent-indigo-600"
                                    >
                                    <span class="text-sm font-semibold text-indigo-900">
                                        üíä Paziente in terapia immunosoppressiva/biologica
                                    </span>
                                </label>
                                <p class="text-xs text-indigo-700 mt-1 ml-6">
                                    Modula interpretazione pattern topografico (es: retto risparmiato in RCU trattata)
                                </p>
                            </div>
                            
                            ${ibdNota.diagnosiIniziale && ibdNota.diagnosiAttuale && ibdNota.diagnosiIniziale !== ibdNota.diagnosiAttuale ? `
                                <div class="p-2 bg-yellow-100 rounded text-sm text-yellow-800">
                                    ‚ÑπÔ∏è Riclassificazione: ${ibdNota.diagnosiIniziale} ‚Üí ${ibdNota.diagnosiAttuale}
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <p class="text-xs text-indigo-600">
                            Spunta se il paziente ha gi√† diagnosi di IBD (RCU, Crohn, IBDU). Altrimenti lascia vuoto per prima diagnosi.
                        </p>
                    `}
                </div>
            `;
        };

        // v3.0.5: Sedi standard (per "Seleziona Tutti") - escluse pouch e anastomosi
        const STANDARD_SITES = ['ileo', 'cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];
        const SPECIAL_SITES = ['pouch', 'anastomosi'];
        const ALL_SITES = [...STANDARD_SITES, ...SPECIAL_SITES];
        
        // Sedi per pattern topografico UC
        const LEFT_COLON_SITES = ['sigma', 'retto'];
        const LEFT_EXTENDED_SITES = ['discendente', 'sigma', 'retto'];
        const PANCOLITIS_SITES = ['cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];

        // Findings di default (tutti assente) per campioni "normali"
        const DEFAULT_COLON_FINDINGS = {
            granulomi_epitelioidi: 'assente',
            neutrofili_epitelio: 'assente',
            ascessi_criptici: 'assente',
            plasmacellule_basale: 'assente',
            distorsione_architettura: 'assente',
            metaplasia_paneth: 'assente',
            ulcerazione: 'assente',
            fibrosi_sottomucosa: 'assente',
            displasia: 'assente'
        };

        const DEFAULT_ILEUM_FINDINGS = {
            granulomi_epitelioidi: 'assente',
            neutrofili_lamina_propria: 'assente',
            erosioni_ulcerazioni: 'assente',
            iperplasia_linfoide: 'assente',
            edema_lamina_propria: 'assente',
            atrofia_villi: 'assente',
            plasmacellule_aumentate: 'assente',
            fibrosi_sottomucosa: 'assente'
        };

        // Findings per UC ATTIVA in base al grado Nancy
        const getUCActiveFindings = (nancyGrade) => {
            const base = { ...DEFAULT_COLON_FINDINGS };
            base.distorsione_architettura = 'presente';
            base.plasmacellule_basale = 'presente';
            
            if (nancyGrade >= 1) {
                // Nancy 1: solo cronicit√†
            }
            if (nancyGrade >= 2) {
                base.neutrofili_epitelio = 'lieve';
            }
            if (nancyGrade >= 3) {
                base.neutrofili_epitelio = 'moderata';
                base.ascessi_criptici = 'presente';
            }
            if (nancyGrade >= 4) {
                base.neutrofili_epitelio = 'marcata';
                base.ulcerazione = 'presente';
            }
            return base;
        };

        // Findings per UC in REMISSIONE (cronicit√† senza attivit√†)
        const getUCRemissionFindings = () => {
            const base = { ...DEFAULT_COLON_FINDINGS };
            base.distorsione_architettura = 'presente';
            base.plasmacellule_basale = 'presente';
            return base;
        };

        // Findings per CROHN ileale attivo
        const getCrohnIleumFindings = (severity) => {
            const base = { ...DEFAULT_ILEUM_FINDINGS };
            if (severity === 'lieve') {
                base.erosioni_ulcerazioni = 'presente';
                base.iperplasia_linfoide = 'presente';
            } else if (severity === 'moderata') {
                base.erosioni_ulcerazioni = 'presente';
                base.iperplasia_linfoide = 'presente';
                base.neutrofili_lamina_propria = 'moderata';
            } else if (severity === 'severa') {
                base.erosioni_ulcerazioni = 'presente';
                base.neutrofili_lamina_propria = 'marcata';
                base.granulomi_epitelioidi = 'presente';
            }
            return base;
        };

        // Genera campioni in base alla diagnosi veloce
        const generateSpecimensFromDiagnosi = (diagnosiCode, nancyGrade = 2) => {
            if (selectedSites.length === 0) {
                alert('Seleziona prima le sedi campionate!');
                return;
            }
            
            specimens = [];
            
            // Fix ChatGPT: reset altreColiti per evitare contaminazione tra diagnosi
            altreColiti = {
                banda_collagene: 'assente',
                iel_aumentati: 'assente',
                pattern_superficiale: false,
                architettura_conservata: false,
                atrofia_ischemica: false,
                membrane_ialine: false,
                emorragia_recente: false,
                apoptosi_cripte: 'assente',
                ulcere_diaframma: false
            };
            
            selectedSites.forEach(site => {
                const isIleum = site === 'ileo';
                let findings;
                
                switch(diagnosiCode) {
                    case 'NORMALE':
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS };
                        break;
                        
                    case 'PROCTITE_UC':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else if (site === 'retto') {
                            findings = getUCActiveFindings(nancyGrade);
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        break;
                        
                    case 'COLITE_SINISTRA_UC':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else if (LEFT_EXTENDED_SITES.includes(site)) {
                            findings = getUCActiveFindings(nancyGrade);
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        break;
                        
                    case 'PANCOLITE_UC':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            findings = getUCActiveFindings(nancyGrade);
                        }
                        break;
                        
                    case 'IBD_REMISSIONE':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            // Logica Nancy Index stratificata
                            if (nancyGrade === 0) {
                                // Nancy 0: mucosa normale (raro in remissione)
                                findings = { ...DEFAULT_COLON_FINDINGS };
                            } else if (nancyGrade === 1) {
                                // Nancy 1: remissione con alterazioni croniche (TIPICO)
                                findings = getUCRemissionFindings();
                            } else if (nancyGrade !== null && nancyGrade >= 2) {
                                // Nancy 2-4: attivit√† persistente
                                findings = getUCActiveFindings(nancyGrade);
                            } else {
                                // Nessun Nancy specificato: default remissione (Nancy 1)
                                findings = getUCRemissionFindings();
                            }
                        }
                        break;
                        
                    case 'ILEITE_NAS':
                        if (isIleum) {
                            findings = getCrohnIleumFindings('moderata');
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        break;
                        
                    case 'CROHN_LIKE':
                        // Pattern discontinuo: ileo + colon destro attivi
                        if (isIleum) {
                            findings = getCrohnIleumFindings('moderata');
                        } else if (['cieco', 'ascendente'].includes(site)) {
                            const f = { ...DEFAULT_COLON_FINDINGS };
                            f.granulomi_epitelioidi = 'sospetti';
                            f.neutrofili_epitelio = 'lieve';
                            f.distorsione_architettura = 'presente';
                            findings = f;
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        break;
                        
                    case 'COLITE_COLLAGENA':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                            // Colite collagenosica: architettura conservata!
                        }
                        // Setta anche altreColiti
                        altreColiti.banda_collagene = 'ispessita';
                        altreColiti.architettura_conservata = true;
                        break;
                        
                    case 'COLITE_LINFOCITICA':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        altreColiti.iel_aumentati = 'aumentati';
                        altreColiti.architettura_conservata = true;
                        break;
                        
                    case 'COLITE_INFETTIVA':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            const f = { ...DEFAULT_COLON_FINDINGS };
                            f.neutrofili_epitelio = 'moderata';
                            // Architettura conservata (tipico infettivo)
                            findings = f;
                        }
                        altreColiti.pattern_superficiale = true;
                        altreColiti.architettura_conservata = true;
                        break;
                        
                    case 'COLITE_ISCHEMICA':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            const f = { ...DEFAULT_COLON_FINDINGS };
                            f.fibrosi_sottomucosa = 'lieve';
                            findings = f;
                        }
                        altreColiti.atrofia_ischemica = true;
                        altreColiti.membrane_ialine = true;
                        altreColiti.emorragia_recente = true;
                        break;
                        
                    case 'COLITE_FANS':
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        altreColiti.apoptosi_cripte = 'presente';
                        break;
                        
                    case 'SCAD':
                        // SCAD: sigma attivo, retto risparmiato
                        if (isIleum) {
                            findings = { ...DEFAULT_ILEUM_FINDINGS };
                        } else if (site === 'sigma') {
                            const f = { ...DEFAULT_COLON_FINDINGS };
                            f.distorsione_architettura = 'presente';
                            f.neutrofili_epitelio = 'lieve';
                            findings = f;
                        } else {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                        }
                        break;
                        
                    default:
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS };
                }
                
                specimens.push({
                    site,
                    findings,
                    siteType: isIleum ? 'ileum' : 'colon',
                    mucinGranulomaLikely: false
                });
            });
            
            // Salva la diagnosi veloce selezionata
            const opt = diagnosiVeloceOptions.find(o => o.codice === diagnosiCode);
            diagnosiVeloce.selected = diagnosiCode;
            diagnosiVeloce.testo = opt ? opt.testo : null;
            diagnosiVeloce.gradoManuale = nancyGrade;
            diagnosiVeloce.autoGenerated = true;  // Punto 2 ChatGPT: flag auto-generati
            
            // Reset selezione sedi
            selectedSites = [];
            
            saveData();
            render();
        };

        // Diagnosi che richiedono selezione grado Nancy
        const DIAGNOSI_CON_NANCY = ['PROCTITE_UC', 'COLITE_SINISTRA_UC', 'PANCOLITE_UC', 'IBD_REMISSIONE'];

        // ‚ö° TUTTI NORMALI: Aggiunge tutte le 7 sedi standard con findings normali
        const addAllNormalSpecimens = () => {
            if (caseLocked) return;
            
            // Pulisce campioni esistenti se ce ne sono
            if (specimens.length > 0) {
                if (!confirm('Ci sono gi√† campioni inseriti. Vuoi sostituirli con 7 campioni normali?')) {
                    return;
                }
            }
            
            selectedSites = [...STANDARD_SITES];
            generateSpecimensFromDiagnosi('NORMALE');
            
            alert('‚úÖ Aggiunti 7 campioni normali');
        };

        const selectAllStandardSites = () => {
            if (caseLocked) return;
            selectedSites = [...STANDARD_SITES];
            saveData();
            render();
        };

        const deselectAllSites = () => {
            if (caseLocked) return;
            selectedSites = [];
            saveData();
            render();
        };

        const applyDiagnosiVeloce = (diagnosiCode) => {
            if (caseLocked) return;
            if (selectedSites.length === 0) {
                alert('‚ö†Ô∏è Seleziona prima le sedi campionate!');
                return;
            }
            
            // Se diagnosi richiede Nancy, chiedi il grado
            if (DIAGNOSI_CON_NANCY.includes(diagnosiCode)) {
                let promptText, defaultNancy;
                
                if (diagnosiCode === 'IBD_REMISSIONE') {
                    // Prompt specifico per remissione
                    defaultNancy = '1';
                    promptText = 
                        'Inserisci il grado Nancy (0-4):\n\n' +
                        '0 = Remissione completa (mucosa normale - considera "NORMALE")\n' +
                        '1 = Remissione con alterazioni croniche (TIPICO) ‚≠ê\n' +
                        '2 = Remissione parziale con attivit√† lieve residua\n' +
                        '3 = Attivit√† moderata residua\n' +
                        '4 = Attivit√† severa (non √® remissione)';
                } else {
                    // Prompt standard per UC attiva
                    defaultNancy = '2';
                    promptText = 
                        'Inserisci il grado Nancy (0-4):\n\n' +
                        '0 = Remissione completa (mucosa normale)\n' +
                        '1 = Remissione con alterazioni croniche\n' +
                        '2 = Attivit√† lieve\n' +
                        '3 = Attivit√† moderata (ascessi criptici)\n' +
                        '4 = Attivit√† severa (ulcerazione)';
                }
                
                const nancyInput = prompt(promptText, defaultNancy);
                
                if (nancyInput === null) return; // Annullato
                
                const nancy = parseInt(nancyInput);
                if (isNaN(nancy) || nancy < 0 || nancy > 4) {
                    alert('Grado Nancy non valido. Usa un numero da 0 a 4.');
                    return;
                }
                
                generateSpecimensFromDiagnosi(diagnosiCode, nancy);
            } 
            // Se colite linfocitica, chiedi conta IEL
            else if (diagnosiCode === 'COLITE_LINFOCITICA') {
                const ielInput = prompt(
                    'Inserisci la conta IEL/100 cellule epiteliali:\n\n' +
                    '(v.n. <20, diagnostico ‚â•20)',
                    '25'
                );
                
                if (ielInput === null) return; // Annullato
                
                const ielCount = parseInt(ielInput);
                if (isNaN(ielCount) || ielCount < 0 || ielCount > 100) {
                    alert('Conta IEL non valida. Usa un numero da 0 a 100.');
                    return;
                }
                
                // Setta il valore IEL
                altreColiti.iel_count = ielCount;
                altreColiti.iel_aumentati = ielCount >= 30 ? 'marcati' : 'aumentati';
                
                generateSpecimensFromDiagnosi(diagnosiCode);
            }
            // Se colite collagenosica, chiedi spessore banda
            else if (diagnosiCode === 'COLITE_COLLAGENA') {
                const bandaInput = prompt(
                    'Inserisci lo spessore della banda collagene (Œºm):\n\n' +
                    '(v.n. <10Œºm, diagnostico ‚â•10Œºm, marcato >20Œºm)',
                    '15'
                );
                
                if (bandaInput === null) return; // Annullato
                
                const bandaUm = parseInt(bandaInput);
                if (isNaN(bandaUm) || bandaUm < 0 || bandaUm > 100) {
                    alert('Spessore non valido. Usa un numero da 0 a 100.');
                    return;
                }
                
                // Setta il valore banda collagene
                altreColiti.banda_collagene_um = bandaUm;
                altreColiti.banda_collagene = bandaUm >= 20 ? 'marcata' : 'ispessita';
                altreColiti.architettura_conservata = true;
                
                generateSpecimensFromDiagnosi(diagnosiCode);
            }
            else {
                generateSpecimensFromDiagnosi(diagnosiCode);
            }
            
            const opt = diagnosiVeloceOptions.find(o => o.codice === diagnosiCode);
            alert(`‚úÖ Campioni generati per: ${opt?.label || diagnosiCode}\n\nOra puoi andare al tab Referto o modificare i singoli campioni.`);
        };

        const SpecimenForm = () => {
            if (caseLocked) return '';
            
            // Se ci sono gi√† campioni, mostra la lista (non il form selezione)
            if (specimens.length > 0) {
                return '';
            }
            
            // Se modalit√† compilazione manuale attiva
            if (multiSiteMode && selectedSites.length > 0) {
                return MultiSiteWorkflow();
            }
            
            // Se ci sono sedi selezionate, mostra le opzioni diagnosi veloce
            if (selectedSites.length > 0) {
                return SiteSelectionWithDiagnosi();
            }
            
            // Altrimenti mostra la griglia di selezione sedi (DEFAULT)
            return `
                <div class="bg-blue-50 rounded-lg p-6 mb-6 border-2 border-blue-300">
                    <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                        <span>üìç</span> STEP 1: Sedi Campionate
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Leggi il referto endoscopico e clicca le sedi campionate:
                    </p>
                    
                    <!-- Sedi Standard -->
                    <div class="mb-4">
                        <p class="text-xs font-semibold text-blue-700 mb-2 uppercase">Sedi Standard:</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${STANDARD_SITES.map(site => `
                                <label class="flex items-center gap-2 p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-blue-400 cursor-pointer transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                    <input 
                                        type="checkbox" 
                                        id="site-checkbox-${site}"
                                        value="${site}"
                                        ${selectedSites.includes(site) ? 'checked' : ''}
                                        onchange="toggleSiteSelection('${site}', this.checked)"
                                        class="w-5 h-5 accent-blue-600"
                                    >
                                    <span class="font-semibold capitalize text-sm">${site}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Sedi Speciali -->
                    <div class="mb-4 pt-3 border-t border-gray-300">
                        <p class="text-xs font-semibold text-amber-700 mb-2 uppercase">Casi Speciali:</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${SPECIAL_SITES.map(site => `
                                <label class="flex items-center gap-2 p-3 bg-amber-50 rounded-lg border-2 border-amber-200 hover:border-amber-400 cursor-pointer transition-all has-[:checked]:border-amber-500 has-[:checked]:bg-amber-100">
                                    <input 
                                        type="checkbox" 
                                        id="site-checkbox-${site}"
                                        value="${site}"
                                        ${selectedSites.includes(site) ? 'checked' : ''}
                                        onchange="toggleSiteSelection('${site}', this.checked)"
                                        class="w-5 h-5 accent-amber-600"
                                    >
                                    <span class="font-semibold capitalize text-sm">${site}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Bottoni azione -->
                    <div class="flex items-center gap-3 mt-4">
                        <button 
                            onclick="selectAllStandardSites()"
                            class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-all flex items-center gap-2"
                        >
                            <span>‚òë</span> Seleziona 7 Standard
                        </button>
                        
                        <button 
                            onclick="deselectAllSites()"
                            class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition-all"
                        >
                            ‚úï Deseleziona
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-3">
                        üí° Dopo aver selezionato le sedi, potrai scegliere una <strong>diagnosi veloce</strong> per auto-compilare i findings.
                    </p>
                </div>
            `;
        };

        // Pannello selezione sedi + diagnosi veloce
        const SiteSelectionWithDiagnosi = () => {
            const ibdOptions = diagnosiVeloceOptions.filter(o => o.gruppo === 'ibd');
            const altreOptions = diagnosiVeloceOptions.filter(o => o.gruppo === 'altre');
            
            return `
                <div class="bg-green-50 rounded-lg p-6 mb-6 border-2 border-green-400">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            <span>‚ö°</span> STEP 2: Scegli Diagnosi (${selectedSites.length} sedi selezionate)
                        </h3>
                        <button 
                            onclick="deselectAllSites()"
                            class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300"
                        >
                            ‚Üê Cambia Sedi
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-700 mb-4">
                        <strong>Sedi:</strong> ${selectedSites.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ')}
                    </p>
                    
                    <!-- IBD -->
                    <div class="mb-4">
                        <p class="text-xs font-semibold text-green-700 mb-2 uppercase">IBD:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${ibdOptions.map(opt => `
                                <button 
                                    onclick="applyDiagnosiVeloce('${opt.codice}')"
                                    class="p-3 rounded-lg text-sm font-medium transition-all bg-white border-2 border-green-300 hover:bg-green-100 hover:border-green-500 text-left"
                                >
                                    <span class="text-xl">${opt.emoji}</span>
                                    <span class="block text-xs mt-1 font-bold">${opt.label}</span>
                                    ${DIAGNOSI_CON_NANCY.includes(opt.codice) ? '<span class="block text-xs text-green-600">‚Üí chiede Nancy</span>' : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Altre Coliti -->
                    <div class="mb-4 pt-3 border-t border-gray-300">
                        <p class="text-xs font-semibold text-amber-700 mb-2 uppercase">Altre Coliti:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${altreOptions.map(opt => `
                                <button 
                                    onclick="applyDiagnosiVeloce('${opt.codice}')"
                                    class="p-3 rounded-lg text-sm font-medium transition-all bg-white border-2 border-amber-300 hover:bg-amber-100 hover:border-amber-500 text-left"
                                >
                                    <span class="text-xl">${opt.emoji}</span>
                                    <span class="block text-xs mt-1 font-bold">${opt.label}</span>
                                    ${opt.codice === 'COLITE_LINFOCITICA' ? '<span class="block text-xs text-purple-600">‚Üí chiede IEL</span>' : ''}
                                    ${opt.codice === 'COLITE_COLLAGENA' ? '<span class="block text-xs text-purple-600">‚Üí chiede spessore</span>' : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Oppure compila manualmente -->
                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <button 
                            onclick="confirmSiteSelection()"
                            class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-all"
                        >
                            üìù Oppure compila manualmente i findings...
                        </button>
                    </div>
                </div>
            `;
        };

        const MultiSiteWorkflow = () => {
            // Mostra direttamente la compilazione findings per le sedi selezionate
            const colonFindings = {
                granulomi_epitelioidi: ['assente', 'sospetti', 'presente'],
                neutrofili_epitelio: ['assente', 'lieve', 'moderata', 'marcata'],
                ascessi_criptici: ['assente', 'presente'],
                plasmacellule_basale: ['assente', 'presente'],
                distorsione_architettura: ['assente', 'presente'],
                metaplasia_paneth: ['assente', 'presente'],
                ulcerazione: ['assente', 'presente'],
                fibrosi_sottomucosa: ['assente', 'lieve', 'moderata', 'marcata'],
                displasia: ['assente', 'indefinita', 'LGD', 'HGD']
            };

            const ileumFindings = {
                granulomi_epitelioidi: ['assente', 'sospetti', 'presente'],
                neutrofili_lamina_propria: ['assente', 'lieve', 'moderata', 'marcata'],
                erosioni_ulcerazioni: ['assente', 'presente'],
                iperplasia_linfoide: ['assente', 'presente'],
                edema_lamina_propria: ['assente', 'presente'],
                atrofia_villi: ['assente', 'lieve', 'moderata', 'marcata'],
                plasmacellule_aumentate: ['assente', 'presente'],
                fibrosi_sottomucosa: ['assente', 'lieve', 'moderata', 'marcata']
            };

            const getLabel = (key) => {
                const labels = {
                    'granulomi_epitelioidi': 'Granulomi Epitelioidi',
                    'neutrofili_epitelio': 'Neutrofili Intraepiteliali',
                    'neutrofili_lamina_propria': 'Neutrofili Lamina Propria',
                    'erosioni_ulcerazioni': 'Erosioni/Ulcerazioni Aftose',
                    'iperplasia_linfoide': 'Iperplasia Linfoide',
                    'edema_lamina_propria': 'Edema Lamina Propria',
                    'atrofia_villi': 'Atrofia Villi',
                    'plasmacellule_aumentate': 'Plasmacellule Aumentate',
                    'ascessi_criptici': 'Ascessi Criptici',
                    'plasmacellule_basale': 'Plasmacellule Basale',
                    'distorsione_architettura': 'Distorsione Architettura',
                    'metaplasia_paneth': 'Metaplasia Paneth',
                    'ulcerazione': 'Ulcerazione',
                    'fibrosi_sottomucosa': 'Fibrosi Sottomucosa',
                    'displasia': '‚ö†Ô∏è Displasia'
                };
                return labels[key] || key.replace(/_/g, ' ');
            };

            const renderFindings = (site, siteIndex) => {
                const isIleum = site === 'ileo';
                const findings = isIleum ? ileumFindings : colonFindings;
                
                return Object.entries(findings).map(([key, values]) => {
                    const label = getLabel(key);
                    const isDisplasia = key === 'displasia';
                    const isGranulomi = key === 'granulomi_epitelioidi';
                    const options = values.map(v => 
                        '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>'
                    ).join('');
                    
                    return `
                        <div class="${isDisplasia ? 'col-span-2 bg-red-50 p-2 rounded border border-red-200' : ''}">
                            <label class="block text-sm font-semibold mb-2 ${isDisplasia ? 'text-red-700' : ''}">${label}:</label>
                            <select id="finding-${siteIndex}-${key}" class="w-full p-2 border rounded ${isDisplasia ? 'border-red-300' : ''}" ${isGranulomi ? `onchange="toggleMucinCheckbox('${site}', '${siteIndex}', this.value)"` : ''}>
                            ${options}
                            </select>
                        </div>
                        ${isGranulomi ? `
                            <div id="mucin-checkbox-container-${siteIndex}" class="col-span-2 hidden bg-yellow-50 p-3 border border-yellow-400 rounded">
                                <label class="flex items-center gap-2">
                                    <input 
                                        type="checkbox" 
                                        id="mucin-granuloma-checkbox-${siteIndex}"
                                        class="w-4 h-4"
                                    >
                                    <span class="text-sm font-semibold text-yellow-900">
                                        ‚ö†Ô∏è Rottura criptale/Mucin granuloma plausibile?
                                    </span>
                                </label>
                                <p class="text-xs text-yellow-800 mt-1">
                                    Spunta se granulomi potrebbero essere secondari a rottura criptale (riduce peso Crohn)
                                </p>
                            </div>
                        ` : ''}
                    `;
                }).join('');
            };

            return `
                <div class="bg-green-50 rounded-lg p-6 mb-6 border-2 border-green-400">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold flex items-center gap-2">
                            <span>üìã</span> Compila Findings per Ogni Sede (${selectedSites.length})
                        </h3>
                        <button 
                            onclick="cancelMultiSiteMode()"
                            class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300"
                        >
                            ‚Üê Torna alla Selezione Sedi
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${selectedSites.map((site, idx) => {
                            const isIleum = site === 'ileo';
                            return `
                                <div class="bg-white rounded-lg p-4 border-2 ${isIleum ? 'border-orange-400' : 'border-blue-400'}">
                                    <h4 class="font-bold text-lg mb-3 capitalize flex items-center gap-2">
                                        <span>${isIleum ? 'üî¨' : 'üî¨'}</span>
                                        ${site}
                                        <span class="text-xs px-2 py-1 rounded ${isIleum ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                                            ${isIleum ? 'Criteri ILEO' : 'Criteri COLON'}
                                        </span>
                                    </h4>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${renderFindings(site, idx)}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button 
                            onclick="addAllSpecimens()"
                            class="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 transition-all text-lg"
                        >
                            ‚úì Salva Tutti i Campioni (${selectedSites.length})
                        </button>
                        <button 
                            onclick="cancelMultiSiteMode()"
                            class="bg-gray-400 text-white px-6 py-3 rounded-lg hover:bg-gray-500"
                        >
                            Annulla
                        </button>
                    </div>
                </div>
            `;
        };

        // Form per editing di un campione esistente
        const EditSpecimenForm = () => {
            if (editingSpecimenIndex === null || !specimens[editingSpecimenIndex]) return '';
            
            const spec = specimens[editingSpecimenIndex];
            const isIleum = spec.siteType === 'ileum';
            
            const findingLabels = {
                'granulomi_epitelioidi': 'Granulomi epitelioidi',
                'neutrofili_epitelio': 'Neutrofili epitelio',
                'neutrofili_lamina_propria': 'Neutrofili LP',
                'ascessi_criptici': 'Ascessi criptici',
                'plasmacellule_basale': 'Plasmacellule basale',
                'distorsione_architettura': 'Distorsione architettura',
                'erosioni_ulcerazioni': 'Erosioni/ulcerazioni',
                'metaplasia_paneth': 'Metaplasia Paneth',
                'ulcerazione': 'Ulcerazione',
                'fibrosi_sottomucosa': 'Fibrosi sottomucosa',
                'displasia': 'Displasia',
                'iperplasia_linfoide': 'Iperplasia linfoide',
                'edema_lamina_propria': 'Edema LP',
                'atrofia_villi': 'Atrofia villi',
                'plasmacellule_aumentate': 'Plasmacellule aumentate'
            };
            
            const findingOptions = {
                'granulomi_epitelioidi': ['assente', 'presente', 'sospetti'],
                'neutrofili_epitelio': ['assente', 'lieve', 'moderata', 'marcata'],
                'neutrofili_lamina_propria': ['assente', 'lieve', 'moderata', 'marcata'],
                'ascessi_criptici': ['assente', 'presente'],
                'plasmacellule_basale': ['assente', 'presente'],
                'distorsione_architettura': ['assente', 'presente'],
                'erosioni_ulcerazioni': ['assente', 'presente'],
                'metaplasia_paneth': ['assente', 'presente'],
                'ulcerazione': ['assente', 'presente'],
                'fibrosi_sottomucosa': ['assente', 'lieve', 'moderata', 'marcata'],
                'displasia': ['assente', 'indefinita', 'basso_grado', 'alto_grado'],
                'iperplasia_linfoide': ['assente', 'presente'],
                'edema_lamina_propria': ['assente', 'presente'],
                'atrofia_villi': ['assente', 'lieve', 'moderata', 'marcata'],
                'plasmacellule_aumentate': ['assente', 'presente']
            };
            
            const findingKeys = isIleum ? [
                'granulomi_epitelioidi', 'neutrofili_lamina_propria', 
                'erosioni_ulcerazioni', 'iperplasia_linfoide',
                'edema_lamina_propria', 'atrofia_villi', 
                'plasmacellule_aumentate', 'fibrosi_sottomucosa'
            ] : [
                'granulomi_epitelioidi', 'neutrofili_epitelio', 'ascessi_criptici',
                'plasmacellule_basale', 'distorsione_architettura', 
                'erosioni_ulcerazioni', 'metaplasia_paneth', 'ulcerazione',
                'fibrosi_sottomucosa', 'displasia'
            ];
            
            return `
                <div class="bg-amber-50 rounded-lg p-6 mb-6 border-2 border-amber-400">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span>‚úèÔ∏è</span> Modifica: <span class="capitalize">${spec.site}</span>
                        <span class="text-sm font-normal px-2 py-1 rounded ${isIleum ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                            ${isIleum ? 'Ileo' : 'Colon'}
                        </span>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        ${findingKeys.map(key => `
                            <div>
                                <label class="block text-sm font-semibold mb-1 ${key === 'displasia' ? 'text-red-700' : ''}">${findingLabels[key]}</label>
                                <select 
                                    id="edit-finding-${key}"
                                    class="w-full p-2 border rounded ${key === 'displasia' ? 'border-red-300' : ''}"
                                >
                                    ${findingOptions[key].map(opt => `
                                        <option value="${opt}" ${spec.findings[key] === opt ? 'selected' : ''}>${opt}</option>
                                    `).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button 
                            onclick="updateSpecimen()"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700"
                        >
                            ‚úì Salva modifiche
                        </button>
                        <button 
                            onclick="cancelEdit()"
                            class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500"
                        >
                            ‚úï Annulla
                        </button>
                    </div>
                </div>
            `;
        };

        const SpecimenList = () => {
            if (specimens.length === 0) {
                return `<div class="text-center py-8 text-gray-500"><p>Nessun campione inserito</p></div>`;
            }

            const getLabel = (key) => {
                const labels = {
                    'granulomi_epitelioidi': 'Granulomi',
                    'neutrofili_epitelio': 'Neutrofili (epitelio)',
                    'neutrofili_lamina_propria': 'Neutrofili (LP)',
                    'erosioni_ulcerazioni': 'Erosioni',
                    'iperplasia_linfoide': 'Iperplasia linf.',
                    'edema_lamina_propria': 'Edema LP',
                    'atrofia_villi': 'Atrofia villi',
                    'plasmacellule_aumentate': 'Plasmacellule',
                    'ascessi_criptici': 'Ascessi criptici',
                    'plasmacellule_basale': 'Plasmacellule basale',
                    'distorsione_architettura': 'Distorsione arch.',
                    'metaplasia_paneth': 'Metaplasia Paneth',
                    'ulcerazione': 'Ulcerazione',
                    'fibrosi_sottomucosa': 'Fibrosi',
                    'displasia': '‚ö†Ô∏è DISPLASIA'
                };
                return labels[key] || key;
            };

            return `
                <div class="space-y-4">
                    ${specimens.map((spec, idx) => {
                        const nancy = spec.siteType !== 'ileum' ? calculateNancyPerSpecimen(spec) : null;
                        const isActive = isSpecimenActive(spec);
                        
                        return `
                        <div class="bg-white border-2 ${editingSpecimenIndex === idx ? 'border-amber-400 bg-amber-50' : spec.findings.displasia && spec.findings.displasia !== 'assente' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-lg capitalize">${spec.site}</h4>
                                    <div class="flex gap-2 mt-1 flex-wrap">
                                        <span class="text-xs px-2 py-1 rounded ${spec.siteType === 'ileum' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                                            ${spec.siteType === 'ileum' ? 'üî¨ Ileo' : 'üî¨ Colon'}
                                        </span>
                                        ${nancy !== null ? `
                                            <span class="text-xs px-2 py-1 rounded ${nancy >= 2 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                                Nancy: ${nancy}
                                            </span>
                                        ` : ''}
                                        <span class="text-xs px-2 py-1 rounded ${isActive ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                            ${isActive ? 'üî• Attiva' : '‚úì Quiescente'}
                                        </span>
                                        ${spec.mucinGranulomaLikely ? `
                                            <span 
                                                class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700 cursor-help"
                                                title="Granulomi da rottura criptale (mucin granuloma) non sono specifici per Crohn. Frequenti in IBD attiva, infezioni, diverticolite. Il peso diagnostico √® ridotto."
                                            >
                                                ‚ö†Ô∏è Mucin granuloma?
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                ${!caseLocked ? `
                                    <div class="flex gap-2">
                                        <button 
                                            onclick="editSpecimen(${idx})"
                                            class="text-blue-600 hover:text-blue-800 font-bold text-sm"
                                        >
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button 
                                            onclick="removeSpecimen(${idx})"
                                            class="text-red-600 hover:text-red-800 font-bold text-sm"
                                        >
                                            ‚úï Rimuovi
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                ${Object.entries(spec.findings)
                                    .filter(([k, v]) => v !== 'assente')
                                    .map(([k, v]) => `
                                        <div class="bg-gray-50 p-2 rounded ${k === 'displasia' ? 'bg-red-100 col-span-3' : ''}">
                                            <span class="font-semibold ${k === 'displasia' ? 'text-red-700' : ''}">${getLabel(k)}:</span>
                                            <span class="ml-1">${v}</span>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        };

        // ==================== IHC PANEL ====================
        const IHCPanel = () => {
            if (caseLocked) {
                return `
                    <div class="bg-gray-100 rounded-lg p-6 text-center">
                        <p class="text-gray-600">üîí Caso bloccato. IHC non modificabile.</p>
                    </div>
                `;
            }
            
            return `
                <div class="bg-purple-50 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Immunoistochimica</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">CD68 Pattern:</label>
                            <select onchange="updateIHC('cd68_pattern', this.value)" class="w-full p-2 border rounded">
                                <option value="non_eseguito" ${ihcData.cd68_pattern === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                                <option value="aggregati_profondi" ${ihcData.cd68_pattern === 'aggregati_profondi' ? 'selected' : ''}>Aggregati macrofagici profondi/sottomucosa (Crohn-like)</option>
                                <option value="diffuso_mucosa" ${ihcData.cd68_pattern === 'diffuso_mucosa' ? 'selected' : ''}>Diffuso mucosa (RCU-like)</option>
                            </select>
                            <p class="text-xs text-gray-600 mt-1">
                                ‚ÑπÔ∏è "Aggregati profondi": pattern macrofagico con estensione sottomucosa (se presente in biopsia)
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">p53 Pattern:</label>
                            <select onchange="updateIHC('p53_pattern', this.value)" class="w-full p-2 border rounded">
                                <option value="non_eseguito" ${ihcData.p53_pattern === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                                <option value="wild_type" ${ihcData.p53_pattern === 'wild_type' ? 'selected' : ''}>Wild-type (normale)</option>
                                <option value="overexpression" ${ihcData.p53_pattern === 'overexpression' ? 'selected' : ''}>Overexpression (mutazione missense)</option>
                                <option value="null" ${ihcData.p53_pattern === 'null' ? 'selected' : ''}>Null/Complete loss (mutazione nonsense)</option>
                            </select>
                            ${ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null' ? `
                                <div class="mt-2 p-2 bg-red-50 border border-red-300 rounded">
                                    <p class="text-xs text-red-600 font-semibold">‚ö†Ô∏è Pattern aberrante = ALTO RISCHIO DISPLASIA</p>
                                    <p class="text-xs text-red-700 mt-1 italic">
                                        Il grading displastico √® MORFOLOGICO. p53 non lo definisce.
                                    </p>
                                </div>
                            ` : ''}
                        </div>

                        <div class="border-t pt-4">
                            <label class="block text-sm font-semibold mb-2">ü¶† CMV:</label>
                            <select onchange="updateIHC('cmv_status', this.value)" class="w-full p-2 border rounded">
                                <option value="non_eseguito" ${ihcData.cmv_status === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                                <option value="negativo" ${ihcData.cmv_status === 'negativo' ? 'selected' : ''}>Negativo</option>
                                <option value="dubbio" ${ihcData.cmv_status === 'dubbio' ? 'selected' : ''}>Dubbio</option>
                                <option value="positivo" ${ihcData.cmv_status === 'positivo' ? 'selected' : ''}>Positivo</option>
                            </select>
                            ${ihcData.cmv_status === 'positivo' ? `
                                <div class="mt-2 p-3 bg-red-100 border border-red-400 rounded">
                                    <p class="text-sm text-red-800 font-semibold">‚ö†Ô∏è CMV POSITIVO</p>
                                    <p class="text-xs text-red-700 mt-1">
                                        Compatibile con colite da CMV sovrapposta. 
                                        Correlare con carica virale, inclusioni citomegaliche e contesto clinico. 
                                        Considerare valutazione infettivologica.
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- COLITI MICROSCOPICHE -->
                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-3 text-purple-800">üî¨ Coliti Microscopiche</h4>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Banda collagene:</label>
                                    <select onchange="updateAltreColiti('banda_collagene', this.value)" class="w-full p-2 border rounded">
                                        <option value="assente" ${altreColiti.banda_collagene === 'assente' ? 'selected' : ''}>Normale/Assente</option>
                                        <option value="ispessita" ${altreColiti.banda_collagene === 'ispessita' ? 'selected' : ''}>Ispessita (‚â•10Œºm)</option>
                                        <option value="marcata" ${altreColiti.banda_collagene === 'marcata' ? 'selected' : ''}>Marcatamente ispessita (>20Œºm)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold mb-2">IEL:</label>
                                    <select onchange="updateAltreColiti('iel_aumentati', this.value)" class="w-full p-2 border rounded">
                                        <option value="assente" ${altreColiti.iel_aumentati === 'assente' ? 'selected' : ''}>Normali</option>
                                        <option value="aumentati" ${altreColiti.iel_aumentati === 'aumentati' ? 'selected' : ''}>Aumentati (‚â•20/100)</option>
                                        <option value="marcati" ${altreColiti.iel_aumentati === 'marcati' ? 'selected' : ''}>Marcatamente aumentati (>30/100)</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${altreColiti.banda_collagene !== 'assente' ? `
                                <div class="mt-3">
                                    <label class="block text-sm font-semibold mb-2">Spessore banda collagene (Œºm):</label>
                                    <div class="flex items-center gap-2">
                                        <input 
                                            type="number" 
                                            min="0" 
                                            max="100"
                                            value="${altreColiti.banda_collagene_um || ''}"
                                            onchange="updateAltreColiti('banda_collagene_um', this.value ? parseInt(this.value) : null)"
                                            class="w-24 p-2 border rounded"
                                            placeholder="es. 15"
                                        >
                                        <span class="text-sm text-gray-600">Œºm (v.n. &lt;10Œºm)</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${altreColiti.iel_aumentati !== 'assente' ? `
                                <div class="mt-3">
                                    <label class="block text-sm font-semibold mb-2">Conta IEL (per 100 cellule epiteliali):</label>
                                    <div class="flex items-center gap-2">
                                        <input 
                                            type="number" 
                                            min="0" 
                                            max="100"
                                            value="${altreColiti.iel_count || ''}"
                                            onchange="updateAltreColiti('iel_count', this.value ? parseInt(this.value) : null)"
                                            class="w-24 p-2 border rounded"
                                            placeholder="es. 35"
                                        >
                                        <span class="text-sm text-gray-600">/100 cellule epiteliali (v.n. &lt;20)</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${altreColiti.banda_collagene !== 'assente' || altreColiti.iel_aumentati !== 'assente' ? `
                                <div class="mt-3 p-2 bg-purple-100 border border-purple-300 rounded text-sm">
                                    <p class="text-purple-800">
                                        ${altreColiti.banda_collagene !== 'assente' ? 'üìå Colite collagenosica' : 'üìå Colite linfocitica'}
                                        - Architettura ghiandolare tipicamente conservata
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        // ==================== SINTESI ENDOSCOPISTA ====================
        const SintesiEndoscopistaBox = ({ sintesi }) => {
            if (!sintesi || !sintesi.isFollowUp || !sintesi.diagnosiAttuale) return '';
            
            const diagnosiLabel = {
                'RCU': 'Rettocolite ulcerosa',
                'Crohn': 'Malattia di Crohn',
                'IBDU': 'IBD non classificabile'
            };
            
            const formatSedi = (sedi) => sedi.length > 0 ? sedi.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ') : '‚Äî';
            
            const sintesiText = `${diagnosiLabel[sintesi.diagnosiAttuale]} - FOLLOW-UP

Quiescenza: ${formatSedi(sintesi.sediQuiescenti)}
Attivit√†: ${formatSedi(sintesi.sediAttive)}
${sintesi.nancyMax !== null ? `NANCY MAX: ${sintesi.nancyMax}` : ''}
${sintesi.hasDisplasia ? `‚ö†Ô∏è DISPLASIA: ${sintesi.maxDisplasia} (${sintesi.displasiaDetails.map(d => d.site).join(', ')})${sintesi.p53Aberrante ? ' - p53 aberrante' : ''}` : ''}`.trim();
            
            return `
                <div class="sintesi-box rounded-lg p-5 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-lg text-green-900 flex items-center gap-2">
                            <span>üìã</span> SINTESI PER ENDOSCOPISTA
                        </h3>
                        <button 
                            onclick="copySintesi()"
                            class="copy-btn bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-all"
                        >
                            üìã Copia
                        </button>
                    </div>
                    
                    <div class="bg-white rounded p-4 font-mono text-sm space-y-2">
                        <p class="font-bold text-lg">${diagnosiLabel[sintesi.diagnosiAttuale]} - FOLLOW-UP</p>
                        ${sintesi.diagnosiIniziale !== sintesi.diagnosiAttuale ? `
                            <p class="text-xs text-gray-500">(diagnosi iniziale: ${sintesi.diagnosiIniziale})</p>
                        ` : ''}
                        <div class="border-t pt-2 mt-2">
                            <p><span class="text-green-700">Quiescenza:</span> ${formatSedi(sintesi.sediQuiescenti)}</p>
                            <p><span class="text-red-700">Attivit√†:</span> ${formatSedi(sintesi.sediAttive)}</p>
                        </div>
                        ${sintesi.nancyMax !== null ? `
                            <p class="text-xl font-bold mt-2">NANCY MAX: ${sintesi.nancyMax}</p>
                        ` : ''}
                        ${sintesi.hasDisplasia ? `
                            <div class="mt-2 p-2 bg-red-100 rounded border border-red-300">
                                <p class="text-red-800 font-bold">‚ö†Ô∏è DISPLASIA: ${sintesi.maxDisplasia}</p>
                                <p class="text-sm text-red-700">Sede: ${sintesi.displasiaDetails.map(d => `${d.site} (${d.grado})`).join(', ')}</p>
                                ${sintesi.p53Aberrante ? `<p class="text-sm text-red-700">p53: aberrante (supporta)</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <p class="text-xs text-green-700 mt-2">
                        Questa sintesi √® pensata per copia-incolla nel referto endoscopico.
                    </p>
                </div>
                
                <textarea id="sintesi-clipboard" class="hidden">${sintesiText}</textarea>
            `;
        };

        // ==================== REPORT TAB ====================
        const ReportTab = () => {
            if (specimens.length === 0) {
                return `
                    <div class="text-center py-12 text-gray-500">
                        <p class="text-xl mb-2">Nessun dato disponibile</p>
                        <p>Aggiungi almeno un campione per generare il referto</p>
                    </div>
                `;
            }

            const report = generateReport();
            
            // CHECK: Mucosa normale
            const isNormalMucosa = report.interpretation.level === 'normale';

            // CASO SPECIALE: Mucosa completamente normale
            if (isNormalMucosa) {
                return `
                    <div class="space-y-6">
                        <div class="bg-white border-2 border-green-400 rounded-lg p-6">
                            <h3 class="text-xl font-bold mb-4 text-green-800">üìÑ REFERTO ISTOLOGICO</h3>
                            
                            <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 rounded">
                                <p class="font-bold text-lg mb-1 text-green-900">${report.interpretation.headline}</p>
                                <p class="text-sm text-green-800">${report.interpretation.description}</p>
                            </div>

                            <div class="mb-4">
                                <h4 class="font-semibold mb-2">Sedi esaminate:</h4>
                                <p class="text-sm text-gray-700">
                                    ${specimens.map(s => s.site.charAt(0).toUpperCase() + s.site.slice(1)).join(', ')}
                                </p>
                            </div>
                            
                            <div class="mt-4 p-3 bg-gray-50 rounded text-sm text-gray-600">
                                <p>‚úì Nessuna evidenza di malattia infiammatoria intestinale</p>
                                <p>‚úì Assenza di displasia</p>
                                <p>‚úì Architettura criptica conservata</p>
                            </div>
                        </div>

                        <div class="flex gap-4 no-print">
                            <button onclick="copyReferto()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700">
                                üìã Copia referto
                            </button>
                            <button onclick="window.print()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">
                                üñ®Ô∏è Stampa/PDF
                            </button>
                            <button onclick="saveData()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
                                üíæ Salva
                            </button>
                            <button onclick="unlockForEdit()" class="bg-amber-500 text-white px-6 py-3 rounded hover:bg-amber-600">
                                üîì Modifica
                            </button>
                        </div>
                    </div>
                `;
            }

            // CASO NORMALE: IBD o altre patologie
            return `
                <div class="space-y-6">
                    
                    <!-- ========== 1. REFERTO ISTOLOGICO (PRINCIPALE) ========== -->
                    <div class="bg-white border-2 border-gray-400 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìÑ REFERTO ISTOLOGICO</h3>
                        
                        ${report.ibdNota.enabled && report.ibdNota.diagnosiAttuale ? `
                            <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                                <p class="font-semibold text-base">
                                    Quadro istologico di IBD compatibile, alla luce della storia clinica, con 
                                    <strong>${report.ibdNota.diagnosiAttuale === 'RCU' ? 'rettocolite ulcerosa' : 
                                             report.ibdNota.diagnosiAttuale === 'Crohn' ? 'malattia di Crohn' : 'IBD non classificata'}</strong>.
                                </p>
                            </div>
                        ` : `
                            <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                                <p class="font-bold text-lg mb-1">${report.interpretation.headline}</p>
                                <p class="text-sm text-gray-700">${report.interpretation.description}</p>
                                ${report.nancy.applicable ? `
                                    <p class="text-sm text-gray-700 mt-2">
                                        Nancy Histological Index: ${report.nancy.score}/4 - ${report.nancy.interpretation.label} (Marchal-Bressenot et al. Gut 2017)
                                    </p>
                                ` : ''}
                            </div>
                        `}

                        <div class="mb-4">
                            <h4 class="font-semibold mb-2">Dettaglio per sede:</h4>
                            <table class="w-full text-sm border-collapse">
                                <thead>
                                    <tr class="bg-gray-200">
                                        <th class="border p-2 text-left">Sede</th>
                                        <th class="border p-2 text-left">Stato</th>
                                        ${report.ibdNota.diagnosiAttuale === 'RCU' ? '<th class="border p-2 text-left">Nancy</th>' : ''}
                                        <th class="border p-2 text-left">Displasia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${specimens.map(s => {
                                        const nancy = s.siteType !== 'ileum' ? calculateNancyPerSpecimen(s) : null;
                                        const active = isSpecimenActive(s);
                                        return `
                                            <tr>
                                                <td class="border p-2 capitalize font-semibold">${s.site}</td>
                                                <td class="border p-2 ${active ? 'text-red-600' : 'text-green-600'}">${active ? 'Attiva' : 'Quiescente'}</td>
                                                ${report.ibdNota.diagnosiAttuale === 'RCU' ? `<td class="border p-2">${nancy !== null ? nancy : 'N/A'}</td>` : ''}
                                                <td class="border p-2 ${s.findings.displasia && s.findings.displasia !== 'assente' ? 'text-red-600 font-bold' : ''}">${s.findings.displasia || 'N/A'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ========== 2. SINTESI ENDOSCOPISTA (se follow-up) ========== -->
                    ${SintesiEndoscopistaBox({ sintesi: report.sintesiEndoscopista })}

                    <!-- ========== 3. ALERT CMV ========== -->
                    ${report.ihcData.cmv_status === 'positivo' ? `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4">
                            <h4 class="font-bold text-red-900 mb-2">ü¶† CMV POSITIVO</h4>
                            <p class="text-sm text-red-800">
                                Compatibile con colite da CMV sovrapposta. 
                                Correlare con carica virale, inclusioni citomegaliche e contesto clinico. 
                                Considerare valutazione infettivologica.
                            </p>
                        </div>
                    ` : ''}

                    <!-- ========== 4. ALERT DISPLASIA ========== -->
                    ${report.dysplasiaReport ? `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4">
                            <h4 class="font-bold text-red-900 mb-2">‚ö†Ô∏è DISPLASIA RILEVATA</h4>
                            <div class="space-y-2">
                                <p class="text-sm text-red-800 font-semibold">Grado massimo: ${report.dysplasiaReport.maxGrade}</p>
                                ${report.dysplasiaReport.findings.map(d => `
                                    <p class="text-sm text-red-800">‚Ä¢ ${d.site.toUpperCase()}: ${d.grade}</p>
                                `).join('')}
                                ${report.dysplasiaReport.p53Aberrant ? `
                                    <div class="mt-2 p-2 bg-red-100 rounded">
                                        <p class="text-sm text-red-800 font-semibold">
                                            p53 aberrante (${report.ihcData.p53_pattern}): supporta displasia
                                        </p>
                                        <p class="text-xs text-red-700 mt-1 italic">
                                            ‚ö†Ô∏è Il grading displastico √® MORFOLOGICO. p53 non lo definisce.
                                            L'IHC supporta ma non sostituisce la valutazione morfologica.
                                        </p>
                                    </div>
                                ` : ''}
                                <div class="mt-3 p-3 bg-white rounded border-l-4 border-red-600">
                                    <p class="text-sm font-semibold text-red-900">Raccomandazione:</p>
                                    <p class="text-sm text-red-800">${report.dysplasiaReport.recommendation}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- ========== 5. SCORING (solo prima diagnosi) ========== -->
                    ${!report.ibdNota.enabled ? `
                        <div class="bg-white border-2 border-blue-400 rounded-lg p-4 no-print">
                            <h4 class="font-semibold mb-3">üìä Scoring Orientativo</h4>
                            
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between items-center text-sm mb-1">
                                        <span>Crohn</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs px-2 py-0.5 rounded ${getScoreLabel(report.scoring.scores.crohn).class}">${getScoreLabel(report.scoring.scores.crohn).text}</span>
                                            <span class="font-bold">${report.scoring.scores.crohn}%</span>
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${report.scoring.scores.crohn}%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center text-sm mb-1">
                                        <span>RCU</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs px-2 py-0.5 rounded ${getScoreLabel(report.scoring.scores.uc).class}">${getScoreLabel(report.scoring.scores.uc).text}</span>
                                            <span class="font-bold">${report.scoring.scores.uc}%</span>
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-purple-600 h-2 rounded-full" style="width: ${report.scoring.scores.uc}%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center text-sm mb-1">
                                        <span>IBDU</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs px-2 py-0.5 rounded ${getScoreLabel(report.scoring.scores.ibdu).class}">${getScoreLabel(report.scoring.scores.ibdu).text}</span>
                                            <span class="font-bold">${report.scoring.scores.ibdu}%</span>
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-amber-600 h-2 rounded-full" style="width: ${report.scoring.scores.ibdu}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            ${report.interpretation.epistemicNote ? `
                                <div class="epistemic-note p-3 rounded mt-3">
                                    <p class="text-xs font-semibold text-amber-900 mb-1">üìå Nota:</p>
                                    <p class="text-xs text-amber-800">${report.interpretation.epistemicNote}</p>
                                </div>
                            ` : ''}
                            
                            ${report.scoring.granulomasDriven ? `
                                <div class="bg-blue-50 border border-blue-300 p-2 rounded mt-3">
                                    <p class="text-xs text-blue-800">
                                        <strong>‚ÑπÔ∏è Nota metodologica:</strong> Il peso diagnostico Crohn √® trainato prevalentemente 
                                        dalla presenza di granulomi epitelioidi. Score grezzo: Crohn ${report.scoring.rawScores.crohn}, 
                                        di cui ${report.scoring.granulomaScore} da granulomi.
                                    </p>
                                </div>
                            ` : ''}
                            
                            <p class="text-xs text-gray-500 mt-3 italic">
                                ‚ö†Ô∏è Scoring orientativo, NON validato. Diagnosi finale richiede correlazione clinica.
                                <br>üìä Percentuali non comparabili tra casi diversi.
                            </p>
                        </div>
                    ` : ''}



                    <!-- ========== 6.5 ALERT CRITICI STAMPABILI ========== -->
                    ${(() => {
                        const alerts = [];
                        
                        // Granulomi ileali isolati senza cronicit√†
                        const ileumWithGranulomas = specimens.filter(s => 
                            s.siteType === 'ileum' && 
                            s.findings.granulomi_epitelioidi === 'presente' &&
                            !s.mucinGranulomaLikely
                        );
                        ileumWithGranulomas.forEach(s => {
                            const f = s.findings;
                            if (f.atrofia_villi === 'assente' && f.plasmacellule_aumentate === 'assente') {
                                alerts.push({
                                    type: 'granuloma_isolato',
                                    text: 'Granulomi ileali isolati senza alterazioni croniche: diagnosi differenziale infettiva obbligatoria (TBC, Yersinia, sarcoidosi). Considerare colorazioni Ziehl-Neelsen e/o PCR Mycobacterium.'
                                });
                            }
                        });
                        
                        // SCAD
                        if (report.diagnosiVeloce.selected === 'SCAD') {
                            alerts.push({
                                type: 'scad',
                                text: 'SCAD: diagnosi di esclusione. Necessaria correlazione con distribuzione endoscopica (sigma coinvolto, retto indenne) e assenza di ileite. Escludere IBD, infezione, ischemia.'
                            });
                        }
                        
                        if (alerts.length === 0) return '';
                        
                        return alerts.map(a => `
                            <div class="bg-amber-50 border-2 border-amber-500 rounded-lg p-4 mb-4">
                                <p class="text-sm text-amber-900">
                                    <strong>‚ö†Ô∏è Nota diagnostica:</strong> ${a.text}
                                </p>
                            </div>
                        `).join('');
                    })()}

                    <!-- ========== 7. NOTE CLINICHE ========== -->
                    ${report.validations.length > 0 ? `
                        <div class="bg-orange-50 border-2 border-orange-400 rounded-lg p-4 no-print">
                            <h4 class="font-bold text-orange-900 mb-2">üîç Note Cliniche</h4>
                            ${report.validations.map(w => `
                                <div class="mb-2 p-2 bg-white rounded">
                                    <p class="font-semibold text-sm">${w.message}</p>
                                    <p class="text-xs text-gray-600">${w.suggestion}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- ========== 7.5 FLAG MDT (Punto 4 ChatGPT) ========== -->
                    ${(() => {
                        const mdtReasons = shouldFlagMDT(report);
                        if (!mdtReasons) return '';
                        return `
                            <div class="bg-purple-100 border-2 border-purple-500 rounded-lg p-4">
                                <h4 class="font-bold text-purple-900 mb-2">üè• CASO DA DISCUSSIONE MDT</h4>
                                <p class="text-sm text-purple-800 mb-2">
                                    Si suggerisce discussione multidisciplinare per i seguenti motivi:
                                </p>
                                <ul class="list-disc ml-5 space-y-1 text-sm text-purple-800">
                                    ${mdtReasons.map(r => `<li>${r}</li>`).join('')}
                                </ul>
                                <p class="text-xs text-purple-700 mt-3 italic">
                                    La complessit√† diagnostica richiede integrazione con gastroenterologo, 
                                    endoscopista e, se indicato, chirurgo.
                                </p>
                            </div>
                        `;
                    })()}

                    <!-- ========== 8. NOTE METODOLOGICHE (solo patologo) ========== -->
                    ${report.contradictoryNotes.length > 0 ? `
                        <div class="no-print">
                            <h4 class="font-bold text-amber-900 mb-3">‚ö†Ô∏è Note Metodologiche (Solo per patologo)</h4>
                            ${report.contradictoryNotes.map(note => `
                                <div class="epistemic-note p-4 rounded-lg mb-3">
                                    <p class="font-bold text-amber-900 mb-2">${note.title}</p>
                                    <ul class="list-disc ml-5 space-y-1 text-sm text-amber-800">
                                        ${note.features.map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                    <p class="text-sm text-amber-900 mt-2"><strong>Interpretazione:</strong> ${note.interpretation}</p>
                                    <p class="text-sm text-amber-900 mt-1"><strong>Raccomandazione:</strong> ${note.suggestion}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- ========== 9. BOTTONI AZIONE ========== -->
                    <div class="flex gap-4 no-print">
                        <button onclick="copyReferto()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700">
                            üìã Copia referto
                        </button>
                        <button onclick="window.print()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">
                            üñ®Ô∏è Stampa/PDF
                        </button>
                        <button onclick="saveData()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
                            üíæ Salva
                        </button>
                        <button onclick="unlockForEdit()" class="bg-amber-500 text-white px-6 py-3 rounded hover:bg-amber-600">
                            üîì Modifica
                        </button>
                    </div>
                </div>
            `;
        };

        // ==================== EVENT HANDLERS ====================
        
        const switchTab = (tab) => {
            if (caseLocked && (tab === 'campioni' || tab === 'ihc')) return;
            
            activeTab = tab;
            
            if (tab === 'referto' && specimens.length > 0 && !caseLocked) {
                lockCase();
            }
            
            render();
        };

        const addSpecimen = () => {
            if (caseLocked) return;
            
            const site = document.getElementById('site-select').value;
            const findings = {};
            const isIleum = (site === 'ileo');
            
            const findingKeys = isIleum ? [
                'granulomi_epitelioidi', 'neutrofili_lamina_propria', 
                'erosioni_ulcerazioni', 'iperplasia_linfoide',
                'edema_lamina_propria', 'atrofia_villi', 
                'plasmacellule_aumentate', 'fibrosi_sottomucosa'
            ] : [
                'granulomi_epitelioidi', 'neutrofili_epitelio', 'ascessi_criptici',
                'plasmacellule_basale', 'distorsione_architettura', 'metaplasia_paneth',
                'ulcerazione', 'fibrosi_sottomucosa', 'displasia'
            ];

            findingKeys.forEach(key => {
                const element = document.getElementById(`finding-${key}`);
                if (element) findings[key] = element.value;
            });

            const mucinCheckbox = document.getElementById('mucin-granuloma-checkbox-single');
            const mucinGranulomaLikely = mucinCheckbox && mucinCheckbox.checked;

            specimens.push({ 
                site, 
                findings, 
                siteType: isIleum ? 'ileum' : 'colon',
                mucinGranulomaLikely: mucinGranulomaLikely || false
            });
            
            saveData();
            render();
        };

        const removeSpecimen = (index) => {
            if (caseLocked) return;
            specimens.splice(index, 1);
            saveData();
            render();
        };

        const editSpecimen = (index) => {
            if (caseLocked) return;
            editingSpecimenIndex = index;
            render();
        };

        const cancelEdit = () => {
            editingSpecimenIndex = null;
            render();
        };

        const updateSpecimen = () => {
            if (caseLocked || editingSpecimenIndex === null) return;
            
            const spec = specimens[editingSpecimenIndex];
            const isIleum = spec.siteType === 'ileum';
            
            const findingKeys = isIleum ? [
                'granulomi_epitelioidi', 'neutrofili_lamina_propria', 
                'erosioni_ulcerazioni', 'iperplasia_linfoide',
                'edema_lamina_propria', 'atrofia_villi', 
                'plasmacellule_aumentate', 'fibrosi_sottomucosa'
            ] : [
                'granulomi_epitelioidi', 'neutrofili_epitelio', 'ascessi_criptici',
                'plasmacellule_basale', 'distorsione_architettura', 
                'erosioni_ulcerazioni', 'metaplasia_paneth', 'ulcerazione',
                'fibrosi_sottomucosa', 'displasia'
            ];
            
            const newFindings = {};
            findingKeys.forEach(key => {
                const el = document.getElementById(`edit-finding-${key}`);
                if (el) newFindings[key] = el.value;
            });
            
            // Aggiorna il campione
            specimens[editingSpecimenIndex].findings = newFindings;
            
            // Ricalcola mucin granuloma
            if (newFindings.granulomi_epitelioidi === 'presente') {
                const hasActiveMucosal = 
                    newFindings.neutrofili_epitelio === 'moderata' || 
                    newFindings.neutrofili_epitelio === 'marcata' ||
                    newFindings.ascessi_criptici === 'presente' ||
                    newFindings.ulcerazione === 'presente';
                specimens[editingSpecimenIndex].mucinGranulomaLikely = hasActiveMucosal;
            } else {
                specimens[editingSpecimenIndex].mucinGranulomaLikely = false;
            }
            
            // Reset editing e flag auto-generati
            editingSpecimenIndex = null;
            diagnosiVeloce.autoGenerated = false;
            
            saveData();
            render();
        };

        const updateIHC = (field, value) => {
            if (caseLocked) return;
            ihcData[field] = value;
            saveData();
            render();
        };

        const copySintesi = () => {
            const textarea = document.getElementById('sintesi-clipboard');
            if (textarea) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert('Sintesi copiata negli appunti!');
                }).catch(() => {
                    textarea.classList.remove('hidden');
                    textarea.select();
                    document.execCommand('copy');
                    textarea.classList.add('hidden');
                    alert('Sintesi copiata!');
                });
            }
        };

        const copyReferto = () => {
            const report = generateReport();
            const isNormal = report.interpretation.level === 'normale';
            
            let plainText = '';
            let html = '<div style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6;">';
            
            if (isNormal) {
                // Referto normale
                plainText = `${report.interpretation.headline}\n`;
                plainText += `${report.interpretation.description}\n\n`;
                plainText += `Sedi esaminate: ${specimens.map(s => s.site.charAt(0).toUpperCase() + s.site.slice(1)).join(', ')}`;
                
                html += `<p style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">${report.interpretation.headline}</p>`;
                html += `<p style="margin-bottom: 12px;">${report.interpretation.description}</p>`;
                html += `<p>Sedi esaminate: ${specimens.map(s => s.site.charAt(0).toUpperCase() + s.site.slice(1)).join(', ')}</p>`;
            } else if (report.ibdNota.enabled && report.ibdNota.diagnosiAttuale) {
                // Follow-up IBD
                const diagnosi = report.ibdNota.diagnosiAttuale === 'RCU' ? 'rettocolite ulcerosa' : 
                                 report.ibdNota.diagnosiAttuale === 'Crohn' ? 'malattia di Crohn' : 'IBD non classificata';
                plainText = `Quadro istologico di IBD compatibile, alla luce della storia clinica, con ${diagnosi}.\n\n`;
                plainText += `Dettaglio per sede:\n`;
                
                html += `<p style="margin-bottom: 12px;">Quadro istologico di IBD compatibile, alla luce della storia clinica, con <strong>${diagnosi}</strong>.</p>`;
                html += `<p style="margin-bottom: 8px;"><strong>Dettaglio per sede:</strong></p><ul style="margin-top: 0;">`;
                
                specimens.forEach(s => {
                    const nancy = s.siteType !== 'ileum' ? calculateNancyPerSpecimen(s) : null;
                    const active = isSpecimenActive(s);
                    const stato = active ? 'Attiva' : 'Quiescente';
                    const displasia = s.findings.displasia || 'assente';
                    plainText += `- ${s.site.charAt(0).toUpperCase() + s.site.slice(1)}: ${stato}`;
                    html += `<li><strong>${s.site.charAt(0).toUpperCase() + s.site.slice(1)}:</strong> ${stato}`;
                    if (report.ibdNota.diagnosiAttuale === 'RCU' && nancy !== null) {
                        plainText += `, Nancy ${nancy}`;
                        html += `, Nancy ${nancy}`;
                    }
                    if (displasia !== 'assente') {
                        plainText += `, displasia ${displasia}`;
                        html += `, displasia ${displasia}`;
                    }
                    plainText += `\n`;
                    html += `</li>`;
                });
                html += `</ul>`;
            } else {
                // Prima diagnosi
                plainText = `${report.interpretation.headline}\n`;
                plainText += `${report.interpretation.description}\n\n`;
                
                html += `<p style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">${report.interpretation.headline}</p>`;
                html += `<p style="margin-bottom: 8px;">${report.interpretation.description}</p>`;
                
                // Aggiungi Nancy globale se applicabile
                if (report.nancy.applicable) {
                    plainText += `Nancy Histological Index (Marchal-Bressenot et al. Gut 2017): ${report.nancy.score}/4 - ${report.nancy.interpretation.label}\n`;
                    plainText += `${report.nancy.interpretation.description}\n\n`;
                    
                    html += `<p style="margin-bottom: 8px;">Nancy Histological Index (Marchal-Bressenot et al. Gut 2017): <strong>${report.nancy.score}/4</strong> - ${report.nancy.interpretation.label}</p>`;
                    html += `<p style="margin-bottom: 12px; font-size: 13px; color: #555;">${report.nancy.interpretation.description}</p>`;
                }
                
                plainText += `Dettaglio per sede:\n`;
                html += `<p style="margin-bottom: 8px;"><strong>Dettaglio per sede:</strong></p><ul style="margin-top: 0;">`;
                
                specimens.forEach(s => {
                    const active = isSpecimenActive(s);
                    const nancy = s.siteType !== 'ileum' ? calculateNancyPerSpecimen(s) : null;
                    const stato = active ? 'Attiva' : 'Quiescente';
                    const displasia = s.findings.displasia || 'assente';
                    plainText += `- ${s.site.charAt(0).toUpperCase() + s.site.slice(1)}: ${stato}`;
                    html += `<li><strong>${s.site.charAt(0).toUpperCase() + s.site.slice(1)}:</strong> ${stato}`;
                    if (report.nancy.applicable && nancy !== null) {
                        plainText += `, Nancy ${nancy}`;
                        html += `, Nancy ${nancy}`;
                    }
                    if (displasia !== 'assente') {
                        plainText += `, displasia ${displasia}`;
                        html += `, displasia ${displasia}`;
                    }
                    plainText += `\n`;
                    html += `</li>`;
                });
                html += `</ul>`;
            }
            
            // Aggiungi alert displasia se presente
            if (report.dysplasiaReport) {
                plainText += `\n‚ö†Ô∏è DISPLASIA RILEVATA: ${report.dysplasiaReport.maxGrade}\n`;
                html += `<p style="margin-top: 12px; color: #dc2626; font-weight: bold;">‚ö†Ô∏è DISPLASIA RILEVATA: ${report.dysplasiaReport.maxGrade}</p>`;
            }
            
            html += '</div>';
            
            // Copia con formattazione (HTML + plain text)
            const htmlBlob = new Blob([html], { type: 'text/html' });
            const textBlob = new Blob([plainText], { type: 'text/plain' });
            
            const clipboardItem = new ClipboardItem({
                'text/html': htmlBlob,
                'text/plain': textBlob
            });
            
            navigator.clipboard.write([clipboardItem]).then(() => {
                alert('‚úÖ Referto copiato con formattazione!');
            }).catch(() => {
                // Fallback per browser vecchi: copia solo testo
                navigator.clipboard.writeText(plainText).then(() => {
                    alert('‚úÖ Referto copiato (solo testo)!');
                }).catch(() => {
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = plainText;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    alert('‚úÖ Referto copiato!');
                });
            });
        };

        const clearData = () => {
            if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                unlockCase();
            }
        };

        const saveData = () => {
            try {
                const data = {
                    version: APP_VERSION,
                    specimens,
                    ihcData,
                    ibdNota,
                    altreColiti,
                    diagnosiVeloce,
                    caseLocked,
                    reportGenerated,
                    selectedSites,
                    multiSiteMode,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        };

        const loadData = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    specimens = data.specimens || [];
                    ihcData = data.ihcData || { cd68_pattern: 'non_eseguito', p53_pattern: 'non_eseguito', cmv_status: 'non_eseguito' };
                    if (!ihcData.cmv_status) ihcData.cmv_status = 'non_eseguito';
                    ibdNota = data.ibdNota || { enabled: false, diagnosiIniziale: null, diagnosiAttuale: null, therapyOngoing: false };
                    if (data.altreColiti) altreColiti = { ...altreColiti, ...data.altreColiti };
                    if (data.diagnosiVeloce) diagnosiVeloce = data.diagnosiVeloce;
                    
                    caseLocked = data.caseLocked || false;
                    reportGenerated = data.reportGenerated || false;
                    selectedSites = data.selectedSites || [];
                    multiSiteMode = data.multiSiteMode || false;
                    
                    if (caseLocked) {
                        document.getElementById('locked-banner').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        };

        // ==================== RENDER ====================
        const render = () => {
            const content = document.getElementById('main-content');
            
            let tabContent = '';
            if (activeTab === 'campioni') {
                if (caseLocked) {
                    tabContent = `
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-2xl mb-4">üîí</p>
                            <p class="text-xl mb-2">Caso Bloccato</p>
                            <p>Tab Campioni non accessibile dopo generazione referto.</p>
                            <p class="mt-4">Usa il pulsante "SBLOCCA NUOVO CASO" per iniziare un nuovo caso.</p>
                        </div>
                    `;
                } else {
                    // Se in editing, mostra form di modifica
                    if (editingSpecimenIndex !== null) {
                        tabContent = ResetButton() + IbdNotaPanel() + EditSpecimenForm() + SpecimenList();
                    } else {
                        tabContent = ResetButton() + IbdNotaPanel() + SpecimenForm() + SpecimenList();
                    }
                }
            } else if (activeTab === 'ihc') {
                tabContent = IHCPanel();
            } else if (activeTab === 'referto') {
                tabContent = ReportTab();
            }

            content.innerHTML = TabNavigation({ active: activeTab, onChange: switchTab }) + tabContent;
        };

        // ==================== EXPORT GLOBALI ====================
        window.acceptDisclaimer = acceptDisclaimer;
        window.addSpecimen = addSpecimen;
        window.removeSpecimen = removeSpecimen;
        window.editSpecimen = editSpecimen;
        window.updateSpecimen = updateSpecimen;
        window.cancelEdit = cancelEdit;
        window.clearData = clearData;
        window.saveData = saveData;
        window.switchTab = switchTab;
        window.updateFormSite = updateFormSite;
        window.updateIHC = updateIHC;
        window.updateAltreColiti = updateAltreColiti;
        window.toggleIbdNota = toggleIbdNota;
        window.updateIbdNota = updateIbdNota;
        window.copySintesi = copySintesi;
        window.selectDiagnosiVeloce = selectDiagnosiVeloce;
        window.clearDiagnosiVeloce = clearDiagnosiVeloce;
        window.updateGradoManuale = updateGradoManuale;
        window.unlockCase = unlockCase;
        window.unlockForEdit = unlockForEdit;
        window.confirmReset = confirmReset;
        window.toggleMucinCheckbox = toggleMucinCheckbox;
        window.toggleMucinCheckboxSingle = toggleMucinCheckboxSingle;
        window.toggleSiteSelection = toggleSiteSelection;
        window.confirmSiteSelection = confirmSiteSelection;
        window.cancelMultiSiteMode = cancelMultiSiteMode;
        window.addAllSpecimens = addAllSpecimens;
        window.selectAllStandardSites = selectAllStandardSites;
        window.deselectAllSites = deselectAllSites;
        window.addAllNormalSpecimens = addAllNormalSpecimens;
        window.applyDiagnosiVeloce = applyDiagnosiVeloce;
        window.copyReferto = copyReferto;

        // ==================== INIT ====================
        loadData();
        checkDisclaimer();
        render();
    </script>

    <!-- Footer -->
    <div class="max-w-6xl mx-auto mt-8 text-xs text-gray-600 text-center p-4 bg-gray-100 rounded">
        <p class="font-semibold mb-2">IBD Diagnostic Tool v3.0.8 "Lean Expert"</p>
        <p class="mb-1">
            <strong>v3.0.8:</strong> Lean expert, alert ridotti. v3.0.7: Nancy con warning, skip lesions smart. v3.0.6: Watermark simulazione, IBDU fix, nota biopsia mucosa. v3.0.5: Griglia selezione sedi + "Seleziona Tutti" (7 sedi standard)
        </p>
        <p class="text-gray-500 text-xs mt-2">
            Release: Febbraio 2026 | Pouch e anastomosi separati come "Casi Speciali"
        </p>
    </div>
</body>
</html>
