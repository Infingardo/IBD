<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Diagnostic Tool v3.1.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, body *, h1, h2, h3, h4, h5, h6, p, div, span, td, th, li, button, input, select {
            font-family: Arial, sans-serif !important;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-after: always; }
        }
        .tab-active {
            background-color: #3b82f6;
            color: white;
            border-bottom: 3px solid #1d4ed8;
        }
        .tab-disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            max-width: 600px;
            width: calc(100% - 20px);
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        .modal-header { flex-shrink: 0; }
        .modal-body { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-footer { flex-shrink: 0; }
        .sintesi-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #22c55e;
        }
        .copy-btn:active { transform: scale(0.95); }
        .locked-banner {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #dc2626;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #dc2626; }
            50% { border-color: #991b1b; }
        }
        .mega-reset-btn {
            animation: pulse-glow 1.5s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px #dc2626, 0 0 20px #dc2626; transform: scale(1); }
            50% { box-shadow: 0 0 20px #dc2626, 0 0 40px #dc2626; transform: scale(1.05); }
        }
        .epistemic-note {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        /* Scoring qualitativo - niente barre percentuali */
        .score-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .score-card.forte { border-color: #dc2626; background: #fef2f2; }
        .score-card.compatibile { border-color: #f97316; background: #fff7ed; }
        .score-card.borderline { border-color: #eab308; background: #fefce8; }
        .score-card.basso { border-color: #d1d5db; background: #f9fafb; }
        .score-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 9999px;
        }
        .score-badge.forte { background: #dc2626; color: white; }
        .score-badge.compatibile { background: #f97316; color: white; }
        .score-badge.borderline { background: #eab308; color: white; }
        .score-badge.basso { background: #9ca3af; color: white; }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <!-- Modal Disclaimer -->
    <div id="disclaimer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header bg-red-600 text-white p-4 rounded-t-xl">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <span>STRUMENTO DI SUPPORTO DIAGNOSTICO</span>
                </h2>
            </div>
            <div class="modal-body p-4 space-y-3">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3">
                    <p class="font-bold mb-1 text-yellow-900">ATTENZIONE: Questo tool NON sostituisce</p>
                    <ul class="list-disc ml-5 space-y-1 text-yellow-800 text-sm">
                        <li>Il ragionamento istopatologico del medico</li>
                        <li>L'integrazione con dati clinici ed endoscopici</li>
                        <li>L'esperienza diagnostica in IBD</li>
                        <li>Il giudizio professionale individuale</li>
                    </ul>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3">
                    <p class="font-semibold text-blue-900 mb-1">Lo scoring √®:</p>
                    <ul class="list-disc ml-5 space-y-1 text-blue-800 text-sm">
                        <li><strong>PURAMENTE ORIENTATIVO</strong> e non diagnostico</li>
                        <li><strong>NON VALIDATO</strong> prospetticamente</li>
                        <li>Da interpretare SEMPRE nel contesto clinico completo</li>
                    </ul>
                </div>
                <div class="bg-green-50 border-l-4 border-green-500 p-3">
                    <p class="font-semibold text-green-900 mb-1">Nancy Histological Index:</p>
                    <p class="text-green-800 text-sm">
                        Calcolato <strong>esclusivamente</strong> per RCU nota in follow-up 
                        (Marchal-Bressenot 2017, Battat 2019).
                    </p>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <p class="text-xs text-gray-700 italic">
                        v3.1.3: Fix topografico pouch ¬∑ FAC per sede ¬∑ versioning allineato ¬∑ Nancy solo RCU follow-up ¬∑ Scoring qualitativo (no percentuali)
                    </p>
                </div>
            </div>
            <div class="modal-footer p-4 bg-gray-50 rounded-b-xl">
                <button onclick="acceptDisclaimer()"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Ho capito, procedi ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Modal input numerico (Nancy / IEL / Banda collagene) -->
    <div id="input-modal" class="modal-overlay hidden" onclick="inputModalBackdropClick(event)">
        <div class="modal-content" style="max-width:420px">
            <div class="modal-header p-4 rounded-t-xl" id="input-modal-header">
                <h2 class="text-lg font-bold text-white" id="input-modal-title">Inserisci valore</h2>
            </div>
            <div class="modal-body p-4">
                <div id="input-modal-desc" class="text-sm text-gray-700 mb-4 space-y-1"></div>
                <div class="flex items-center gap-3">
                    <input type="number" id="input-modal-field"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-xl font-bold text-center focus:border-blue-500 outline-none"
                        min="0" step="1">
                    <span id="input-modal-unit" class="text-gray-500 font-semibold whitespace-nowrap"></span>
                </div>
                <p id="input-modal-error" class="text-red-600 text-sm mt-2 hidden">‚ö†Ô∏è Valore non valido</p>
            </div>
            <div class="modal-footer p-4 bg-gray-50 rounded-b-xl flex gap-3">
                <button onclick="inputModalCancel()"
                    class="flex-1 border-2 border-gray-300 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-100">
                    Annulla
                </button>
                <button onclick="inputModalConfirm()" id="input-modal-confirm-btn"
                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">
                    Conferma
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <!-- Header -->
        <div class="mb-4 border-b pb-4">
            <h1 class="text-3xl font-bold text-blue-900 mb-2">
                IBD Diagnostic Tool <span class="text-lg text-gray-600">v3.1.3</span>
            </h1>
            <p class="text-sm text-gray-600">
                Supporto diagnosi differenziale Malattie Infiammatorie Croniche Intestinali
            </p>
            <p class="text-xs text-gray-500 mt-1">
                v3.1.3: Fix topografico pouch ¬∑ FAC per sede ¬∑ versioning allineato ¬∑ Nancy Index limitato a RCU nota in follow-up ¬∑ Scoring qualitativo senza percentuali
            </p>
        </div>

        <!-- Banner Locked -->
        <div id="locked-banner" class="hidden locked-banner rounded-lg p-4 mb-6 no-print shadow-lg">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 flex-1">
                    <span class="text-4xl">üîí</span>
                    <div>
                        <p class="font-bold text-red-900 text-lg">DIAGNOSI COMPLETATA - CASO BLOCCATO</p>
                        <p class="text-sm text-red-800">Per prevenire contaminazione dati tra casi consecutivi.</p>
                    </div>
                </div>
                <button onclick="confirmReset()"
                    class="mega-reset-btn bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all">
                    üîì SBLOCCA<br>NUOVO CASO
                </button>
            </div>
        </div>

        <!-- Warning permanente -->
        <div class="mb-6 bg-gradient-to-r from-yellow-400 to-orange-400 border-2 border-orange-500 rounded-lg p-4 no-print shadow-md">
            <div class="flex items-center gap-3">
                <span class="text-3xl">‚ö†Ô∏è</span>
                <div class="flex-1">
                    <p class="font-bold text-gray-900 text-sm">
                        TOOL DIAGNOSTICO: Uso riservato a patologi esperti in IBD
                    </p>
                    <p class="text-xs text-gray-800">
                        Scoring orientativo, NON sostitutivo del ragionamento clinico-patologico | 
                        Nancy Index: solo RCU nota in follow-up
                    </p>
                </div>
            </div>
        </div>

        <div id="main-content"></div>
    </div>

    <script>
        const APP_VERSION = '3.1.3';
        const STORAGE_KEY = 'ibdAppDataV310';
        const DISCLAIMER_KEY = 'ibdDisclaimerAccepted';

        // ==================== STATE ====================
        let specimens = [];
        let ihcData = {
            cd68_pattern: 'non_eseguito',
            p53_pattern: 'non_eseguito',
            cmv_status: 'non_eseguito'
        };
        let ibdNota = {
            enabled: false,
            diagnosiIniziale: null,
            diagnosiAttuale: null,
            therapyOngoing: false
        };
        let altreColiti = {
            banda_collagene: 'assente',
            banda_collagene_um: null,
            iel_aumentati: 'assente',
            iel_count: null,
            pattern_superficiale: false,
            architettura_conservata: false,
            atrofia_ischemica: false,
            membrane_ialine: false,
            emorragia_recente: false,
            apoptosi_cripte: 'assente',
            ulcere_diaframma: false
        };
        let activeTab = 'campioni';
        let currentSite = 'ileo';
        let selectedSites = [];
        let multiSiteMode = false;
        let wizardSiteIndex = 0; // indice sede corrente nel wizard
        let siteSelectionDone = false; // true solo dopo "Avanti" nella selezione sedi
        let wizardData = {}; // buffer findings per sede: { siteIndex: { key: value, ... } }
        let diagnosiVeloce = {
            selected: null,
            testo: null,
            gradoManuale: null,
            autoGenerated: false
        };
        let caseLocked = false;
        let reportGenerated = false;
        let editingSpecimenIndex = null;

        // ==================== UNLOCK / LOCK ====================
        const unlockCase = () => {
            try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
            specimens = [];
            ihcData = { cd68_pattern: 'non_eseguito', p53_pattern: 'non_eseguito', cmv_status: 'non_eseguito' };
            ibdNota = { enabled: false, diagnosiIniziale: null, diagnosiAttuale: null, therapyOngoing: false };
            altreColiti = {
                banda_collagene: 'assente', banda_collagene_um: null,
                iel_aumentati: 'assente', iel_count: null,
                pattern_superficiale: false, architettura_conservata: false,
                atrofia_ischemica: false, membrane_ialine: false,
                emorragia_recente: false, apoptosi_cripte: 'assente', ulcere_diaframma: false
            };
            diagnosiVeloce = { selected: null, testo: null, gradoManuale: null, autoGenerated: false };
            selectedSites = []; multiSiteMode = false; siteSelectionDone = false; wizardSiteIndex = 0; wizardData = {}; activeTab = 'campioni'; currentSite = 'ileo';
            caseLocked = false; reportGenerated = false; editingSpecimenIndex = null;
            saveData();
            const banner = document.getElementById('locked-banner');
            if (banner) banner.classList.add('hidden');
            render();
        };

        const lockCase = () => {
            if (specimens.length > 0 && !caseLocked) {
                caseLocked = true; reportGenerated = true;
                document.getElementById('locked-banner').classList.remove('hidden');
                saveData();
            }
        };

        const unlockForEdit = () => {
            caseLocked = false; reportGenerated = false; activeTab = 'campioni';
            document.getElementById('locked-banner').classList.add('hidden');
            saveData(); render();
        };

        const confirmReset = () => {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Questo canceller√† TUTTI i dati del caso attuale.\n\nSei sicuro?')) {
                unlockCase();
            }
        };

        const ResetButton = () => {
            if (caseLocked) return '';
            return `
                <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-lg p-4 mb-6 shadow-lg">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üîÑ</span>
                            <div>
                                <p class="font-bold text-white text-lg">Vuoi iniziare un nuovo caso?</p>
                                <p class="text-sm text-white/90">Click qui per resettare tutti i dati</p>
                            </div>
                        </div>
                        <button onclick="confirmReset()"
                            class="bg-white text-red-600 px-8 py-4 rounded-lg font-bold hover:bg-red-50 transition-all shadow-md text-lg">
                            üóëÔ∏è RESET<br>COMPLETO
                        </button>
                    </div>
                </div>`;
        };

        // ==================== TOPOGRAPHIC ANALYSIS ====================
        const hasInflammatoryFindings = (specimen) => {
            const f = specimen.findings;
            if (specimen.siteType === 'ileum') {
                return (
                    f.granulomi_epitelioidi === 'presente' || f.granulomi_epitelioidi === 'sospetti' ||
                    f.neutrofili_lamina_propria !== 'assente' || f.erosioni_ulcerazioni === 'presente' ||
                    f.iperplasia_linfoide === 'presente' || f.edema_lamina_propria === 'presente' ||
                    f.plasmacellule_aumentate === 'presente'
                );
            } else {
                return (
                    f.granulomi_epitelioidi === 'presente' || f.granulomi_epitelioidi === 'sospetti' ||
                    f.neutrofili_epitelio !== 'assente' || f.ascessi_criptici === 'presente' ||
                    f.plasmacellule_basale === 'presente' || f.distorsione_architettura === 'presente' ||
                    f.metaplasia_paneth === 'presente' || f.ulcerazione === 'presente'
                );
            }
        };

        const analyzeTopographicPattern = () => {
            const sites = specimens.map(s => s.site);
            const sitesWithFindings = specimens.filter(hasInflammatoryFindings).map(s => s.site);
            let pattern = {
                rectumSampled: sites.includes('retto'),
                rectumInvolved: sitesWithFindings.includes('retto'),
                ileumSampled: sites.includes('ileo'),
                ileumInvolved: sitesWithFindings.includes('ileo'),
                skipLesions: false,
                skipLesionsIndeterminate: false,
                continuity: 'sconosciuta',
                warning: null
            };
            const colonOrder = ['cieco','ascendente','trasverso','discendente','sigma','retto'];
            // pouch e anastomosi esclusi dall'analisi topografica (sedi speciali post-chirurgiche)
            const findingsIndices = sitesWithFindings
                .filter(s => colonOrder.includes(s))
                .map(s => colonOrder.indexOf(s))
                .sort((a,b) => a-b);
            // se ci sono siti speciali, disabilita warning topografico
            const hasSpecialSites = specimens.some(s => SPECIAL_SITES.includes(s.site));
            if (findingsIndices.length >= 2) {
                for (let i = 1; i < findingsIndices.length; i++) {
                    const gap = findingsIndices[i] - findingsIndices[i-1];
                    if (gap > 1) {
                        let missingSamples = false;
                        for (let j = findingsIndices[i-1]+1; j < findingsIndices[i]; j++) {
                            if (!sites.includes(colonOrder[j])) { missingSamples = true; break; }
                        }
                        if (missingSamples) { pattern.skipLesionsIndeterminate = true; }
                        else { pattern.skipLesions = true; }
                        break;
                    }
                }
            }
            pattern.continuity = pattern.skipLesions ? 'discontinua' : (pattern.skipLesionsIndeterminate ? 'indeterminabile' : 'continua');
            if (hasSpecialSites) {
                pattern.warning = "‚ÑπÔ∏è Sedi speciali (pouch/anastomosi): analisi topografica standard non applicabile.";
            } else if (pattern.rectumSampled && pattern.rectumInvolved && !pattern.skipLesions && !pattern.ileumInvolved) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico RCU-like: retto coinvolto, distribuzione continua, ileo non coinvolto";
            } else if (pattern.skipLesionsIndeterminate) {
                pattern.warning = "‚ö†Ô∏è Campionamento incompleto: continuit√†/discontinuit√† NON valutabile. Completare mapping endoscopico.";
            } else if (pattern.skipLesions || (pattern.ileumInvolved && !pattern.rectumInvolved)) {
                pattern.warning = "‚ö†Ô∏è Pattern topografico Crohn-like: distribuzione discontinua e/o ileo coinvolto con retto risparmiato";
            } else if (!pattern.rectumSampled) {
                pattern.warning = "‚ÑπÔ∏è Retto non campionato: valutazione pattern topografico limitata";
            } else if (pattern.rectumSampled && !pattern.rectumInvolved && sitesWithFindings.length > 0) {
                if (ibdNota.therapyOngoing) {
                    pattern.warning = "‚ÑπÔ∏è Retto risparmiato in paziente in terapia: non esclude RCU (retto pu√≤ normalizzarsi)";
                } else {
                    pattern.warning = "‚ö†Ô∏è Retto risparmiato: atipico per RCU classica";
                }
            }
            return pattern;
        };

        // ==================== IBD NOTA HANDLERS ====================
        const toggleIbdNota = (enabled) => {
            if (caseLocked) return;
            ibdNota.enabled = enabled;
            if (!enabled) { ibdNota.diagnosiIniziale = null; ibdNota.diagnosiAttuale = null; ibdNota.therapyOngoing = false; }
            saveData(); render();
        };
        const updateIbdNota = (field, value) => {
            if (caseLocked) return;
            if (field === 'therapyOngoing') ibdNota[field] = value;
            else ibdNota[field] = value || null;
            // diagnosiAttuale √® sempre uguale a diagnosiIniziale (campo UI rimosso)
            if (field === 'diagnosiIniziale') ibdNota.diagnosiAttuale = ibdNota.diagnosiIniziale;
            saveData(); render();
        };

        // ==================== NANCY - SOLO RCU FOLLOW-UP ====================
        // v3.0.9: Nancy calcolato ESCLUSIVAMENTE se IBD nota = RCU in follow-up
        // Razionale: Nancy √® validato per monitorare risposta terapeutica in RCU nota,
        // non per diagnosi. In prima diagnosi il pattern IBD non √® ancora definito.
        // In Crohn e IBDU √® fuori validazione (Marchal-Bressenot 2017, Battat 2019).
        const shouldShowNancy = () => {
            return ibdNota.enabled === true && ibdNota.diagnosiAttuale === 'RCU';
        };

        const calculateNancyPerSpecimen = (specimen) => {
            if (specimen.siteType === 'ileum') return null;
            const f = specimen.findings;
            if (f.ulcerazione === 'presente') return 4;
            if (f.neutrofili_epitelio === 'marcata' || f.neutrofili_epitelio === 'moderata' || f.ascessi_criptici === 'presente') return 3;
            if (f.neutrofili_epitelio === 'lieve') return 2;
            if (f.distorsione_architettura === 'presente' || f.plasmacellule_basale === 'presente' || f.metaplasia_paneth === 'presente') return 1;
            return 0;
        };

        const calculateNancyIndex = () => {
            if (!shouldShowNancy()) {
                return { score: null, interpretation: null, applicable: false, warning: null };
            }
            let nancyScore = 0;
            let hasUlceration = false;
            let hasCryptAbscesses = false;
            let neutrophilSeverity = 'assente';
            const neutRank = { assente: 0, lieve: 1, moderata: 2, marcata: 3 };
            const colonSpecimens = specimens.filter(s => s.siteType !== 'ileum');
            colonSpecimens.forEach(specimen => {
                if (specimen.findings.ulcerazione === 'presente') hasUlceration = true;
                if (specimen.findings.ascessi_criptici === 'presente') hasCryptAbscesses = true;
                const neutLevel = specimen.findings.neutrofili_epitelio;
                if (neutRank[neutLevel] > neutRank[neutrophilSeverity]) neutrophilSeverity = neutLevel;
            });
            if (hasUlceration) nancyScore = 4;
            else if (neutrophilSeverity === 'marcata' || neutrophilSeverity === 'moderata' || hasCryptAbscesses) nancyScore = 3;
            else if (neutrophilSeverity === 'lieve') nancyScore = 2;
            else {
                const hasChronicChanges = colonSpecimens.some(s =>
                    s.findings.distorsione_architettura === 'presente' || s.findings.plasmacellule_basale === 'presente'
                );
                nancyScore = hasChronicChanges ? 1 : 0;
            }
            const interpretations = {
                0: { label: 'Remissione completa', description: 'Assenza di attivit√† e alterazioni croniche' },
                1: { label: 'Remissione con alterazioni croniche', description: 'Alterazioni architetturali senza attivit√† acuta' },
                2: { label: 'Attivit√† lieve', description: 'Infiltrato neutrofilo lieve senza ulcerazione' },
                3: { label: 'Attivit√† moderata', description: 'Infiltrato neutrofilo moderato-severo o ascessi criptici' },
                4: { label: 'Attivit√† severa con ulcerazione', description: 'Ulcerazione mucosa presente' }
            };
            return {
                score: nancyScore,
                interpretation: interpretations[nancyScore],
                applicable: true,
                warning: null,
                details: { hasUlceration, hasCryptAbscesses, neutrophilSeverity }
            };
        };

        const isSpecimenActive = (specimen) => {
            const f = specimen.findings;
            if (specimen.siteType === 'ileum') {
                return f.neutrofili_lamina_propria !== 'assente' || f.erosioni_ulcerazioni === 'presente';
            } else {
                return f.neutrofili_epitelio !== 'assente' || f.ascessi_criptici === 'presente' || f.ulcerazione === 'presente';
            }
        };

        // ==================== SCORING ====================
        const calculateIBDUScore = (rawScores, topoPattern) => {
            let ibduScore = 0;
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente' && !s.mucinGranulomaLikely);
            const hasUCPattern = specimens.some(s => s.findings.plasmacellule_basale === 'presente' || s.findings.distorsione_architettura === 'presente');
            if (hasGranulomas && hasUCPattern) ibduScore += 60;
            if (topoPattern.skipLesions && hasUCPattern) ibduScore += 50;
            if (topoPattern.rectumSampled && !topoPattern.rectumInvolved && hasUCPattern) ibduScore += 40;
            if (Math.abs(rawScores.crohn - rawScores.uc) < 20 && rawScores.crohn > 30) ibduScore += 70;
            return ibduScore;
        };

        const calculateScoring = () => {
            let scores = { crohn: 0, uc: 0, ibdu: 0 };
            let granulomaScore = 0;
            specimens.forEach(specimen => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';
                if (siteType === 'ileum') {
                    if (f.granulomi_epitelioidi === 'presente') {
                        const pts = specimen.mucinGranulomaLikely ? 20 : 150;
                        scores.crohn += pts; granulomaScore += pts;
                    } else if (f.granulomi_epitelioidi === 'sospetti') { scores.crohn += 25; granulomaScore += 25; }
                    if (f.erosioni_ulcerazioni === 'presente') scores.crohn += 50;
                    if (f.iperplasia_linfoide === 'presente') scores.crohn += 40;
                    if (f.atrofia_villi === 'marcata') scores.crohn += 30;
                    else if (f.atrofia_villi === 'moderata') scores.crohn += 15;
                    else if (f.atrofia_villi === 'lieve') scores.crohn += 5;
                    if (f.neutrofili_lamina_propria === 'marcata') { scores.crohn += 20; scores.uc += 10; }
                    else if (f.neutrofili_lamina_propria === 'moderata') { scores.crohn += 10; scores.uc += 5; }
                    else if (f.neutrofili_lamina_propria === 'lieve') scores.crohn += 5;
                    if (f.edema_lamina_propria === 'presente') scores.crohn += 15;
                    if (f.plasmacellule_aumentate === 'presente') scores.crohn += 15;
                    if (f.fibrosi_sottomucosa === 'marcata') scores.crohn += 25;
                    else if (f.fibrosi_sottomucosa === 'moderata') scores.crohn += 15;
                    else if (f.fibrosi_sottomucosa === 'lieve') scores.crohn += 5;
                } else {
                    if (f.granulomi_epitelioidi === 'presente') {
                        const pts = specimen.mucinGranulomaLikely ? 15 : 100;
                        scores.crohn += pts; granulomaScore += pts;
                    } else if (f.granulomi_epitelioidi === 'sospetti') { scores.crohn += 25; }
                    if (f.neutrofili_epitelio === 'marcata') { scores.uc += 40; scores.crohn += 20; }
                    else if (f.neutrofili_epitelio === 'moderata') { scores.uc += 25; scores.crohn += 15; }
                    else if (f.neutrofili_epitelio === 'lieve') { scores.uc += 15; scores.crohn += 10; }
                    if (f.ascessi_criptici === 'presente') { scores.uc += 30; scores.crohn += 15; }
                    if (f.plasmacellule_basale === 'presente') { scores.uc += 25; scores.crohn += 10; }
                    if (f.distorsione_architettura === 'presente') { scores.uc += 20; scores.crohn += 15; }
                    if (f.metaplasia_paneth === 'presente') scores.uc += 15;
                    if (f.ulcerazione === 'presente') { scores.crohn += 15; scores.uc += 10; }
                    if (f.fibrosi_sottomucosa === 'marcata') { scores.crohn += 25; scores.uc += 10; }
                    else if (f.fibrosi_sottomucosa === 'moderata') { scores.crohn += 15; scores.uc += 5; }
                }
            });
            if (ihcData.cd68_pattern === 'aggregati_profondi') scores.crohn += 35;
            else if (ihcData.cd68_pattern === 'diffuso_mucosa') { scores.uc += 20; scores.crohn += 10; }
            const topoPattern = analyzeTopographicPattern();
            const rawScores = { crohn: scores.crohn, uc: scores.uc };
            scores.ibdu = calculateIBDUScore(rawScores, topoPattern);
            const total = scores.crohn + scores.uc + scores.ibdu;
            // Manteniamo i raw scores normalizzati internamente per la logica,
            // ma NON li mostriamo come percentuali all'utente (v3.0.9)
            let normalizedScores = { crohn: 0, uc: 0, ibdu: 0 };
            if (total > 0) {
                normalizedScores.crohn = Math.round((scores.crohn / total) * 100);
                normalizedScores.uc = Math.round((scores.uc / total) * 100);
                normalizedScores.ibdu = Math.round((scores.ibdu / total) * 100);
            }
            const granulomasDriven = rawScores.crohn > 0 && (granulomaScore / rawScores.crohn) > 0.5;
            return { scores: normalizedScores, rawScores, dysplasiaRisk: false, granulomaScore, granulomasDriven };
        };

        // ==================== ETICHETTE QUALITATIVE ====================
        // v3.0.9: solo etichette, niente numeri mostrati all'utente
        const getScoreLabel = (score) => {
            if (score >= 80) return { text: 'Forte', cls: 'forte' };
            if (score >= 60) return { text: 'Compatibile', cls: 'compatibile' };
            if (score >= 40) return { text: 'Borderline', cls: 'borderline' };
            return { text: 'Basso', cls: 'basso' };
        };

        // ==================== INTERPRETAZIONE ====================
        const interpretScoringGraduated = (scores) => {
            const { crohn, uc, ibdu } = scores;
            const max = Math.max(crohn, uc, ibdu);
            let result = { primary: null, level: null, headline: null, description: null, epistemicNote: null };

            const hasAltreColitiFindings =
                (altreColiti.banda_collagene !== 'assente') ||
                (altreColiti.iel_aumentati !== 'assente') ||
                altreColiti.apoptosi_cripte !== 'assente' ||
                altreColiti.pattern_superficiale ||
                altreColiti.atrofia_ischemica ||
                altreColiti.membrane_ialine ||
                altreColiti.emorragia_recente ||
                altreColiti.ulcere_diaframma;

            const isAllNormal = !hasAltreColitiFindings && specimens.every(s => {
                const f = s.findings;
                if (s.siteType === 'ileum') {
                    return f.granulomi_epitelioidi === 'assente' && f.neutrofili_lamina_propria === 'assente' &&
                           f.erosioni_ulcerazioni === 'assente' && f.iperplasia_linfoide === 'assente' &&
                           f.edema_lamina_propria === 'assente' && f.atrofia_villi === 'assente' &&
                           f.plasmacellule_aumentate === 'assente' && f.fibrosi_sottomucosa === 'assente';
                } else {
                    return f.granulomi_epitelioidi === 'assente' && f.neutrofili_epitelio === 'assente' &&
                           f.ascessi_criptici === 'assente' && f.plasmacellule_basale === 'assente' &&
                           f.distorsione_architettura === 'assente' && f.metaplasia_paneth === 'assente' &&
                           f.ulcerazione === 'assente' && f.fibrosi_sottomucosa === 'assente' &&
                           (!f.displasia || f.displasia === 'assente');
                }
            });

            if (isAllNormal) {
                return { primary: 'Normale', level: 'normale', headline: 'Mucosa ileo-colica nella norma',
                    description: 'Non si osservano alterazioni istologiche significative nei campioni esaminati.', epistemicNote: null };
            }

            if (hasAltreColitiFindings) {
                if (altreColiti.banda_collagene === 'ispessita' || altreColiti.banda_collagene === 'marcata') {
                    const bandaText = altreColiti.banda_collagene_um
                        ? `Banda collagene subepiteliale: ${altreColiti.banda_collagene_um}Œºm (v.n. <10Œºm)`
                        : `Banda collagene subepiteliale ${altreColiti.banda_collagene === 'marcata' ? 'marcatamente ispessita (>20Œºm)' : 'ispessita (‚â•10Œºm)'}`;
                    return { primary: 'Colite Collagenosica', level: altreColiti.banda_collagene === 'marcata' ? 'alta' : 'buona',
                        headline: 'Colite microscopica, tipo collagenosica',
                        description: `${bandaText}. Architettura ghiandolare conservata.`, epistemicNote: null };
                }
                if (altreColiti.iel_aumentati === 'aumentati' || altreColiti.iel_aumentati === 'marcati') {
                    const ielText = altreColiti.iel_count
                        ? `Linfociti intraepiteliali: ${altreColiti.iel_count}/100 cellule epiteliali (v.n. <20)`
                        : `IEL ${altreColiti.iel_aumentati === 'marcati' ? 'marcatamente aumentati (>30/100)' : 'aumentati (‚â•20/100)'}`;
                    return { primary: 'Colite Linfocitica', level: altreColiti.iel_aumentati === 'marcati' ? 'alta' : 'buona',
                        headline: 'Colite microscopica, tipo linfocitica',
                        description: `${ielText}. Architettura ghiandolare conservata.`, epistemicNote: null };
                }
                const ischemicFeatures = [altreColiti.atrofia_ischemica, altreColiti.membrane_ialine, altreColiti.emorragia_recente].filter(Boolean).length;
                if (ischemicFeatures >= 2) {
                    return { primary: 'Colite Ischemica', level: ischemicFeatures === 3 ? 'alta' : 'suggestivo',
                        headline: 'Pattern compatibile con colite ischemica',
                        description: `Presenti ${ischemicFeatures}/3 criteri ischemici. Correlare con sede e fattori di rischio cardiovascolare.`, epistemicNote: null };
                }
                if (altreColiti.ulcere_diaframma) {
                    return { primary: 'Enteropatia da FANS', level: 'alta', headline: 'Enteropatia/Colite da FANS',
                        description: 'Ulcere a diaframma presenti (patognomonico). Confermare anamnesi farmacologica.', epistemicNote: null };
                }
                if (altreColiti.apoptosi_cripte !== 'assente') {
                    return { primary: 'Possibile Colite da FANS', level: 'suggestivo',
                        headline: 'Pattern suggestivo per colite da FANS',
                        description: `Apoptosi cripte ${altreColiti.apoptosi_cripte}. Considerare eziologia farmacologica.`, epistemicNote: null };
                }
                if (altreColiti.pattern_superficiale && altreColiti.architettura_conservata) {
                    return { primary: 'Colite Infettiva', level: 'suggestivo',
                        headline: 'Pattern compatibile con colite infettiva',
                        description: 'Infiammazione superficiale con architettura conservata. Correlare con coprocoltura.', epistemicNote: null };
                }
            }

            if (max === crohn && crohn >= 40) {
                result.primary = 'Malattia di Crohn';
                if (crohn >= 80) {
                    result.level = 'alta'; result.headline = 'Malattia di Crohn (pattern istologico fortemente suggestivo)';
                    result.description = 'Pattern morfologico e architetturale fortemente indicativo per malattia di Crohn.';
                } else if (crohn >= 60) {
                    result.level = 'probabile'; result.headline = 'Quadro compatibile con malattia di Crohn';
                    result.description = 'Pattern morfologico compatibile con malattia di Crohn. Correlazione con dati clinici, endoscopici e imaging NECESSARIA.';
                    result.epistemicNote = 'Criteri multipli ma non patognomonici. Conferma clinico-radiologica essenziale.';
                } else {
                    result.level = 'suggestivo'; result.headline = 'Pattern suggestivo ma non diagnostico per malattia di Crohn';
                    result.description = 'Pattern con alcune features compatibili con Crohn, INSUFFICIENTE per diagnosi definitiva.';
                    result.epistemicNote = 'Istologia da sola NON consente diagnosi. Correlazione clinica, distribuzione endoscopica e imaging INDISPENSABILI.';
                }
            } else if (max === uc && uc >= 40) {
                const topoPattern = analyzeTopographicPattern();
                const activeSites = specimens.filter(s => s.siteType !== 'ileum' && (
                    s.findings.neutrofili_epitelio !== 'assente' || s.findings.distorsione_architettura === 'presente' || s.findings.plasmacellule_basale === 'presente'
                )).map(s => s.site);
                const hasAcuteActivity = specimens.some(s => s.siteType !== 'ileum' && (
                    s.findings.neutrofili_epitelio !== 'assente' || s.findings.ascessi_criptici === 'presente' || s.findings.ulcerazione === 'presente'
                ));
                const isRemission = diagnosiVeloce.selected === 'IBD_REMISSIONE' || !hasAcuteActivity;
                const isProctitis = activeSites.length === 1 && activeSites.includes('retto');
                const leftSites = ['retto','sigma','discendente'], rightSites = ['trasverso','ascendente','cieco'];
                const isLeftSided = activeSites.every(s => leftSites.includes(s)) && activeSites.includes('retto') && !activeSites.some(s => rightSites.includes(s));
                const ucLabel = isProctitis ? 'proctite ulcerosa' : (isLeftSided && !isProctitis) ? 'rettocolite ulcerosa sinistra' : 'rettocolite ulcerosa';
                const ucLabelCap = ucLabel.charAt(0).toUpperCase() + ucLabel.slice(1);
                const remissionSuffix = isRemission ? ' in fase di remissione istologica' : '';
                result.primary = ucLabelCap;
                if (uc >= 80) {
                    result.level = 'alta'; result.headline = `${ucLabelCap}${remissionSuffix} (pattern istologico fortemente suggestivo)`;
                    result.description = `Pattern morfologico e distributivo fortemente indicativo per ${ucLabel}${remissionSuffix}.`;
                } else if (uc >= 60) {
                    result.level = 'probabile'; result.headline = `Quadro compatibile con ${ucLabel}${remissionSuffix}`;
                    result.description = `Pattern morfologico compatibile con ${ucLabel}${remissionSuffix}.${isRemission ? ' Persistono alterazioni architetturali croniche residue.' : ' Correlazione con distribuzione endoscopica NECESSARIA.'}`;
                    result.epistemicNote = isRemission ? null : 'Conferma con pattern topografico endoscopico (continuo, retto coinvolto, ileo indenne) essenziale.';
                } else {
                    result.level = 'suggestivo'; result.headline = `Pattern suggestivo ma non diagnostico per ${ucLabel}`;
                    result.description = `Features compatibili con ${ucLabel}, INSUFFICIENTE per diagnosi definitiva.`;
                    result.epistemicNote = 'Verifica distribuzione continua, coinvolgimento rettale e risparmio ileale tramite endoscopia.';
                }
            } else if (max === ibdu || Math.abs(crohn - uc) < 15) {
                result.primary = 'IBDU'; result.level = 'indeterminato'; result.headline = 'IBD non classificabile (IBDU)';
                if (ibdu > 50) {
                    result.description = 'Pattern contraddittorio con features sovrapposte Crohn/RCU. Classificazione istologica non possibile.';
                    result.epistemicNote = 'IBDU con overlap features. Diagnosi definitiva richiede follow-up clinico-istologico prolungato.';
                } else {
                    result.description = 'Pattern aspecifico di IBD. Dati istologici insufficienti per classificazione Crohn vs RCU.';
                    result.epistemicNote = 'Score equiparati. Rivalutazione con follow-up istologico + correlazione clinico-endoscopica-radiologica INDISPENSABILE.';
                }
            } else {
                result.primary = 'Indeterminato'; result.level = 'insufficiente'; result.headline = 'Pattern istologico aspecifico';
                result.description = 'Reperti morfologici insufficienti per orientamento diagnostico IBD.';
                result.epistemicNote = 'Campionamento inadeguato o fase precoce di malattia. Necessaria rivalutazione con campionamento esteso.';
            }
            return result;
        };

        // ==================== DISPLASIA ====================
        const generateDysplasiaReport = () => {
            const colonSpecs = specimens.filter(s => s.siteType !== 'ileum');
            const displasiaFindings = colonSpecs
                .filter(s => s.findings.displasia && s.findings.displasia !== 'assente')
                .map(s => ({ site: s.site, grade: s.findings.displasia, p53Support: ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null' }));
            if (displasiaFindings.length === 0) return null;
            const maxGrade = displasiaFindings.some(d => d.grade === 'HGD') ? 'HGD' :
                             displasiaFindings.some(d => d.grade === 'LGD') ? 'LGD' : 'IND';
            let recommendation = '';
            if (maxGrade === 'HGD') recommendation = 'HGD: Colectomia da considerare. Discussione multidisciplinare URGENTE.';
            else if (maxGrade === 'LGD') recommendation = 'LGD: Sorveglianza endoscopica stretta (3-6 mesi). Valutare resezione endoscopica se lesione visibile.';
            else recommendation = 'IND: Rivalutazione con campionamento esteso. Considerare review con patologo esperto.';
            return { present: true, maxGrade, findings: displasiaFindings, recommendation, p53Aberrant: displasiaFindings.some(d => d.p53Support) };
        };

        // ==================== NOTE METODOLOGICHE ====================
        const detectContradictoryPatterns = () => {
            const notes = [];
            const isAllNormal = specimens.every(s => {
                const f = s.findings;
                if (s.siteType === 'ileum') return f.granulomi_epitelioidi === 'assente' && f.neutrofili_lamina_propria === 'assente' && f.erosioni_ulcerazioni === 'assente' && f.atrofia_villi === 'assente' && f.plasmacellule_aumentate === 'assente';
                else return f.granulomi_epitelioidi === 'assente' && f.neutrofili_epitelio === 'assente' && f.ascessi_criptici === 'assente' && f.plasmacellule_basale === 'assente' && f.distorsione_architettura === 'assente' && f.ulcerazione === 'assente';
            });
            if (isAllNormal) return notes;
            const hasGranulomas = specimens.some(s => s.findings.granulomi_epitelioidi === 'presente');
            const hasUCPattern = specimens.some(s => s.findings.plasmacellule_basale === 'presente' || s.findings.distorsione_architettura === 'presente');
            const scoring = calculateScoring();
            if (hasGranulomas && hasUCPattern) {
                notes.push({ type: 'CONTRADDITTORIO', title: 'Pattern contraddittorio: Granulomi + Cronicit√† RCU-like',
                    features: ['Granulomi epitelioidi (feature Crohn)', 'Alterazioni croniche RCU-like (plasmacellule basali, distorsione)'],
                    interpretation: 'Scoring a fini DESCRITTIVI; affidabilit√† LIMITATA per features contraddittorie.',
                    suggestion: 'Pattern suggerisce IBDU con overlap. Rivalutazione con follow-up clinico-istologico NECESSARIA.' });
            }
            if (!hasGranulomas && scoring.scores.crohn > 60) {
                const hasTransmuralEquivalent = specimens.some(s => s.findings.fibrosi_sottomucosa === 'marcata');
                if (!hasTransmuralEquivalent) {
                    notes.push({ type: 'LIMITAZIONE', title: 'Crohn senza features patognomoniche',
                        features: ['Pattern Crohn ma ASSENZA granulomi epitelioidi', 'ASSENZA evidenza di transmuralit√†', '‚ö†Ô∏è Biopsia mucosa NON dimostra transmuralit√†'],
                        interpretation: 'Diagnosi basata su criteri ASPECIFICI. Granulomi assenti nel 30-50% dei Crohn bioptici.',
                        suggestion: 'IMAGING MANDATORIO: entero-RM o TC per ispessimento parietale, fistole, stenosi, coinvolgimento mesenterico.' });
                }
            }
            if (Math.abs(scoring.scores.crohn - scoring.scores.uc) < 15) {
                notes.push({ type: 'INCERTEZZA', title: 'Pattern Crohn/RCU sovrapponibile',
                    features: ['Differenza tra orientamento Crohn e RCU non significativa'],
                    interpretation: 'Istologia INSUFFICIENTE per diagnosi definitiva.',
                    suggestion: 'Richiede: distribuzione endoscopica, imaging, risposta terapeutica, evoluzione clinica.' });
            }
            return notes;
        };

        const validateClinicalLogic = () => {
            const warnings = [];
            specimens.forEach(specimen => {
                const f = specimen.findings;
                const siteType = specimen.siteType || 'colon';
                if (f.granulomi_epitelioidi === 'presente') {
                    if (specimen.mucinGranulomaLikely) {
                        warnings.push({ type: 'GRANULOMA_CAUTION', site: specimen.site,
                            message: `üîç ${specimen.site.toUpperCase()}: Granulomi marcati come "possibile rottura criptale"`,
                            severity: 'medium',
                            suggestion: 'Escludere mucin granuloma. Se persistono dubbi, considerare PAS-D.' });
                    } else if (siteType === 'ileum') {
                        if (f.atrofia_villi === 'assente' && f.plasmacellule_aumentate === 'assente') {
                            warnings.push({ type: 'DIAGNOSTIC_ALERT', site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()} (ILEO): Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Considerare: TBC, Yersinia, sarcoidosi, Crohn precoce. Colorazioni Ziehl-Neelsen, PCR Mycobacterium.' });
                        }
                    } else {
                        if (f.distorsione_architettura === 'assente' && f.plasmacellule_basale === 'assente') {
                            warnings.push({ type: 'DIAGNOSTIC_ALERT', site: specimen.site,
                                message: `üîç ${specimen.site.toUpperCase()}: Granulomi epitelioidi SENZA alterazioni croniche`,
                                severity: 'high',
                                suggestion: 'Considerare: TBC, sarcoidosi, Crohn precoce, iatrogeni. DD infettiva richiede colorazioni specifiche.' });
                        }
                    }
                }
            });
            return warnings;
        };

        const shouldFlagMDT = (report) => {
            if (report.metadata && report.metadata.simulation) return null;
            const reasons = [];
            if (report.contradictoryNotes && report.contradictoryNotes.length > 0) reasons.push('Pattern contraddittorio');
            if (report.scoring.scores.ibdu >= 40) reasons.push('IBDU score elevato');
            if (report.dysplasiaReport && (report.ihcData.p53_pattern === 'overexpression' || report.ihcData.p53_pattern === 'null')) reasons.push('Displasia con p53 aberrante');
            if (Math.abs(report.scoring.scores.crohn - report.scoring.scores.uc) < 15 && report.scoring.scores.crohn >= 30 && report.scoring.scores.uc >= 30) reasons.push('Orientamento Crohn/RCU indistinguibile');
            return reasons.length > 0 ? reasons : null;
        };

        // ==================== SINTESI ENDOSCOPISTA ====================

        // ==================== GENERATE REPORT ====================
        const generateReport = () => {
            const scoring = calculateScoring();
            const interpretation = interpretScoringGraduated(scoring.scores);
            const contradictoryNotes = detectContradictoryPatterns();
            const nancy = calculateNancyIndex();
            const topoPattern = analyzeTopographicPattern();
            const validations = validateClinicalLogic();
            const dysplasiaReport = generateDysplasiaReport();
            return {
                specimens, scoring, interpretation, contradictoryNotes, nancy, topoPattern,
                ibdNota, diagnosiVeloce, dysplasiaReport,
                suspiciousGranulomas: specimens.filter(s => s.findings.granulomi_epitelioidi === 'sospetti').map(s => s.site),
                validations, ihcData, altreColiti,
                metadata: {
                    version: APP_VERSION, date: new Date().toISOString(),
                    hasGranulomas: specimens.some(s => s.findings.granulomi_epitelioidi === 'presente'),
                    hasNancy: shouldShowNancy(),
                    simulation: diagnosiVeloce.autoGenerated === true,
                    logicVersion: 'IBD-ECCO2023-adapted',
                    educationalProfile: 'Senior-pathologist-Rosai-school'
                }
            };
        };

        // ==================== DIAGNOSI VELOCE OPTIONS ====================
        const diagnosiVeloceOptions = [
            { codice: 'NORMALE', emoji: 'üü¢', label: 'Normale', testo: 'Mucosa colica/ileale istologicamente nella norma.', gruppo: 'ibd' },
            { codice: 'PROCTITE_UC', emoji: 'üîµ', label: 'Proctite ulcerosa', testo: 'Proctite cronica attiva, pattern morfologico compatibile con proctite ulcerosa.', gruppo: 'ibd' },
            { codice: 'COLITE_SINISTRA_UC', emoji: 'üîµ', label: 'Colite UC sinistra', testo: 'Colite cronica attiva con distribuzione sinistra, pattern morfologico compatibile con rettocolite ulcerosa sinistra.', gruppo: 'ibd' },
            { codice: 'PANCOLITE_UC', emoji: 'üîµ', label: 'Pancolite UC', testo: 'Pancolite cronica attiva con distribuzione continua, pattern morfologico compatibile con rettocolite ulcerosa estesa. Ileo terminale indenne.', gruppo: 'ibd' },
            { codice: 'IBD_REMISSIONE', emoji: 'üü°', label: 'IBD in remissione', testo: 'Colite cronica in fase di remissione istologica. Persistono alterazioni architetturali residue. Assenza di attivit√† infiammatoria acuta.', gruppo: 'ibd' },
            { codice: 'ILEITE_NAS', emoji: 'üü†', label: 'Ileite NAS', testo: 'Ileite cronica attiva. Pattern aspecifico, da correlare con dati clinici ed endoscopici.', gruppo: 'ibd' },
            { codice: 'CROHN_LIKE', emoji: 'üü£', label: 'Crohn probabile', testo: 'Colite cronica attiva con pattern morfologico suggestivo per malattia di Crohn. Correlare con clinica ed endoscopia.', gruppo: 'ibd' },
            { codice: 'COLITE_CRONICA_ASPECIFICA', emoji: 'üî≤', label: 'Colite cr. aspecifica', testo: 'Mucosa del grosso intestino contrassegnata da struttura ghiandolare conservata, attivit√† mucipara conservata, infiltrato linfoplasmacellulare lievemente aumentato. Quadro di colite cronica di grado lieve, quiescente, esente da caratteristiche di specificit√†.', gruppo: 'altre' },
            { codice: 'COLITE_COLLAGENA', emoji: 'üî¨', label: 'Colite collagenosica', testo: 'Colite microscopica, tipo collagenosica. Banda collagene subepiteliale ispessita (‚â•10Œºm). Architettura ghiandolare conservata.', gruppo: 'altre' },
            { codice: 'COLITE_LINFOCITICA', emoji: 'üî¨', label: 'Colite Linfocitica', testo: 'Colite microscopica, tipo linfocitica. Linfociti intraepiteliali aumentati (‚â•20/100 cellule epiteliali). Architettura ghiandolare conservata.', gruppo: 'altre' },
            { codice: 'COLITE_INFETTIVA', emoji: 'ü¶†', label: 'Colite Infettiva', testo: 'Colite acuta con pattern superficiale e architettura conservata, compatibile con eziologia infettiva.', gruppo: 'altre' },
            { codice: 'COLITE_ISCHEMICA', emoji: 'üíî', label: 'Colite Ischemica', testo: 'Colite con pattern ischemico. Correlare con sede e fattori di rischio cardiovascolare.', gruppo: 'altre' },
            { codice: 'COLITE_FANS', emoji: 'üíä', label: 'Colite da FANS', testo: 'Colite/enteropatia da FANS. Confermare anamnesi farmacologica.', gruppo: 'altre' },
            { codice: 'SCAD', emoji: 'üîò', label: 'SCAD', testo: 'Colite cronica segmentale associata a diverticolosi (SCAD). Flogosi cronica attiva limitata al segmento con diverticoli, retto indenne.', gruppo: 'altre' }
        ];

        const DIAGNOSI_CON_NANCY = ['PROCTITE_UC', 'COLITE_SINISTRA_UC', 'PANCOLITE_UC', 'IBD_REMISSIONE'];
        // Diagnosi che bypassano lo scoring e usano il testo preconfezionato direttamente
        const DIAGNOSI_TESTO_FISSO = ['COLITE_COLLAGENA','COLITE_LINFOCITICA','COLITE_INFETTIVA','COLITE_ISCHEMICA','COLITE_FANS','SCAD','COLITE_CRONICA_ASPECIFICA'];
        const STANDARD_SITES = ['ileo', 'cieco', 'ascendente', 'trasverso', 'discendente', 'sigma', 'retto'];
        const SITE_LABELS = {
            ileo: 'Ileo', cieco: 'Cieco', ascendente: 'Colon ascendente',
            trasverso: 'Colon trasverso', discendente: 'Colon discendente',
            sigma: 'Sigma', retto: 'Retto', pouch: 'Pouch', anastomosi: 'Anastomosi'
        };
        const formatFacNote = (specimenList) => {
            const facSedi = specimenList.filter(s => s.facPresente && s.siteType !== 'ileum').map(s => SITE_LABELS[s.site] || s.site);
            if (facSedi.length === 0) return null;
            return `Colite attiva focale (FAC) rilevata in: ${facSedi.join(', ')}. Reperto aspecifico; correlazione clinico-endoscopica e anamnesi farmacologica raccomandate.`;
        };

        const formatSediCampionate = (specimenList) => {
            const sedi = specimenList.map(s => SITE_LABELS[s.site] || s.site);
            return 'Sedi esaminate: ' + sedi.join(', ') + '.';
        };
        const SPECIAL_SITES = ['pouch', 'anastomosi'];
        const LEFT_EXTENDED_SITES = ['discendente', 'sigma', 'retto'];

        const DEFAULT_COLON_FINDINGS = {
            granulomi_epitelioidi: 'assente', neutrofili_epitelio: 'assente', ascessi_criptici: 'assente',
            plasmacellule_basale: 'assente', distorsione_architettura: 'assente', metaplasia_paneth: 'assente',
            ulcerazione: 'assente', fibrosi_sottomucosa: 'assente', displasia: 'assente'
        };
        const DEFAULT_ILEUM_FINDINGS = {
            granulomi_epitelioidi: 'assente', neutrofili_lamina_propria: 'assente', erosioni_ulcerazioni: 'assente',
            iperplasia_linfoide: 'assente', edema_lamina_propria: 'assente', atrofia_villi: 'assente',
            plasmacellule_aumentate: 'assente', fibrosi_sottomucosa: 'assente'
        };

        const getUCActiveFindings = (nancyGrade) => {
            const base = { ...DEFAULT_COLON_FINDINGS };
            base.distorsione_architettura = 'presente'; base.plasmacellule_basale = 'presente';
            if (nancyGrade >= 2) base.neutrofili_epitelio = 'lieve';
            if (nancyGrade >= 3) { base.neutrofili_epitelio = 'moderata'; base.ascessi_criptici = 'presente'; }
            if (nancyGrade >= 4) { base.neutrofili_epitelio = 'marcata'; base.ulcerazione = 'presente'; }
            return base;
        };

        const getUCRemissionFindings = () => {
            const base = { ...DEFAULT_COLON_FINDINGS };
            base.distorsione_architettura = 'presente'; base.plasmacellule_basale = 'presente';
            return base;
        };

        const getCrohnIleumFindings = (severity) => {
            const base = { ...DEFAULT_ILEUM_FINDINGS };
            if (severity === 'lieve') { base.erosioni_ulcerazioni = 'presente'; base.iperplasia_linfoide = 'presente'; }
            else if (severity === 'moderata') { base.erosioni_ulcerazioni = 'presente'; base.iperplasia_linfoide = 'presente'; base.neutrofili_lamina_propria = 'moderata'; }
            else if (severity === 'severa') { base.erosioni_ulcerazioni = 'presente'; base.neutrofili_lamina_propria = 'marcata'; base.granulomi_epitelioidi = 'presente'; }
            return base;
        };

        const generateSpecimensFromDiagnosi = (diagnosiCode, nancyGrade = 2) => {
            if (selectedSites.length === 0) { alert('Seleziona prima le sedi campionate!'); return; }
            specimens = [];
            altreColiti = {
                banda_collagene: 'assente', iel_aumentati: 'assente',
                pattern_superficiale: false, architettura_conservata: false,
                atrofia_ischemica: false, membrane_ialine: false,
                emorragia_recente: false, apoptosi_cripte: 'assente', ulcere_diaframma: false
            };
            selectedSites.forEach(site => {
                const isIleum = (site === 'ileo');
                let findings;
                switch(diagnosiCode) {
                    case 'NORMALE': findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS }; break;
                    case 'PROCTITE_UC':
                        if (isIleum) findings = { ...DEFAULT_ILEUM_FINDINGS };
                        else if (site === 'retto') findings = getUCActiveFindings(nancyGrade);
                        else findings = { ...DEFAULT_COLON_FINDINGS }; break;
                    case 'COLITE_SINISTRA_UC':
                        if (isIleum) findings = { ...DEFAULT_ILEUM_FINDINGS };
                        else if (LEFT_EXTENDED_SITES.includes(site)) findings = getUCActiveFindings(nancyGrade);
                        else findings = { ...DEFAULT_COLON_FINDINGS }; break;
                    case 'PANCOLITE_UC':
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : getUCActiveFindings(nancyGrade); break;
                    case 'IBD_REMISSIONE':
                        if (isIleum) findings = { ...DEFAULT_ILEUM_FINDINGS };
                        else if (nancyGrade === 0) findings = { ...DEFAULT_COLON_FINDINGS };
                        else if (nancyGrade === 1) findings = getUCRemissionFindings();
                        else findings = getUCActiveFindings(nancyGrade); break;
                    case 'ILEITE_NAS':
                        findings = isIleum ? getCrohnIleumFindings('moderata') : { ...DEFAULT_COLON_FINDINGS }; break;
                    case 'CROHN_LIKE':
                        if (isIleum) findings = getCrohnIleumFindings('moderata');
                        else if (['cieco','ascendente'].includes(site)) {
                            findings = { ...DEFAULT_COLON_FINDINGS };
                            findings.granulomi_epitelioidi = 'sospetti'; findings.neutrofili_epitelio = 'lieve'; findings.distorsione_architettura = 'presente';
                        } else findings = { ...DEFAULT_COLON_FINDINGS }; break;
                    case 'COLITE_COLLAGENA':
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS };
                        altreColiti.banda_collagene = 'ispessita'; altreColiti.architettura_conservata = true; break;
                    case 'COLITE_LINFOCITICA':
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS };
                        altreColiti.iel_aumentati = 'aumentati'; altreColiti.architettura_conservata = true; break;
                    case 'COLITE_INFETTIVA':
                        if (isIleum) findings = { ...DEFAULT_ILEUM_FINDINGS };
                        else { findings = { ...DEFAULT_COLON_FINDINGS }; findings.neutrofili_epitelio = 'moderata'; }
                        altreColiti.pattern_superficiale = true; altreColiti.architettura_conservata = true; break;
                    case 'COLITE_ISCHEMICA':
                        if (isIleum) findings = { ...DEFAULT_ILEUM_FINDINGS };
                        else { findings = { ...DEFAULT_COLON_FINDINGS }; findings.fibrosi_sottomucosa = 'lieve'; }
                        altreColiti.atrofia_ischemica = true; altreColiti.membrane_ialine = true; altreColiti.emorragia_recente = true; break;
                    case 'COLITE_FANS':
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS };
                        altreColiti.apoptosi_cripte = 'presente'; break;
                    case 'SCAD':
                        if (isIleum) findings = { ...DEFAULT_ILEUM_FINDINGS };
                        else if (site === 'sigma') { findings = { ...DEFAULT_COLON_FINDINGS }; findings.distorsione_architettura = 'presente'; findings.neutrofili_epitelio = 'lieve'; }
                        else findings = { ...DEFAULT_COLON_FINDINGS }; break;
                    case 'COLITE_CRONICA_ASPECIFICA':
                        findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS, plasmacellule_basale: 'presente' }; break;
                    default: findings = isIleum ? { ...DEFAULT_ILEUM_FINDINGS } : { ...DEFAULT_COLON_FINDINGS };
                }
                specimens.push({ site, findings, siteType: isIleum ? 'ileum' : 'colon', mucinGranulomaLikely: false });
            });
            const opt = diagnosiVeloceOptions.find(o => o.codice === diagnosiCode);
            diagnosiVeloce.selected = diagnosiCode; diagnosiVeloce.testo = opt ? opt.testo : null;
            diagnosiVeloce.gradoManuale = nancyGrade; diagnosiVeloce.autoGenerated = true;
            selectedSites = [];
            saveData(); render();
        };

        // ==================== INPUT MODAL (sostituisce prompt()) ====================
        let _inputModalCallback = null;
        let _inputModalMin = 0;
        let _inputModalMax = 100;

        const showInputModal = ({ title, desc, unit, min, max, defaultVal, headerColor, callback }) => {
            _inputModalCallback = callback;
            _inputModalMin = min ?? 0;
            _inputModalMax = max ?? 999;
            const modal = document.getElementById('input-modal');
            document.getElementById('input-modal-title').textContent = title;
            document.getElementById('input-modal-header').style.background = headerColor || '#2563eb';
            const descEl = document.getElementById('input-modal-desc');
            descEl.innerHTML = Array.isArray(desc) ? desc.map(d => `<p>${d}</p>`).join('') : `<p>${desc}</p>`;
            document.getElementById('input-modal-unit').textContent = unit || '';
            const field = document.getElementById('input-modal-field');
            field.min = _inputModalMin; field.max = _inputModalMax;
            field.value = defaultVal ?? '';
            document.getElementById('input-modal-error').classList.add('hidden');
            modal.classList.remove('hidden');
            setTimeout(() => { field.focus(); field.select(); }, 50);
            field.onkeydown = (e) => { if (e.key === 'Enter') inputModalConfirm(); if (e.key === 'Escape') inputModalCancel(); };
        };

        const inputModalCancel = () => {
            document.getElementById('input-modal').classList.add('hidden');
            _inputModalCallback = null;
        };

        const inputModalConfirm = () => {
            const val = parseInt(document.getElementById('input-modal-field').value);
            const errEl = document.getElementById('input-modal-error');
            if (isNaN(val) || val < _inputModalMin || val > _inputModalMax) {
                errEl.textContent = `‚ö†Ô∏è Inserire un numero tra ${_inputModalMin} e ${_inputModalMax}`;
                errEl.classList.remove('hidden');
                document.getElementById('input-modal-field').focus();
                return;
            }
            errEl.classList.add('hidden');
            document.getElementById('input-modal').classList.add('hidden');
            if (_inputModalCallback) { _inputModalCallback(val); _inputModalCallback = null; }
        };

        const inputModalBackdropClick = (e) => {
            if (e.target.id === 'input-modal') inputModalCancel();
        };

        const applyDiagnosiVeloce = (diagnosiCode) => {
            if (caseLocked) return;
            if (selectedSites.length === 0) { alert('‚ö†Ô∏è Seleziona prima le sedi campionate!'); return; }

            const finalize = () => {
                siteSelectionDone = false; multiSiteMode = false; wizardSiteIndex = 0; wizardData = {};
                const opt = diagnosiVeloceOptions.find(o => o.codice === diagnosiCode);
                alert(`‚úÖ Campioni generati per: ${opt?.label || diagnosiCode}`);
            };

            if (DIAGNOSI_CON_NANCY.includes(diagnosiCode)) {
                const isRemission = diagnosiCode === 'IBD_REMISSIONE';
                showInputModal({
                    title: 'Nancy Histological Index',
                    headerColor: '#1d4ed8',
                    desc: isRemission
                        ? ['<strong>Grado 0</strong> ‚Äî Remissione completa',
                           '<strong>Grado 1</strong> ‚Äî Remissione con alterazioni croniche ‚≠ê',
                           '<strong>Grado 2</strong> ‚Äî Attivit√† lieve residua',
                           '<strong>Grado 3</strong> ‚Äî Attivit√† moderata',
                           '<strong>Grado 4</strong> ‚Äî Attivit√† severa']
                        : ['<strong>Grado 0</strong> ‚Äî Remissione',
                           '<strong>Grado 1</strong> ‚Äî Remissione con alterazioni croniche',
                           '<strong>Grado 2</strong> ‚Äî Attivit√† lieve',
                           '<strong>Grado 3</strong> ‚Äî Attivit√† moderata (ascessi criptici)',
                           '<strong>Grado 4</strong> ‚Äî Attivit√† severa (ulcerazione)'],
                    unit: '/ 4',
                    min: 0, max: 4,
                    defaultVal: isRemission ? 1 : 2,
                    callback: (val) => { generateSpecimensFromDiagnosi(diagnosiCode, val); finalize(); }
                });
            } else if (diagnosiCode === 'COLITE_LINFOCITICA') {
                showInputModal({
                    title: 'Conta IEL',
                    headerColor: '#7c3aed',
                    desc: ['Linfociti intraepiteliali per 100 cellule epiteliali',
                           '<span class="text-gray-500">v.n. &lt;20 ¬∑ diagnostico ‚â•20 ¬∑ marcato ‚â•30</span>'],
                    unit: '/ 100 ep.',
                    min: 0, max: 100,
                    defaultVal: 25,
                    callback: (val) => {
                        altreColiti.iel_count = val;
                        altreColiti.iel_aumentati = val >= 30 ? 'marcati' : 'aumentati';
                        generateSpecimensFromDiagnosi(diagnosiCode);
                        finalize();
                    }
                });
            } else if (diagnosiCode === 'COLITE_COLLAGENA') {
                showInputModal({
                    title: 'Banda collagene subepiteliale',
                    headerColor: '#b45309',
                    desc: ['Spessore della banda collagene subepiteliale',
                           '<span class="text-gray-500">v.n. &lt;10Œºm ¬∑ diagnostico ‚â•10Œºm ¬∑ marcato ‚â•20Œºm</span>'],
                    unit: 'Œºm',
                    min: 0, max: 200,
                    defaultVal: 15,
                    callback: (val) => {
                        altreColiti.banda_collagene_um = val;
                        altreColiti.banda_collagene = val >= 20 ? 'marcata' : 'ispessita';
                        altreColiti.architettura_conservata = true;
                        generateSpecimensFromDiagnosi(diagnosiCode);
                        finalize();
                    }
                });
            } else {
                generateSpecimensFromDiagnosi(diagnosiCode);
                finalize();
            }
        };

        const updateSiteSelectionUI = () => {
            // Ricostruisce solo le checkbox e counter/bottone senza render() completo
            const n = selectedSites.length;
            const counter = document.getElementById('site-selection-counter');
            const btn = document.getElementById('btn-confirm-sites');
            if (counter) counter.textContent = n > 0 ? (n + ' sede' + (n > 1 ? 'i' : '') + ' selezionat' + (n > 1 ? 'e' : 'a')) : '';
            if (btn) {
                btn.disabled = n === 0;
                btn.className = 'w-full py-3 rounded-lg font-bold text-white transition-all ' + (n === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700');
                btn.textContent = n === 0 ? 'Seleziona almeno una sede ‚Üí' : '‚ñ∂ Avanti con ' + n + ' sede' + (n > 1 ? 'i' : '');
            }
            // Aggiorna le checkbox visivamente
            document.querySelectorAll('input[type=checkbox][onchange*=toggleSiteSelection]').forEach(cb => {
                cb.checked = selectedSites.includes(cb.value);
            });
        };
        const selectAllStandardSites = () => { if (caseLocked) return; selectedSites = [...STANDARD_SITES]; saveData(); updateSiteSelectionUI(); };
        const deselectAllSites = () => {
            if (caseLocked) return;
            if (siteSelectionDone) { siteSelectionDone = false; selectedSites = []; saveData(); render(); return; }
            selectedSites = []; saveData(); updateSiteSelectionUI();
        };

        const toggleSiteSelection = (site, checked) => {
            if (caseLocked) return;
            if (checked) { if (!selectedSites.includes(site)) selectedSites.push(site); }
            else { selectedSites = selectedSites.filter(s => s !== site); }
            saveData();
            // Aggiornamento chirurgico: solo counter e bottone, senza render() completo
            // (render() causerebbe transizione a SiteSelectionWithDiagnosi dopo la prima spunta)
            const counter = document.getElementById('site-selection-counter');
            const btn = document.getElementById('btn-confirm-sites');
            const n = selectedSites.length;
            if (counter) counter.textContent = n > 0 ? (n + ' sede' + (n > 1 ? 'i' : '') + ' selezionat' + (n > 1 ? 'e' : 'a')) : '';
            if (btn) {
                btn.disabled = n === 0;
                btn.className = 'w-full py-3 rounded-lg font-bold text-white transition-all ' + (n === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700');
                btn.textContent = n === 0 ? 'Seleziona almeno una sede ‚Üí' : '‚ñ∂ Avanti con ' + n + ' sede' + (n > 1 ? 'i' : '');
            }
        };

        // proceedFromSiteSelection: va a SiteSelectionWithDiagnosi (step 2 con diagnosi veloce)
        // da l√¨ si pu√≤ usare diagnosi veloce OPPURE "Compila manualmente" ‚Üí wizard
        const proceedFromSiteSelection = () => {
            if (caseLocked || selectedSites.length === 0) return;
            siteSelectionDone = true; saveData(); render();
        };
        const confirmSiteSelection = () => { if (caseLocked || selectedSites.length === 0) return; multiSiteMode = true; wizardSiteIndex = 0; wizardData = {}; saveData(); render(); };
        const cancelMultiSiteMode = () => { if (caseLocked) return; multiSiteMode = false; wizardSiteIndex = 0; wizardData = {}; siteSelectionDone = false; selectedSites = []; saveData(); render(); };
        const wizardSaveCurrent = () => {
            const site = selectedSites[wizardSiteIndex];
            if (!site) return;
            const isIleum = site === 'ileo';
            const keys = isIleum
                ? ['granulomi_epitelioidi','neutrofili_lamina_propria','erosioni_ulcerazioni','iperplasia_linfoide','edema_lamina_propria','atrofia_villi','plasmacellule_aumentate','fibrosi_sottomucosa']
                : ['granulomi_epitelioidi','neutrofili_epitelio','ascessi_criptici','plasmacellule_basale','distorsione_architettura','metaplasia_paneth','ulcerazione','fibrosi_sottomucosa','displasia'];
            const findings = {};
            keys.forEach(k => { const el = document.getElementById(`finding-${wizardSiteIndex}-${k}`); if (el) findings[k] = el.value; });
            const mucinCb = document.getElementById(`mucin-granuloma-checkbox-${wizardSiteIndex}`);
            const facCb = document.getElementById(`fac-checkbox-${wizardSiteIndex}`);
            wizardData[wizardSiteIndex] = { findings, mucinGranulomaLikely: (mucinCb && mucinCb.checked) || false, facPresente: (facCb && facCb.checked) || false };
        };
        const wizardNext = () => { wizardSaveCurrent(); if (wizardSiteIndex < selectedSites.length - 1) { wizardSiteIndex++; render(); } };
        const wizardPrev = () => { wizardSaveCurrent(); if (wizardSiteIndex > 0) { wizardSiteIndex--; render(); } };

        const toggleMucinCheckbox = (site, siteIndex, granulomaValue) => {
            const container = document.getElementById(`mucin-checkbox-container-${siteIndex}`);
            if (!container) return;
            if (granulomaValue === 'presente' || granulomaValue === 'sospetti') container.classList.remove('hidden');
            else { container.classList.add('hidden'); const cb = document.getElementById(`mucin-granuloma-checkbox-${siteIndex}`); if (cb) cb.checked = false; }
        };

        const addAllSpecimens = () => {
            if (caseLocked) return;
            wizardSaveCurrent(); // salva l'ultima sede prima di committare
            selectedSites.forEach((site, siteIndex) => {
                const isIleum = (site === 'ileo');
                const saved = wizardData[siteIndex] || {};
                const findings = saved.findings || {};
                // fallback al DOM se per qualche motivo wizardData manca
                if (Object.keys(findings).length === 0) {
                    const findingKeys = isIleum
                        ? ['granulomi_epitelioidi','neutrofili_lamina_propria','erosioni_ulcerazioni','iperplasia_linfoide','edema_lamina_propria','atrofia_villi','plasmacellule_aumentate','fibrosi_sottomucosa']
                        : ['granulomi_epitelioidi','neutrofili_epitelio','ascessi_criptici','plasmacellule_basale','distorsione_architettura','metaplasia_paneth','ulcerazione','fibrosi_sottomucosa','displasia'];
                    findingKeys.forEach(key => { const el = document.getElementById(`finding-${siteIndex}-${key}`); if (el) findings[key] = el.value; });
                }
                specimens.push({ site, findings, siteType: isIleum ? 'ileum' : 'colon', mucinGranulomaLikely: saved.mucinGranulomaLikely || false, facPresente: saved.facPresente || false });
            });
            multiSiteMode = false; wizardSiteIndex = 0; wizardData = {}; siteSelectionDone = false; selectedSites = [];
            saveData(); render();
        };

        // ==================== DISCLAIMER ====================
        const checkDisclaimer = () => { if (!localStorage.getItem(DISCLAIMER_KEY)) document.getElementById('disclaimer-modal').classList.remove('hidden'); };
        const acceptDisclaimer = () => { localStorage.setItem(DISCLAIMER_KEY, 'true'); document.getElementById('disclaimer-modal').classList.add('hidden'); };

        // ==================== IHC ====================
        const updateIHC = (field, value) => { if (caseLocked) return; ihcData[field] = value; saveData(); render(); };
        const updateAltreColiti = (field, value) => {
            if (caseLocked) return;
            altreColiti[field] = value;
            if (field === 'iel_aumentati' && value === 'assente') altreColiti.iel_count = null;
            if (field === 'banda_collagene' && value === 'assente') altreColiti.banda_collagene_um = null;
            saveData(); render();
        };

        // ==================== COMPONENTS ====================
        const TabNavigation = ({ active }) => {
            const tabs = [{ id: 'campioni', label: 'üìã Campioni' }, { id: 'ihc', label: 'üî¨ IHC' }, { id: 'referto', label: 'üìÑ Referto' }];
            return `<div class="flex gap-2 mb-6 border-b no-print">
                ${tabs.map(tab => {
                    const isDisabled = caseLocked && (tab.id === 'campioni' || tab.id === 'ihc');
                    return `<button onclick="${isDisabled ? 'return false' : `switchTab('${tab.id}')`}"
                        class="px-6 py-3 font-semibold rounded-t-lg transition-colors ${active === tab.id ? 'tab-active' : isDisabled ? 'tab-disabled' : 'bg-gray-200 hover:bg-gray-300'}"
                        ${isDisabled ? 'disabled' : ''}>${tab.label}${isDisabled ? ' üîí' : ''}</button>`;
                }).join('')}
            </div>`;
        };

        const IbdNotaPanel = () => {
            if (caseLocked) return '';
            return `<div class="bg-indigo-50 rounded-lg p-4 mb-6 border-2 border-indigo-300">
                <div class="flex items-center gap-3 mb-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${ibdNota.enabled ? 'checked' : ''} onchange="toggleIbdNota(this.checked)" class="w-5 h-5 accent-indigo-600">
                        <span class="font-bold text-indigo-900">IBD nota (Follow-up)</span>
                    </label>
                </div>
                ${ibdNota.enabled ? `
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-indigo-800 mb-1">Diagnosi:</label>
                                <select onchange="updateIbdNota('diagnosiIniziale', this.value)" class="w-full p-2 border-2 border-indigo-300 rounded bg-white">
                                    <option value="" ${!ibdNota.diagnosiIniziale ? 'selected' : ''}>-- Seleziona --</option>
                                    <option value="RCU" ${ibdNota.diagnosiIniziale === 'RCU' ? 'selected' : ''}>RCU</option>
                                    <option value="Crohn" ${ibdNota.diagnosiIniziale === 'Crohn' ? 'selected' : ''}>Crohn</option>
                                    <option value="IBDU" ${ibdNota.diagnosiIniziale === 'IBDU' ? 'selected' : ''}>IBDU</option>
                                </select>
                            </div>
                            <div>

                            </div>
                        </div>
                        <div class="p-3 bg-white rounded border border-indigo-200">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" ${ibdNota.therapyOngoing ? 'checked' : ''} onchange="updateIbdNota('therapyOngoing', this.checked)" class="w-4 h-4 accent-indigo-600">
                                <span class="text-sm font-semibold text-indigo-900">üíä Paziente in terapia immunosoppressiva/biologica</span>
                            </label>
                            <p class="text-xs text-indigo-700 mt-1 ml-6">Modula interpretazione retto risparmiato</p>
                        </div>
                        ${ibdNota.diagnosiAttuale === 'RCU' ? `
                            <div class="p-2 bg-blue-50 border border-blue-300 rounded text-xs text-blue-800">
                                üìä Nancy Histological Index: <strong>abilitato</strong> (RCU in follow-up)
                            </div>
                        ` : `
                            <div class="p-2 bg-gray-50 border border-gray-300 rounded text-xs text-gray-600">
                                üìä Nancy Histological Index: non applicabile (solo per RCU nota in follow-up)
                            </div>
                        `}
                    </div>
                ` : `<p class="text-xs text-indigo-600">Spunta se il paziente ha gi√† diagnosi di IBD. Lascia vuoto per prima diagnosi.</p>`}
            </div>`;
        };

        const SpecimenForm = () => {
            if (caseLocked || specimens.length > 0) return '';
            if (multiSiteMode && selectedSites.length > 0) return MultiSiteWorkflow();
            if (siteSelectionDone && selectedSites.length > 0) return SiteSelectionWithDiagnosi();
            return `<div class="bg-blue-50 rounded-lg p-6 mb-6 border-2 border-blue-300">
                <h3 class="text-xl font-bold mb-2 flex items-center gap-2"><span>üìç</span> STEP 1: Sedi Campionate</h3>
                <p class="text-sm text-gray-600 mb-4">Seleziona le sedi biopsite:</p>
                <div class="mb-4">
                    <p class="text-xs font-semibold text-blue-700 mb-2 uppercase">Sedi Standard:</p>
                    <div class="grid grid-cols-4 gap-2">
                        ${STANDARD_SITES.map(site => `
                            <label class="flex items-center gap-2 p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-blue-400 cursor-pointer transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                                <input type="checkbox" value="${site}" ${selectedSites.includes(site) ? 'checked' : ''} onchange="toggleSiteSelection('${site}', this.checked)" class="w-5 h-5 accent-blue-600">
                                <span class="font-semibold capitalize text-sm">${site}</span>
                            </label>`).join('')}
                    </div>
                </div>
                <div class="mb-4 pt-3 border-t border-gray-300">
                    <p class="text-xs font-semibold text-amber-700 mb-2 uppercase">Casi Speciali:</p>
                    <div class="grid grid-cols-4 gap-2">
                        ${SPECIAL_SITES.map(site => `
                            <label class="flex items-center gap-2 p-3 bg-amber-50 rounded-lg border-2 border-amber-200 hover:border-amber-400 cursor-pointer transition-all has-[:checked]:border-amber-500 has-[:checked]:bg-amber-100">
                                <input type="checkbox" value="${site}" ${selectedSites.includes(site) ? 'checked' : ''} onchange="toggleSiteSelection('${site}', this.checked)" class="w-5 h-5 accent-amber-600">
                                <span class="font-semibold capitalize text-sm">${site}</span>
                            </label>`).join('')}
                    </div>
                </div>
                <div class="flex items-center gap-3 mt-4 flex-wrap">
                    <button onclick="selectAllStandardSites()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-all">‚òë Seleziona 7 Standard</button>
                    <button onclick="deselectAllSites()" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition-all">‚úï Deseleziona</button>
                    <span id="site-selection-counter" class="text-sm font-semibold text-blue-700 ml-2">${selectedSites.length > 0 ? `${selectedSites.length} sede${selectedSites.length > 1 ? 'i' : ''} selezionat${selectedSites.length > 1 ? 'e' : 'a'}` : ''}</span>
                </div>
                <div class="mt-4">
                    <button id="btn-confirm-sites" onclick="proceedFromSiteSelection()" ${selectedSites.length === 0 ? 'disabled' : ''}
                        class="w-full py-3 rounded-lg font-bold text-white transition-all ${selectedSites.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}">
                        ${selectedSites.length === 0 ? 'Seleziona almeno una sede ‚Üí' : `‚ñ∂ Avanti con ${selectedSites.length} sede${selectedSites.length > 1 ? 'i' : ''}`}
                    </button>
                </div>
            </div>`;
        };

        const SiteSelectionWithDiagnosi = () => {
            const ibdOpts = diagnosiVeloceOptions.filter(o => o.gruppo === 'ibd');
            const altreOpts = diagnosiVeloceOptions.filter(o => o.gruppo === 'altre');
            return `<div class="bg-green-50 rounded-lg p-6 mb-6 border-2 border-green-400">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold flex items-center gap-2"><span>‚ö°</span> STEP 2: Scegli Diagnosi (${selectedSites.length} sedi)</h3>
                    <button onclick="deselectAllSites()" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">‚Üê Cambia Sedi</button>
                </div>
                <p class="text-sm text-gray-700 mb-4"><strong>Sedi:</strong> ${selectedSites.map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(', ')}</p>
                <div class="mb-4">
                    <p class="text-xs font-semibold text-green-700 mb-2 uppercase">IBD:</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        ${ibdOpts.map(opt => `
                            <button onclick="applyDiagnosiVeloce('${opt.codice}')"
                                class="p-3 rounded-lg text-sm font-medium transition-all bg-white border-2 border-green-300 hover:bg-green-100 hover:border-green-500 text-left">
                                <span class="text-xl">${opt.emoji}</span>
                                <span class="block text-xs mt-1 font-bold">${opt.label}</span>
                                ${DIAGNOSI_CON_NANCY.includes(opt.codice) ? '<span class="block text-xs text-green-600">‚Üí chiede Nancy</span>' : ''}
                            </button>`).join('')}
                    </div>
                </div>
                <div class="mb-4 pt-3 border-t border-gray-300">
                    <p class="text-xs font-semibold text-amber-700 mb-2 uppercase">Altre Coliti:</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        ${altreOpts.map(opt => `
                            <button onclick="applyDiagnosiVeloce('${opt.codice}')"
                                class="p-3 rounded-lg text-sm font-medium transition-all bg-white border-2 border-amber-300 hover:bg-amber-100 hover:border-amber-500 text-left">
                                <span class="text-xl">${opt.emoji}</span>
                                <span class="block text-xs mt-1 font-bold">${opt.label}</span>
                                ${opt.codice === 'COLITE_LINFOCITICA' ? '<span class="block text-xs text-purple-600">‚Üí chiede IEL</span>' : ''}
                                ${opt.codice === 'COLITE_COLLAGENA' ? '<span class="block text-xs text-purple-600">‚Üí chiede spessore</span>' : ''}
                            </button>`).join('')}
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-300">
                    <button onclick="confirmSiteSelection()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-all">üìù Compila manualmente i findings...</button>
                </div>
            </div>`;
        };

        const MultiSiteWorkflow = () => {
            const colonFindings = {
                granulomi_epitelioidi: ['assente','sospetti','presente'],
                neutrofili_epitelio: ['assente','lieve','moderata','marcata'],
                ascessi_criptici: ['assente','presente'],
                plasmacellule_basale: ['assente','presente'],
                distorsione_architettura: ['assente','presente'],
                metaplasia_paneth: ['assente','presente'],
                ulcerazione: ['assente','presente'],
                fibrosi_sottomucosa: ['assente','lieve','moderata','marcata'],
                displasia: ['assente','indefinita','LGD','HGD']
            };
            const ileumFindings = {
                granulomi_epitelioidi: ['assente','sospetti','presente'],
                neutrofili_lamina_propria: ['assente','lieve','moderata','marcata'],
                erosioni_ulcerazioni: ['assente','presente'],
                iperplasia_linfoide: ['assente','presente'],
                edema_lamina_propria: ['assente','presente'],
                atrofia_villi: ['assente','lieve','moderata','marcata'],
                plasmacellule_aumentate: ['assente','presente'],
                fibrosi_sottomucosa: ['assente','lieve','moderata','marcata']
            };
            const findingLabels = {
                granulomi_epitelioidi: 'Granulomi Epitelioidi', neutrofili_epitelio: 'Neutrofili Intraepiteliali',
                neutrofili_lamina_propria: 'Neutrofili LP', erosioni_ulcerazioni: 'Erosioni/Ulcerazioni Aftose',
                iperplasia_linfoide: 'Iperplasia Linfoide', edema_lamina_propria: 'Edema LP',
                atrofia_villi: 'Atrofia Villi', plasmacellule_aumentate: 'Plasmacellule Aumentate',
                ascessi_criptici: 'Ascessi Criptici', plasmacellule_basale: 'Plasmacellule Basale',
                distorsione_architettura: 'Distorsione Architettura', metaplasia_paneth: 'Metaplasia Paneth',
                ulcerazione: 'Ulcerazione', fibrosi_sottomucosa: 'Fibrosi Sottomucosa', displasia: '‚ö†Ô∏è Displasia'
            };
            const renderFindings = (site, siteIndex) => {
                const isIleum = site === 'ileo';
                const findings = isIleum ? ileumFindings : colonFindings;
                return Object.entries(findings).map(([key, values]) => {
                    const isDisplasia = key === 'displasia', isGranulomi = key === 'granulomi_epitelioidi';
                    const options = values.map(v => `<option value="${v}">${v.charAt(0).toUpperCase() + v.slice(1)}</option>`).join('');
                    return `<div class="${isDisplasia ? 'col-span-2 bg-red-50 p-2 rounded border border-red-200' : ''}">
                        <label class="block text-sm font-semibold mb-2 ${isDisplasia ? 'text-red-700' : ''}">${findingLabels[key]}:</label>
                        <select id="finding-${siteIndex}-${key}" class="w-full p-2 border rounded ${isDisplasia ? 'border-red-300' : ''}"
                            ${isGranulomi ? `onchange="toggleMucinCheckbox('${site}', '${siteIndex}', this.value)"` : ''}>${options}</select>
                    </div>
                    ${isGranulomi ? `<div id="mucin-checkbox-container-${siteIndex}" class="col-span-2 hidden bg-yellow-50 p-3 border border-yellow-400 rounded">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="mucin-granuloma-checkbox-${siteIndex}" class="w-4 h-4">
                            <span class="text-sm font-semibold text-yellow-900">‚ö†Ô∏è Rottura criptale/Mucin granuloma plausibile?</span>
                        </label>
                        <p class="text-xs text-yellow-800 mt-1">Spunta se granulomi potrebbero essere da rottura criptale (riduce peso Crohn)</p>
                    </div>` : ''}`;
                }).join('');
            };

            // WIZARD: una sede alla volta
            const total = selectedSites.length;
            const idx = wizardSiteIndex;
            const site = selectedSites[idx];
            const isIleum = site === 'ileo';
            const isLast = idx === total - 1;
            const isFirst = idx === 0;

            // Progress bar
            const progressPercent = Math.round(((idx + 1) / total) * 100);
            const progressDots = selectedSites.map((s, i) => {
                const isDone = i < idx;
                const isCurrent = i === idx;
                return `<div class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border-2
                        ${isCurrent ? 'bg-blue-600 border-blue-600 text-white' : isDone ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-gray-300 text-gray-400'}">
                        ${isDone ? '‚úì' : i + 1}
                    </div>
                    <span class="text-xs mt-1 capitalize ${isCurrent ? 'text-blue-700 font-bold' : isDone ? 'text-green-600' : 'text-gray-400'}">${s}</span>
                </div>`;
            }).join('<div class="flex-1 h-0.5 mt-4 mx-1 ' + 'bg-gray-200"></div>');

            return `<div class="bg-green-50 rounded-lg p-6 mb-6 border-2 border-green-400">
                <!-- Header wizard -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold flex items-center gap-2"><span>üìã</span> Compila Findings</h3>
                    <button onclick="cancelMultiSiteMode()" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">‚úï Annulla</button>
                </div>

                <!-- Step indicator -->
                <div class="bg-white rounded-lg p-3 mb-4 border border-gray-200">
                    <div class="flex items-start justify-between gap-1 overflow-x-auto pb-1">
                        ${selectedSites.map((s, i) => {
                            const isDone = i < idx;
                            const isCurrent = i === idx;
                            return `<div class="flex flex-col items-center min-w-0 flex-1">
                                <div class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold border-2 flex-shrink-0
                                    ${isCurrent ? 'bg-blue-600 border-blue-600 text-white' : isDone ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-gray-300 text-gray-400'}">
                                    ${isDone ? '‚úì' : i + 1}
                                </div>
                                <span class="text-xs mt-1 capitalize text-center truncate w-full ${isCurrent ? 'text-blue-700 font-bold' : isDone ? 'text-green-600' : 'text-gray-400'}">${s}</span>
                            </div>
                            ${i < total - 1 ? '<div class="flex-shrink-0 w-4 h-0.5 bg-gray-200 mt-3.5"></div>' : ''}`;
                        }).join('')}
                    </div>
                    <div class="mt-2 text-xs text-center text-gray-500">Sede ${idx + 1} di ${total}</div>
                </div>

                <!-- Sede corrente -->
                <div class="bg-white rounded-lg p-4 border-2 ${isIleum ? 'border-orange-400' : 'border-blue-400'}">
                    <h4 class="font-bold text-lg mb-3 capitalize flex items-center gap-2">
                        üî¨ ${site}
                        <span class="text-xs px-2 py-1 rounded ${isIleum ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${isIleum ? 'Criteri ILEO' : 'Criteri COLON'}</span>
                    </h4>
                    <div class="grid grid-cols-2 gap-3">${renderFindings(site, idx)}</div>
                    ${!isIleum ? `
                    <div class="mt-3 bg-orange-50 border border-orange-300 rounded-lg p-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="fac-checkbox-${idx}" class="w-4 h-4 accent-orange-600"
                                ${(wizardData[idx] && wizardData[idx].facPresente) ? 'checked' : ''}>
                            <span class="text-sm font-semibold text-orange-900">üî¨ Colite attiva focale (FAC) presente in questa sede</span>
                        </label>
                        <p class="text-xs text-orange-700 mt-1">Almeno una cripta con infiltrato neutrofilo, architettura conservata, senza cronicit√†</p>
                    </div>` : ''}
                </div>

                <!-- Navigazione -->
                <div class="mt-5 flex items-center justify-between gap-3">
                    <button onclick="wizardPrev()" ${isFirst ? 'disabled' : ''} class="px-5 py-2 rounded-lg font-semibold border-2
                        ${isFirst ? 'border-gray-200 text-gray-300 cursor-not-allowed' : 'border-gray-400 text-gray-700 hover:bg-gray-100'}">
                        ‚Üê Precedente
                    </button>

                    <span class="text-sm text-gray-400">${idx + 1} / ${total}</span>

                    ${isLast
                        ? `<button onclick="addAllSpecimens()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 transition-all">‚úì Salva Tutti (${total})</button>`
                        : `<button onclick="wizardNext()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition-all">Avanti ‚Üí</button>`
                    }
                </div>
            </div>`;
        };

        const SpecimenList = () => {
            if (specimens.length === 0) return `<div class="text-center py-8 text-gray-500"><p>Nessun campione inserito</p></div>`;
            const getLabel = (key) => {
                const labels = { granulomi_epitelioidi: 'Granulomi', neutrofili_epitelio: 'Neutrofili (ep)', neutrofili_lamina_propria: 'Neutrofili (LP)', erosioni_ulcerazioni: 'Erosioni', iperplasia_linfoide: 'Iperplasia linf.', edema_lamina_propria: 'Edema LP', atrofia_villi: 'Atrofia villi', plasmacellule_aumentate: 'Plasmacellule', ascessi_criptici: 'Ascessi criptici', plasmacellule_basale: 'Plasmacellule basale', distorsione_architettura: 'Distorsione arch.', metaplasia_paneth: 'Metaplasia Paneth', ulcerazione: 'Ulcerazione', fibrosi_sottomucosa: 'Fibrosi', displasia: '‚ö†Ô∏è DISPLASIA' };
                return labels[key] || key;
            };
            return `<div class="space-y-4">
                ${specimens.map((spec, idx) => {
                    const nancy = (shouldShowNancy() && spec.siteType !== 'ileum') ? calculateNancyPerSpecimen(spec) : null;
                    const hasFac = spec.facPresente === true;
                    const isActive = isSpecimenActive(spec);
                    return `<div class="bg-white border-2 ${spec.findings.displasia && spec.findings.displasia !== 'assente' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg capitalize">${spec.site}</h4>
                                <div class="flex gap-2 mt-1 flex-wrap">
                                    <span class="text-xs px-2 py-1 rounded ${spec.siteType === 'ileum' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">${spec.siteType === 'ileum' ? 'üî¨ Ileo' : 'üî¨ Colon'}</span>
                                    <span class="text-xs px-2 py-1 rounded ${isActive ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${isActive ? 'üî• Attiva' : '‚úì Quiescente'}</span>
                                    ${spec.mucinGranulomaLikely ? `<span class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700">‚ö†Ô∏è Mucin granuloma?</span>` : ''}
                                </div>
                            </div>
                            ${!caseLocked ? `<div class="flex gap-2">
                                <button onclick="editSpecimen(${idx})" class="text-blue-600 hover:text-blue-800 font-bold text-sm">‚úèÔ∏è Modifica</button>
                                <button onclick="removeSpecimen(${idx})" class="text-red-600 hover:text-red-800 font-bold text-sm">‚úï Rimuovi</button>
                            </div>` : ''}
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            ${Object.entries(spec.findings).filter(([k,v]) => v !== 'assente').map(([k,v]) => `
                                <div class="bg-gray-50 p-2 rounded ${k === 'displasia' ? 'bg-red-100 col-span-3' : ''}">
                                    <span class="font-semibold ${k === 'displasia' ? 'text-red-700' : ''}">${getLabel(k)}:</span>
                                    <span class="ml-1">${v}</span>
                                </div>`).join('')}
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        };

        const EditSpecimenForm = () => {
            if (editingSpecimenIndex === null || !specimens[editingSpecimenIndex]) return '';
            const spec = specimens[editingSpecimenIndex];
            const isIleum = spec.siteType === 'ileum';
            const findingLabels = { granulomi_epitelioidi: 'Granulomi epitelioidi', neutrofili_epitelio: 'Neutrofili epitelio', neutrofili_lamina_propria: 'Neutrofili LP', ascessi_criptici: 'Ascessi criptici', plasmacellule_basale: 'Plasmacellule basale', distorsione_architettura: 'Distorsione architettura', erosioni_ulcerazioni: 'Erosioni/ulcerazioni', metaplasia_paneth: 'Metaplasia Paneth', ulcerazione: 'Ulcerazione', fibrosi_sottomucosa: 'Fibrosi sottomucosa', displasia: 'Displasia', iperplasia_linfoide: 'Iperplasia linfoide', edema_lamina_propria: 'Edema LP', atrofia_villi: 'Atrofia villi', plasmacellule_aumentate: 'Plasmacellule aumentate' };
            const findingOptions = { granulomi_epitelioidi: ['assente','presente','sospetti'], neutrofili_epitelio: ['assente','lieve','moderata','marcata'], neutrofili_lamina_propria: ['assente','lieve','moderata','marcata'], ascessi_criptici: ['assente','presente'], plasmacellule_basale: ['assente','presente'], distorsione_architettura: ['assente','presente'], erosioni_ulcerazioni: ['assente','presente'], metaplasia_paneth: ['assente','presente'], ulcerazione: ['assente','presente'], fibrosi_sottomucosa: ['assente','lieve','moderata','marcata'], displasia: ['assente','indefinita','LGD','HGD'], iperplasia_linfoide: ['assente','presente'], edema_lamina_propria: ['assente','presente'], atrofia_villi: ['assente','lieve','moderata','marcata'], plasmacellule_aumentate: ['assente','presente'] };
            const findingKeys = isIleum ? ['granulomi_epitelioidi','neutrofili_lamina_propria','erosioni_ulcerazioni','iperplasia_linfoide','edema_lamina_propria','atrofia_villi','plasmacellule_aumentate','fibrosi_sottomucosa'] : ['granulomi_epitelioidi','neutrofili_epitelio','ascessi_criptici','plasmacellule_basale','distorsione_architettura','erosioni_ulcerazioni','metaplasia_paneth','ulcerazione','fibrosi_sottomucosa','displasia'];
            return `<div class="bg-amber-50 rounded-lg p-6 mb-6 border-2 border-amber-400">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">‚úèÔ∏è Modifica: <span class="capitalize">${spec.site}</span></h3>
                <div class="grid grid-cols-2 gap-4">
                    ${findingKeys.map(key => `<div>
                        <label class="block text-sm font-semibold mb-1 ${key === 'displasia' ? 'text-red-700' : ''}">${findingLabels[key]}</label>
                        <select id="edit-finding-${key}" class="w-full p-2 border rounded ${key === 'displasia' ? 'border-red-300' : ''}">
                            ${findingOptions[key].map(opt => `<option value="${opt}" ${spec.findings[key] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>`).join('')}
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="updateSpecimen()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">‚úì Salva</button>
                    <button onclick="cancelEdit()" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500">‚úï Annulla</button>
                </div>
            </div>`;
        };

        const IHCPanel = () => {
            if (caseLocked) return `<div class="bg-gray-100 rounded-lg p-6 text-center"><p class="text-gray-600">üîí Caso bloccato.</p></div>`;
            return `<div class="bg-purple-50 rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4">Immunoistochimica</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">CD68 Pattern:</label>
                        <select onchange="updateIHC('cd68_pattern', this.value)" class="w-full p-2 border rounded">
                            <option value="non_eseguito" ${ihcData.cd68_pattern === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                            <option value="aggregati_profondi" ${ihcData.cd68_pattern === 'aggregati_profondi' ? 'selected' : ''}>Aggregati macrofagici profondi/sottomucosa (Crohn-like)</option>
                            <option value="diffuso_mucosa" ${ihcData.cd68_pattern === 'diffuso_mucosa' ? 'selected' : ''}>Diffuso mucosa (RCU-like)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">p53 Pattern:</label>
                        <select onchange="updateIHC('p53_pattern', this.value)" class="w-full p-2 border rounded">
                            <option value="non_eseguito" ${ihcData.p53_pattern === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                            <option value="wild_type" ${ihcData.p53_pattern === 'wild_type' ? 'selected' : ''}>Wild-type (normale)</option>
                            <option value="overexpression" ${ihcData.p53_pattern === 'overexpression' ? 'selected' : ''}>Overexpression (mutazione missense)</option>
                            <option value="null" ${ihcData.p53_pattern === 'null' ? 'selected' : ''}>Null/Complete loss (mutazione nonsense)</option>
                        </select>
                        ${ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null' ? `
                            <div class="mt-2 p-2 bg-red-50 border border-red-300 rounded">
                                <p class="text-xs text-red-600 font-semibold">‚ö†Ô∏è Pattern aberrante = ALTO RISCHIO DISPLASIA</p>
                                <p class="text-xs text-red-700 mt-1 italic">Il grading displastico √® MORFOLOGICO. p53 non lo definisce.</p>
                            </div>` : ''}
                    </div>
                    <div class="border-t pt-4">
                        <label class="block text-sm font-semibold mb-2">ü¶† CMV:</label>
                        <select onchange="updateIHC('cmv_status', this.value)" class="w-full p-2 border rounded">
                            <option value="non_eseguito" ${ihcData.cmv_status === 'non_eseguito' ? 'selected' : ''}>Non eseguito</option>
                            <option value="negativo" ${ihcData.cmv_status === 'negativo' ? 'selected' : ''}>Negativo</option>
                            <option value="dubbio" ${ihcData.cmv_status === 'dubbio' ? 'selected' : ''}>Dubbio</option>
                            <option value="positivo" ${ihcData.cmv_status === 'positivo' ? 'selected' : ''}>Positivo</option>
                        </select>
                        ${ihcData.cmv_status === 'positivo' ? `<div class="mt-2 p-3 bg-red-100 border border-red-400 rounded"><p class="text-sm text-red-800 font-semibold">‚ö†Ô∏è CMV POSITIVO</p><p class="text-xs text-red-700 mt-1">Compatibile con colite da CMV sovrapposta. Correlare con carica virale e clinica. Considerare valutazione infettivologica.</p></div>` : ''}
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-semibold mb-3 text-purple-800">üî¨ Coliti Microscopiche</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Banda collagene:</label>
                                <select onchange="updateAltreColiti('banda_collagene', this.value)" class="w-full p-2 border rounded">
                                    <option value="assente" ${altreColiti.banda_collagene === 'assente' ? 'selected' : ''}>Normale/Assente</option>
                                    <option value="ispessita" ${altreColiti.banda_collagene === 'ispessita' ? 'selected' : ''}>Ispessita (‚â•10Œºm)</option>
                                    <option value="marcata" ${altreColiti.banda_collagene === 'marcata' ? 'selected' : ''}>Marcatamente ispessita (>20Œºm)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">IEL:</label>
                                <select onchange="updateAltreColiti('iel_aumentati', this.value)" class="w-full p-2 border rounded">
                                    <option value="assente" ${altreColiti.iel_aumentati === 'assente' ? 'selected' : ''}>Normali</option>
                                    <option value="aumentati" ${altreColiti.iel_aumentati === 'aumentati' ? 'selected' : ''}>Aumentati (‚â•20/100)</option>
                                    <option value="marcati" ${altreColiti.iel_aumentati === 'marcati' ? 'selected' : ''}>Marcatamente aumentati (>30/100)</option>
                                </select>
                            </div>
                        </div>
                        ${altreColiti.banda_collagene !== 'assente' ? `<div class="mt-3">
                            <label class="block text-sm font-semibold mb-2">Spessore banda collagene (Œºm):</label>
                            <div class="flex items-center gap-2">
                                <input type="number" min="0" max="100" value="${altreColiti.banda_collagene_um || ''}" onchange="updateAltreColiti('banda_collagene_um', this.value ? parseInt(this.value) : null)" class="w-24 p-2 border rounded" placeholder="es. 15">
                                <span class="text-sm text-gray-600">Œºm (v.n. &lt;10Œºm)</span>
                            </div>
                        </div>` : ''}
                        ${altreColiti.iel_aumentati !== 'assente' ? `<div class="mt-3">
                            <label class="block text-sm font-semibold mb-2">Conta IEL (per 100 cellule epiteliali):</label>
                            <div class="flex items-center gap-2">
                                <input type="number" min="0" max="100" value="${altreColiti.iel_count || ''}" onchange="updateAltreColiti('iel_count', this.value ? parseInt(this.value) : null)" class="w-24 p-2 border rounded" placeholder="es. 35">
                                <span class="text-sm text-gray-600">/100 cellule epiteliali (v.n. &lt;20)</span>
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            </div>`;
        };


        // ==================== SCORING DISPLAY (v3.0.9: solo qualitativo) ====================
        const ScoringDisplay = (report) => {
            const { crohn, uc, ibdu } = report.scoring.scores;
            const crohnLabel = getScoreLabel(crohn);
            const ucLabel = getScoreLabel(uc);
            const ibduLabel = getScoreLabel(ibdu);

            return `<div class="bg-white border-2 border-blue-400 rounded-lg p-4 no-print">
                <h4 class="font-semibold mb-1">üìä Orientamento Diagnostico</h4>
                <p class="text-xs text-gray-500 mb-3 italic">
                    Indicatori qualitativi ‚Äî non percentuali validate. Il pattern morfologico prevale sullo scoring.
                </p>
                <div class="space-y-3">
                    <div class="score-card ${crohnLabel.cls}">
                        <span class="font-semibold">Malattia di Crohn</span>
                        <span class="score-badge ${crohnLabel.cls}">${crohnLabel.text}</span>
                    </div>
                    <div class="score-card ${ucLabel.cls}">
                        <span class="font-semibold">RCU</span>
                        <span class="score-badge ${ucLabel.cls}">${ucLabel.text}</span>
                    </div>
                    <div class="score-card ${ibduLabel.cls}">
                        <span class="font-semibold">IBDU</span>
                        <span class="score-badge ${ibduLabel.cls}">${ibduLabel.text}</span>
                    </div>
                </div>
                ${report.interpretation.epistemicNote ? `
                    <div class="epistemic-note p-3 rounded mt-3">
                        <p class="text-xs font-semibold text-amber-900 mb-1">üìå Nota:</p>
                        <p class="text-xs text-amber-800">${report.interpretation.epistemicNote}</p>
                    </div>` : ''}
                ${report.scoring.granulomasDriven ? `
                    <div class="bg-blue-50 border border-blue-300 p-2 rounded mt-3">
                        <p class="text-xs text-blue-800">
                            <strong>‚ÑπÔ∏è Nota metodologica:</strong> L'orientamento verso Crohn √® trainato prevalentemente 
                            dalla presenza di granulomi epitelioidi.
                        </p>
                    </div>` : ''}
                <p class="text-xs text-gray-500 mt-3 italic">
                    ‚ö†Ô∏è Indicatori orientativi, NON validati. Diagnosi finale richiede correlazione clinica.
                </p>
            </div>`;
        };

        // ==================== REPORT TAB ====================
        const ReportTab = () => {
            if (specimens.length === 0) return `<div class="text-center py-12 text-gray-500"><p class="text-xl mb-2">Nessun dato disponibile</p><p>Aggiungi almeno un campione per generare il referto</p></div>`;
            const report = generateReport();
            const isNormalMucosa = report.interpretation.level === 'normale';
            if (isNormalMucosa) {
                return `<div class="space-y-6">
                    <div class="bg-white border-2 border-green-400 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4 text-green-800">üìÑ REFERTO ISTOLOGICO</h3>
                        <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 rounded">
                            <p class="font-bold text-lg mb-1 text-green-900">${report.interpretation.headline}</p>
                            <p class="text-sm text-green-800">${report.interpretation.description}</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="font-semibold mb-2">Sedi esaminate:</h4>
                            <p class="text-sm text-gray-700">${specimens.map(s => s.site.charAt(0).toUpperCase() + s.site.slice(1)).join(', ')}</p>
                        </div>
                        <div class="mt-4 p-3 bg-gray-50 rounded text-sm text-gray-600">
                            <p>‚úì Nessuna evidenza di malattia infiammatoria intestinale</p>
                            <p>‚úì Assenza di displasia</p>
                            <p>‚úì Architettura criptica conservata</p>
                        </div>
                    </div>
                    <div class="flex gap-4 no-print">
                        <button onclick="copyReferto()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700">üìã Copia referto</button>
                        <button onclick="window.print()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">üñ®Ô∏è Stampa/PDF</button>
                        <button onclick="unlockForEdit()" class="bg-amber-500 text-white px-6 py-3 rounded hover:bg-amber-600">üîì Modifica</button>
                    </div>
                </div>`;
            }

            return `<div class="space-y-6">
                <!-- REFERTO PRINCIPALE -->
                <div class="bg-white border-2 border-gray-400 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">üìÑ REFERTO ISTOLOGICO</h3>
                    ${report.ibdNota.enabled && report.ibdNota.diagnosiAttuale ? `
                        <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                            <p class="font-semibold text-base">Quadro istologico di IBD compatibile, alla luce della storia clinica, con
                                <strong>${report.ibdNota.diagnosiAttuale === 'RCU' ? 'rettocolite ulcerosa' : report.ibdNota.diagnosiAttuale === 'Crohn' ? 'malattia di Crohn' : 'IBD non classificata'}</strong>.
                            </p>
                        </div>
                    ` : DIAGNOSI_TESTO_FISSO.includes(report.diagnosiVeloce.selected) && report.diagnosiVeloce.testo ? `
                        <div class="mb-4 p-4 bg-gray-50 border-l-4 border-gray-400 rounded">
                            <p class="text-sm text-gray-800">${report.diagnosiVeloce.testo}</p>
                        </div>
                    ` : `
                        <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                            <p class="font-bold text-lg mb-1">${report.interpretation.headline}</p>
                            <p class="text-sm text-gray-700">${report.interpretation.description}</p>
                        </div>
                    `}
                    <!-- Nancy: SOLO se RCU follow-up -->
                    ${report.nancy.applicable ? `
                        <div class="mb-4 p-4 bg-blue-50 border border-blue-300 rounded">
                            <p class="font-semibold text-blue-900 mb-1">
                                Nancy Histological Index: <strong>${report.nancy.score}/4</strong> ‚Äî ${report.nancy.interpretation.label}
                            </p>
                            <p class="text-sm text-blue-800">${report.nancy.interpretation.description}</p>
                            <p class="text-xs text-gray-500 mt-2">Marchal-Bressenot et al., Gut 2017; Travis et al., Gut 2019</p>
                        </div>
                    ` : ''}
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Dettaglio per sede:</h4>
                        <table class="w-full text-sm border-collapse">
                            <thead><tr class="bg-gray-200">
                                <th class="border p-2 text-left">Sede</th>
                                <th class="border p-2 text-left">Stato</th>
                                <th class="border p-2 text-left">FAC</th>
                                <th class="border p-2 text-left">Displasia</th>
                            </tr></thead>
                            <tbody>
                                ${specimens.map(s => {

                                    const active = isSpecimenActive(s);
                                    return `<tr>
                                        <td class="border p-2 capitalize font-semibold">${s.site}</td>
                                        <td class="border p-2 ${active ? 'text-red-600' : 'text-green-600'}">${active ? 'Attiva' : 'Quiescente'}</td>
                                        <td class="border p-2 ${s.facPresente ? 'text-orange-600 font-semibold' : 'text-gray-400'}">${s.facPresente ? 'üî¨ S√¨' : '‚Äî'}</td>
                                        <td class="border p-2 ${s.findings.displasia && s.findings.displasia !== 'assente' ? 'text-red-600 font-bold' : ''}">${s.findings.displasia || 'N/A'}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${(() => { const sl = formatSediCampionate(specimens); return sl ? `<p class="text-xs text-gray-500 mt-2">üìç ${sl}</p>` : ''; })()}
                </div>


                <!-- CMV -->
                ${report.ihcData.cmv_status === 'positivo' ? `
                    <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4">
                        <h4 class="font-bold text-red-900 mb-2">ü¶† CMV POSITIVO</h4>
                        <p class="text-sm text-red-800">Compatibile con colite da CMV sovrapposta. Correlare con carica virale. Valutazione infettivologica raccomandata.</p>
                    </div>` : ''}

                <!-- DISPLASIA -->
                ${report.dysplasiaReport ? `
                    <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4">
                        <h4 class="font-bold text-red-900 mb-2">‚ö†Ô∏è DISPLASIA RILEVATA</h4>
                        <div class="space-y-2">
                            <p class="text-sm text-red-800 font-semibold">Grado massimo: ${report.dysplasiaReport.maxGrade}</p>
                            ${report.dysplasiaReport.findings.map(d => `<p class="text-sm text-red-800">‚Ä¢ ${d.site.toUpperCase()}: ${d.grade}</p>`).join('')}
                            ${report.dysplasiaReport.p53Aberrant ? `
                                <div class="mt-2 p-2 bg-red-100 rounded">
                                    <p class="text-sm text-red-800 font-semibold">p53 aberrante (${report.ihcData.p53_pattern}): supporta displasia</p>
                                    <p class="text-xs text-red-700 mt-1 italic">‚ö†Ô∏è Il grading displastico √® MORFOLOGICO. p53 non lo definisce.</p>
                                </div>` : ''}
                            <div class="mt-3 p-3 bg-white rounded border-l-4 border-red-600">
                                <p class="text-sm font-semibold text-red-900">Raccomandazione:</p>
                                <p class="text-sm text-red-800">${report.dysplasiaReport.recommendation}</p>
                            </div>
                        </div>
                    </div>` : ''}

                <!-- SCORING QUALITATIVO (solo prima diagnosi) -->
                ${!report.ibdNota.enabled && !DIAGNOSI_TESTO_FISSO.includes(report.diagnosiVeloce.selected) ? ScoringDisplay(report) : ''}

                <!-- NOTE CLINICHE -->
                ${report.validations.length > 0 ? `
                    <div class="bg-orange-50 border-2 border-orange-400 rounded-lg p-4 no-print">
                        <h4 class="font-bold text-orange-900 mb-2">üîç Note Cliniche</h4>
                        ${report.validations.map(w => `<div class="mb-2 p-2 bg-white rounded">
                            <p class="font-semibold text-sm">${w.message}</p>
                            <p class="text-xs text-gray-600">${w.suggestion}</p>
                        </div>`).join('')}
                    </div>` : ''}

                <!-- FLAG MDT -->
                ${(() => { const mdtReasons = shouldFlagMDT(report); if (!mdtReasons) return '';
                    return `<div class="bg-purple-100 border-2 border-purple-500 rounded-lg p-4">
                        <h4 class="font-bold text-purple-900 mb-2">üè• CASO DA DISCUSSIONE MDT</h4>
                        <ul class="list-disc ml-5 space-y-1 text-sm text-purple-800">${mdtReasons.map(r => `<li>${r}</li>`).join('')}</ul>
                        <p class="text-xs text-purple-700 mt-3 italic">Complessit√† diagnostica: integrazione con gastroenterologo e, se indicato, chirurgo.</p>
                    </div>`; })()}

                <!-- NOTE METODOLOGICHE -->
                ${report.contradictoryNotes.length > 0 ? `
                    <div class="no-print">
                        <h4 class="font-bold text-amber-900 mb-3">‚ö†Ô∏è Note Metodologiche (Solo per patologo)</h4>
                        ${report.contradictoryNotes.map(note => `
                            <div class="epistemic-note p-4 rounded-lg mb-3">
                                <p class="font-bold text-amber-900 mb-2">${note.title}</p>
                                <ul class="list-disc ml-5 space-y-1 text-sm text-amber-800">${note.features.map(f => `<li>${f}</li>`).join('')}</ul>
                                <p class="text-sm text-amber-900 mt-2"><strong>Interpretazione:</strong> ${note.interpretation}</p>
                                <p class="text-sm text-amber-900 mt-1"><strong>Raccomandazione:</strong> ${note.suggestion}</p>
                            </div>`).join('')}
                    </div>` : ''}

                <!-- BOTTONI -->
                <div class="flex gap-4 no-print">
                    <button onclick="copyReferto()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700">üìã Copia referto</button>
                    <button onclick="window.print()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">üñ®Ô∏è Stampa/PDF</button>
                    <button onclick="saveData()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">üíæ Salva</button>
                    <button onclick="unlockForEdit()" class="bg-amber-500 text-white px-6 py-3 rounded hover:bg-amber-600">üîì Modifica</button>
                </div>
            </div>`;
        };

        // ==================== EVENT HANDLERS ====================
        const switchTab = (tab) => {
            if (caseLocked && (tab === 'campioni' || tab === 'ihc')) return;
            activeTab = tab;
            if (tab === 'referto' && specimens.length > 0 && !caseLocked) lockCase();
            render();
        };

        const removeSpecimen = (index) => { if (caseLocked) return; specimens.splice(index, 1); saveData(); render(); };
        const editSpecimen = (index) => { if (caseLocked) return; editingSpecimenIndex = index; render(); };
        const cancelEdit = () => { editingSpecimenIndex = null; render(); };

        const updateSpecimen = () => {
            if (caseLocked || editingSpecimenIndex === null) return;
            const spec = specimens[editingSpecimenIndex];
            const isIleum = spec.siteType === 'ileum';
            const findingKeys = isIleum
                ? ['granulomi_epitelioidi','neutrofili_lamina_propria','erosioni_ulcerazioni','iperplasia_linfoide','edema_lamina_propria','atrofia_villi','plasmacellule_aumentate','fibrosi_sottomucosa']
                : ['granulomi_epitelioidi','neutrofili_epitelio','ascessi_criptici','plasmacellule_basale','distorsione_architettura','erosioni_ulcerazioni','metaplasia_paneth','ulcerazione','fibrosi_sottomucosa','displasia'];
            const newFindings = {};
            findingKeys.forEach(key => { const el = document.getElementById(`edit-finding-${key}`); if (el) newFindings[key] = el.value; });
            specimens[editingSpecimenIndex].findings = newFindings;
            if (newFindings.granulomi_epitelioidi === 'presente') {
                const hasActiveMucosal = newFindings.neutrofili_epitelio === 'moderata' || newFindings.neutrofili_epitelio === 'marcata' || newFindings.ascessi_criptici === 'presente' || newFindings.ulcerazione === 'presente';
                specimens[editingSpecimenIndex].mucinGranulomaLikely = hasActiveMucosal;
            } else { specimens[editingSpecimenIndex].mucinGranulomaLikely = false; }
            editingSpecimenIndex = null;
            diagnosiVeloce.autoGenerated = false;
            saveData(); render();
        };


        const copyReferto = () => {
            const report = generateReport();
            const isNormal = report.interpretation.level === 'normale';
            let plainText = '';
            if (isNormal) {
                const sediNorm = formatSediCampionate(specimens);
                const facNoteNorm = formatFacNote(specimens);
                plainText = `${report.interpretation.headline}\n${report.interpretation.description}`;
                if (sediNorm) plainText += `\n\n${sediNorm}`;
                if (facNoteNorm) plainText += `\n\n${facNoteNorm}`;
            } else if (DIAGNOSI_TESTO_FISSO.includes(report.diagnosiVeloce.selected) && report.diagnosiVeloce.testo) {
                const sediLine = formatSediCampionate(specimens);
                plainText = report.diagnosiVeloce.testo;
                if (sediLine) plainText += `\n\n${sediLine}`;
                const facNoteFisso = formatFacNote(specimens);
                if (facNoteFisso) plainText += `\n\n${facNoteFisso}`;
                if (report.dysplasiaReport) plainText += `\n\n‚ö†Ô∏è DISPLASIA RILEVATA: ${report.dysplasiaReport.maxGrade}\n${report.dysplasiaReport.recommendation}`;
                navigator.clipboard.writeText(plainText).then(() => alert('‚úÖ Referto copiato!')).catch(() => {
                    const t = document.createElement('textarea'); t.value = plainText; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); alert('‚úÖ Copiato!');
                });
                return;
            } else if (report.ibdNota.enabled && report.ibdNota.diagnosiAttuale) {
                const diagnosi = report.ibdNota.diagnosiAttuale === 'RCU' ? 'rettocolite ulcerosa' : report.ibdNota.diagnosiAttuale === 'Crohn' ? 'malattia di Crohn' : 'IBD non classificata';
                plainText = `Quadro istologico di IBD compatibile, alla luce della storia clinica, con ${diagnosi}.\n\n`;
                if (report.nancy.applicable) {
                    plainText += `Nancy Histological Index = ${report.nancy.score}/4 ‚Äî ${report.nancy.interpretation.label} (Marchal-Bressenot et al., Gut 2017; Travis et al., Gut 2019)\n\n`;
                }
                plainText += `Dettaglio per sede:\n`;
                specimens.forEach(s => {
                    const nancyObj = (report.nancy.applicable && s.siteType !== 'ileum') ? calculateNancyPerSpecimen(s) : null;
                    const nancyScore = nancyObj !== null ? (typeof nancyObj === 'object' ? nancyObj.score : nancyObj) : null;
                    const active = isSpecimenActive(s);
                    plainText += `- ${s.site.charAt(0).toUpperCase() + s.site.slice(1)}: ${active ? 'Attiva' : 'Quiescente'}`;
                    if (s.findings.fibrosi_sottomucosa && s.findings.fibrosi_sottomucosa !== 'assente') plainText += `, fibrosi sottomucosa ${s.findings.fibrosi_sottomucosa}`;
                    if (s.findings.displasia && s.findings.displasia !== 'assente') plainText += `, displasia ${s.findings.displasia}`;
                    plainText += `\n`;
                });
                const sediIbd = formatSediCampionate(specimens);
                if (sediIbd) plainText += `\n${sediIbd}`;
                const facNoteIbd = formatFacNote(specimens);
                if (facNoteIbd) plainText += `\n\n${facNoteIbd}`;
            } else {
                plainText = `${report.interpretation.headline}\n${report.interpretation.description}\n\nDettaglio per sede:\n`;
                specimens.forEach(s => {
                    const active = isSpecimenActive(s);
                    plainText += `- ${s.site.charAt(0).toUpperCase() + s.site.slice(1)}: ${active ? 'Attiva' : 'Quiescente'}`;
                    if (s.findings.fibrosi_sottomucosa && s.findings.fibrosi_sottomucosa !== 'assente') plainText += `, fibrosi sottomucosa ${s.findings.fibrosi_sottomucosa}`;
                    if (s.findings.displasia && s.findings.displasia !== 'assente') plainText += `, displasia ${s.findings.displasia}`;
                    plainText += `\n`;
                });
                const sediElse = formatSediCampionate(specimens);
                if (sediElse) plainText += `\n${sediElse}`;
                const facNoteElse = formatFacNote(specimens);
                if (facNoteElse) plainText += `\n\n${facNoteElse}`;
            }
            if (report.dysplasiaReport) plainText += `\n‚ö†Ô∏è DISPLASIA RILEVATA: ${report.dysplasiaReport.maxGrade}\n${report.dysplasiaReport.recommendation}`;
            navigator.clipboard.writeText(plainText).then(() => alert('‚úÖ Referto copiato!')).catch(() => {
                const t = document.createElement('textarea'); t.value = plainText; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); alert('‚úÖ Copiato!');
            });
        };

        const saveData = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    version: APP_VERSION, specimens, ihcData, ibdNota, altreColiti, diagnosiVeloce,
                    caseLocked, reportGenerated, selectedSites, multiSiteMode,
                    siteSelectionDone, wizardSiteIndex, wizardData,
                    savedAt: new Date().toISOString()
                }));
            } catch(e) { console.error('Save error:', e); }
        };

        const loadData = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    specimens = data.specimens || [];
                    ihcData = data.ihcData || { cd68_pattern: 'non_eseguito', p53_pattern: 'non_eseguito', cmv_status: 'non_eseguito' };
                    if (!ihcData.cmv_status) ihcData.cmv_status = 'non_eseguito';
                    ibdNota = data.ibdNota || { enabled: false, diagnosiIniziale: null, diagnosiAttuale: null, therapyOngoing: false };
                    if (data.altreColiti) altreColiti = { ...altreColiti, ...data.altreColiti };
                    if (data.diagnosiVeloce) diagnosiVeloce = data.diagnosiVeloce;
                    caseLocked = data.caseLocked || false;
                    reportGenerated = data.reportGenerated || false;
                    selectedSites = data.selectedSites || [];
                    multiSiteMode = data.multiSiteMode || false;
                    siteSelectionDone = data.siteSelectionDone || false;
                    wizardSiteIndex = data.wizardSiteIndex || 0;
                    wizardData = data.wizardData || {};
                    if (caseLocked) document.getElementById('locked-banner').classList.remove('hidden');
                }
            } catch(e) { console.error('Load error:', e); }
        };

        const render = () => {
            const content = document.getElementById('main-content');
            let tabContent = '';
            if (activeTab === 'campioni') {
                if (caseLocked) {
                    tabContent = `<div class="text-center py-12 text-gray-500"><p class="text-2xl mb-4">üîí</p><p class="text-xl mb-2">Caso Bloccato</p><p>Usa "SBLOCCA NUOVO CASO" per iniziare.</p></div>`;
                } else {
                    tabContent = ResetButton() + IbdNotaPanel() + (editingSpecimenIndex !== null ? EditSpecimenForm() : SpecimenForm()) + SpecimenList();
                }
            } else if (activeTab === 'ihc') {
                tabContent = IHCPanel();
            } else if (activeTab === 'referto') {
                tabContent = ReportTab();
            }
            content.innerHTML = TabNavigation({ active: activeTab }) + tabContent;
            // Ripristina valori wizard se si torna a una sede gi√† compilata
            if (multiSiteMode && wizardData[wizardSiteIndex]) {
                const saved = wizardData[wizardSiteIndex];
                if (saved.findings) {
                    Object.entries(saved.findings).forEach(([key, val]) => {
                        const el = document.getElementById(`finding-${wizardSiteIndex}-${key}`);
                        if (el) el.value = val;
                    });
                }
                if (saved.mucinGranulomaLikely) {
                    const cb = document.getElementById(`mucin-granuloma-checkbox-${wizardSiteIndex}`);
                    if (cb) cb.checked = true;
                }
                if (saved.facPresente) {
                    const facCb = document.getElementById(`fac-checkbox-${wizardSiteIndex}`);
                    if (facCb) facCb.checked = true;
                }
            }
        };

        // ==================== EXPORTS ====================
        window.acceptDisclaimer = acceptDisclaimer;
        window.removeSpecimen = removeSpecimen;
        window.editSpecimen = editSpecimen;
        window.updateSpecimen = updateSpecimen;
        window.cancelEdit = cancelEdit;
        window.saveData = saveData;
        window.switchTab = switchTab;
        window.updateIHC = updateIHC;
        window.updateAltreColiti = updateAltreColiti;
        window.toggleIbdNota = toggleIbdNota;
        window.updateIbdNota = updateIbdNota;
        window.unlockCase = unlockCase;
        window.unlockForEdit = unlockForEdit;
        window.confirmReset = confirmReset;
        window.toggleMucinCheckbox = toggleMucinCheckbox;
        window.inputModalCancel = inputModalCancel;
        window.inputModalConfirm = inputModalConfirm;
        window.inputModalBackdropClick = inputModalBackdropClick;
        window.toggleSiteSelection = toggleSiteSelection;
        window.confirmSiteSelection = confirmSiteSelection;
        window.proceedFromSiteSelection = proceedFromSiteSelection;
        window.cancelMultiSiteMode = cancelMultiSiteMode;
        window.addAllSpecimens = addAllSpecimens;
        window.wizardNext = wizardNext;
        window.wizardPrev = wizardPrev;
        window.wizardSaveCurrent = wizardSaveCurrent;
        window.selectAllStandardSites = selectAllStandardSites;
        window.deselectAllSites = deselectAllSites;
        window.applyDiagnosiVeloce = applyDiagnosiVeloce;
        window.copyReferto = copyReferto;

        loadData();
        checkDisclaimer();
        render();
    </script>

    <div class="max-w-6xl mx-auto mt-8 text-xs text-gray-600 text-center p-4 bg-gray-100 rounded">
        <p class="font-semibold mb-1">IBD Diagnostic Tool v3.1.3</p>
        <p class="mb-1">
            <strong>v3.0.9:</strong> Nancy limitato a RCU nota in follow-up ¬∑ Scoring qualitativo (etichette, no percentuali) ¬∑
            <strong>v3.0.8:</strong> Lean expert ¬∑ <strong>v3.0.7:</strong> Epistemic Guard ¬∑ <strong>v3.0.5:</strong> Quick Sites
        </p>
        <p class="text-gray-500 mt-2">Febbraio 2026 | "Il vetrino non mente, il reagente s√¨."</p>
    </div>
</body>
</html>
