<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBD Diagnostic Tool v2.2.1 - Nancy Index 0-4 Corretto</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        .confidence-bar {
            height: 30px;
            background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #84cc16 75%, #22c55e 100%);
            border-radius: 4px;
            position: relative;
        }
        .confidence-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #000;
            z-index: 10;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            vertical-align: middle;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 320px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -160px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
            line-height: 1.5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tooltip .tooltiptext a {
            color: #60a5fa;
            text-decoration: underline;
            font-weight: 600;
        }
        .tooltip .tooltiptext a:hover {
            color: #93c5fd;
            text-decoration: none;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        const Microscope = () => <i data-lucide="microscope"></i>;
        const FileText = () => <i data-lucide="file-text"></i>;
        const User = () => <i data-lucide="user"></i>;
        const MapPin = () => <i data-lucide="map-pin"></i>;
        const Printer = () => <i data-lucide="printer"></i>;
        const AlertCircle = () => <i data-lucide="alert-circle"></i>;
        const CheckCircle = () => <i data-lucide="check-circle"></i>;
        const Info = () => <i data-lucide="info" className="tooltip-icon"></i>;

        const IBDDiagnosticTool = () => {
            const [activeTab, setActiveTab] = useState('clinical');
            const [patientData, setPatientData] = useState({
                age: '',
                gender: '',
                clinicalHistory: '',
                indication: ''
            });
            
            const [specimens, setSpecimens] = useState([
                { id: 1, label: 'A', site: 'cieco', findings: {} }
            ]);
            
            const [ihcData, setIhcData] = useState({
                cd3: '',
                cd68_pattern: 'negativo',
                cmv: 'assente',
                p53_pattern: 'wild_type',
                cd20: 'assente',
                cd138: 'assente'
            });

            const [warnings, setWarnings] = useState({});

            const anatomicalSites = [
                { value: 'ileo', label: 'Ileo terminale' },
                { value: 'cieco', label: 'Cieco' },
                { value: 'ascendente', label: 'Colon ascendente' },
                { value: 'trasverso', label: 'Colon trasverso' },
                { value: 'discendente', label: 'Colon discendente' },
                { value: 'sigma', label: 'Sigma' },
                { value: 'retto', label: 'Retto' }
            ];

            const validateIHC = (marker, value) => {
                const ranges = {
                    cd3: { 
                        min: 0, 
                        max: 100,
                        unit: 'IEL/100 epiteliali',
                        warn_low: 20,
                        warn_high: 50,
                        reference: 'Mahadeva 2002 (PMID: 12121233), Chang 2005 (PMID: 16327441)'
                    }
                };

                if (!ranges[marker]) return null;

                const range = ranges[marker];
                const num = parseFloat(value);

                if (isNaN(num)) return null;
                
                let warning = null;
                if (num < range.min || num > range.max) {
                    warning = `‚ö†Ô∏è Valore fuori range biologico (${range.min}-${range.max} ${range.unit})`;
                } else if (marker === 'cd3' && num >= range.warn_low && num < 50) {
                    warning = `‚ö†Ô∏è Valore ${num} ${range.unit} - SUGGESTIVO colite linfocitica.\nConsiderare: banda collagena (tricromia)? Anamnesi farmaci (FANS, PPI)?\nRif: ${range.reference}`;
                } else if (marker === 'cd3' && num >= 50) {
                    warning = `‚ö†Ô∏è Valore ${num} ${range.unit} - ALTAMENTE SUGGESTIVO colite linfocitica.\nConferma con banda collagena per DD colite collagena.\nRif: ${range.reference}`;
                }

                return warning;
            };

            const updateIHC = (marker, value) => {
                if (marker === 'cd3') {
                    setIhcData({...ihcData, cd3: value});
                    if (value) {
                        const warning = validateIHC(marker, value);
                        setWarnings({...warnings, [marker]: warning});
                    } else {
                        const newWarnings = {...warnings};
                        delete newWarnings[marker];
                        setWarnings(newWarnings);
                    }
                } else {
                    setIhcData({...ihcData, [marker]: value});
                }
            };

            useEffect(() => {
                const savedData = localStorage.getItem('ibdAppDataV221');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.patientData) setPatientData(parsed.patientData);
                        if (parsed.specimens) setSpecimens(parsed.specimens);
                        if (parsed.ihcData) setIhcData(parsed.ihcData);
                    } catch (e) {
                        console.error('Errore caricamento:', e);
                    }
                }
            }, []);

            useEffect(() => {
                const dataToSave = { patientData, specimens, ihcData, lastUpdated: new Date().toISOString() };
                localStorage.setItem('ibdAppDataV221', JSON.stringify(dataToSave));
            }, [patientData, specimens, ihcData]);

            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [activeTab, specimens, ihcData]);

            const ReferenceTooltip = ({ reference }) => {
                if (!reference) return null;
                return (
                    <span className="tooltip">
                        <Info />
                        <span className="tooltiptext">
                            <strong>üìö Riferimento:</strong><br/>
                            {reference.main}<br/>
                            {reference.pmid && (
                                <>
                                    <strong>PMID:</strong>{' '}
                                    <a 
                                        href={`https://pubmed.ncbi.nlm.nih.gov/${reference.pmid}`}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        style={{ color: '#60a5fa', textDecoration: 'underline' }}
                                        onClick={(e) => e.stopPropagation()}
                                    >
                                        {reference.pmid}
                                    </a>
                                    <br/>
                                </>
                            )}
                            {reference.note && <><br/><em>{reference.note}</em></>}
                        </span>
                    </span>
                );
            };

            const findingsDatabase = {
                architectural: {
                    title: "Alterazioni Architetturali (Cronicit√†)",
                    color: "bg-purple-50 border-purple-300",
                    items: {
                        glandular_distortion: {
                            name: "Distorsione ghiandolare",
                            desc: "Cripte ramificate, accorciate, distribuzione irregolare",
                            crohnScore: 15,
                            ucScore: 20,
                            reference: { main: "Geboes K et al. Gut 2000;47:404-9", pmid: "10940279" }
                        },
                        glandular_atrophy: {
                            name: "Atrofia ghiandolare",
                            desc: "Riduzione numerica delle cripte, spaziatura aumentata",
                            crohnScore: 10,
                            ucScore: 15,
                            reference: { main: "ECCO Consensus 2013" }
                        },
                        paneth_metaplasia: {
                            name: "Metaplasia di Paneth",
                            desc: "Cellule di Paneth ectopiche nel colon sinistro",
                            crohnScore: 5,
                            ucScore: 10,
                            reference: { main: "Tanaka M et al. Gut 1992;33:1190-3", pmid: "1427370" }
                        },
                        mucin_depletion: {
                            name: "Deplezione mucinica",
                            desc: "Riduzione/assenza goblet cells",
                            crohnScore: 3,
                            ucScore: 8,
                            reference: { main: "Langner C. Virchows Arch 2015;466:613-26", pmid: "25791242" }
                        }
                    }
                },
                inflammation: {
                    title: "Pattern Infiammatorio",
                    color: "bg-red-50 border-red-300",
                    items: {
                        chronic_inflammation: {
                            name: "Infiammazione cronica linfoplasmacellulare",
                            desc: "Infiltrato cronico nella lamina propria",
                            crohnScore: 10,
                            ucScore: 10,
                            reference: { main: "WHO Classification 5th Ed 2019" }
                        },
                        basal_plasmacytosis: {
                            name: "Plasmacitosi basale",
                            desc: "Accumulo plasmacellule alla base delle cripte",
                            crohnScore: 8,
                            ucScore: 12,
                            reference: { main: "Bressenot A et al. Gut 2017;66:43-9", pmid: "26464414" }
                        },
                        acute_inflammation: {
                            name: "Infiltrato flogistico acuto (granulocitario)",
                            desc: "Granulociti neutrofili nella lamina propria",
                            crohnScore: 5,
                            ucScore: 12,
                            reference: { main: "Magro F et al. J Crohns Colitis 2017;11:649-70", pmid: "28158819" }
                        },
                        cryptitis: {
                            name: "Criptite",
                            desc: "Neutrofili nell'epitelio delle cripte",
                            crohnScore: 5,
                            ucScore: 15,
                            reference: { main: "Geboes K et al. Gut 2000;47:404-9", pmid: "10940279" }
                        },
                        crypt_abscesses: {
                            name: "Ascessi criptici",
                            desc: "Neutrofili nel lume ghiandolare",
                            crohnScore: 3,
                            ucScore: 20,
                            reference: { main: "Geboes K et al. Gut 2000;47:404-9", pmid: "10940279" }
                        },
                        transmural_deep: {
                            name: "Infiammazione profonda estesa alla muscolaris mucosae",
                            desc: "Infiltrato che raggiunge/supera la muscolaris mucosae (su biopsie profonde o resezioni)",
                            crohnScore: 35,
                            ucScore: 5,
                            reference: { main: "WHO Classification 5th Ed 2019" },
                            warning: "‚ö†Ô∏è Transmuralit√† vera visibile solo su resezioni chirurgiche"
                        },
                        fissuring_ulcers: {
                            name: "Ulcere fissuriformi",
                            desc: "Ulcere lineari profonde",
                            crohnScore: 35,
                            ucScore: 5,
                            reference: { main: "Levine DS, Haggitt RC. Hum Pathol 1989;20:732-41", pmid: "2753719" }
                        }
                    }
                },
                specific: {
                    title: "Reperti Patognomonici",
                    color: "bg-orange-50 border-orange-300",
                    items: {
                        granulomas: {
                            name: "Granulomi epitelioidi non-caseosi",
                            desc: "Aggregati epitelioidi con/senza cellule giganti",
                            pathognomonic: true,
                            crohnScore: 100,
                            ucScore: 0,
                            reference: { 
                                main: "WHO Classification 5th Ed 2019",
                                note: "ATTENZIONE: Granulomi in UC possibili post-terapia anti-TNF (Maeng L, Histopathology 2004;45:298, PMID: 15330813). Correlazione clinica essenziale."
                            }
                        }
                    }
                }
            };

            const addSpecimen = () => {
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const nextLetter = letters[specimens.length];
                setSpecimens([...specimens, { 
                    id: Date.now(), 
                    label: nextLetter, 
                    site: 'cieco', 
                    findings: {} 
                }]);
            };

            const removeSpecimen = (id) => {
                if (specimens.length > 1) {
                    setSpecimens(specimens.filter(s => s.id !== id));
                }
            };

            const updateSpecimen = (id, field, value) => {
                setSpecimens(specimens.map(s => 
                    s.id === id ? { ...s, [field]: value } : s
                ));
            };

            const updateFinding = (specimenId, category, key, severity) => {
                setSpecimens(specimens.map(s => {
                    if (s.id === specimenId) {
                        return {
                            ...s,
                            findings: {
                                ...s.findings,
                                [`${category}_${key}`]: severity
                            }
                        };
                    }
                    return s;
                }));
            };

            const getFindingSeverity = (specimenId, category, key) => {
                const specimen = specimens.find(s => s.id === specimenId);
                return specimen?.findings?.[`${category}_${key}`] || 'assente';
            };

            // ========================================
            // NANCY HISTOLOGICAL INDEX v2.2.1 (CORRETTO)
            // Riferimento: Marchal-Bressenot A et al. Gut 2017;66:43-9 (PMID: 26464414)
            // Score 0-4 ORIGINALE
            // ========================================
            
            const getMaxSeverity = (severities) => {
                const order = ['assente', 'lieve', 'moderata', 'severa'];
                let maxIndex = 0;
                severities.forEach(sev => {
                    const idx = order.indexOf(sev);
                    if (idx > maxIndex) maxIndex = idx;
                });
                return order[maxIndex];
            };

            // ‚úÖ FIX: Aggregazione worst-case tra tutti i campioni
            const aggregateFindings = () => {
                const severityOrder = ['assente', 'lieve', 'moderata', 'severa'];
                let aggregated = {};
                
                specimens.forEach(spec => {
                    Object.entries(spec.findings).forEach(([key, severity]) => {
                        const currentIdx = severityOrder.indexOf(aggregated[key] || 'assente');
                        const newIdx = severityOrder.indexOf(severity);
                        if (newIdx > currentIdx) {
                            aggregated[key] = severity;
                        }
                    });
                });
                return aggregated;
            };

            const calculateNancyIndex = () => {
                // ‚úÖ FIX: Usa aggregazione worst-case
                const allFindings = aggregateFindings();
                
                // Parametri Nancy
                const hasUlceration = allFindings['inflammation_fissuring_ulcers'] && 
                                      allFindings['inflammation_fissuring_ulcers'] !== 'assente';
                
                const cryptitisSeverity = allFindings['inflammation_cryptitis'] || 'assente';
                const abscessSeverity = allFindings['inflammation_crypt_abscesses'] || 'assente';
                const acuteSeverity = allFindings['inflammation_acute_inflammation'] || 'assente';
                
                const neutrophilSeverity = getMaxSeverity([cryptitisSeverity, abscessSeverity, acuteSeverity]);
                
                const hasAbscesses = abscessSeverity !== 'assente';
                
                const hasChronicChanges = 
                    (allFindings['architectural_glandular_distortion'] && 
                     allFindings['architectural_glandular_distortion'] !== 'assente') ||
                    (allFindings['architectural_glandular_atrophy'] && 
                     allFindings['architectural_glandular_atrophy'] !== 'assente') ||
                    (allFindings['architectural_mucin_depletion'] && 
                     allFindings['architectural_mucin_depletion'] !== 'assente') ||
                    (allFindings['inflammation_basal_plasmacytosis'] && 
                     allFindings['inflammation_basal_plasmacytosis'] !== 'assente');
                
                // ‚úÖ Calcolo score 0-4 secondo Nancy Index ORIGINALE
                let nancyScore = 0;
                
                if (hasUlceration) {
                    // Grade 4: Ulcerazione presente (indipendentemente da altri parametri)
                    nancyScore = 4;
                } else if (neutrophilSeverity === 'severa' || neutrophilSeverity === 'moderata' || hasAbscesses) {
                    // Grade 3: Neutrofili moderati/severi O ascessi criptici, senza ulcere
                    nancyScore = 3;
                } else if (neutrophilSeverity === 'lieve') {
                    // Grade 2: Neutrofili lievi (criptite senza ascessi), senza ulcere
                    nancyScore = 2;
                } else if (hasChronicChanges) {
                    // Grade 1: Solo alterazioni croniche, nessun neutrofilo
                    nancyScore = 1;
                } else {
                    // Grade 0: Nessuna alterazione istologica significativa
                    nancyScore = 0;
                }
                
                return {
                    score: nancyScore,
                    hasUlceration,
                    neutrophilSeverity,
                    hasAbscesses,
                    hasChronicChanges
                };
            };

            const getNancyInterpretation = (score) => {
                const interpretations = {
                    0: {
                        text: "Assenza di malattia istologicamente significativa",
                        color: "green",
                        clinical: "Remissione istologica completa. Rischio recidiva molto basso (5-10% a 1 anno)",
                        recommendation: "Monitoraggio clinico routinario. Target terapeutico raggiunto."
                    },
                    1: {
                        text: "Infiltrato infiammatorio cronico senza attivit√† acuta",
                        color: "sky",
                        clinical: "Remissione con sequele croniche. Rischio recidiva basso (15-20% a 1 anno)",
                        recommendation: "Mantenimento terapia. Considerare de-escalation cauta."
                    },
                    2: {
                        text: "Attivit√† infiammatoria lieve",
                        color: "yellow",
                        clinical: "Malattia lievemente attiva. Rischio recidiva moderato (25-35% a 1 anno)",
                        recommendation: "Ottimizzazione terapia di mantenimento."
                    },
                    3: {
                        text: "Attivit√† infiammatoria moderata",
                        color: "orange",
                        clinical: "Malattia moderatamente attiva. Rischio recidiva elevato (40-50% a 1 anno)",
                        recommendation: "Step-up terapeutico raccomandato."
                    },
                    4: {
                        text: "Attivit√† infiammatoria severa con ulcerazione",
                        color: "red",
                        clinical: "Malattia severamente attiva. Rischio recidiva molto elevato (>60% a 1 anno)",
                        recommendation: "Escalation terapeutica urgente (biologici, JAK-i, chirurgia)."
                    }
                };
                return interpretations[score];
            };

            const calculateScoring = () => {
                let scores = {
                    crohn: 0,
                    uc: 0,
                    ibdu: 0
                };
                
                let hasGranulomas = false;
                let hasSevereActivity = false;

                specimens.forEach(spec => {
                    Object.entries(spec.findings).forEach(([key, severity]) => {
                        if (severity === 'assente') return;

                        const [category, findingKey] = key.split('_').reduce((acc, part, idx, arr) => {
                            if (idx === 0) return [part, ''];
                            if (idx === 1) return [acc[0], part];
                            return [acc[0], acc[1] + '_' + part];
                        }, ['', '']);

                        const finding = findingsDatabase[category]?.items[findingKey];
                        if (finding) {
                            const severityMult = {
                                'lieve': 0.5,
                                'moderata': 1.0,
                                'severa': 1.5
                            }[severity] || 0.3;

                            scores.crohn += (finding.crohnScore || 0) * severityMult;
                            scores.uc += (finding.ucScore || 0) * severityMult;

                            if (finding.pathognomonic && findingKey === 'granulomas') {
                                hasGranulomas = true;
                                scores.crohn += 150;
                            }
                            
                            if (findingKey === 'crypt_abscesses' && severity === 'severa') {
                                hasSevereActivity = true;
                            }
                        }
                    });
                });

                const cd3 = parseFloat(ihcData.cd3);
                if (!isNaN(cd3) && cd3 >= 20) {
                    scores.crohn += 15;
                }

                if (ihcData.cmv !== 'assente') {
                    scores.crohn += 5;
                    scores.uc += 5;
                }

                if (ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null') {
                    scores.crohn += 30;
                    scores.uc += 35;
                }

                const total = Math.max(scores.crohn, scores.uc);
                
                let result = {};
                if (total === 0) {
                    result = { crohn: 0, uc: 0, ibdu: 100 };
                } else {
                    result.crohn = Math.min(100, Math.round((scores.crohn / total) * 100));
                    result.uc = Math.min(100, Math.round((scores.uc / total) * 100));
                    
                    if (result.crohn > 40 && result.uc > 40 && Math.abs(result.crohn - result.uc) < 20) {
                        result.ibdu = Math.max(result.ibdu, 65);
                        result.conflictWarning = "‚ö†Ô∏è Pattern sovrapposto (Crohn + UC features). Considerare IBD-Unclassified con overlap.";
                        if (hasGranulomas && hasSevereActivity) {
                            result.conflictDetail = "Granulomi (Crohn) + Attivit√† criptica severa diffusa (UC-like)";
                        }
                    }
                    
                    if (result.crohn < 35 && result.uc < 35) {
                        result.ibdu = 100 - Math.max(result.crohn, result.uc);
                    } else {
                        result.ibdu = 100 - Math.max(result.crohn, result.uc);
                    }
                }

                return result;
            };

            const generateReport = () => {
                const groupedSpecimens = {};
                
                specimens.forEach(spec => {
                    const hasFindings = Object.values(spec.findings).some(v => v !== 'assente');
                    if (!groupedSpecimens[spec.site]) {
                        groupedSpecimens[spec.site] = [];
                    }
                    groupedSpecimens[spec.site].push({
                        ...spec,
                        hasFindings
                    });
                });

                let report = {
                    materialReceived: [],
                    diagnoses: [],
                    comment: '',
                    scoring: calculateScoring(),
                    nancyIndex: calculateNancyIndex()
                };

                Object.entries(groupedSpecimens).forEach(([site, specs]) => {
                    const labels = specs.map(s => s.label).join('-');
                    const siteName = anatomicalSites.find(a => a.value === site)?.label || site;
                    report.materialReceived.push(`${labels}: ${siteName}`);

                    const withFindings = specs.filter(s => s.hasFindings);
                    const withoutFindings = specs.filter(s => !s.hasFindings);

                    if (withFindings.length > 0) {
                        const allFindings = withFindings[0].findings;
                        const findingsList = [];
                        
                        let hasChronicChanges = false;
                        let hasActivity = false;
                        let hasGranulomas = false;
                        let hasTransmural = false;

                        Object.entries(allFindings).forEach(([key, severity]) => {
                            if (severity === 'assente') return;
                            
                            const [category, findingKey] = key.split('_').reduce((acc, part, idx, arr) => {
                                if (idx === 0) return [part, ''];
                                if (idx === 1) return [acc[0], part];
                                return [acc[0], acc[1] + '_' + part];
                            }, ['', '']);
                            
                            const finding = findingsDatabase[category]?.items[findingKey];
                            if (finding) {
                                if (category === 'architectural') hasChronicChanges = true;
                                if (category === 'inflammation' && (findingKey.includes('crypt') || findingKey === 'cryptitis' || findingKey === 'acute_inflammation')) hasActivity = true;
                                if (findingKey === 'granulomas') hasGranulomas = true;
                                if (findingKey === 'transmural_deep') hasTransmural = true;
                            }
                        });

                        let diagnosis = '';
                        if (hasGranulomas) {
                            diagnosis = `Colite cronica attiva con granulomi epitelioidi non-caseosi (CROHN DISEASE - HIGH CONFIDENCE)`;
                        } else if (hasTransmural) {
                            diagnosis = `Colite cronica con infiammazione profonda (CROHN DISEASE - SUGGESTIVO)`;
                        } else if (hasChronicChanges && hasActivity) {
                            diagnosis = `Colite cronica attiva`;
                            
                            const chronicDetails = [];
                            const activityDetails = [];
                            
                            if (allFindings['inflammation_crypt_abscesses'] !== 'assente' || 
                                allFindings['inflammation_cryptitis'] !== 'assente') {
                                activityDetails.push('ascessi/criptite');
                            }
                            if (allFindings['inflammation_acute_inflammation'] !== 'assente') {
                                activityDetails.push('infiltrato granulocitario');
                            }
                            if (allFindings['architectural_glandular_distortion'] !== 'assente' || 
                                allFindings['architectural_glandular_atrophy'] !== 'assente') {
                                chronicDetails.push('alterazioni architetturali');
                            }
                            
                            if (chronicDetails.length > 0 && activityDetails.length > 0) {
                                diagnosis += ` con ${chronicDetails.join(', ')} e ${activityDetails.join(' / ')}`;
                            }
                            
                        } else if (hasChronicChanges) {
                            diagnosis = `Colite cronica in fase quiescente`;
                        } else if (hasActivity) {
                            diagnosis = `Colite attiva senza franche alterazioni croniche`;
                        } else {
                            diagnosis = `Mucosa colica con lievi alterazioni infiammatorie`;
                        }

                        report.diagnoses.push({
                            site: siteName,
                            labels: labels,
                            diagnosis: diagnosis
                        });
                    }

                    if (withoutFindings.length > 0) {
                        const labels = withoutFindings.map(s => s.label).join('-');
                        report.diagnoses.push({
                            site: siteName,
                            labels: labels,
                            diagnosis: 'Mucosa colica nei limiti della norma'
                        });
                    }
                });

                return report;
            };

            const report = useMemo(() => {
                if (activeTab !== 'diagnosis') return null;
                return generateReport();
            }, [activeTab, specimens, ihcData]);

            const printReport = () => {
                window.print();
            };

            const ConfidenceBar = ({ crohn, uc, ibdu, conflictWarning, conflictDetail }) => {
                const total = crohn + uc + ibdu;
                if (total === 0) return <div className="text-gray-500">Nessun dato di scoring disponibile</div>;

                return (
                    <div className="space-y-4">
                        {conflictWarning && (
                            <div className="bg-amber-50 border-2 border-amber-400 rounded-lg p-4 mb-4">
                                <div className="flex items-start gap-2">
                                    <AlertCircle className="text-amber-600 flex-shrink-0 mt-1" />
                                    <div>
                                        <p className="font-bold text-amber-900">{conflictWarning}</p>
                                        {conflictDetail && <p className="text-sm text-amber-800 mt-1">{conflictDetail}</p>}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-sm">Crohn Disease</span>
                                <span className="text-sm font-bold text-blue-600">{crohn}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div className="bg-blue-600 h-2 rounded-full" style={{ width: `${crohn}%` }}></div>
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-sm">Ulcerative Colitis</span>
                                <span className="text-sm font-bold text-purple-600">{uc}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div className="bg-purple-600 h-2 rounded-full" style={{ width: `${uc}%` }}></div>
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-semibold text-sm">IBD Unclassified</span>
                                <span className="text-sm font-bold text-amber-600">{ibdu}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div className="bg-amber-600 h-2 rounded-full" style={{ width: `${ibdu}%` }}></div>
                            </div>
                        </div>

                        <div className="mt-4 p-3 bg-green-50 border border-green-300 rounded-lg">
                            <p className="text-sm">
                                <strong>Diagnosi pi√π probabile:</strong> {
                                    crohn >= uc && crohn >= ibdu ? 'Crohn Disease' :
                                    uc >= crohn && uc >= ibdu ? 'Ulcerative Colitis' :
                                    'IBD Unclassified'
                                }
                            </p>
                        </div>
                    </div>
                );
            };

            // ========================================
            // NANCY INDEX DISPLAY COMPONENT (v2.2.1 - Score 0-4)
            // ========================================
            const NancyIndexDisplay = ({ nancyData, scoringData }) => {
                if (!nancyData) return null;
                
                // ‚úÖ Mostra warning se Crohn-dominant
                const isCrohnDominant = scoringData && scoringData.crohn > scoringData.uc;
                
                const { score, hasUlceration, neutrophilSeverity, hasAbscesses, hasChronicChanges } = nancyData;
                const interpretation = getNancyInterpretation(score);
                
                const colorClasses = {
                    green: "bg-green-50 border-green-400 text-green-900",
                    sky: "bg-sky-50 border-sky-400 text-sky-900",
                    yellow: "bg-yellow-50 border-yellow-400 text-yellow-900",
                    orange: "bg-orange-50 border-orange-400 text-orange-900",
                    red: "bg-red-50 border-red-400 text-red-900"
                };
                
                const badgeColors = {
                    green: "bg-green-600",
                    sky: "bg-sky-600",
                    yellow: "bg-yellow-500",
                    orange: "bg-orange-500",
                    red: "bg-red-600"
                };
                
                return (
                    <div className={`border-2 rounded-lg p-5 ${colorClasses[interpretation.color]} mb-6 mt-6`}>
                        {/* Warning se Crohn-dominant */}
                        {isCrohnDominant && (
                            <div className="bg-amber-100 border border-amber-400 rounded p-3 mb-4 text-sm text-amber-800">
                                <strong>‚ö†Ô∏è Nota:</strong> Il Nancy Index √® validato per UC. 
                                Lo scoring diagnostico suggerisce pattern Crohn-dominant. 
                                Interpretare con cautela.
                            </div>
                        )}
                        
                        <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                                <h4 className="font-bold text-lg mb-1 flex items-center gap-2">
                                    Nancy Histological Index
                                    <ReferenceTooltip reference={{ 
                                        main: "Marchal-Bressenot A et al. Gut 2017;66:43-9", 
                                        pmid: "26464414",
                                        note: "Score 0-4 originale. Sistema validato per attivit√† istologica UC."
                                    }} />
                                </h4>
                                <p className="text-sm opacity-75">Scoring attivit√† UC (0-4)</p>
                            </div>
                            <div className={`${badgeColors[interpretation.color]} text-white text-4xl font-bold rounded-full w-20 h-20 flex items-center justify-center shadow-lg`}>
                                {score}
                            </div>
                        </div>
                        
                        <div className="space-y-3">
                            <div className="bg-white bg-opacity-50 rounded p-3">
                                <p className="font-bold text-base mb-1">{interpretation.text}</p>
                                <p className="text-sm opacity-90">
                                    <span className="font-semibold">Significato clinico:</span> {interpretation.clinical}
                                </p>
                            </div>
                            
                            <div className="bg-white bg-opacity-50 rounded p-3">
                                <p className="text-sm">
                                    <span className="font-semibold">üí° Raccomandazione:</span> {interpretation.recommendation}
                                </p>
                            </div>
                            
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mt-3 bg-white bg-opacity-30 rounded p-3">
                                <div>
                                    <span className="font-semibold block mb-1">Ulcerazioni:</span>
                                    <span className={hasUlceration ? "text-red-700 font-bold" : "opacity-75"}>
                                        {hasUlceration ? '‚úì Presenti' : '‚úó Assenti'}
                                    </span>
                                </div>
                                <div>
                                    <span className="font-semibold block mb-1">Neutrofili:</span>
                                    <span className={neutrophilSeverity !== 'assente' ? "font-bold" : "opacity-75"}>
                                        {neutrophilSeverity === 'assente' ? '‚úó Assenti' : `‚úì ${neutrophilSeverity.charAt(0).toUpperCase() + neutrophilSeverity.slice(1)}`}
                                    </span>
                                </div>
                                <div>
                                    <span className="font-semibold block mb-1">Ascessi criptici:</span>
                                    <span className={hasAbscesses ? "text-orange-700 font-bold" : "opacity-75"}>
                                        {hasAbscesses ? '‚úì Presenti' : '‚úó Assenti'}
                                    </span>
                                </div>
                                <div>
                                    <span className="font-semibold block mb-1">Alterazioni croniche:</span>
                                    <span className={hasChronicChanges ? "font-bold" : "opacity-75"}>
                                        {hasChronicChanges ? '‚úì Presenti' : '‚úó Assenti'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6 no-print">
                            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <Microscope />
                                    <div>
                                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">IBD Diagnostic Tool v2.2.1</h1>
                                        <p className="text-xs md:text-sm text-gray-600">Nancy Index 0-4 Corretto + Fix Scientifiche</p>
                                    </div>
                                </div>
                                <div className="flex flex-col items-start md:items-end gap-2">
                                    <span className="text-xs text-green-600 flex items-center gap-1">
                                        <span className="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                                        Salvataggio automatico
                                    </span>
                                    <button
                                        onClick={() => {
                                            if (confirm('Cancellare tutti i dati?')) {
                                                setPatientData({ age: '', gender: '', clinicalHistory: '', indication: '' });
                                                setSpecimens([{ id: 1, label: 'A', site: 'cieco', findings: {} }]);
                                                setIhcData({ cd3: '', cd68_pattern: 'negativo', cmv: 'assente', p53_pattern: 'wild_type', cd20: 'assente', cd138: 'assente' });
                                                localStorage.removeItem('ibdAppDataV221');
                                            }
                                        }}
                                        className="text-xs text-red-600 hover:text-red-800 underline"
                                    >
                                        Reset dati
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg mb-6">
                            <div className="flex flex-col sm:flex-row border-b no-print">
                                {[
                                    { id: 'clinical', label: 'Dati Clinici', icon: <User /> },
                                    { id: 'specimens', label: 'Campioni', icon: <MapPin /> },
                                    { id: 'ihc', label: 'Immunoistochimica', icon: <Microscope /> },
                                    { id: 'diagnosis', label: 'Referto', icon: <FileText /> }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 font-semibold ${
                                            activeTab === tab.id ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'
                                        }`}
                                    >
                                        {tab.icon}
                                        <span className="text-sm sm:text-base">{tab.label}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="p-6">
                                {/* TAB DATI CLINICI */}
                                {activeTab === 'clinical' && (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p className="text-sm text-blue-800">
                                                <strong>Info:</strong> Questi dati compariranno nel referto finale.
                                            </p>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block font-semibold mb-2">Et√†</label>
                                                <input
                                                    type="number"
                                                    value={patientData.age}
                                                    onChange={(e) => setPatientData({...patientData, age: e.target.value})}
                                                    placeholder="Es. 45"
                                                    className="w-full px-4 py-2 border rounded-lg"
                                                />
                                            </div>

                                            <div>
                                                <label className="block font-semibold mb-2">Sesso</label>
                                                <select
                                                    value={patientData.gender}
                                                    onChange={(e) => setPatientData({...patientData, gender: e.target.value})}
                                                    className="w-full px-4 py-2 border rounded-lg"
                                                >
                                                    <option value="">Seleziona...</option>
                                                    <option value="M">Maschio</option>
                                                    <option value="F">Femmina</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block font-semibold mb-2">Quesito Diagnostico / Indicazione Clinica</label>
                                            <textarea
                                                value={patientData.indication}
                                                onChange={(e) => setPatientData({...patientData, indication: e.target.value})}
                                                placeholder="Es. Sospetta IBD. Mapping colonoscopico."
                                                className="w-full px-4 py-3 border rounded-lg h-24"
                                            />
                                        </div>

                                        <div>
                                            <label className="block font-semibold mb-2">Storia Clinica (opzionale)</label>
                                            <textarea
                                                value={patientData.clinicalHistory}
                                                onChange={(e) => setPatientData({...patientData, clinicalHistory: e.target.value})}
                                                placeholder="Es. Pregressa RCU diagnosticata 5 anni fa..."
                                                className="w-full px-4 py-3 border rounded-lg h-32"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* TAB CAMPIONI */}
                                {activeTab === 'specimens' && (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start justify-between">
                                            <p className="text-sm text-blue-800">
                                                <strong>Campioni bioptici:</strong> Aggiungi le sedi anatomiche biopsiate e per ciascuna specifica i reperti istologici.
                                            </p>
                                            <button
                                                onClick={addSpecimen}
                                                className="ml-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold whitespace-nowrap"
                                            >
                                                + Aggiungi sede
                                            </button>
                                        </div>

                                        {specimens.map((specimen, idx) => (
                                            <div key={specimen.id} className="border-2 border-indigo-200 rounded-lg p-6 bg-indigo-50">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">
                                                            {specimen.label}
                                                        </div>
                                                        <select
                                                            value={specimen.site}
                                                            onChange={(e) => updateSpecimen(specimen.id, 'site', e.target.value)}
                                                            className="px-4 py-2 border-2 border-indigo-300 rounded-lg font-semibold"
                                                        >
                                                            {anatomicalSites.map(site => (
                                                                <option key={site.value} value={site.value}>{site.label}</option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                    {specimens.length > 1 && (
                                                        <button
                                                            onClick={() => removeSpecimen(specimen.id)}
                                                            className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                                                        >
                                                            Rimuovi
                                                        </button>
                                                    )}
                                                </div>

                                                {Object.entries(findingsDatabase).map(([category, data]) => (
                                                    <div key={category} className={`border-2 ${data.color} rounded-lg p-4 mb-4`}>
                                                        <h4 className="font-bold mb-3">{data.title}</h4>
                                                        <div className="space-y-3">
                                                            {Object.entries(data.items).map(([key, item]) => {
                                                                const severity = getFindingSeverity(specimen.id, category, key);
                                                                return (
                                                                    <div key={key} className="bg-white rounded-lg border p-3">
                                                                        <div className="flex items-start gap-2 mb-2">
                                                                            <span className="font-semibold text-sm flex-1">
                                                                                {item.name}
                                                                                <ReferenceTooltip reference={item.reference} />
                                                                            </span>
                                                                            {item.pathognomonic && (
                                                                                <span className="text-xs bg-red-600 text-white px-2 py-1 rounded font-bold">
                                                                                    PATOGNOMONICO
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                        <p className="text-xs text-gray-600 mb-2">{item.desc}</p>
                                                                        {item.warning && (
                                                                            <p className="text-xs text-amber-700 bg-amber-50 p-2 rounded mb-2 border border-amber-200">{item.warning}</p>
                                                                        )}
                                                                        <div className="flex items-center gap-2">
                                                                            <select
                                                                                value={severity}
                                                                                onChange={(e) => updateFinding(specimen.id, category, key, e.target.value)}
                                                                                className="flex-1 px-2 py-1 border rounded text-sm"
                                                                            >
                                                                                <option value="assente">Assente</option>
                                                                                <option value="lieve">Lieve</option>
                                                                                <option value="moderata">Moderata</option>
                                                                                <option value="severa">Severa</option>
                                                                            </select>
                                                                            <div className={`px-3 py-1 text-xs font-bold rounded ${
                                                                                severity === 'assente' ? 'bg-gray-200' :
                                                                                severity === 'lieve' ? 'bg-green-200' :
                                                                                severity === 'moderata' ? 'bg-yellow-200' :
                                                                                'bg-red-200'
                                                                            }`}>
                                                                                {severity.toUpperCase()}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* TAB IMMUNOISTOCHIMICA */}
                                {activeTab === 'ihc' && (
                                    <div className="space-y-6">
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <p className="text-sm text-blue-800">
                                                <strong>Immunoistochimica:</strong> Inserisci i valori misurati. Il tool validher√† i range biologici e avviser√† su valori anomali.
                                            </p>
                                        </div>

                                        <div className="grid md:grid-cols-2 gap-6">
                                            {/* CD3 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD3 (IEL/100 epiteliali)</label>
                                                <input
                                                    type="number"
                                                    value={ihcData.cd3}
                                                    onChange={(e) => updateIHC('cd3', e.target.value)}
                                                    placeholder="Es. 25"
                                                    min="0"
                                                    max="100"
                                                    className="w-full px-3 py-2 border rounded-lg mb-2"
                                                />
                                                <p className="text-xs text-gray-600 mb-2">Range biologico: 0-100 IEL/100 cellule epiteliali</p>
                                                {warnings.cd3 && (
                                                    <div className="flex items-start gap-2 text-xs text-orange-700 bg-orange-50 p-2 rounded border border-orange-200 whitespace-pre-line">
                                                        <AlertCircle className="flex-shrink-0 mt-0.5" />
                                                        <span>{warnings.cd3}</span>
                                                    </div>
                                                )}
                                                {!warnings.cd3 && ihcData.cd3 && (
                                                    <div className="flex items-start gap-2 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-200">
                                                        <CheckCircle />
                                                        <span>Valore accettabile</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* CD68 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD68 - Macrofagi (pattern)</label>
                                                <select
                                                    value={ihcData.cd68_pattern}
                                                    onChange={(e) => updateIHC('cd68_pattern', e.target.value)}
                                                    className="w-full px-3 py-2 border rounded-lg mb-2"
                                                >
                                                    <option value="negativo">Negativo / Non eseguito</option>
                                                    <option value="focale">Focale (aggregati macrofagici)</option>
                                                    <option value="granulomi">Granulomi ben formati</option>
                                                    <option value="confluenti">Granulomi confluenti</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mb-2">Valutazione qualitativa per granulomi</p>
                                                {ihcData.cd68_pattern !== 'negativo' && (
                                                    <p className="text-xs text-orange-700 bg-orange-50 p-2 rounded border border-orange-200">
                                                        ‚ö†Ô∏è Confermare sempre morfologia H&E
                                                    </p>
                                                )}
                                            </div>

                                            {/* CMV */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CMV - Citomegalovirus</label>
                                                <select
                                                    value={ihcData.cmv}
                                                    onChange={(e) => setIhcData({...ihcData, cmv: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="assente">Assente</option>
                                                    <option value="presente">Presente (positivo)</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">Superinfezione oppurtunistica</p>
                                            </div>

                                            {/* p53 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">p53 - Pattern (WHO 2019)</label>
                                                <select
                                                    value={ihcData.p53_pattern}
                                                    onChange={(e) => updateIHC('p53_pattern', e.target.value)}
                                                    className="w-full px-3 py-2 border rounded-lg mb-2"
                                                >
                                                    <option value="wild_type">Wild-type (&lt;5%)})</option>
                                                    <option value="equivocal">Equivocal (5-60%)</option>
                                                    <option value="overexpression">Overexpression (&gt;60%)</option>
                                                    <option value="null">Null pattern (perdita completa)</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mb-2">Pattern recognition secondo WHO 2019</p>
                                                {(ihcData.p53_pattern === 'overexpression' || ihcData.p53_pattern === 'null') && (
                                                    <div className="flex items-start gap-2 text-xs text-red-700 bg-red-50 p-2 rounded border border-red-200">
                                                        <AlertCircle className="flex-shrink-0 mt-0.5" />
                                                        <span>‚ö†Ô∏è Pattern aberrante - SUGGESTIVO DISPLASIA HIGH-GRADE.<br/>Rif: Voltaggio L et al. Am J Surg Pathol 2016;40:e1-e10 (PMID: 26945341)</span>
                                                    </div>
                                                )}
                                            </div>

                                            {/* CD20 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD20 - Linfociti B</label>
                                                <select
                                                    value={ihcData.cd20}
                                                    onChange={(e) => setIhcData({...ihcData, cd20: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="assente">Assente / Scarsi</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="moderato">Moderato</option>
                                                    <option value="cospicuo">Cospicuo</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">Follicoli linfoidi B</p>
                                            </div>

                                            {/* CD138 */}
                                            <div className="border rounded-lg p-4">
                                                <label className="block font-semibold mb-2">CD138 - Plasmacellule</label>
                                                <select
                                                    value={ihcData.cd138}
                                                    onChange={(e) => setIhcData({...ihcData, cd138: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="assente">Assente</option>
                                                    <option value="lieve">Lieve</option>
                                                    <option value="moderata">Moderata</option>
                                                    <option value="severa">Severa</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">Plasmacitosi - segno di cronicit√†</p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* TAB REFERTO */}
                                {activeTab === 'diagnosis' && report && (
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center no-print mb-4">
                                            <h2 className="text-2xl font-bold">Referto Anatomopatologico</h2>
                                            <button
                                                onClick={printReport}
                                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold"
                                            >
                                                <Printer />
                                                Stampa
                                            </button>
                                        </div>

                                        {/* SCORING SECTION */}
                                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-indigo-300 rounded-lg p-6 no-print">
                                            <h3 className="text-lg font-bold mb-4 text-indigo-900">üìä Analisi Scoring Diagnostico</h3>
                                            <ConfidenceBar 
                                                crohn={report.scoring.crohn}
                                                uc={report.scoring.uc}
                                                ibdu={report.scoring.ibdu}
                                                conflictWarning={report.scoring.conflictWarning}
                                                conflictDetail={report.scoring.conflictDetail}
                                            />
                                        </div>

                                        {/* NANCY INDEX SECTION (v2.2.1 - Score 0-4) */}
                                        {report.nancyIndex && (
                                            <div className="no-print">
                                                <NancyIndexDisplay 
                                                    nancyData={report.nancyIndex} 
                                                    scoringData={report.scoring}
                                                />
                                            </div>
                                        )}

                                        <div className="print-only mb-6">
                                            <div className="border-b-2 pb-4 mb-4">
                                                <h1 className="text-2xl font-bold">U.O. ANATOMIA PATOLOGICA</h1>
                                                <p className="text-sm text-gray-600">Referto Istologico - IBD Diagnostic Tool v2.2.1</p>
                                            </div>
                                            {patientData.age && (
                                                <p><strong>Et√†:</strong> {patientData.age} anni</p>
                                            )}
                                            {patientData.gender && (
                                                <p><strong>Sesso:</strong> {patientData.gender === 'M' ? 'Maschio' : 'Femmina'}</p>
                                            )}
                                            {patientData.indication && (
                                                <p><strong>Quesito diagnostico:</strong> {patientData.indication}</p>
                                            )}
                                        </div>

                                        <div className="bg-white border-2 border-gray-300 rounded-lg p-6">
                                            <div className="mb-6">
                                                <h3 className="text-lg font-bold mb-3 text-indigo-800">MATERIALE PERVENUTO:</h3>
                                                <div className="bg-gray-50 p-4 rounded">
                                                    {report.materialReceived.map((item, idx) => (
                                                        <p key={idx} className="mb-1">‚Ä¢ {item}</p>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="mb-6">
                                                <h3 className="text-lg font-bold mb-3 text-indigo-800">DIAGNOSI:</h3>
                                                <div className="space-y-3">
                                                    {report.diagnoses.map((diag, idx) => (
                                                        <div key={idx} className="bg-blue-50 p-4 rounded border-l-4 border-indigo-600">
                                                            <p className="font-bold text-indigo-900 mb-1">
                                                                {diag.labels} ({diag.site}):
                                                            </p>
                                                            <p className="text-gray-800">{diag.diagnosis}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            <div>
                                                <h3 className="text-lg font-bold mb-3 text-indigo-800">COMMENTO:</h3>
                                                <div className="bg-yellow-50 p-4 rounded border-l-4 border-yellow-600">
                                                    <p className="text-gray-800">
                                                        Quadro istologico analizzato con sistema di scoring ponderato v2.2.1 (Nancy Index 0-4 corretto). 
                                                        Confidenza diagnostica: Crohn {report.scoring.crohn}%, UC {report.scoring.uc}%, IBD-U {report.scoring.ibdu}%.
                                                        {report.nancyIndex && ` Nancy Index: ${report.nancyIndex.score}/4.`}
                                                        {report.scoring.conflictWarning && ` ${report.scoring.conflictWarning}`}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-4 no-print">
                                            <p className="text-sm">
                                                <strong>Disclaimer:</strong> Questo referto √® generato automaticamente dal sistema di scoring v2.2.1 con Nancy Index 0-4 originale (Marchal-Bressenot 2017). 
                                                La diagnosi definitiva richiede sempre correlazione clinica, endoscopica e sierologica. 
                                                Il Nancy Index √® validato per UC; interpretare con cautela se pattern Crohn-dominant.
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="text-center text-xs text-gray-600 space-y-1 no-print">
                            <p className="font-semibold">IBD Diagnostic Tool v2.2.1 - Nancy Index 0-4 Corretto</p>
                            <p>Basato su: Marchal-Bressenot 2017 | Mahadeva 2002 | Chang 2005 | Geboes 2000 | WHO 5th Ed 2019</p>
                            <p className="text-green-600">‚úì Nancy 0-4 originale | ‚úì Aggregazione worst-case | ‚úì Warning Crohn-dominant | ‚úì Bibliografia integrata</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<IBDDiagnosticTool />, document.getElementById('root'));
    </script>
</body>
</html>
